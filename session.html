<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html
  PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"><head><title>第 8 章 Request Context之Session指南</title><link rel="stylesheet" type="text/css" href="docbook.css"/><meta name="generator" content="DocBook XSL Stylesheets V1.77.1"/><link rel="home" href="index.html" title="Webx框架指南"/><link rel="up" href="pt02.html" title="部分 II. Webx基础设施服务"/><link rel="prev" href="requestcontexts.html" title="第 7 章 Request Contexts功能指南"/><link rel="next" href="pt03.html" title="部分 III. Webx应用支持服务"/><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/></head><body><div class="navheader"><table width="100%" summary="Navigation header"><tr><th colspan="3" align="center">第 8 章 Request Context之Session指南</th></tr><tr><td width="20%" align="left"><a accesskey="p" href="requestcontexts.html">上一页</a> </td><th width="60%" align="center">部分 II. Webx基础设施服务</th><td width="20%" align="right"> <a accesskey="n" href="pt03.html">下一页</a></td></tr></table><hr/></div><div xml:lang="zh-CN" class="chapter"><div class="titlepage"><div><div><h2 class="title"><a id="webx.requestcontext.session"><!--anchor webx.requestcontext.session--></a>第 8 章 Request Context之Session指南</h2></div></div></div><div class="toc"><dl><dt><span class="section"><a href="session.html#d0e9084">8.1. Session概述</a></span></dt><dd><dl><dt><span class="section"><a href="session.html#d0e9087">8.1.1. 什么是Session</a></span></dt><dt><span class="section"><a href="session.html#d0e9106">8.1.2. Session数据存在哪？</a></span></dt><dt><span class="section"><a href="session.html#d0e9174">8.1.3. 创建通用的session框架</a></span></dt></dl></dd><dt><span class="section"><a href="session.html#d0e9198">8.2. Session框架</a></span></dt><dd><dl><dt><span class="section"><a href="session.html#d0e9201">8.2.1. 最简配置</a></span></dt><dt><span class="section"><a href="session.html#d0e9237">8.2.2. Session ID</a></span></dt><dt><span class="section"><a href="session.html#d0e9520">8.2.3. Session的生命期</a></span></dt><dt><span class="section"><a href="session.html#d0e9681">8.2.4. Session Store</a></span></dt><dt><span class="section"><a href="session.html#d0e9822">8.2.5. Session Model</a></span></dt><dt><span class="section"><a href="session.html#d0e9878">8.2.6. Session Interceptor</a></span></dt></dl></dd><dt><span class="section"><a href="session.html#d0e9984">8.3. Cookie Store</a></span></dt><dd><dl><dt><span class="section"><a href="session.html#d0e10006">8.3.1. 多值Cookie Store</a></span></dt><dt><span class="section"><a href="session.html#d0e10438">8.3.2. 单值Cookie Store</a></span></dt></dl></dd><dt><span class="section"><a href="session.html#d0e10791">8.4. 其它Session Store</a></span></dt><dd><dl><dt><span class="section"><a href="session.html#d0e10794">8.4.1. Simple Memory Store</a></span></dt></dl></dd><dt><span class="section"><a href="session.html#d0e10815">8.5. 本章总结</a></span></dt></dl></div><p>Webx实现了一套session框架。Session框架建立在request contexts机制之上。建议你先阅读<a class="xref" href="filter.html" title="第 6 章 Filter、Request Contexts和Pipeline">第 6 章 <em>Filter、Request Contexts和Pipeline</em></a>和<a class="xref" href="requestcontexts.html" title="第 7 章 Request Contexts功能指南">第 7 章 <em>Request Contexts功能指南</em></a>，以便了解request contexts是怎么回事。</p><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="d0e9084"><!--anchor d0e9084--></a>8.1. Session概述</h2></div></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="d0e9087"><!--anchor d0e9087--></a>8.1.1. 什么是Session</h3></div></div></div><p>HTTP协议是无状态的，但通过session机制，就能把无状态的变成有状态的。Session的功能就是保存HTTP请求之间的状态数据。有了session的支持，就很容易实现诸如用户登录、购物车等网站功能。在Servlet
                    API中，有一个<code class="code">HttpSession</code>的接口。你可以这样使用它：</p><div class="example"><a id="d0e9095"><!--anchor d0e9095--></a><p class="title"><strong>例 8.1. 在Java代码中访问session</strong></p><div class="example-contents"><p>在一个请求中，保存session的状态</p><pre class="programlisting"><em class="hl-comment" style="color: green">// 取得session对象</em>
HttpSession session = request.getSession();

<em class="hl-comment" style="color: green">// 在session中保存用户状态</em>
session.setAttribute(<strong class="hl-string"><em style="color:navy">"loginId"</em></strong>, <strong class="hl-string"><em style="color:navy">"myName"</em></strong>);</pre><p>在另一个请求中，取出session的状态：</p><pre class="programlisting"><em class="hl-comment" style="color: green">// 得到"myName"</em>
String myName = (String) session.getAttribute(<strong class="hl-string"><em style="color:navy">"loginId"</em></strong>);</pre></div></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="d0e9106"><!--anchor d0e9106--></a>8.1.2. Session数据存在哪？</h3></div></div></div><p>Session的状态数据是怎样保存的呢？</p><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="d0e9111"><!--anchor d0e9111--></a>8.1.2.1. 保存在应用服务器的内存中</h4></div></div></div><p>一般的做法，是将session对象保存在内存里。同一时间，会有很多session被保存在服务器的内存里。由于内存是有限的，较好的服务器会把session对象的数据交换到文件中，以确保内存中的session数目保持在一个合理的范围内。</p><p>为了提高系统扩展性和可用性，我们会使用集群技术 ——
                    就是一组独立的机器共同运行同一个应用。对用户来讲，集群相当于一台“大型服务器”。而实际上，同一用户的两次请求可能被分配到两台不同的服务器上来处理。这样一来，怎样保证两次请求中存取的session值一致呢？</p><p>一种方法是使用session复制：当session的值被改变时，将它复制到其它机器上。这个方案又有两种具体的实现，一种是广播的方式。这种方式下，任何一台服务器都保存着所有服务器所接受到的session对象。服务器之间随时保持着同步，因而所有服务器都是等同的。可想而知，当访问量增大的时候，这种方式花费在广播session上的带宽有多大，而且随着机器增加，网络负担成指数级上升，不具备高度可扩展性。</p><p>另一种方法是TCP-Ring的方式，也就是把集群中所有的服务器看成一个环，A→B→C→D→A，首尾相接。把A的session复制到B，B的session复制到C，……，以此类推，最后一台服务器的session复制到A。这样，万一A宕机，还有B可以顶上来，用户的session数据不会轻易丢失。但这种方案也有缺点：一是配置复杂；二是每增添/减少一台机器时，ring都需要重新调整，这将成为性能瓶颈；三是要求前端的Load
                    Balancer具有相当强的智能，才能将用户请求分发到正确的机器上。</p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="d0e9122"><!--anchor d0e9122--></a>8.1.2.2. 保存在单一数据源中</h4></div></div></div><p>也可以将session保存在单一的数据源中，这个数据源可被集群中所有的机器所共享。这样一来，就不存在复制的问题了。</p><p>然而单一数据源的性能成了问题。每个用户请求，都需要访问后端的数据源（很可能是数据库）来存取用户的数据。</p><p>这种方案的第二个问题是：缺少应用服务厂商的支持 ——
                    很少有应用服务器直接支持这种方案。更不用说数据源有很多种（MySQL、Oracle、Hsqldb等各种数据库、专用的session
                    server等）了。</p><p>第三个问题是：数据源成了系统的瓶颈，一但这个数据源崩溃，所有的应用都不可能正常运行了。</p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="d0e9133"><!--anchor d0e9133--></a>8.1.2.3. 保存在客户端</h4></div></div></div><p>把session保存在客户端。这样一来，由于不需要在服务器上保存数据，每台服务器就变得独立，能够做到线性可扩展和极高的可用性。</p><p>具体怎么做呢？目前可用的方法，恐怕就是保存在cookie中了。但需要提醒的是，cookie具有有以下限制，因此不可无节制使用该方案：</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>Cookie数量和长度的限制。每个domain最多只能有20条cookie，每个cookie长度不能超过4KB，否则会被截掉。</p></li><li class="listitem"><p>安全性问题。如果cookie被人拦截了，那人就可以取得所有的session信息。即使加密也与事无补，因为拦截者并不需要知道cookie的意义，他只要原样转发cookie就可以达到目的了。</p></li><li class="listitem"><p>有些状态不可能保存在客户端。例如，为了防止重复提交表单，我们需要在服务器端保存一个计数器。如果我们把这个计数器保存在客户端，那么它起不到任何作用。</p></li></ul></div><p>虽然有上述缺点，但是对于其优点（极高的扩展性和可用性）来说，就显得微不足道。我们可以用下面的方法来回避上述的缺点：</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>通过良好的编程，控制保存在cookie中的session对象的大小。</p></li><li class="listitem"><p>通过加密和安全传输技术（SSL），减少cookie被破解的可能性。</p></li><li class="listitem"><p>只在cookie中存放不敏感数据，即使被盗也不会有重大损失。</p></li><li class="listitem"><p>控制cookie的生命期，使之不会永远有效。偷盗者很可能拿到一个过期的cookie。 </p></li></ul></div></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="d0e9165"><!--anchor d0e9165--></a>8.1.2.4. 将客户端、服务器端组合的方案</h4></div></div></div><p>任何一种session方案都有其优缺点。最好的方法是把它们结合起来。这样就可以弥补各自的缺点。</p><p>将大部分session数据保存在cookie中，将小部分关键和涉及安全的数据保存在服务器上。由于我们只把少量关键的信息保存在服务端，因而服务器的压力不会非常大。</p><p>在服务器上，单一的数据源比复制session的方案，更简单可靠。我们可以使用数据库来保存这部分session，也可以使用更廉价、更简单的存储，例如Berkeley
                    DB就是一种不错的服务器存储方案。将session数据保存在cookie和Berkeley
                    DB（或其它类似存储技术）中，就可以解决我们的绝大部分问题。</p></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="d0e9174"><!--anchor d0e9174--></a>8.1.3. 创建通用的session框架</h3></div></div></div><p>多数应用服务器并没有留出足够的余地，来让你自定义session的存储方案。纵使某个应用服务器提供了对外扩展的接口，可以自定义session的方案，我们也不大可能使用它。为什么呢？因为我们希望保留选择应用服务器软件的自由。</p><p>因此，最好的方案，不是在应用服务器上增加什么新功能，而是在WEB应用框架上做手术。一但我们在WEB应用框架中实现了这种灵活的session框架，那么我们的应用可以跑在任何标准的JavaEE应用服务器上。</p><p>除此之外，一个好的session框架还应该做到对应用程序透明。具体表现在：</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>使用标准的<code class="code">HttpSession</code>接口，而不是增加新的API。这样任何WEB应用，都可以轻易在两种不同的session机制之间切换。</p></li><li class="listitem"><p>应用程序不需要知道session中的对象是被保存到了cookie中还是别的什么地方。</p></li><li class="listitem"><p>Session框架可以把同一个session中的不同的对象分别保存到不同的地方去，应用程序同样不需要关心这些。例如，把一般信息放到cookie中，关键信息放到Berkeley
                            DB中。甚至同是cookie，也有持久和临时之分，有生命期长短之分。 </p></li></ul></div><p>Webx实现了这种session框架，把它建立在Request Contexts的基础上。</p></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="d0e9198"><!--anchor d0e9198--></a>8.2. Session框架</h2></div></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="d0e9201"><!--anchor d0e9201--></a>8.2.1. 最简配置</h3></div></div></div><div class="example"><a id="d0e9204"><!--anchor d0e9204--></a><p class="title"><strong>例 8.2. Session框架基本配置（<code class="filename">/WEB-INF/webx.xml</code>）</strong></p><div class="example-contents"><pre class="programlisting"><strong class="hl-tag" style="color: #000096">&lt;services:request-contexts</strong> <span class="hl-attribute" style="color: #F5844C">xmlns</span>=<span class="hl-value" style="color: #993300">"http://www.alibaba.com/schema/services/request-contexts"</span><strong class="hl-tag" style="color: #000096">&gt;</strong>
    <strong class="hl-tag" style="color: #000096">&lt;buffered /&gt;</strong>
    <strong class="hl-tag" style="color: #000096">&lt;lazy-commit /&gt;</strong>
    ...
    <strong class="hl-tag" style="color: #000096">&lt;session&gt;</strong>
        <strong class="hl-tag" style="color: #000096">&lt;stores&gt;</strong>
            <strong class="hl-tag" style="color: #000096">&lt;session-stores:simple-memory-store</strong> <span class="hl-attribute" style="color: #F5844C">id</span>=<span class="hl-value" style="color: #993300">"simple"</span><strong class="hl-tag" style="color: #000096"> /&gt;</strong> <a id="co.session.store.simple1"><!--anchor co.session.store.simple1--></a><span class="calloutno"><img src="images/callouts/1.png" border="0"/></span>
        <strong class="hl-tag" style="color: #000096">&lt;/stores&gt;</strong>
        <strong class="hl-tag" style="color: #000096">&lt;store-mappings&gt;</strong>
            <strong class="hl-tag" style="color: #000096">&lt;match</strong> <span class="hl-attribute" style="color: #F5844C">name</span>=<span class="hl-value" style="color: #993300">"*"</span> <span class="hl-attribute" style="color: #F5844C">store</span>=<span class="hl-value" style="color: #993300">"simple"</span><strong class="hl-tag" style="color: #000096"> /&gt;</strong> <a id="co.session.store.simple1.maptoall"><!--anchor co.session.store.simple1.maptoall--></a><span class="calloutno"><img src="images/callouts/2.png" border="0"/></span>
        <strong class="hl-tag" style="color: #000096">&lt;/store-mappings&gt;</strong>
    <strong class="hl-tag" style="color: #000096">&lt;/session&gt;</strong>
<strong class="hl-tag" style="color: #000096">&lt;/services:request-contexts&gt;</strong></pre></div></div><p>以上的配置，创建了一个最基本的session实现：将所有数据（<a id="co.session.store.simple1.maptoall"><!--anchor co.session.store.simple1.maptoall--></a><span class="calloutno"><img src="images/callouts/2.png" border="0"/></span>
                <code class="code">name=*</code>）保存在内存里（<a id="co.session.store.simple1"><!--anchor co.session.store.simple1--></a><span class="calloutno"><img src="images/callouts/1.png" border="0"/></span>
                <code class="code">simple-memory-store</code>）。</p><div class="warning" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Warning"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[警告]" src="images/warning.png"/></td><th align="left">警告</th></tr><tr><td align="left" valign="top"><p>最简配置只能用于开发，<span class="emphasis"><em>请不要将上述配置用在生产环境</em></span>。因为<code class="code">simple-memory-store</code>只是将数据保存在内存里。在生产环境中，内存有被耗尽的可能。这段配置也不支持服务器集群。</p></td></tr></table></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="d0e9237"><!--anchor d0e9237--></a>8.2.2. Session ID</h3></div></div></div><p>Session ID唯一标识了一个session对象。把session
                ID保存在cookie里是最方便的。这样，凡是cookie值相同的所有的请求，就被看作是在同一个session中的请求。在servlet中，还可以把session
                ID编码到URL中。Session框架既支持把session ID保存在cookie中，也支持把session ID编码到URL中。</p><p>完整的session ID配置如下： </p><div class="example"><a id="d0e9244"><!--anchor d0e9244--></a><p class="title"><strong>例 8.3. Session ID的配置</strong></p><div class="example-contents"><pre class="programlisting"><strong class="hl-tag" style="color: #000096">&lt;session&gt;</strong>
    <strong class="hl-tag" style="color: #000096">&lt;id</strong> <span class="hl-attribute" style="color: #F5844C">cookieEnabled</span>=<span class="hl-value" style="color: #993300">"true"</span> <span class="hl-attribute" style="color: #F5844C">urlEncodeEnabled</span>=<span class="hl-value" style="color: #993300">"false"</span><strong class="hl-tag" style="color: #000096">&gt;</strong>
        <strong class="hl-tag" style="color: #000096">&lt;cookie</strong> <span class="hl-attribute" style="color: #F5844C">name</span>=<span class="hl-value" style="color: #993300">"JSESSIONID"</span> <span class="hl-attribute" style="color: #F5844C">domain</span>=<span class="hl-value" style="color: #993300">""</span> <span class="hl-attribute" style="color: #F5844C">maxAge</span>=<span class="hl-value" style="color: #993300">"0"</span> <span class="hl-attribute" style="color: #F5844C">path</span>=<span class="hl-value" style="color: #993300">"/"</span> <span class="hl-attribute" style="color: #F5844C">httpOnly</span>=<span class="hl-value" style="color: #993300">"true"</span> <span class="hl-attribute" style="color: #F5844C">secure</span>=<span class="hl-value" style="color: #993300">"false"</span><strong class="hl-tag" style="color: #000096"> /&gt;</strong>
        <strong class="hl-tag" style="color: #000096">&lt;url-encode</strong> <span class="hl-attribute" style="color: #F5844C">name</span>=<span class="hl-value" style="color: #993300">"JSESSIONID"</span><strong class="hl-tag" style="color: #000096"> /&gt;</strong>
        <strong class="hl-tag" style="color: #000096">&lt;session-idgens:uuid-generator /&gt;</strong>
    <strong class="hl-tag" style="color: #000096">&lt;/id&gt;</strong>
<strong class="hl-tag" style="color: #000096">&lt;/session&gt;</strong></pre></div></div><p>上面这段配置包含了关于Session ID的所有配置以及默认值。如果不指定上述参数，则系统将使用默认值，其效果等同于上述配置。</p><div class="table"><a id="d0e9251"><!--anchor d0e9251--></a><p class="title"><strong>表 8.1. Session ID的配置说明</strong></p><div class="table-contents"><table summary="Session ID的配置说明" cellpadding="10" style="border: none;"><colgroup><col width="31%" class="c1"/><col width="69%" class="c2"/></colgroup><thead><tr><th style="border-bottom: 0.5pt solid #6666cc; " colspan="2">配置<code class="code">&lt;session&gt;&lt;id&gt;</code> ——
                                将Session ID保存于何处？</th></tr></thead><tbody valign="middle"><tr><td style="border-right: 0.5pt solid #6666cc; border-bottom: 0.5pt solid #6666cc; " valign="middle"><code class="code">cookieEnabled</code></td><td style="border-bottom: 0.5pt solid #6666cc; " valign="middle">
                                <p>是否把session ID保存在cookie中，如若不是，则只能保存的URL中。</p>
                                <p>默认为开启：<code class="code">true</code>。</p>
                            </td></tr><tr><td style="border-right: 0.5pt solid #6666cc; " valign="middle"><code class="code">urlEncodeEnabled</code></td><td style="" valign="middle">
                                <p>是否支持把session
                                        ID编码在URL中。如果为<code class="code">true</code>开启，应用必须调用<code class="code">response.encodeURL()</code>或<code class="code">response.encodeRedirectURL()</code>来将<code class="code">JSESSIONID</code>编码到URL中。</p>
                                <p>默认为关闭：<code class="code">false</code>。</p>
                            </td></tr></tbody></table><table summary="Session ID的配置说明" cellpadding="10" style="border: none;"><colgroup><col width="31%" class="c1"/><col width="69%" class="c2"/></colgroup><thead><tr><th style="border-bottom: 0.5pt solid #6666cc; " colspan="2">配置<code class="code">&lt;session&gt;&lt;id&gt;&lt;cookie&gt;</code> —— 将Session
                                ID存放于cookie的设置</th></tr></thead><tbody valign="middle"><tr><td style="border-right: 0.5pt solid #6666cc; border-bottom: 0.5pt solid #6666cc; " valign="middle"><code class="code">name</code></td><td style="border-bottom: 0.5pt solid #6666cc; " valign="middle">
                                <p>Session ID cookie的名称。</p>
                                <p>默认为<code class="code">JSESSIONID</code>。</p>
                            </td></tr><tr><td style="border-right: 0.5pt solid #6666cc; border-bottom: 0.5pt solid #6666cc; " valign="middle"><code class="code">domain</code></td><td style="border-bottom: 0.5pt solid #6666cc; " valign="middle">
                                <p>Session ID cookie的domain。</p>
                                <p>默认为空，表示根据当前请求自动设置domain。这意味着浏览器认为你的cookie属于当前域名。如果你的应用包含多个子域名，例如：<code class="code">www.alibaba.com</code>、<code class="code">china.alibaba.com</code>，而你又希望它们能共享session的话，请把域名设置成“<code class="code">alibaba.com</code>”。</p>
                            </td></tr><tr><td style="border-right: 0.5pt solid #6666cc; border-bottom: 0.5pt solid #6666cc; " valign="middle"><code class="code">maxAge</code></td><td style="border-bottom: 0.5pt solid #6666cc; " valign="middle">
                                <p>Session ID cookie的最长存活时间（秒）。</p>
                                <p>默认为<code class="code">0</code>，表示临时cookie，随浏览器的关闭而消失。</p>
                            </td></tr><tr><td style="border-right: 0.5pt solid #6666cc; border-bottom: 0.5pt solid #6666cc; " valign="middle"><code class="code">path</code></td><td style="border-bottom: 0.5pt solid #6666cc; " valign="middle">
                                <p>Session ID cookie的path。</p>
                                <p>默认为<code class="code">/</code>，表示根路径。</p>
                            </td></tr><tr><td style="border-right: 0.5pt solid #6666cc; border-bottom: 0.5pt solid #6666cc; " valign="middle"><code class="code">httpOnly</code></td><td style="border-bottom: 0.5pt solid #6666cc; " valign="middle">
                                <p>在session ID cookie上设置<code class="code">HttpOnly</code>标记。</p>
                                <p>在IE6及更新版本中，可以缓解XSS攻击的危险。默认为<code class="code">true</code>。</p>
                            </td></tr><tr><td style="border-right: 0.5pt solid #6666cc; " valign="middle"><code class="code">secure</code></td><td style="" valign="middle">
                                <p>在session ID cookie上设置<code class="code">Secure</code>标记。</p>
                                <p>这样，只有在https请求中才可访问该cookie。默认为<code class="code">false</code>。</p>
                            </td></tr></tbody></table><table summary="Session ID的配置说明" cellpadding="10" style="border: none;"><colgroup><col width="31%" class="c1"/><col width="69%" class="c2"/></colgroup><thead><tr><th style="border-bottom: 0.5pt solid #6666cc; " colspan="2">配置<code class="code">&lt;session&gt;&lt;id&gt;&lt;url-encode&gt;</code> —— 将Session
                                ID编码到URL的设置</th></tr></thead><tbody valign="middle"><tr><td style="border-right: 0.5pt solid #6666cc; " valign="middle"><code class="code">name</code></td><td style="" valign="middle">
                                <p>指定在URL中表示session ID的名字，默认也是<code class="code">JSESSIONID</code>。</p>
                                <p>此时，如果<code class="code">urlEncodeEnabled</code>为<code class="code">true</code>的话，调用：</p>
                                <pre class="programlisting">response.encodeURL(<strong class="hl-string"><em style="color:navy">"http://localhost:8080/test.jsp?id=1"</em></strong>)</pre>
                                <p>将得到类似这样的结果：</p>
                                <p>
                                    </p><pre class="screen">http://localhost:8080/test.jsp;JSESSIONID=xxxyyyzzz?id=1</pre><p>
                                </p>
                            </td></tr></tbody></table><table summary="Session ID的配置说明" cellpadding="10" style="border: none;"><colgroup><col width="31%" class="c1"/><col width="69%" class="c2"/></colgroup><thead><tr><th style="border-bottom: 0.5pt solid #6666cc; " colspan="2">配置<code class="code">&lt;session&gt;&lt;id&gt;&lt;session-idgens:*&gt;</code> ——
                                如何生成session ID？</th></tr></thead><tbody valign="middle"><tr><td style="border-right: 0.5pt solid #6666cc; " valign="middle"><code class="code">uuid-generator</code></td><td style="" valign="middle">
                                <p>以UUID作为新session ID的生成算法。</p>
                                <p>这是默认的session ID生成算法。</p>
                            </td></tr></tbody></table></div></div><p>为了达到最大的兼容性，我们分两种情况来处理<code class="code">JSESSIONID</code>：</p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><p>当一个新session到达时，假如cookie或URL中已然包含了<code class="code">JSESSIONID</code>，那么我们将直接利用这个值。为什么这样做呢？因为这个<code class="code">JSESSIONID</code>可能是由同一域名下的另一个不相关应用生成的。如果我们不由分说地将这个cookie覆盖掉，那么另一个应用的session就会丢失。</p></li><li class="listitem"><p>多数情况下，对于一个新session，应该是不包含<code class="code">JSESSIONID</code>的。这时，我们需要利用<code class="code">SessionIDGenerator</code>来生成一个唯一的字符串，作为<code class="code">JSESSIONID</code>的值。<code class="code">SessionIDGenerator</code>的默认实现<code class="code">UUIDGenerator</code>。
                        </p></li></ol></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="d0e9520"><!--anchor d0e9520--></a>8.2.3. Session的生命期</h3></div></div></div><p>所谓生命期，就是session从创建到失效的整个过程。其状态变迁如下图所示：</p><div class="figure"><a id="d0e9525"><!--anchor d0e9525--></a><div class="figure-contents"><div class="mediaobject"><img src="images/session/session-lifecycle.png" alt="Session生命期"/></div></div><p class="title"><strong>图 8.1. Session生命期</strong></p></div><p>总结一下，其实很简单：</p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><p>第一次打开浏览器时，<code class="code">JSESSIONID</code>还不存在，或者存在由同一域名下的其它应用所设置的无效的<code class="code">JSESSIONID</code>。这种情况下，<code class="code">session.isNew()</code>返回<code class="code">true</code>。</p></li><li class="listitem"><p>随后，只要在规定的时间间隔内，以及cookie过期之前，每一次访问系统，都会使session得到更新。此时<code class="code">session.isNew()</code>总是返回<code class="code">false</code>。Session中的数据得到保持。</p></li><li class="listitem"><p>如果用户有一段时间不访问系统了，超过指定的时间，那么系统会清除所有的session内容，并将session看作是新的session。</p></li><li class="listitem"><p>用户可以调用<code class="code">session.invalidate()</code>方法，直接清除所有的session内容。此后所有试图<code class="code">session.getAttribute()</code>或<code class="code">session.setAttribute()</code>等操作，都会失败，得到<code class="code">IllegalStateException</code>异常，直到下一个请求到来。</p></li></ol></div><p>在session框架中，有一个重要的特殊对象，用来保存session生命期的状态。这个对象叫作session
                    model。它被当作一个普通的对象存放在session中，但是通过<code class="code">HttpSession</code>接口不能直接看到它。</p><p>关于session生命期的完整配置如下：</p><div class="example"><a id="d0e9583"><!--anchor d0e9583--></a><p class="title"><strong>例 8.4. 关于Session生命期的配置</strong></p><div class="example-contents"><pre class="programlisting"><strong class="hl-tag" style="color: #000096">&lt;session</strong> <span class="hl-attribute" style="color: #F5844C">maxInactiveInterval</span>=<span class="hl-value" style="color: #993300">"0"</span> <span class="hl-attribute" style="color: #F5844C">keepInTouch</span>=<span class="hl-value" style="color: #993300">"false"</span> <span class="hl-attribute" style="color: #F5844C">forceExpirationPeriod</span>=<span class="hl-value" style="color: #993300">"14400"</span>
         <span class="hl-attribute" style="color: #F5844C">modelKey</span>=<span class="hl-value" style="color: #993300">"SESSION_MODEL"</span><strong class="hl-tag" style="color: #000096">&gt;</strong>
    ...
<strong class="hl-tag" style="color: #000096">&lt;/session&gt;</strong></pre></div></div><p>参数的意思是：</p><div class="table"><a id="d0e9590"><!--anchor d0e9590--></a><p class="title"><strong>表 8.2. Session生命期的配置参数</strong></p><div class="table-contents"><table summary="Session生命期的配置参数" cellpadding="10" style="border: none;"><colgroup><col width="29%" class="c1"/><col width="71%" class="c2"/></colgroup><thead><tr><th style="border-right: 0.5pt solid #6666cc; border-bottom: 0.5pt solid #6666cc; ">参数名</th><th style="border-bottom: 0.5pt solid #6666cc; ">说明</th></tr></thead><tbody valign="middle"><tr><td style="border-right: 0.5pt solid #6666cc; border-bottom: 0.5pt solid #6666cc; " valign="middle"><code class="code">maxInactiveInterval</code></td><td style="border-bottom: 0.5pt solid #6666cc; " valign="middle">
                                <p>指定session不活动而失效的期限，单位是秒。</p>
                                <p>默认为<code class="code">0</code>，也就是永不失效（除非cookie失效）。例如，设置<code class="code">3600</code>秒，表示用户离开浏览器1小时以后再回来，session将重新开始，老数据将被丢弃。</p>
                            </td></tr><tr><td style="border-right: 0.5pt solid #6666cc; border-bottom: 0.5pt solid #6666cc; " valign="middle"><code class="code">keepInTouch</code></td><td style="border-bottom: 0.5pt solid #6666cc; " valign="middle">
                                <p>是否每次都touch session（即更新最近访问时间）。</p>
                                <p>如果是<code class="code">false</code>，那么只在session值有改变时touch。当将session
                                        model保存在cookie中时，设为<code class="code">false</code>可以减少网络流量。但如果session值长期不改变，由于最近访问时间一直无法更新，将会使session超过<code class="code">maxInactiveInterval</code>所设定的秒数而失效。</p>
                                <p>默认为<code class="code">false</code>。</p>
                            </td></tr><tr><td style="border-right: 0.5pt solid #6666cc; border-bottom: 0.5pt solid #6666cc; " valign="middle"><code class="code">forceExpirationPeriod</code></td><td style="border-bottom: 0.5pt solid #6666cc; " valign="middle">
                                <p>指定session强制作废期限，单位是秒。</p>
                                <p>无论用户活动与否，从session创建之时算起，超过这个期限，session将被强制作废。这是一个安全选项：万一cookie被盗，过了这个期限的话，那么无论如何，被盗的cookie就没有用了。</p>
                                <p>默认为<code class="code">0</code>，表示无期限。 </p>
                            </td></tr><tr><td style="border-right: 0.5pt solid #6666cc; " valign="middle"><code class="code">modelKey</code></td><td style="" valign="middle">
                                <p>指定用于保存session状态的对象的名称。</p>
                                <p>默认为"<code class="code">SESSION_MODEL</code>"。一般没必要修改这个值。 </p>
                            </td></tr></tbody></table></div></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="d0e9681"><!--anchor d0e9681--></a>8.2.4. Session Store</h3></div></div></div><p>Session Store是session框架中最核心的部分。Session框架最强大的部分就在于此。我们可以定义很多个session
                stores，让不同的session对象分别存放到不同的Session
                Store中。前面提到有一个特殊的对象“<code class="code">SESSION_MODEL</code>”也必须保存在一个session store中。</p><div class="figure"><a id="d0e9689"><!--anchor d0e9689--></a><div class="figure-contents"><div class="mediaobject"><img src="images/session/session-stores.png" alt="Session和Stores"/></div></div><p class="title"><strong>图 8.2. Session和Stores</strong></p></div><p>类似于Servlet的配置，Session store的配置也包含两部分内容：session store的定义，和session
                store的映射（mapping）。</p><div class="example"><a id="d0e9697"><!--anchor d0e9697--></a><p class="title"><strong>例 8.5. Session Store的配置</strong></p><div class="example-contents"><pre class="programlisting">    <strong class="hl-tag" style="color: #000096">&lt;session&gt;</strong>
        <strong class="hl-tag" style="color: #000096">&lt;stores&gt;</strong>
            <strong class="hl-tag" style="color: #000096">&lt;session-stores:store</strong> <span class="hl-attribute" style="color: #F5844C">id</span>=<span class="hl-value" style="color: #993300">"store1"</span><strong class="hl-tag" style="color: #000096"> /&gt;</strong> <a id="co.session.stores.store1"><!--anchor co.session.stores.store1--></a><span class="calloutno"><img src="images/callouts/1.png" border="0"/></span>
            <strong class="hl-tag" style="color: #000096">&lt;session-stores:store</strong> <span class="hl-attribute" style="color: #F5844C">id</span>=<span class="hl-value" style="color: #993300">"store2"</span><strong class="hl-tag" style="color: #000096"> /&gt;</strong> <a id="co.session.stores.store2"><!--anchor co.session.stores.store2--></a><span class="calloutno"><img src="images/callouts/2.png" border="0"/></span>
            <strong class="hl-tag" style="color: #000096">&lt;session-stores:store</strong> <span class="hl-attribute" style="color: #F5844C">id</span>=<span class="hl-value" style="color: #993300">"store3"</span><strong class="hl-tag" style="color: #000096"> /&gt;</strong> <a id="co.session.stores.store3"><!--anchor co.session.stores.store3--></a><span class="calloutno"><img src="images/callouts/3.png" border="0"/></span>
        <strong class="hl-tag" style="color: #000096">&lt;/stores&gt;</strong>
        <strong class="hl-tag" style="color: #000096">&lt;store-mappings&gt;</strong>
            <strong class="hl-tag" style="color: #000096">&lt;match</strong> <span class="hl-attribute" style="color: #F5844C">name</span>=<span class="hl-value" style="color: #993300">"*"</span> <span class="hl-attribute" style="color: #F5844C">store</span>=<span class="hl-value" style="color: #993300">"store1"</span><strong class="hl-tag" style="color: #000096"> /&gt;</strong> <a id="co.session.stores.store1.mapping"><!--anchor co.session.stores.store1.mapping--></a><span class="calloutno"><img src="images/callouts/4.png" border="0"/></span>
            <strong class="hl-tag" style="color: #000096">&lt;match</strong> <span class="hl-attribute" style="color: #F5844C">name</span>=<span class="hl-value" style="color: #993300">"loginName"</span> <span class="hl-attribute" style="color: #F5844C">store</span>=<span class="hl-value" style="color: #993300">"store2"</span><strong class="hl-tag" style="color: #000096"> /&gt;</strong> <a id="co.session.stores.store2.mapping"><!--anchor co.session.stores.store2.mapping--></a><span class="calloutno"><img src="images/callouts/5.png" border="0"/></span>
            <strong class="hl-tag" style="color: #000096">&lt;matchRegex</strong> <span class="hl-attribute" style="color: #F5844C">pattern</span>=<span class="hl-value" style="color: #993300">"key.*"</span> <span class="hl-attribute" style="color: #F5844C">store</span>=<span class="hl-value" style="color: #993300">"store3"</span><strong class="hl-tag" style="color: #000096"> /&gt;</strong> <a id="co.session.stores.store3.mapping"><!--anchor co.session.stores.store3.mapping--></a><span class="calloutno"><img src="images/callouts/6.png" border="0"/></span>
        <strong class="hl-tag" style="color: #000096">&lt;/store-mappings&gt;</strong>
    <strong class="hl-tag" style="color: #000096">&lt;/session&gt;</strong></pre><div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#co.session.stores.store1"><span class="calloutno"><img src="images/callouts/1.png" border="0"/></span></a> <a href="#co.session.stores.store2"><span class="calloutno"><img src="images/callouts/2.png" border="0"/></span></a> <a href="#co.session.stores.store3"><span class="calloutno"><img src="images/callouts/3.png" border="0"/></span></a> </p></td><td valign="top" align="left"><p>定义session stores：你可以配置任意多个session
                                store，只要ID不重复。此处，<code class="code">store1</code>、<code class="code">store2</code>和<code class="code">store3</code>分别是三个session
                            store的名称。</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#co.session.stores.store1.mapping"><span class="calloutno"><img src="images/callouts/4.png" border="0"/></span></a> <a href="#co.session.stores.store2.mapping"><span class="calloutno"><img src="images/callouts/5.png" border="0"/></span></a> </p></td><td valign="top" align="left"><p>映射session stores：<code class="code">match</code>标签用来精确匹配attribute
                                name。一个特别的值是“<code class="code">*</code>”，它代表默认匹配所有的names。</p><p>本例中， 如果调用<code class="code">session.setAttribute("loginName",
                                user.getId())</code>，那么这个值将被保存到<code class="code">store2</code>里；如果调用<code class="code">session.setAttribute("other",
                                value)</code>将被默认匹配到<code class="code">store1</code>中。</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#co.session.stores.store3.mapping"><span class="calloutno"><img src="images/callouts/6.png" border="0"/></span></a> </p></td><td valign="top" align="left"><p>映射session stores：<code class="code">matchRegexp</code>标签用正则表达式来匹配attribute
                            names。</p><p>本例中，
                            <code class="code">key_a</code>、<code class="code">key_b</code>等值都将被保存到<code class="code">store3</code>里。</p></td></tr></table></div></div></div><p>需要注意以下几点：</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p><span class="emphasis"><em>在整个session配置中，只能有一个store拥有默认的匹配</em></span>。</p></li><li class="listitem"><p>假如有多个<code class="code">match</code>或<code class="code">matchRegex</code>同时匹配某个attribute name，那么遵循以下匹配顺序：</p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><p><span class="emphasis"><em>精确的匹配</em></span>最优先。</p></li><li class="listitem"><p>正则表达式的匹配遵循最大匹配的原则，假如有两个以上的正则表达式被同时匹配，<span class="emphasis"><em>长度较长的匹配</em></span>胜出。</p></li><li class="listitem"><p><span class="emphasis"><em>默认匹配<code class="code">*</code></em></span>总是在所有的匹配都失败以后才会被激活。
                                    </p></li></ol></div></li><li class="listitem"><p>必须有一个session store能够用来存放session model。</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem"><p>你可以用<code class="code">&lt;match name="*"&gt;</code>来匹配session
                                        model；</p></li><li class="listitem"><p>也可以用精确匹配：<code class="code">&lt;match name="SESSION_MODEL"
                                        /&gt;</code>。其中session
                                            model的名字是必须和前述modelKey配置的值相同，其默认值为“<code class="code">SESSION_MODEL</code>”。
                                    </p></li></ul></div></li></ul></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="d0e9822"><!--anchor d0e9822--></a>8.2.5. Session Model</h3></div></div></div><p>Session Model是用来记录当前session的生命期数据的，例如：session的创建时间、最近更新时间等。默认情况下，</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>当需要保存session数据时，<code class="code">SessionModel</code>对象将被转换成一个JSON字符串（如下所示），然后这个字符串将被保存在某个session
                            store中：</p><pre class="screen">{id:<strong class="hl-string"><em style="color:navy">"SESSION_ID"</em></strong>,ct:创建时间,ac:最近访问时间,mx:最长不活动时间}</pre></li><li class="listitem"><p>需要读取时，先从store中读到上述格式的字符串数据，然后再把它解码成真正的<code class="code">SessionModel</code>对象。</p></li></ul></div><p>以上转换过程是通过一个<code class="code">SessionModelEncoder</code>接口来实现的。为了提供更好的移植性，Session框架可同时支持多个<code class="code">SessionModelEncoder</code>的实现。配置如下：</p><div class="example"><a id="d0e9850"><!--anchor d0e9850--></a><p class="title"><strong>例 8.6. Session Model编码器的配置</strong></p><div class="example-contents"><pre class="programlisting"><strong class="hl-tag" style="color: #000096">&lt;session&gt;</strong>
    <strong class="hl-tag" style="color: #000096">&lt;session-model-encoders&gt;</strong>
        <strong class="hl-tag" style="color: #000096">&lt;model-encoders:default-session-model-encoder /&gt;</strong>
        <strong class="hl-tag" style="color: #000096">&lt;model-encoders:model-encoder</strong> <span class="hl-attribute" style="color: #F5844C">class</span>=<span class="hl-value" style="color: #993300">"..."</span><strong class="hl-tag" style="color: #000096"> /&gt;</strong>
        <strong class="hl-tag" style="color: #000096">&lt;model-encoders:model-encoder</strong> <span class="hl-attribute" style="color: #F5844C">class</span>=<span class="hl-value" style="color: #993300">"..."</span><strong class="hl-tag" style="color: #000096"> /&gt;</strong>
    <strong class="hl-tag" style="color: #000096">&lt;/session-model-encoders&gt;</strong>
<strong class="hl-tag" style="color: #000096">&lt;/session&gt;</strong></pre></div></div><p>在上面的例子中，提供了三个<code class="code">SessionModelEncoder</code>的实现。第一个是默认的实现，第二、第三个是任意实现。</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>当从store取得<code class="code">SessionModel</code>对象时，框架将依次尝试所有的encoder，直到解码成功为止。</p></li><li class="listitem"><p>当将<code class="code">SessionModel</code>对象保存到store之前，框架将使用第一个encoder来编码对象。</p></li></ul></div><p>当你从不同的<code class="code">SessionModel</code>编码方案中移植的时候，上述多encoders共存的方案可以实现平滑的过渡。</p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="d0e9878"><!--anchor d0e9878--></a>8.2.6. Session Interceptor</h3></div></div></div><p>Session Interceptor拦截器的作用是拦截特定的事件，甚至干预该事件的执行结果。目前有两种拦截器接口：</p><div class="table"><a id="d0e9883"><!--anchor d0e9883--></a><p class="title"><strong>表 8.3. Session Interceptor拦截器接口</strong></p><div class="table-contents"><table summary="Session Interceptor拦截器接口" cellpadding="10" style="border: none;"><colgroup><col width="35%" class="c1"/><col width="65%" class="c2"/></colgroup><thead><tr><th style="border-right: 0.5pt solid #6666cc; border-bottom: 0.5pt solid #6666cc; ">接口</th><th style="border-bottom: 0.5pt solid #6666cc; ">功能</th></tr></thead><tbody valign="middle"><tr><td style="border-right: 0.5pt solid #6666cc; border-bottom: 0.5pt solid #6666cc; " valign="middle"><code class="code">SessionLifecycleListener</code></td><td style="border-bottom: 0.5pt solid #6666cc; " valign="middle">
                                <p>监听以下session生命期事件：</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>Session被创建</p></li><li class="listitem"><p>Session被访问</p></li><li class="listitem"><p>Session被作废 </p></li></ul></div>
                            </td></tr><tr><td style="border-right: 0.5pt solid #6666cc; " valign="middle"><code class="code">SessionAttributeInterceptor</code></td><td style="" valign="middle">
                                <p>拦截以下session读写事件：</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p><code class="code">onRead</code> –
                                                  拦截<code class="code">session.getAttribute()</code>方法，可以修改所读取的数据。</p></li><li class="listitem"><p><code class="code">onWrite</code> –
                                                  拦截<code class="code">session.setAttribute()</code>方法，可以修改所写到store中的数据。
                                            </p></li></ul></div>
                            </td></tr></tbody></table></div></div><p>Session框架自身已经提供了两个有用的拦截器：</p><div class="table"><a id="d0e9943"><!--anchor d0e9943--></a><p class="title"><strong>表 8.4. Session Interceptor的实现</strong></p><div class="table-contents"><table summary="Session Interceptor的实现" cellpadding="10" style="border: none;"><colgroup><col width="35%" class="c1"/><col width="65%" class="c2"/></colgroup><thead><tr><th style="border-right: 0.5pt solid #6666cc; border-bottom: 0.5pt solid #6666cc; ">名称</th><th style="border-bottom: 0.5pt solid #6666cc; ">说明</th></tr></thead><tbody valign="middle"><tr><td style="border-right: 0.5pt solid #6666cc; border-bottom: 0.5pt solid #6666cc; " valign="middle"><code class="code">&lt;lifecycle-logger&gt;</code></td><td style="border-bottom: 0.5pt solid #6666cc; " valign="middle">
                                <p>监听session生命期事件，并记录日志。</p>
                            </td></tr><tr><td style="border-right: 0.5pt solid #6666cc; " valign="middle"><code class="code">&lt;attribute-whitelist&gt;</code></td><td style="" valign="middle">
                                <p>控制session中的attributes，只允许白名单中所定义的attribute名称和类型被写入到或读出于session
                                    store中。</p>
                                <p>这个功能对于cookie
                                    store是很有用的。因为cookie有长度的限制，所以需要用白名单来限制写入到cookie中的数据数量和类型。 </p>
                            </td></tr></tbody></table></div></div><p>你可以同时配置多种拦截器，如下所示。</p><div class="example"><a id="d0e9979"><!--anchor d0e9979--></a><p class="title"><strong>例 8.7. 配置session interceptors</strong></p><div class="example-contents"><pre class="programlisting"><strong class="hl-tag" style="color: #000096">&lt;session&gt;</strong>
  <strong class="hl-tag" style="color: #000096">&lt;request-contexts:interceptors</strong>
        <span class="hl-attribute" style="color: #F5844C">xmlns</span>=<span class="hl-value" style="color: #993300">"http://www.alibaba.com/schema/services/request-contexts/session/interceptors"</span><strong class="hl-tag" style="color: #000096">&gt;</strong>

    <strong class="hl-tag" style="color: #000096">&lt;lifecycle-logger /&gt;</strong>

    <strong class="hl-tag" style="color: #000096">&lt;attribute-whitelist&gt;</strong>
      <strong class="hl-tag" style="color: #000096">&lt;attribute</strong> <span class="hl-attribute" style="color: #F5844C">name</span>=<span class="hl-value" style="color: #993300">"_csrf_token"</span><strong class="hl-tag" style="color: #000096"> /&gt;</strong>
      <strong class="hl-tag" style="color: #000096">&lt;attribute</strong> <span class="hl-attribute" style="color: #F5844C">name</span>=<span class="hl-value" style="color: #993300">"_lang"</span><strong class="hl-tag" style="color: #000096"> /&gt;</strong>
      <strong class="hl-tag" style="color: #000096">&lt;attribute</strong> <span class="hl-attribute" style="color: #F5844C">name</span>=<span class="hl-value" style="color: #993300">"loginUser"</span> <span class="hl-attribute" style="color: #F5844C">type</span>=<span class="hl-value" style="color: #993300">"com.alibaba...MyUser"</span><strong class="hl-tag" style="color: #000096"> /&gt;</strong>
      <strong class="hl-tag" style="color: #000096">&lt;attribute</strong> <span class="hl-attribute" style="color: #F5844C">name</span>=<span class="hl-value" style="color: #993300">"shoppingCart"</span> <span class="hl-attribute" style="color: #F5844C">type</span>=<span class="hl-value" style="color: #993300">"com.alibaba....ShoppingCart"</span><strong class="hl-tag" style="color: #000096"> /&gt;</strong>
    <strong class="hl-tag" style="color: #000096">&lt;/attribute-whitelist&gt;</strong>

    <strong class="hl-tag" style="color: #000096">&lt;interceptor</strong> <span class="hl-attribute" style="color: #F5844C">class</span>=<span class="hl-value" style="color: #993300">"..."</span><strong class="hl-tag" style="color: #000096"> /&gt;</strong>

  <strong class="hl-tag" style="color: #000096">&lt;/request-contexts:interceptors&gt;</strong>
<strong class="hl-tag" style="color: #000096">&lt;/session&gt;</strong></pre></div></div></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="d0e9984"><!--anchor d0e9984--></a>8.3. Cookie Store</h2></div></div></div><p>Cookie Store的作用，是将session对象保存在客户端cookie中。Cookie
            Store减轻了服务器维护session数据的压力，从而提高了应用的扩展性和可用性。</p><p>另一方面，在现实应用中，很多地方都会直接读写cookie。读写cookie是一件麻烦的事，因为你必须要设置很多参数：<code class="code">domain</code>、<code class="code">path</code>、<code class="code">httpOnly</code>...等很多参数。而操作<code class="code">HttpSession</code>是一件相对简单的事。因此，<span class="emphasis"><em>webx主张把一切对cookie的读写，都转换成对session的读写</em></span>。</p><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="d0e10006"><!--anchor d0e10006--></a>8.3.1. 多值Cookie Store</h3></div></div></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="d0e10009"><!--anchor d0e10009--></a>8.3.1.1. 最简配置</h4></div></div></div><div class="example"><a id="d0e10012"><!--anchor d0e10012--></a><p class="title"><strong>例 8.8. 最基本的cookie配置（<code class="filename">/WEB-INF/webx.xml</code>）</strong></p><div class="example-contents"><pre class="programlisting"><strong class="hl-tag" style="color: #000096">&lt;services:request-contexts</strong> <span class="hl-attribute" style="color: #F5844C">xmlns</span>=<span class="hl-value" style="color: #993300">"http://www.alibaba.com/schema/services/request-contexts"</span><strong class="hl-tag" style="color: #000096">&gt;</strong>
    <strong class="hl-tag" style="color: #000096">&lt;buffered /&gt;</strong> <a id="co.session.dep.buffered"><!--anchor co.session.dep.buffered--></a><span class="calloutno"><img src="images/callouts/1.png" border="0"/></span>
    <strong class="hl-tag" style="color: #000096">&lt;lazy-commit /&gt;</strong> <a id="co.session.dep.lazycommit"><!--anchor co.session.dep.lazycommit--></a><span class="calloutno"><img src="images/callouts/2.png" border="0"/></span>
    ...
    <strong class="hl-tag" style="color: #000096">&lt;session&gt;</strong>
        <strong class="hl-tag" style="color: #000096">&lt;stores&gt;</strong>
            <strong class="hl-tag" style="color: #000096">&lt;session-stores:cookie-store</strong> <span class="hl-attribute" style="color: #F5844C">id</span>=<span class="hl-value" style="color: #993300">"temporaryClientStore"</span><strong class="hl-tag" style="color: #000096">&gt;</strong>
                <strong class="hl-tag" style="color: #000096">&lt;session-stores:cookie</strong> <span class="hl-attribute" style="color: #F5844C">name</span>=<span class="hl-value" style="color: #993300">"tmp"</span><strong class="hl-tag" style="color: #000096"> /&gt;</strong>
            <strong class="hl-tag" style="color: #000096">&lt;/session-stores:cookie-store&gt;</strong>
        <strong class="hl-tag" style="color: #000096">&lt;/stores&gt;</strong>
        <strong class="hl-tag" style="color: #000096">&lt;store-mappings&gt;</strong>
            <strong class="hl-tag" style="color: #000096">&lt;match</strong> <span class="hl-attribute" style="color: #F5844C">name</span>=<span class="hl-value" style="color: #993300">"*"</span> <span class="hl-attribute" style="color: #F5844C">store</span>=<span class="hl-value" style="color: #993300">"temporaryClientStore"</span><strong class="hl-tag" style="color: #000096"> /&gt;</strong>
        <strong class="hl-tag" style="color: #000096">&lt;/store-mappings&gt;</strong>
    <strong class="hl-tag" style="color: #000096">&lt;/session&gt;</strong>
<strong class="hl-tag" style="color: #000096">&lt;/services:request-contexts&gt;</strong></pre></div></div><p>上面的配置创建了一个“临时”cookie（即随着浏览器关闭而清除），来作为默认的session对象的存储。</p><p><span class="emphasis"><em>Cookie Store依赖其它两个Request Contexts：<a id="co.session.dep.buffered"><!--anchor co.session.dep.buffered--></a><span class="calloutno"><img src="images/callouts/1.png" border="0"/></span>
                        <code class="code">&lt;buffered&gt;</code> 和 <a id="co.session.dep.lazycommit"><!--anchor co.session.dep.lazycommit--></a><span class="calloutno"><img src="images/callouts/2.png" border="0"/></span>
                        <code class="code">&lt;lazy-commit&gt;</code></em></span>。没有它们，就不能实现基于cookie的session。为什么呢？这要从HTTP协议谈起。下面是一个标准的HTTP响应的文本。无论你的服务器使用了何种平台（Apache
                    HTTPD Server、Java Servlet/JSP、Microsoft
                    IIS，……），只要你通过浏览器来访问，必须返回类似下面的HTTP响应：</p><pre class="screen">HTTP/1.1 200 OK
Server: Apache-Coyote/1.1
Set-Cookie: JSESSIONID=AywiPrQKPEzfF9OZ; Path=/
Content-Type: text/html;charset=GBK
Content-Language: zh-CN
Content-Length: 48
Date: Mon, 06 Nov 2006 07:59:38 GMT


&lt;html&gt;
&lt;body&gt;
……</pre><p>我们注意到，HTTP响应分为Header和Content两部分。从“<code class="code">HTTP/1.1 200
                        OK</code>”开始，到“<code class="code">&lt;html&gt;</code>”之前，都是HTTP
                    <span class="emphasis"><em>Header</em></span>，后面则为HTTP
                    <span class="emphasis"><em>Content</em></span>。而cookie是在header中指定的。一但应用服务器开始向浏览器输出content，那就再也没有机会修改header了。问题就出在这里。作为session的cookie可以在应用程序的任何时间被修改，甚至可能在content开始输出之后被修改。但是此后修改的session将不能被保存到cookie中。</p><p>Java Servlet
                        API的术语称“应用服务器开始输出content”为“response被提交”。你可以通过<code class="code">response.isCommitted()</code>方法来判断这一点。那么，哪些操作会导致response被提交呢？</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>向<code class="code">response.getWriter()</code>或<code class="code">getOutputStream()</code>所返回的流中输出，累计达到服务器所设定的一个chunk的大小，通常为<code class="code">8K</code>。</p></li><li class="listitem"><p>用户程序或系统调用<code class="code">response.flushBuffer()</code>。</p></li><li class="listitem"><p>用户程序或系统调用<code class="code">response.sendError()</code>转到错误页面。</p></li><li class="listitem"><p>用户程序或系统调用<code class="code">response.sendRedirect()</code>重定向。 </p></li></ul></div><p>只要避免上述情形的出现，就可以确保cookie可以被随时写入。前两个Request Contexts ——
                        <code class="code">&lt;buffered&gt;</code>和<code class="code">&lt;lazy-commit&gt;</code>正好解决了上面的问题。第一个<code class="code">&lt;buffered&gt;</code>将所有的输出到<code class="code">response.getWriter()</code>或<code class="code">getOutputStream()</code>的内容缓存在内存里，直到最后一刻才真正输出到浏览器；第二个<code class="code">&lt;lazy-commit&gt;</code>拦截了response对象中引起提交的方法，将它们延迟到最后才执行。这样就保证了在cookie被完整写入之前，response绝不会被任何因素提交。</p><p>此外，<code class="code">&lt;buffered&gt;</code>不是专为session框架而设计的。Webx的页面布局系统也依赖于这个Request
                    Context。 </p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="d0e10116"><!--anchor d0e10116--></a>8.3.1.2. Cookie的参数</h4></div></div></div><div class="example"><a id="d0e10119"><!--anchor d0e10119--></a><p class="title"><strong>例 8.9. Cookie的参数</strong></p><div class="example-contents"><pre class="programlisting"><strong class="hl-tag" style="color: #000096">&lt;session-stores:cookie-store</strong> <span class="hl-attribute" style="color: #F5844C">id</span>=<span class="hl-value" style="color: #993300">"temporaryClientStore"</span>
        <span class="hl-attribute" style="color: #F5844C">maxLength</span>=<span class="hl-value" style="color: #993300">"3896"</span> <span class="hl-attribute" style="color: #F5844C">maxCount</span>=<span class="hl-value" style="color: #993300">"5"</span> <span class="hl-attribute" style="color: #F5844C">checksum</span>=<span class="hl-value" style="color: #993300">"false"</span><strong class="hl-tag" style="color: #000096">&gt;</strong>

    <strong class="hl-tag" style="color: #000096">&lt;session-stores:cookie</strong> <span class="hl-attribute" style="color: #F5844C">name</span>=<span class="hl-value" style="color: #993300">"tmp"</span> <span class="hl-attribute" style="color: #F5844C">domain</span>=<span class="hl-value" style="color: #993300">""</span> <span class="hl-attribute" style="color: #F5844C">path</span>=<span class="hl-value" style="color: #993300">"/"</span> <span class="hl-attribute" style="color: #F5844C">maxAge</span>=<span class="hl-value" style="color: #993300">"0"</span> <span class="hl-attribute" style="color: #F5844C">httpOnly</span>=<span class="hl-value" style="color: #993300">"true"</span>
        <span class="hl-attribute" style="color: #F5844C">secure</span>=<span class="hl-value" style="color: #993300">"false"</span> <span class="hl-attribute" style="color: #F5844C">survivesInInvalidating</span>=<span class="hl-value" style="color: #993300">"false"</span><strong class="hl-tag" style="color: #000096"> /&gt;</strong>

<strong class="hl-tag" style="color: #000096">&lt;/session-stores:cookie-store&gt;</strong></pre></div></div><p>上例中列出了所有关于cookie的参数，解释如下：</p><div class="table"><a id="d0e10126"><!--anchor d0e10126--></a><p class="title"><strong>表 8.5. Cookie的参数</strong></p><div class="table-contents"><table summary="Cookie的参数" cellpadding="10" style="border: none;"><colgroup><col width="29%" class="c1"/><col width="45%" class="c2"/><col width="26%" class="c3"/></colgroup><thead><tr><th style="border-right: 0.5pt solid #6666cc; border-bottom: 0.5pt solid #6666cc; ">参数名称</th><th style="border-bottom: 0.5pt solid #6666cc; " colspan="2">说明</th></tr></thead><tbody valign="middle"><tr><td style="border-right: 0.5pt solid #6666cc; border-bottom: 0.5pt solid #6666cc; " valign="middle"><code class="code">name</code></td><td style="border-bottom: 0.5pt solid #6666cc; " colspan="2" valign="middle">
                                    <p>指定cookie的名称。</p>
                                    <p>假设名称为“<code class="code">tmp</code>”，那么将生成<code class="code">tmp0</code>、<code class="code">tmp1</code>、<code class="code">tmp2</code>等cookie。</p>
                                    <p>多个cookie stores的cookie名称不能重复。</p>
                                </td></tr><tr><td style="border-right: 0.5pt solid #6666cc; border-bottom: 0.5pt solid #6666cc; " valign="middle"><code class="code">domain</code></td><td style="border-right: 0.5pt solid #6666cc; border-bottom: 0.5pt solid #6666cc; " valign="middle">
                                    <p>指定cookie的域名。</p>
                                </td><td style="border-bottom: 0.5pt solid #6666cc; " rowspan="5" valign="middle">
                                    <p>这几个参数的默认值，均和Session ID
                                            cookie的设置相同。因此，<span class="emphasis"><em>一般不需要特别设置它们</em></span>。</p>
                                </td></tr><tr><td style="border-right: 0.5pt solid #6666cc; border-bottom: 0.5pt solid #6666cc; " valign="middle"><code class="code">path</code></td><td style="border-right: 0.5pt solid #6666cc; border-bottom: 0.5pt solid #6666cc; " valign="middle">
                                    <p>指定cookie的路径。</p>
                                </td></tr><tr><td style="border-right: 0.5pt solid #6666cc; border-bottom: 0.5pt solid #6666cc; " valign="middle"><code class="code">maxAge</code></td><td style="border-right: 0.5pt solid #6666cc; border-bottom: 0.5pt solid #6666cc; " valign="middle">
                                    <p>指定cookie的过期时间，单位是秒。</p>
                                    <p>如果值为<code class="code">0</code>，意味着cookie持续到浏览器被关闭（或称临时cookie）。</p>
                                    <p>有效值必须大于<code class="code">0</code>，否则均被认为是临时cookie。</p>
                                </td></tr><tr><td style="border-right: 0.5pt solid #6666cc; border-bottom: 0.5pt solid #6666cc; " valign="middle"><code class="code">httpOnly</code></td><td style="border-right: 0.5pt solid #6666cc; border-bottom: 0.5pt solid #6666cc; " valign="middle">
                                    <p>在cookie上设置<code class="code">HttpOnly</code>标记。</p>
                                    <p>在IE6及更新版本中，可以缓解XSS攻击的危险。</p>
                                </td></tr><tr><td style="border-right: 0.5pt solid #6666cc; border-bottom: 0.5pt solid #6666cc; " valign="middle"><code class="code">secure</code></td><td style="border-right: 0.5pt solid #6666cc; border-bottom: 0.5pt solid #6666cc; " valign="middle">
                                    <p>在cookie上设置<code class="code">Secure</code>标记。</p>
                                    <p>这样，只有在https请求中才可访问该cookie。</p>
                                </td></tr><tr><td style="border-right: 0.5pt solid #6666cc; border-bottom: 0.5pt solid #6666cc; " valign="middle"><code class="code">survivesInInvalidating</code></td><td style="border-bottom: 0.5pt solid #6666cc; " colspan="2" valign="middle">
                                    <p>这是一个特殊的设置。如果它被设置成<code class="code">true</code>，那么当session被作废（invalidate）时，这个cookie
                                        store中的对象会幸存下来，并带入下一个新的session中。</p>
                                    <p>如果这个值为<code class="code">true</code>，必须同时设置一个大于<code class="code">0</code>的<code class="code">maxAge</code>。</p>
                                    <p>这个设置有什么用呢？比如，我们希望在cookie中记录最近登录的用户名，以方便用户再次登录。可以把这个用户名记录在一个cookie
                                            store中，并设置<code class="code">survivesInInvalidating=true</code>。即使用户退出登录，或当前session过期，新的session仍然可以读到这个store中所保存的对象。
                                    </p>
                                </td></tr><tr><td style="border-right: 0.5pt solid #6666cc; border-bottom: 0.5pt solid #6666cc; " valign="middle"><code class="code">maxLength</code></td><td style="border-bottom: 0.5pt solid #6666cc; " colspan="2" valign="middle">
                                    <p>指定每个cookie的最大长度。默认为<code class="code">3896</code>，约<code class="code">3.8K</code>。</p>
                                    <p>Cookie
                                            store会把所有对象序列化到cookie中。但是cookie的长度是不能超过<code class="code">4K</code>的。如果cookie的长度超过这个设定，就把数据分发到新的cookie中去。因此每个cookie
                                        store实际可能产生好几个cookie。</p>
                                    <p>假设cookie
                                            name为<code class="code">tmp</code>，那么所生成的cookie的名称将分别为：<code class="code">tmp0</code>、<code class="code">tmp1</code>、<code class="code">tmp2</code>，以此类推。
                                    </p>
                                </td></tr><tr><td style="border-right: 0.5pt solid #6666cc; border-bottom: 0.5pt solid #6666cc; " valign="middle"><code class="code">maxCount</code></td><td style="border-bottom: 0.5pt solid #6666cc; " colspan="2" valign="middle">
                                    <p>指定cookie的最大个数。默认为<code class="code">5</code>。</p>
                                    <p>因此，实际cookie store可生成的cookie总长度为：<code class="code">maxLength *
                                            maxCount</code>。如果超过这个长度，cookie
                                            store将会在日志里面发出警告（<code class="code">WARN</code>级别），并忽略store中的所有对象。
                                    </p>
                                </td></tr><tr><td style="border-right: 0.5pt solid #6666cc; " valign="middle"><code class="code">checksum</code></td><td style="" colspan="2" valign="middle">
                                    <p>是否创建概要cookie。默认为<code class="code">false</code>。</p>
                                    <p>有时由于域名、路径等设置的问题，会导致cookie紊乱。例如：发现同名的cookie、cookie缺失等错误。这些问题很难跟踪。概要cookie就是为检查这类问题提供一个线索。如果把这个开关打开，将会产生一个概要性的cookie。假如cookie
                                            name为<code class="code">tmp</code>，那么概要cookie的名字将是<code class="code">tmpsum</code>。概要cookie会指出当前store共有几个cookie，每个cookie的前缀等内容。当cookie的总数和内容与概要cookie不符时，系统将会在日志中提出详细的警告信息（<code class="code">DEBUG</code>级别）。</p>
                                    <p>请尽量不要在生产系统中使用这个功能。 </p>
                                </td></tr></tbody></table></div></div></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="d0e10358"><!--anchor d0e10358--></a>8.3.1.3. Session Encoders</h4></div></div></div><p>Session里保存的是Java对象，而cookie中只能保存字符串。如何把Java对象转换成合法的cookie字符串（或者将字符串恢复成对象）呢？这就是Session
                    Encoder所要完成的任务。</p><div class="example"><a id="d0e10363"><!--anchor d0e10363--></a><p class="title"><strong>例 8.10. 配置Session Encoders</strong></p><div class="example-contents"><pre class="programlisting"><strong class="hl-tag" style="color: #000096">&lt;session-stores:cookie-store&gt;</strong>
    ...
    <strong class="hl-tag" style="color: #000096">&lt;session-stores:encoders&gt;</strong>
        <strong class="hl-tag" style="color: #000096">&lt;session-encoders:encoder</strong> <span class="hl-attribute" style="color: #F5844C">class</span>=<span class="hl-value" style="color: #993300">"..."</span><strong class="hl-tag" style="color: #000096"> /&gt;</strong>
        <strong class="hl-tag" style="color: #000096">&lt;session-encoders:encoder</strong> <span class="hl-attribute" style="color: #F5844C">class</span>=<span class="hl-value" style="color: #993300">"..."</span><strong class="hl-tag" style="color: #000096"> /&gt;</strong>
        <strong class="hl-tag" style="color: #000096">&lt;session-encoders:encoder</strong> <span class="hl-attribute" style="color: #F5844C">class</span>=<span class="hl-value" style="color: #993300">"..."</span><strong class="hl-tag" style="color: #000096"> /&gt;</strong>
    <strong class="hl-tag" style="color: #000096">&lt;/session-stores:encoders&gt;</strong>
<strong class="hl-tag" style="color: #000096">&lt;/session-stores:cookie-store&gt;</strong></pre></div></div><p>和<code class="code">SessionModelEncoder</code>类似，session框架也支持多个session encoders同时存在。</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>保存session数据时，session框架将使用第一个encoder来将对象转换成cookie可接受的字符串；</p></li><li class="listitem"><p>读取session数据时，session框架将依次尝试所有的encoders，直到解码成功为止。</p></li></ul></div><p>这种编码、解码方案可让使用不同session encoders的系统之间共享cookie数据，也有利于平滑迁移系统。</p><p>Session框架提供了一种encoder的实现，编码的基本过程为：序列化、加密（可选）、压缩、Base64编码、URL
                    encoding编码。</p><div class="example"><a id="d0e10384"><!--anchor d0e10384--></a><p class="title"><strong>例 8.11. 配置Session Encoders的几种方案</strong></p><div class="example-contents"><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>基本配置：用hessian算法（默认）来序列化，不加密。</p><pre class="programlisting"><strong class="hl-tag" style="color: #000096">&lt;session-stores:cookie-store&gt;</strong>
    <strong class="hl-tag" style="color: #000096">&lt;session-stores:encoders&gt;</strong>
        <strong class="hl-tag" style="color: #000096">&lt;session-encoders:serialization-encoder /&gt;</strong> <a id="co.session.encoders.default"><!--anchor co.session.encoders.default--></a><span class="calloutno"><img src="images/callouts/1.png" border="0"/></span>
    <strong class="hl-tag" style="color: #000096">&lt;/session-stores:encoders&gt;</strong>
<strong class="hl-tag" style="color: #000096">&lt;/session-stores:cookie-store&gt;</strong></pre><div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#co.session.encoders.default"><span class="calloutno"><img src="images/callouts/1.png" border="0"/></span></a> </p></td><td valign="top" align="left"><p>这是默认实现。</p></td></tr></table></div></li><li class="listitem"><p>用aes算法加密。AES算法可支持<code class="code">128</code>、<code class="code">192</code>、<code class="code">256</code>位的密钥，默认为<code class="code">keySize=128</code>。</p><pre class="programlisting"><strong class="hl-tag" style="color: #000096">&lt;session-stores:cookie-store&gt;</strong>
    <strong class="hl-tag" style="color: #000096">&lt;session-stores:encoders&gt;</strong>
        <strong class="hl-tag" style="color: #000096">&lt;session-encoders:serialization-encoder&gt;</strong>
            <strong class="hl-tag" style="color: #000096">&lt;session-serializers:hessian-serializer /&gt;</strong> <a id="co.session.encoders.hession"><!--anchor co.session.encoders.hession--></a><span class="calloutno"><img src="images/callouts/1.png" border="0"/></span>
            <strong class="hl-tag" style="color: #000096">&lt;session-encrypters:aes-encrypter</strong> <span class="hl-attribute" style="color: #F5844C">key</span>=<span class="hl-value" style="color: #993300">"0123456789abcdef"</span><strong class="hl-tag" style="color: #000096"> /&gt;</strong> <a id="co.session.encoders.aes"><!--anchor co.session.encoders.aes--></a><span class="calloutno"><img src="images/callouts/2.png" border="0"/></span>
        <strong class="hl-tag" style="color: #000096">&lt;/session-encoders:serialization-encoder&gt;</strong>
    <strong class="hl-tag" style="color: #000096">&lt;/session-stores:encoders&gt;</strong>
<strong class="hl-tag" style="color: #000096">&lt;/session-stores:cookie-store&gt;</strong></pre><div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#co.session.encoders.hession"><span class="calloutno"><img src="images/callouts/1.png" border="0"/></span></a> </p></td><td valign="top" align="left"><p>也可以明确指定hession序列化。</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#co.session.encoders.aes"><span class="calloutno"><img src="images/callouts/2.png" border="0"/></span></a> </p></td><td valign="top" align="left"><p>添加AES加密算法，并提供密钥。</p></td></tr></table></div></li><li class="listitem"><p>改用java原生的序列化算法。使用hessian算法（默认）可大幅缩短序列化的长度，但使用java原生的序列化算法，具有最好的可移植性。</p><pre class="programlisting"><strong class="hl-tag" style="color: #000096">&lt;session-stores:cookie-store&gt;</strong>
    <strong class="hl-tag" style="color: #000096">&lt;session-stores:encoders&gt;</strong>
        <strong class="hl-tag" style="color: #000096">&lt;session-encoders:serialization-encoder&gt;</strong>
            <strong class="hl-tag" style="color: #000096">&lt;session-serializers:java-serializer /&gt;</strong> <a id="co.session.encoders.java"><!--anchor co.session.encoders.java--></a><span class="calloutno"><img src="images/callouts/1.png" border="0"/></span>
        <strong class="hl-tag" style="color: #000096">&lt;/session-encoders:serialization-encoder&gt;</strong>
    <strong class="hl-tag" style="color: #000096">&lt;/session-stores:encoders&gt;</strong>
<strong class="hl-tag" style="color: #000096">&lt;/session-stores:cookie-store&gt;</strong></pre><div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#co.session.encoders.java"><span class="calloutno"><img src="images/callouts/1.png" border="0"/></span></a> </p></td><td valign="top" align="left"><p>指定java序列化。</p></td></tr></table></div></li></ul></div></div></div></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="d0e10438"><!--anchor d0e10438--></a>8.3.2. 单值Cookie Store</h3></div></div></div><p>前面所描述的cookie store，是在一组cookie（如<code class="code">tmp0</code>, <code class="code">tmp1</code>,
                ...）中保存一组attributes的名称和对象。它所创建的cookie值，只有session框架自己才能解读。</p><p>假如有一些非webx的代码想要共享保存在cookie中的session数据，例如，Java
                Script代码、其它未使用webx框架的应用，希望能读取session数据，应该怎么办呢？Session框架提供了一种相对简单的“单值cookie
                store”可用来解决这个问题。顾名思义，单值cookie store就是在一个cookie中仅保存一个值或对象。</p><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="d0e10451"><!--anchor d0e10451--></a>8.3.2.1. 最简配置</h4></div></div></div><div class="example"><a id="d0e10454"><!--anchor d0e10454--></a><p class="title"><strong>例 8.12. 单值cookie store基本配置</strong></p><div class="example-contents"><pre class="programlisting"><strong class="hl-tag" style="color: #000096">&lt;session&gt;</strong>
    <strong class="hl-tag" style="color: #000096">&lt;stores&gt;</strong>
        ...
        <strong class="hl-tag" style="color: #000096">&lt;stores:single-valued-cookie-store</strong> <span class="hl-attribute" style="color: #F5844C">id</span>=<span class="hl-value" style="color: #993300">"loginNameCookie"</span><strong class="hl-tag" style="color: #000096">&gt;</strong> <a id="co.session.singlevalued.cookie.store"><!--anchor co.session.singlevalued.cookie.store--></a><span class="calloutno"><img src="images/callouts/1.png" border="0"/></span>
            <strong class="hl-tag" style="color: #000096">&lt;stores:cookie</strong> <span class="hl-attribute" style="color: #F5844C">name</span>=<span class="hl-value" style="color: #993300">"login"</span><strong class="hl-tag" style="color: #000096"> /&gt;</strong> <a id="co.session.singlevalued.cookie"><!--anchor co.session.singlevalued.cookie--></a><span class="calloutno"><img src="images/callouts/2.png" border="0"/></span>
        <strong class="hl-tag" style="color: #000096">&lt;/stores:single-valued-cookie-store&gt;</strong>
    <strong class="hl-tag" style="color: #000096">&lt;/stores&gt;</strong>
    <strong class="hl-tag" style="color: #000096">&lt;store-mappings&gt;</strong>
        ...
        <strong class="hl-tag" style="color: #000096">&lt;match</strong> <span class="hl-attribute" style="color: #F5844C">name</span>=<span class="hl-value" style="color: #993300">"loginName"</span> <span class="hl-attribute" style="color: #F5844C">store</span>=<span class="hl-value" style="color: #993300">"loginNameCookie"</span><strong class="hl-tag" style="color: #000096"> /&gt;</strong> <a id="co.session.singlevalued.cookie.store.mapping"><!--anchor co.session.singlevalued.cookie.store.mapping--></a><span class="calloutno"><img src="images/callouts/3.png" border="0"/></span>
    <strong class="hl-tag" style="color: #000096">&lt;/store-mappings&gt;</strong>
<strong class="hl-tag" style="color: #000096">&lt;/session&gt;</strong></pre><div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#co.session.singlevalued.cookie.store"><span class="calloutno"><img src="images/callouts/1.png" border="0"/></span></a> </p></td><td valign="top" align="left"><p>单值cookie store的ID是<code class="code">loginNameCookie</code>。</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#co.session.singlevalued.cookie"><span class="calloutno"><img src="images/callouts/2.png" border="0"/></span></a> </p></td><td valign="top" align="left"><p>Cookie的名称是<code class="code">login</code>。</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#co.session.singlevalued.cookie.store.mapping"><span class="calloutno"><img src="images/callouts/3.png" border="0"/></span></a> </p></td><td valign="top" align="left"><p>Session
                                attribute的名称是<code class="code">loginName</code>，attribute名称和cookie名称不必相同。</p></td></tr></table></div></div></div><p>根据上面的配置，下面程序会生成cookie：<code class="code">login=myname</code>。</p><div class="example"><a id="d0e10489"><!--anchor d0e10489--></a><p class="title"><strong>例 8.13. 访问单值cookie的代码</strong></p><div class="example-contents"><pre class="programlisting">session.setAttribute(<strong class="hl-string"><em style="color:navy">"loginName"</em></strong>, <strong class="hl-string"><em style="color:navy">"myname"</em></strong>);</pre></div></div><p>需要注意的是，上述最简配置，只能用来存取字符串值。如果需要存取其它类型的对象，则需要配置Session Value Encoder。详见<a class="xref" href="session.html#webx.requestcontexts.session.value.encoders" title="8.3.2.3. Session Value Encoders">第 8.3.2.3 节 “Session Value Encoders”</a>。</p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="d0e10498"><!--anchor d0e10498--></a>8.3.2.2. Cookie的参数</h4></div></div></div><div class="example"><a id="d0e10501"><!--anchor d0e10501--></a><p class="title"><strong>例 8.14. 单值cookie的参数配置</strong></p><div class="example-contents"><pre class="programlisting"><strong class="hl-tag" style="color: #000096">&lt;session-stores:single-valued-cookie-store</strong> <span class="hl-attribute" style="color: #F5844C">id</span>=<span class="hl-value" style="color: #993300">"loginNameCookie"</span><strong class="hl-tag" style="color: #000096">&gt;</strong>

    <strong class="hl-tag" style="color: #000096">&lt;session-stores:cookie</strong> <span class="hl-attribute" style="color: #F5844C">name</span>=<span class="hl-value" style="color: #993300">"login"</span> <span class="hl-attribute" style="color: #F5844C">domain</span>=<span class="hl-value" style="color: #993300">""</span> <span class="hl-attribute" style="color: #F5844C">path</span>=<span class="hl-value" style="color: #993300">"/"</span> <span class="hl-attribute" style="color: #F5844C">maxAge</span>=<span class="hl-value" style="color: #993300">"0"</span> <span class="hl-attribute" style="color: #F5844C">httpOnly</span>=<span class="hl-value" style="color: #993300">"true"</span>
        <span class="hl-attribute" style="color: #F5844C">secure</span>=<span class="hl-value" style="color: #993300">"false"</span> <span class="hl-attribute" style="color: #F5844C">survivesInInvalidating</span>=<span class="hl-value" style="color: #993300">"false"</span><strong class="hl-tag" style="color: #000096"> /&gt;</strong>

<strong class="hl-tag" style="color: #000096">&lt;/session-stores:single-valued-cookie-store&gt;</strong></pre></div></div><p>单值cookie的参数设置完全类似于普通cookie store的设置。唯一的差别是，单值cookie只生成一个cookie，而普通的cookie
                    store则可能生成多个相关的cookies。</p><div class="table"><a id="d0e10508"><!--anchor d0e10508--></a><p class="title"><strong>表 8.6. Cookie的参数</strong></p><div class="table-contents"><table summary="Cookie的参数" cellpadding="10" style="border: none;"><colgroup><col width="29%" class="c1"/><col width="45%" class="c2"/><col width="26%" class="c3"/></colgroup><thead><tr><th style="border-right: 0.5pt solid #6666cc; border-bottom: 0.5pt solid #6666cc; ">参数名称</th><th style="border-bottom: 0.5pt solid #6666cc; " colspan="2">说明</th></tr></thead><tbody valign="middle"><tr><td style="border-right: 0.5pt solid #6666cc; border-bottom: 0.5pt solid #6666cc; " valign="middle"><code class="code">name</code></td><td style="border-bottom: 0.5pt solid #6666cc; " colspan="2" valign="middle">
                                    <p>指定cookie的名称。</p>
                                </td></tr><tr><td style="border-right: 0.5pt solid #6666cc; border-bottom: 0.5pt solid #6666cc; " valign="middle"><code class="code">domain</code></td><td style="border-right: 0.5pt solid #6666cc; border-bottom: 0.5pt solid #6666cc; " valign="middle">
                                    <p>指定cookie的域名。</p>
                                </td><td style="border-bottom: 0.5pt solid #6666cc; " rowspan="5" valign="middle">
                                    <p>这几个参数的默认值，均和Session ID
                                            cookie的设置相同。因此，<span class="emphasis"><em>一般不需要特别设置它们</em></span>。</p>
                                </td></tr><tr><td style="border-right: 0.5pt solid #6666cc; border-bottom: 0.5pt solid #6666cc; " valign="middle"><code class="code">path</code></td><td style="border-right: 0.5pt solid #6666cc; border-bottom: 0.5pt solid #6666cc; " valign="middle">
                                    <p>指定cookie的路径。</p>
                                </td></tr><tr><td style="border-right: 0.5pt solid #6666cc; border-bottom: 0.5pt solid #6666cc; " valign="middle"><code class="code">maxAge</code></td><td style="border-right: 0.5pt solid #6666cc; border-bottom: 0.5pt solid #6666cc; " valign="middle">
                                    <p>指定cookie的过期时间，单位是秒。</p>
                                    <p>如果值为<code class="code">0</code>，意味着cookie持续到浏览器被关闭（或称临时cookie）。</p>
                                    <p>有效值必须大于<code class="code">0</code>，否则均被认为是临时cookie。</p>
                                </td></tr><tr><td style="border-right: 0.5pt solid #6666cc; border-bottom: 0.5pt solid #6666cc; " valign="middle"><code class="code">httpOnly</code></td><td style="border-right: 0.5pt solid #6666cc; border-bottom: 0.5pt solid #6666cc; " valign="middle">
                                    <p>在cookie上设置<code class="code">HttpOnly</code>标记。</p>
                                    <p>在IE6及更新版本中，可以缓解XSS攻击的危险。</p>
                                </td></tr><tr><td style="border-right: 0.5pt solid #6666cc; border-bottom: 0.5pt solid #6666cc; " valign="middle"><code class="code">secure</code></td><td style="border-right: 0.5pt solid #6666cc; border-bottom: 0.5pt solid #6666cc; " valign="middle">
                                    <p>在cookie上设置<code class="code">Secure</code>标记。</p>
                                    <p>这样，只有在https请求中才可访问该cookie。</p>
                                </td></tr><tr><td style="border-right: 0.5pt solid #6666cc; " valign="middle"><code class="code">survivesInInvalidating</code></td><td style="" colspan="2" valign="middle">
                                    <p>这是一个特殊的设置。如果它被设置成<code class="code">true</code>，那么当session被作废（invalidate）时，这个cookie
                                        store中的对象会幸存下来，并带入下一个新的session中。</p>
                                    <p>如果这个值为<code class="code">true</code>，必须同时设置一个大于<code class="code">0</code>的<code class="code">maxAge</code>。</p>
                                    <p>这个设置有什么用呢？比如，我们希望在cookie中记录最近登录的用户名，以方便用户再次登录。可以把这个用户名记录在一个cookie
                                            store中，并设置<code class="code">survivesInInvalidating=true</code>。即使用户退出登录，或当前session过期，新的session仍然可以读到这个store中所保存的对象。
                                    </p>
                                </td></tr></tbody></table></div></div></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="webx.requestcontexts.session.value.encoders"><!--anchor webx.requestcontexts.session.value.encoders--></a>8.3.2.3. Session Value Encoders</h4></div></div></div><p>单值cookie
                    store可以保存任意的Java对象，只要这个Java对象能够被转换成字符串，以及从字符串中恢复。将Java对象转换成字符串，以及从字符串中恢复，就是Session
                    Value Encoder的任务。和前面所说的Session Encoder不同，Session Value Encoder只转换session
                    attribute的值，而Session Encoder需要转换一组session attributes的key-values。</p><div class="example"><a id="d0e10643"><!--anchor d0e10643--></a><p class="title"><strong>例 8.15. Session Value Encoders的配置</strong></p><div class="example-contents"><pre class="programlisting"><strong class="hl-tag" style="color: #000096">&lt;session-stores:single-valued-cookie-store&gt;</strong>
    ...
    <strong class="hl-tag" style="color: #000096">&lt;session-stores:encoders&gt;</strong>
        <strong class="hl-tag" style="color: #000096">&lt;session-value-encoders:encoder</strong> <span class="hl-attribute" style="color: #F5844C">class</span>=<span class="hl-value" style="color: #993300">"..."</span><strong class="hl-tag" style="color: #000096"> /&gt;</strong>
        <strong class="hl-tag" style="color: #000096">&lt;session-value-encoders:encoder</strong> <span class="hl-attribute" style="color: #F5844C">class</span>=<span class="hl-value" style="color: #993300">"..."</span><strong class="hl-tag" style="color: #000096"> /&gt;</strong>
        <strong class="hl-tag" style="color: #000096">&lt;session-value-encoders:encoder</strong> <span class="hl-attribute" style="color: #F5844C">class</span>=<span class="hl-value" style="color: #993300">"..."</span><strong class="hl-tag" style="color: #000096"> /&gt;</strong>
    <strong class="hl-tag" style="color: #000096">&lt;/session-stores:encoders&gt;</strong>
<strong class="hl-tag" style="color: #000096">&lt;/session-stores:single-valued-cookie-store&gt;</strong></pre></div></div><p>和<code class="code">SessionModelEncoder</code>以及<code class="code">SessionEncoder</code>类似，session框架也支持多个session
                    value encoders同时存在。</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>保存session数据时，session框架将使用第一个encoder来将对象转换成cookie可接受的字符串；</p></li><li class="listitem"><p>读取session数据时，session框架将依次尝试所有的encoders，直到解码成功为止。</p></li></ul></div><p>这种编码、解码方案可让使用不同session value encoders的系统之间共享cookie数据，也有利于平滑迁移系统。</p><p>目前有两种基本的session value
                        encoders实现。<code class="code">&lt;simple-value-encoder&gt;</code>和<code class="code">&lt;mapped-values-encoder&gt;</code>。下面举例说明。 </p><div class="example"><a id="d0e10673"><!--anchor d0e10673--></a><p class="title"><strong>例 8.16. 配置Session Value Encoders的几种方案</strong></p><div class="example-contents"><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>编码字符串值，以指定的charset对字符串进行URL encoding。</p><pre class="programlisting"><strong class="hl-tag" style="color: #000096">&lt;session-stores:encoders&gt;</strong>
    <strong class="hl-tag" style="color: #000096">&lt;session-value-encoders:simple-value-encoder</strong> <span class="hl-attribute" style="color: #F5844C">charset</span>=<span class="hl-value" style="color: #993300">"GBK"</span><strong class="hl-tag" style="color: #000096"> /&gt;</strong> <a id="co.session.singlevalued.cookie.store.encoders.simple"><!--anchor co.session.singlevalued.cookie.store.encoders.simple--></a><span class="calloutno"><img src="images/callouts/1.png" border="0"/></span>
<strong class="hl-tag" style="color: #000096">&lt;/session-stores:encoders&gt;</strong></pre><div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#co.session.singlevalued.cookie.store.encoders.simple"><span class="calloutno"><img src="images/callouts/1.png" border="0"/></span></a> </p></td><td valign="top" align="left"><p>如不指定<code class="code">charset</code>参数，默认charset为“<code class="code">UTF-8</code>”。</p></td></tr></table></div></li><li class="listitem"><p>编码指定类型的值，该值具有默认的<code class="code">PropertyEditor</code>，可以转换成<code class="code">String</code>，或从<code class="code">String</code>中恢复。</p><pre class="programlisting"><strong class="hl-tag" style="color: #000096">&lt;session-stores:encoders&gt;</strong>
    <strong class="hl-tag" style="color: #000096">&lt;session-value-encoders:simple-value-encoder</strong> <span class="hl-attribute" style="color: #F5844C">type</span>=<span class="hl-value" style="color: #993300">"com.alibaba...MyEnum"</span><strong class="hl-tag" style="color: #000096"> /&gt;</strong> <a id="co.session.singlevalued.cookie.store.encoders.simple.enum"><!--anchor co.session.singlevalued.cookie.store.encoders.simple.enum--></a><span class="calloutno"><img src="images/callouts/1.png" border="0"/></span>
<strong class="hl-tag" style="color: #000096">&lt;/session-stores:encoders&gt;</strong></pre><div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#co.session.singlevalued.cookie.store.encoders.simple.enum"><span class="calloutno"><img src="images/callouts/1.png" border="0"/></span></a> </p></td><td valign="top" align="left"><p>Spring直接支持将<code class="code">Enum</code>类型的值转成<code class="code">String</code>类型，或反之。</p></td></tr></table></div></li><li class="listitem"><p>编码指定类型的值，注册相应的registrar来进行类型转换。</p><pre class="programlisting"><strong class="hl-tag" style="color: #000096">&lt;session-stores:encoders&gt;</strong>
    <strong class="hl-tag" style="color: #000096">&lt;session-value-encoders:simple-value-encoder</strong> <span class="hl-attribute" style="color: #F5844C">type</span>=<span class="hl-value" style="color: #993300">"java.util.Date"</span><strong class="hl-tag" style="color: #000096">&gt;</strong>
        <strong class="hl-tag" style="color: #000096">&lt;session-value-encoders:property-editor-registrar</strong>
            <span class="hl-attribute" style="color: #F5844C">class</span>=<span class="hl-value" style="color: #993300">"com.alibaba.citrus.service.configuration.support.CustomDateRegistrar"</span>
            <span class="hl-attribute" style="color: #F5844C">p:timeZone</span>=<span class="hl-value" style="color: #993300">"GMT+8"</span> <span class="hl-attribute" style="color: #F5844C">p:format</span>=<span class="hl-value" style="color: #993300">"yyyy-MM-dd"</span><strong class="hl-tag" style="color: #000096"> /&gt;</strong> <a id="co.session.singlevalued.cookie.store.encoders.simple.registrar"><!--anchor co.session.singlevalued.cookie.store.encoders.simple.registrar--></a><span class="calloutno"><img src="images/callouts/1.png" border="0"/></span>
    <strong class="hl-tag" style="color: #000096">&lt;/session-value-encoders:simple-value-encoder&gt;</strong>
<strong class="hl-tag" style="color: #000096">&lt;/session-stores:encoders&gt;</strong></pre><div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#co.session.singlevalued.cookie.store.encoders.simple.registrar"><span class="calloutno"><img src="images/callouts/1.png" border="0"/></span></a> </p></td><td valign="top" align="left"><p>注册registrar，将<code class="code">Date</code>类型按格式<code class="code">yyyy-MM-dd</code>转成字符串，或从该格式的字符串中恢复。</p></td></tr></table></div></li><li class="listitem"><p>在上面例子的基础上，可增加encrypter，对value进行加密。</p><pre class="programlisting"><strong class="hl-tag" style="color: #000096">&lt;session-stores:encoders&gt;</strong>
    <strong class="hl-tag" style="color: #000096">&lt;session-value-encoders:simple-value-encoder</strong> <span class="hl-attribute" style="color: #F5844C">type</span>=<span class="hl-value" style="color: #993300">"java.util.Date"</span><strong class="hl-tag" style="color: #000096">&gt;</strong>
        <strong class="hl-tag" style="color: #000096">&lt;session-value-encoders:property-editor-registrar</strong>
            <span class="hl-attribute" style="color: #F5844C">class</span>=<span class="hl-value" style="color: #993300">"com.alibaba.citrus.service.configuration.support.CustomDateRegistrar"</span>
            <span class="hl-attribute" style="color: #F5844C">p:timeZone</span>=<span class="hl-value" style="color: #993300">"GMT+8"</span> <span class="hl-attribute" style="color: #F5844C">p:format</span>=<span class="hl-value" style="color: #993300">"yyyy-MM-dd"</span><strong class="hl-tag" style="color: #000096"> /&gt;</strong>

        <strong class="hl-tag" style="color: #000096">&lt;session-encrypters:aes-encrypter</strong> <span class="hl-attribute" style="color: #F5844C">key</span>=<span class="hl-value" style="color: #993300">"0123456789abcdef"</span><strong class="hl-tag" style="color: #000096"> /&gt;</strong> <a id="co.session.singlevalued.cookie.store.encoders.simple.aes"><!--anchor co.session.singlevalued.cookie.store.encoders.simple.aes--></a><span class="calloutno"><img src="images/callouts/1.png" border="0"/></span>

    <strong class="hl-tag" style="color: #000096">&lt;/session-value-encoders:simple-value-encoder&gt;</strong>
<strong class="hl-tag" style="color: #000096">&lt;/session-stores:encoders&gt;</strong></pre><div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#co.session.singlevalued.cookie.store.encoders.simple.aes"><span class="calloutno"><img src="images/callouts/1.png" border="0"/></span></a> </p></td><td valign="top" align="left"><p>用AES和指定密钥进行加密。</p></td></tr></table></div></li><li class="listitem"><p><code class="code">&lt;mapped-values-encoder&gt;</code>和<code class="code">&lt;simple-value-encoder&gt;</code>类似，差别在于，前者只接受<code class="code">java.util.Map</code>数据类型，并将其编码成“<code class="code">key:value&amp;key:value</code>”的格式。下面的例子可接受<code class="code">Map&lt;String,
                                    Date&gt;</code>类型的数据：</p><pre class="programlisting"><strong class="hl-tag" style="color: #000096">&lt;session-stores:encoders&gt;</strong>
    <strong class="hl-tag" style="color: #000096">&lt;session-value-encoders:mapped-values-encoder</strong> <span class="hl-attribute" style="color: #F5844C">valueType</span>=<span class="hl-value" style="color: #993300">"com.alibaba...MyEnum"</span><strong class="hl-tag" style="color: #000096"> /&gt;</strong> <a id="co.session.singlevalued.cookie.store.encoders.mapped"><!--anchor co.session.singlevalued.cookie.store.encoders.mapped--></a><span class="calloutno"><img src="images/callouts/1.png" border="0"/></span>
<strong class="hl-tag" style="color: #000096">&lt;/session-stores:encoders&gt;</strong></pre><div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#co.session.singlevalued.cookie.store.encoders.mapped"><span class="calloutno"><img src="images/callouts/1.png" border="0"/></span></a> </p></td><td valign="top" align="left"><p>注意此处所指定的类型为map中的value的类型。</p></td></tr></table></div><p>当你用下面的代码，可设置cookie值“<code class="code">key1:value1&amp;key2:value2</code>”：</p><pre class="programlisting">Map&lt;String, MyEnum&gt; mappedValue = <strong class="hl-keyword" style="color: maroon">new</strong> HashMap&lt;String, MyEnum&gt;();

mappedValue.put(<strong class="hl-string"><em style="color:navy">"key1"</em></strong>, MyEnum.value1);
mappedValue.put(<strong class="hl-string"><em style="color:navy">"key2"</em></strong>, MyEnum.value2);

session.setAttribute(<strong class="hl-string"><em style="color:navy">"cookie"</em></strong>, mappedValue); <a id="co.session.singlevalued.cookie.store.encoders.mapped.code"><!--anchor co.session.singlevalued.cookie.store.encoders.mapped.code--></a><span class="calloutno"><img src="images/callouts/1.png" border="0"/></span></pre><div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#co.session.singlevalued.cookie.store.encoders.mapped.code"><span class="calloutno"><img src="images/callouts/1.png" border="0"/></span></a> </p></td><td valign="top" align="left"><p>将整个map作为session
                                        attribute的值，其中，map的value类型必须符合配置文件中指定的类型。</p></td></tr></table></div></li><li class="listitem"><p>类似的，你同样可以对<code class="code">&lt;mapped-values-encoder&gt;</code>指定registrar和encrypter，不再赘述。</p></li></ul></div></div></div></div></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="d0e10791"><!--anchor d0e10791--></a>8.4. 其它Session Store</h2></div></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="d0e10794"><!--anchor d0e10794--></a>8.4.1. Simple Memory Store</h3></div></div></div><p><code class="code">SimpleMemoryStore</code>是最简单的session
                store。它将所有的session对象都保存在内存里面。这种store不支持多台机器的session同步，而且也不关心内存是否被用尽。因此这种简单的store一般只应使用于测试环境。</p><div class="example"><a id="d0e10801"><!--anchor d0e10801--></a><p class="title"><strong>例 8.17. 配置simple memory store</strong></p><div class="example-contents"><pre class="programlisting"><strong class="hl-tag" style="color: #000096">&lt;stores&gt;</strong>
    <strong class="hl-tag" style="color: #000096">&lt;session-stores:simple-memory-store</strong> <span class="hl-attribute" style="color: #F5844C">id</span>=<span class="hl-value" style="color: #993300">"simple"</span><strong class="hl-tag" style="color: #000096"> /&gt;</strong>
<strong class="hl-tag" style="color: #000096">&lt;/stores&gt;</strong></pre></div></div><div class="warning" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Warning"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[警告]" src="images/warning.png"/></td><th align="left">警告</th></tr><tr><td align="left" valign="top"><p>鉴于<code class="code">simple-memory-store</code>的实现的简单性，<span class="emphasis"><em>请不要将它应用在生产环境</em></span>。</p></td></tr></table></div></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="d0e10815"><!--anchor d0e10815--></a>8.5. 本章总结</h2></div></div></div><p>Session是个难题，特别是对于要求高扩展性和高可用性的网站来说。</p><p>我们在标准的Java Servlet
            API的基础之上，实现了一套全新的session框架。在此基础上可以进一步实现多种session的技术，例如：基于cookie的session、基于数据库的session、基于Berkeley
            DB的session、基于内存的session，甚至也可以实现基于TCP-ring的session等等。最重要的是，我们能把这些技术结合起来，使每种技术的优点能够互补，缺点可以被避免。</p><p>所有这一切，对应用程序是完全透明的 —— 应用程序不用知道session是如何实现的、它们的对象被保存到哪个session store中等问题 ——
            session框架可以妥善地处理好这一切。</p></div></div><div class="navfooter"><hr/><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="requestcontexts.html">上一页</a> </td><td width="20%" align="center"><a accesskey="u" href="pt02.html">上一级</a></td><td width="40%" align="right"> <a accesskey="n" href="pt03.html">下一页</a></td></tr><tr><td width="40%" align="left" valign="top">第 7 章 Request Contexts功能指南 </td><td width="20%" align="center"><a accesskey="h" href="index.html">起始页</a></td><td width="40%" align="right" valign="top"> 部分 III. Webx应用支持服务</td></tr></table></div></body></html>