<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html
  PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"><head><title>第 11 章 Webx日志系统的配置</title><link rel="stylesheet" type="text/css" href="docbook.css"/><meta name="generator" content="DocBook XSL Stylesheets V1.77.1"/><link rel="home" href="index.html" title="Webx框架指南"/><link rel="up" href="pt04.html" title="部分 IV. Webx应用实作"/><link rel="prev" href="firstapp.html" title="第 10 章 创建第一个Webx应用"/><link rel="next" href="pt05.html" title="部分 V. 辅助工具"/><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/></head><body><div class="navheader"><table width="100%" summary="Navigation header"><tr><th colspan="3" align="center">第 11 章 Webx日志系统的配置</th></tr><tr><td width="20%" align="left"><a accesskey="p" href="firstapp.html">上一页</a> </td><th width="60%" align="center">部分 IV. Webx应用实作</th><td width="20%" align="right"> <a accesskey="n" href="pt05.html">下一页</a></td></tr></table><hr/></div><div xml:lang="zh-CN" class="chapter"><div class="titlepage"><div><div><h2 class="title"><a id="webx.logging"><!--anchor webx.logging--></a>第 11 章 Webx日志系统的配置</h2></div></div></div><div class="toc"><dl><dt><span class="section"><a href="logging.html#d0e14851">11.1. 名词解释</a></span></dt><dd><dl><dt><span class="section"><a href="logging.html#d0e14854">11.1.1. 日志系统（Logging System）</a></span></dt><dt><span class="section"><a href="logging.html#d0e14918">11.1.2. 日志框架（Logging Framework）</a></span></dt></dl></dd><dt><span class="section"><a href="logging.html#d0e14968">11.2. 在Maven中组装日志系统</a></span></dt><dd><dl><dt><span class="section"><a href="logging.html#d0e15052">11.2.1. 在Maven中配置logback作为日志系统</a></span></dt><dt><span class="section"><a href="logging.html#d0e15139">11.2.2. 在Maven中配置log4j作为日志系统</a></span></dt></dl></dd><dt><span class="section"><a href="logging.html#d0e15173">11.3. 在WEB应用中配置日志系统</a></span></dt><dd><dl><dt><span class="section"><a href="logging.html#d0e15176">11.3.1. 设置WEB应用</a></span></dt><dt><span class="section"><a href="logging.html#d0e15419">11.3.2. 定制<code class="filename">/WEB-INF/logback.xml</code>（或<code class="filename">/WEB-INF/log4j.xml</code>）</a></span></dt><dt><span class="section"><a href="logging.html#d0e15674">11.3.3. 同时初始化多个日志系统</a></span></dt></dl></dd><dt><span class="section"><a href="logging.html#d0e15736">11.4. 常见错误及解决</a></span></dt><dd><dl><dt><span class="section"><a href="logging.html#d0e15739">11.4.1. 查错技巧</a></span></dt><dt><span class="section"><a href="logging.html#d0e15806">11.4.2. 异常信息：No log system exists</a></span></dt><dt><span class="section"><a href="logging.html#d0e15832">11.4.3. 异常信息：<code class="code">NoSuchMethodError</code>:
                    <code class="code">org.slf4j.MDC.getCopyOfContextMap()</code></a></span></dt><dt><span class="section"><a href="logging.html#d0e15858">11.4.4. <code class="code">STDERR</code>输出：Class path contains multiple SLF4J bindings</a></span></dt><dt><span class="section"><a href="logging.html#d0e15885">11.4.5. 看不到日志输出</a></span></dt></dl></dd><dt><span class="section"><a href="logging.html#d0e15985">11.5. 本章总结</a></span></dt></dl></div><p>日志系统是一个应用中必备的部分，提供了查看错误信息、了解系统状态的最直接手段。</p><p>本章介绍了基于Webx框架的应用如何配置、使用日志系统的方法。 </p><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="d0e14851"><!--anchor d0e14851--></a>11.1. 名词解释</h2></div></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="d0e14854"><!--anchor d0e14854--></a>11.1.1. 日志系统（Logging System）</h3></div></div></div><div class="table"><a id="d0e14857"><!--anchor d0e14857--></a><p class="title"><strong>表 11.1. 日志系统</strong></p><div class="table-contents"><table summary="日志系统" cellpadding="10" style="border: none;"><colgroup><col width="28%" class="c1"/><col width="72%" class="c2"/></colgroup><thead><tr><th style="border-right: 0.5pt solid #6666cc; border-bottom: 0.5pt solid #6666cc; ">名称</th><th style="border-bottom: 0.5pt solid #6666cc; ">说明</th></tr></thead><tbody><tr><td style="border-right: 0.5pt solid #6666cc; border-bottom: 0.5pt solid #6666cc; ">Log4j</td><td style="border-bottom: 0.5pt solid #6666cc; ">
                                <p><a class="link" href="http://logging.apache.org/log4j/" target="_top">http://logging.apache.org/log4j/</a></p>
                                <p>较早出现的比较成功的日志系统是Log4j。</p>
                                <p>Log4j开创的日志系统模型（Logger/Appender/Level）行之有效，并一直延用至今。</p>
                            </td></tr><tr><td style="border-right: 0.5pt solid #6666cc; border-bottom: 0.5pt solid #6666cc; ">JUL（<code class="code">java.util.logging.*</code>）</td><td style="border-bottom: 0.5pt solid #6666cc; ">
                                <p><a class="link" href="http://download.oracle.com/javase/6/docs/technotes/guides/logging/overview.html" target="_top">http://download.oracle.com/javase/6/docs/technotes/guides/logging/overview.html</a></p>
                                <p>JDK1.4是第一个自带日志系统的JDK，简称（JUL）。</p>
                                <p>JUL并没有明显的优势来战胜Log4j，反而造成了标准的混乱 —— 采用不同日志系统的应用程序无法和谐共存。</p>
                            </td></tr><tr><td style="border-right: 0.5pt solid #6666cc; ">Logback</td><td style="">
                                <p><a class="link" href="http://logback.qos.ch/" target="_top">http://logback.qos.ch/</a></p>
                                <p>是较新的日志系统。</p>
                                <p>它是Log4j的作者吸取多年的经验教训以后重新做出的一套系统。它的使用更方便，功能更强，而且性能也更高。</p>
                                <p>Logback不能单独使用，必须配合日志框架SLF4J来使用。</p>
                            </td></tr></tbody></table></div></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="d0e14918"><!--anchor d0e14918--></a>11.1.2. 日志框架（Logging Framework）</h3></div></div></div><p>JUL诞生以后，为了克服多种日志系统并存所带来的混乱，就出现了“日志框架”。日志框架本身不提供记录日志的功能，它只提供了日志调用的接口。日志框架依赖于实际的日志系统如Log4j或JUL来产生真实的日志。</p><p>使用日志框架的好处是：应用的部署者可以决定使用哪一种日志系统（Log4j还是JUL），或者在多种日志系统之间切换，而不需要更改应用的代码。</p><div class="table"><a id="d0e14925"><!--anchor d0e14925--></a><p class="title"><strong>表 11.2. 日志框架</strong></p><div class="table-contents"><table summary="日志框架" cellpadding="10" style="border: none;"><colgroup><col width="28%" class="c1"/><col width="72%" class="c2"/></colgroup><thead><tr><th style="border-right: 0.5pt solid #6666cc; border-bottom: 0.5pt solid #6666cc; ">名称</th><th style="border-bottom: 0.5pt solid #6666cc; ">说明</th></tr></thead><tbody><tr><td style="border-right: 0.5pt solid #6666cc; border-bottom: 0.5pt solid #6666cc; ">JCL（Jakarta Commons Logging）</td><td style="border-bottom: 0.5pt solid #6666cc; ">
                                <p><a class="link" href="http://commons.apache.org/logging/" target="_top">http://commons.apache.org/logging/</a></p>
                                <p>这是目前最流行的一个日志框架，由Apache Jakarta社区提供。</p>
                                <p>Spring框架、许多老应用都依赖于JCL。</p>
                            </td></tr><tr><td style="border-right: 0.5pt solid #6666cc; ">SLF4J</td><td style="">
                                <p><a class="link" href="http://www.slf4j.org/" target="_top">http://www.slf4j.org/</a></p>
                                <p>这是一个最新的日志框架，由Log4j的作者推出。</p>
                                <p>SLF4J提供了新的API，特别用来配合Logback的新功能。但SLF4J同样兼容Log4j。</p>
                            </td></tr></tbody></table></div></div><p>由于Log4j原作者的感召力，SLF4J和Logback很快就流行起来。Webx的新版本也决定使用SLF4J作为其日志框架；并推荐Logback作为日志系统，但同时支持Log4J。</p></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="d0e14968"><!--anchor d0e14968--></a>11.2. 在Maven中组装日志系统</h2></div></div></div><p>要在应用中使用日志系统，必须把正确的jar包组装起来。本章假设你的应用是用maven构建的。</p><div class="figure"><a id="d0e14973"><!--anchor d0e14973--></a><div class="figure-contents"><div class="mediaobject"><img src="images/log/log-components.png" alt="日志系统的组成"/></div></div><p class="title"><strong>图 11.1. 日志系统的组成</strong></p></div><p>如图所示，</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>由于JCL-over-SLF4J和原来的JCL具有完全相同的API，因此两者是不能共存的。</p></li><li class="listitem"><p>Logback和slf4j-log4j12也不能并存，否则SLF4J会迷惑并产生不确定的结果。</p></li></ul></div><p>
        </p><p>组装完整的日志系统将涉及如下部件：</p><div class="table"><a id="d0e14991"><!--anchor d0e14991--></a><p class="title"><strong>表 11.3. 日志系统的组成</strong></p><div class="table-contents"><table summary="日志系统的组成" cellpadding="10" style="border: none;"><colgroup><col width="20%" class="c1"/><col width="20%" class="c2"/><col width="60%" class="c3"/></colgroup><thead><tr><th style="border-right: 0.5pt solid #6666cc; border-bottom: 0.5pt solid #6666cc; ">类别</th><th style="border-right: 0.5pt solid #6666cc; border-bottom: 0.5pt solid #6666cc; ">组件名称</th><th style="border-bottom: 0.5pt solid #6666cc; ">说明</th></tr></thead><tbody><tr><td style="border-right: 0.5pt solid #6666cc; border-bottom: 0.5pt solid #6666cc; " rowspan="2">日志框架</td><td style="border-right: 0.5pt solid #6666cc; border-bottom: 0.5pt solid #6666cc; ">SLF4J</td><td style="border-bottom: 0.5pt solid #6666cc; ">
                            <p>Webx框架以及所有新应用，直接依赖于SLF4J。</p>
                        </td></tr><tr><td style="border-right: 0.5pt solid #6666cc; border-bottom: 0.5pt solid #6666cc; ">JCL</td><td style="border-bottom: 0.5pt solid #6666cc; ">
                            <p>Spring框架、许多以前的老应用，都使用JCL来输出日志。</p>
                            <p>好在SLF4J提供了一个“桥接”包：JCL-over-SLF4J，它重写了JCL的API，并将所有日志输出转向SLF4J。这样就避免了两套日志框架并存的问题。</p>
                        </td></tr><tr><td style="border-right: 0.5pt solid #6666cc; " rowspan="2">日志系统</td><td style="border-right: 0.5pt solid #6666cc; border-bottom: 0.5pt solid #6666cc; ">Logback</td><td style="border-bottom: 0.5pt solid #6666cc; ">
                            <p>Webx推荐使用logback来取代log4j。</p>
                            <p>Logback可直接被SLF4J识别并使用。</p>
                        </td></tr><tr><td style="border-right: 0.5pt solid #6666cc; ">Log4j</td><td style="">
                            <p>由于客观原因，有些系统暂时不能升级到Logback。</p>
                            <p>好在SLF4J仍然支持Log4j。Log4j需要一个适配器slf4j-log4j12才能被SLF4J识别并使用。</p>
                        </td></tr></tbody></table></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="d0e15052"><!--anchor d0e15052--></a>11.2.1. 在Maven中配置logback作为日志系统</h3></div></div></div><div class="figure"><a id="d0e15055"><!--anchor d0e15055--></a><div class="figure-contents"><div class="mediaobject"><img src="images/log/logback.png" alt="以logback作为日志系统"/></div></div><p class="title"><strong>图 11.2. 以logback作为日志系统</strong></p></div><div class="example"><a id="webx.logging.logback.example.pom"><!--anchor webx.logging.logback.example.pom--></a><p class="title"><strong>例 11.1. 配置<code class="filename">pom.xml</code>以使用logback</strong></p><div class="example-contents"><pre class="programlisting"><strong class="hl-tag" style="color: #000096">&lt;dependencies&gt;</strong>
    <strong class="hl-tag" style="color: #000096">&lt;dependency&gt;</strong>
        <strong class="hl-tag" style="color: #000096">&lt;groupId&gt;</strong>org.slf4j<strong class="hl-tag" style="color: #000096">&lt;/groupId&gt;</strong>
        <strong class="hl-tag" style="color: #000096">&lt;artifactId&gt;</strong>slf4j-api<strong class="hl-tag" style="color: #000096">&lt;/artifactId&gt;</strong>
    <strong class="hl-tag" style="color: #000096">&lt;/dependency&gt;</strong>
    <strong class="hl-tag" style="color: #000096">&lt;dependency&gt;</strong>
        <strong class="hl-tag" style="color: #000096">&lt;groupId&gt;</strong>org.slf4j<strong class="hl-tag" style="color: #000096">&lt;/groupId&gt;</strong>
        <strong class="hl-tag" style="color: #000096">&lt;artifactId&gt;</strong>jcl-over-slf4j<strong class="hl-tag" style="color: #000096">&lt;/artifactId&gt;</strong>
    <strong class="hl-tag" style="color: #000096">&lt;/dependency&gt;</strong>
    <strong class="hl-tag" style="color: #000096">&lt;dependency&gt;</strong>
        <strong class="hl-tag" style="color: #000096">&lt;groupId&gt;</strong>ch.qos.logback<strong class="hl-tag" style="color: #000096">&lt;/groupId&gt;</strong>
        <strong class="hl-tag" style="color: #000096">&lt;artifactId&gt;</strong>logback-classic<strong class="hl-tag" style="color: #000096">&lt;/artifactId&gt;</strong>
    <strong class="hl-tag" style="color: #000096">&lt;/dependency&gt;</strong>
<strong class="hl-tag" style="color: #000096">&lt;/dependencies&gt;</strong>

<strong class="hl-tag" style="color: #000096">&lt;dependencyManagement&gt;</strong> <a id="co.log.logback.dep.man"><!--anchor co.log.logback.dep.man--></a><span class="calloutno"><img src="images/callouts/1.png" border="0"/></span>
    <strong class="hl-tag" style="color: #000096">&lt;dependencies&gt;</strong>
        <strong class="hl-tag" style="color: #000096">&lt;dependency&gt;</strong>
            <strong class="hl-tag" style="color: #000096">&lt;groupId&gt;</strong>org.slf4j<strong class="hl-tag" style="color: #000096">&lt;/groupId&gt;</strong>
            <strong class="hl-tag" style="color: #000096">&lt;artifactId&gt;</strong>slf4j-api<strong class="hl-tag" style="color: #000096">&lt;/artifactId&gt;</strong>
            <strong class="hl-tag" style="color: #000096">&lt;version&gt;</strong>1.7.5<strong class="hl-tag" style="color: #000096">&lt;/version&gt;</strong>
        <strong class="hl-tag" style="color: #000096">&lt;/dependency&gt;</strong>
        <strong class="hl-tag" style="color: #000096">&lt;dependency&gt;</strong>
            <strong class="hl-tag" style="color: #000096">&lt;groupId&gt;</strong>org.slf4j<strong class="hl-tag" style="color: #000096">&lt;/groupId&gt;</strong>
            <strong class="hl-tag" style="color: #000096">&lt;artifactId&gt;</strong>jcl-over-slf4j<strong class="hl-tag" style="color: #000096">&lt;/artifactId&gt;</strong>
            <strong class="hl-tag" style="color: #000096">&lt;version&gt;</strong>1.7.5<strong class="hl-tag" style="color: #000096">&lt;/version&gt;</strong>
        <strong class="hl-tag" style="color: #000096">&lt;/dependency&gt;</strong>
        <strong class="hl-tag" style="color: #000096">&lt;dependency&gt;</strong>
            <strong class="hl-tag" style="color: #000096">&lt;groupId&gt;</strong>ch.qos.logback<strong class="hl-tag" style="color: #000096">&lt;/groupId&gt;</strong>
            <strong class="hl-tag" style="color: #000096">&lt;artifactId&gt;</strong>logback-classic<strong class="hl-tag" style="color: #000096">&lt;/artifactId&gt;</strong>
            <strong class="hl-tag" style="color: #000096">&lt;version&gt;</strong>1.0.13<strong class="hl-tag" style="color: #000096">&lt;/version&gt;</strong>
            <strong class="hl-tag" style="color: #000096">&lt;scope&gt;</strong>runtime<strong class="hl-tag" style="color: #000096">&lt;/scope&gt;</strong> <a id="co.log.logback.scope"><!--anchor co.log.logback.scope--></a><span class="calloutno"><img src="images/callouts/2.png" border="0"/></span>
        <strong class="hl-tag" style="color: #000096">&lt;/dependency&gt;</strong>
        <strong class="hl-tag" style="color: #000096">&lt;dependency&gt;</strong>
            <strong class="hl-tag" style="color: #000096">&lt;groupId&gt;</strong>commons-logging<strong class="hl-tag" style="color: #000096">&lt;/groupId&gt;</strong>
            <strong class="hl-tag" style="color: #000096">&lt;artifactId&gt;</strong>commons-logging<strong class="hl-tag" style="color: #000096">&lt;/artifactId&gt;</strong>
            <strong class="hl-tag" style="color: #000096">&lt;version&gt;</strong>1.1.3<strong class="hl-tag" style="color: #000096">&lt;/version&gt;</strong>
            <strong class="hl-tag" style="color: #000096">&lt;scope&gt;</strong>provided<strong class="hl-tag" style="color: #000096">&lt;/scope&gt;</strong> <a id="co.log.jcl.scope"><!--anchor co.log.jcl.scope--></a><span class="calloutno"><img src="images/callouts/3.png" border="0"/></span>
        <strong class="hl-tag" style="color: #000096">&lt;/dependency&gt;</strong>
    <strong class="hl-tag" style="color: #000096">&lt;/dependencies&gt;</strong>
<strong class="hl-tag" style="color: #000096">&lt;/dependencyManagement&gt;</strong></pre><div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#co.log.logback.dep.man"><span class="calloutno"><img src="images/callouts/1.png" border="0"/></span></a> </p></td><td valign="top" align="left"><p>把所依赖jar包的版本定义在<code class="code">&lt;dependencyManagement&gt;</code>中，而不是<code class="code">&lt;dependencies&gt;</code>中。因为前者可影响间接依赖，后者只能影响直接依赖。</p><p>如果你的项目指定了parent
                                    pom，那么<span class="emphasis"><em>建议把<code class="code">&lt;dependencyManagement&gt;</code>放在parent
                                pom中</em></span>，以便多个子项目共享配置。</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#co.log.logback.scope"><span class="calloutno"><img src="images/callouts/2.png" border="0"/></span></a> </p></td><td valign="top" align="left"><p>将logback日志系统的依赖设定为<code class="code">&lt;scope&gt;runtime&lt;/scope&gt;</code>，因为应用程序永远不需要直接调用日志系统，而是通过SLF4J或JCL这样的日志框架来调用它们。</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#co.log.jcl.scope"><span class="calloutno"><img src="images/callouts/3.png" border="0"/></span></a> </p></td><td valign="top" align="left"><p>由于和jcl-over-slf4j存在冲突，因此JCL（commons-logging）是必须被排除的。由于maven目前缺少这样一个功能：它不能全局地排除一个jar包依赖，所以建议将commons-logging设置成<code class="code">&lt;scope&gt;provided&lt;/scope&gt;</code>，这样在最终的依赖关系中，将不会包含commons-logging包。</p></td></tr></table></div></div></div><p>将commons-logging设置成<code class="code">&lt;scope&gt;provided&lt;/scope&gt;</code>可以用来排除commons-logging，然而这样做有一个缺点
                —— 你无法从单元测试中将commons-logging排除。假如这个影响了你的单元测试的话，请使用另一种方案：</p><div class="example"><a id="d0e15110"><!--anchor d0e15110--></a><p class="title"><strong>例 11.2. 另一种排除commons-logging的方法</strong></p><div class="example-contents"><pre class="programlisting">        <strong class="hl-tag" style="color: #000096">&lt;dependency&gt;</strong>
            <strong class="hl-tag" style="color: #000096">&lt;groupId&gt;</strong>commons-logging<strong class="hl-tag" style="color: #000096">&lt;/groupId&gt;</strong>
            <strong class="hl-tag" style="color: #000096">&lt;artifactId&gt;</strong>commons-logging<strong class="hl-tag" style="color: #000096">&lt;/artifactId&gt;</strong>
            <strong class="hl-tag" style="color: #000096">&lt;version&gt;</strong>99.0-does-not-exist<strong class="hl-tag" style="color: #000096">&lt;/version&gt;</strong> <a id="co.log.jcl.exclude"><!--anchor co.log.jcl.exclude--></a><span class="calloutno"><img src="images/callouts/1.png" border="0"/></span>
        <strong class="hl-tag" style="color: #000096">&lt;/dependency&gt;</strong></pre><div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#co.log.jcl.exclude"><span class="calloutno"><img src="images/callouts/1.png" border="0"/></span></a> </p></td><td valign="top" align="left"><p>“<code class="code">&lt;version&gt;99.0-does-not-exist&lt;/version&gt;</code>”是一个特殊的版本，这个版本的jar包里空无一物。这样就可以“欺骗”maven使用这个空的jar包来取代commons-logging，达到排除它的目的。</p></td></tr></table></div></div></div><p>最后，你需要在项目文件夹下面，执行一下命令：“<code class="code">mvn
                dependency:tree</code>”，确保没有jar包直接或间接依赖了slf4j-log4j12。如果有的话，你可以用下面的配置来排除掉：</p><div class="example"><a id="d0e15129"><!--anchor d0e15129--></a><p class="title"><strong>例 11.3. 排除间接依赖的slf4j-log4j12</strong></p><div class="example-contents"><pre class="programlisting"><strong class="hl-tag" style="color: #000096">&lt;dependencyManagement&gt;</strong>
    <strong class="hl-tag" style="color: #000096">&lt;dependencies&gt;</strong>
        <strong class="hl-tag" style="color: #000096">&lt;dependency&gt;</strong>
            <strong class="hl-tag" style="color: #000096">&lt;groupId&gt;</strong>yourGroupId<strong class="hl-tag" style="color: #000096">&lt;/groupId&gt;</strong>
            <strong class="hl-tag" style="color: #000096">&lt;artifactId&gt;</strong>yourArtifactId<strong class="hl-tag" style="color: #000096">&lt;/artifactId&gt;</strong>
            <strong class="hl-tag" style="color: #000096">&lt;version&gt;</strong>yourVersion<strong class="hl-tag" style="color: #000096">&lt;/version&gt;</strong>
            <strong class="hl-tag" style="color: #000096">&lt;exclusions&gt;</strong>
                <strong class="hl-tag" style="color: #000096">&lt;exclusion&gt;</strong>
                    <strong class="hl-tag" style="color: #000096">&lt;groupId&gt;</strong>org.slf4j<strong class="hl-tag" style="color: #000096">&lt;/groupId&gt;</strong>
                    <strong class="hl-tag" style="color: #000096">&lt;artifactId&gt;</strong>slf4j-log4j12<strong class="hl-tag" style="color: #000096">&lt;/artifactId&gt;</strong>
                <strong class="hl-tag" style="color: #000096">&lt;/exclusion&gt;</strong>
            <strong class="hl-tag" style="color: #000096">&lt;/exclusions&gt;</strong>
        <strong class="hl-tag" style="color: #000096">&lt;/dependency&gt;</strong>
    <strong class="hl-tag" style="color: #000096">&lt;/dependencies&gt;</strong>
<strong class="hl-tag" style="color: #000096">&lt;/dependencyManagement&gt;</strong></pre></div></div><p>事实上，如果有其它的jar包依赖slf4j-log4j12，这本身就是有错误的。因为应用不应该直接依赖于这些包中的API ——
                    它们只应该依赖于日志框架API。任何应用都应该把下列和日志系统相关的依赖（如：slf4j-log4j12、logback-classic）设置成<code class="code">&lt;scope&gt;runtime&lt;/scope&gt;</code>的。</p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="d0e15139"><!--anchor d0e15139--></a>11.2.2. 在Maven中配置log4j作为日志系统</h3></div></div></div><div class="figure"><a id="d0e15142"><!--anchor d0e15142--></a><div class="figure-contents"><div class="mediaobject"><img src="images/log/log4j.png" alt="以log4j作为日志系统"/></div></div><p class="title"><strong>图 11.3. 以log4j作为日志系统</strong></p></div><div class="example"><a id="webx.logging.log4j.example.pom"><!--anchor webx.logging.log4j.example.pom--></a><p class="title"><strong>例 11.4. 配置<code class="filename">pom.xml</code>以使用log4j</strong></p><div class="example-contents"><pre class="programlisting"><strong class="hl-tag" style="color: #000096">&lt;dependencies&gt;</strong>
    <strong class="hl-tag" style="color: #000096">&lt;dependency&gt;</strong>
        <strong class="hl-tag" style="color: #000096">&lt;groupId&gt;</strong>org.slf4j<strong class="hl-tag" style="color: #000096">&lt;/groupId&gt;</strong>
        <strong class="hl-tag" style="color: #000096">&lt;artifactId&gt;</strong>slf4j-api<strong class="hl-tag" style="color: #000096">&lt;/artifactId&gt;</strong>
    <strong class="hl-tag" style="color: #000096">&lt;/dependency&gt;</strong>
    <strong class="hl-tag" style="color: #000096">&lt;dependency&gt;</strong>
        <strong class="hl-tag" style="color: #000096">&lt;groupId&gt;</strong>org.slf4j<strong class="hl-tag" style="color: #000096">&lt;/groupId&gt;</strong>
        <strong class="hl-tag" style="color: #000096">&lt;artifactId&gt;</strong>jcl-over-slf4j<strong class="hl-tag" style="color: #000096">&lt;/artifactId&gt;</strong>
    <strong class="hl-tag" style="color: #000096">&lt;/dependency&gt;</strong>
    <strong class="hl-tag" style="color: #000096">&lt;dependency&gt;</strong>
        <strong class="hl-tag" style="color: #000096">&lt;groupId&gt;</strong>org.slf4j<strong class="hl-tag" style="color: #000096">&lt;/groupId&gt;</strong>
        <strong class="hl-tag" style="color: #000096">&lt;artifactId&gt;</strong>slf4j-log4j12<strong class="hl-tag" style="color: #000096">&lt;/artifactId&gt;</strong>
    <strong class="hl-tag" style="color: #000096">&lt;/dependency&gt;</strong>
<strong class="hl-tag" style="color: #000096">&lt;/dependencies&gt;</strong>

<strong class="hl-tag" style="color: #000096">&lt;dependencyManagement&gt;</strong>
    <strong class="hl-tag" style="color: #000096">&lt;dependencies&gt;</strong>
        <strong class="hl-tag" style="color: #000096">&lt;dependency&gt;</strong>
            <strong class="hl-tag" style="color: #000096">&lt;groupId&gt;</strong>org.slf4j<strong class="hl-tag" style="color: #000096">&lt;/groupId&gt;</strong>
            <strong class="hl-tag" style="color: #000096">&lt;artifactId&gt;</strong>slf4j-api<strong class="hl-tag" style="color: #000096">&lt;/artifactId&gt;</strong>
            <strong class="hl-tag" style="color: #000096">&lt;version&gt;</strong>1.7.5<strong class="hl-tag" style="color: #000096">&lt;/version&gt;</strong>
        <strong class="hl-tag" style="color: #000096">&lt;/dependency&gt;</strong>
        <strong class="hl-tag" style="color: #000096">&lt;dependency&gt;</strong>
            <strong class="hl-tag" style="color: #000096">&lt;groupId&gt;</strong>org.slf4j<strong class="hl-tag" style="color: #000096">&lt;/groupId&gt;</strong>
            <strong class="hl-tag" style="color: #000096">&lt;artifactId&gt;</strong>jcl-over-slf4j<strong class="hl-tag" style="color: #000096">&lt;/artifactId&gt;</strong>
            <strong class="hl-tag" style="color: #000096">&lt;version&gt;</strong>1.7.5<strong class="hl-tag" style="color: #000096">&lt;/version&gt;</strong>
        <strong class="hl-tag" style="color: #000096">&lt;/dependency&gt;</strong>
        <strong class="hl-tag" style="color: #000096">&lt;dependency&gt;</strong>
            <strong class="hl-tag" style="color: #000096">&lt;groupId&gt;</strong>commons-logging<strong class="hl-tag" style="color: #000096">&lt;/groupId&gt;</strong>
            <strong class="hl-tag" style="color: #000096">&lt;artifactId&gt;</strong>commons-logging<strong class="hl-tag" style="color: #000096">&lt;/artifactId&gt;</strong>
            <strong class="hl-tag" style="color: #000096">&lt;version&gt;</strong>1.1.3<strong class="hl-tag" style="color: #000096">&lt;/version&gt;</strong>
            <strong class="hl-tag" style="color: #000096">&lt;scope&gt;</strong>provided<strong class="hl-tag" style="color: #000096">&lt;/scope&gt;</strong>
        <strong class="hl-tag" style="color: #000096">&lt;/dependency&gt;</strong>
        <strong class="hl-tag" style="color: #000096">&lt;dependency&gt;</strong>
            <strong class="hl-tag" style="color: #000096">&lt;groupId&gt;</strong>org.slf4j<strong class="hl-tag" style="color: #000096">&lt;/groupId&gt;</strong>
            <strong class="hl-tag" style="color: #000096">&lt;artifactId&gt;</strong>slf4j-log4j12<strong class="hl-tag" style="color: #000096">&lt;/artifactId&gt;</strong>
            <strong class="hl-tag" style="color: #000096">&lt;version&gt;</strong>1.7.5<strong class="hl-tag" style="color: #000096">&lt;/version&gt;</strong>
            <strong class="hl-tag" style="color: #000096">&lt;scope&gt;</strong>runtime<strong class="hl-tag" style="color: #000096">&lt;/scope&gt;</strong>
        <strong class="hl-tag" style="color: #000096">&lt;/dependency&gt;</strong>
        <strong class="hl-tag" style="color: #000096">&lt;dependency&gt;</strong>
            <strong class="hl-tag" style="color: #000096">&lt;groupId&gt;</strong>log4j<strong class="hl-tag" style="color: #000096">&lt;/groupId&gt;</strong>
            <strong class="hl-tag" style="color: #000096">&lt;artifactId&gt;</strong>log4j<strong class="hl-tag" style="color: #000096">&lt;/artifactId&gt;</strong>
            <strong class="hl-tag" style="color: #000096">&lt;version&gt;</strong>1.2.17<strong class="hl-tag" style="color: #000096">&lt;/version&gt;</strong>
            <strong class="hl-tag" style="color: #000096">&lt;scope&gt;</strong>runtime<strong class="hl-tag" style="color: #000096">&lt;/scope&gt;</strong>
        <strong class="hl-tag" style="color: #000096">&lt;/dependency&gt;</strong>
    <strong class="hl-tag" style="color: #000096">&lt;/dependencies&gt;</strong>
<strong class="hl-tag" style="color: #000096">&lt;/dependencyManagement&gt;</strong></pre></div></div><p>配置log4j的方法和关注要点和logback相似，请参见<a class="xref" href="logging.html#webx.logging.logback.example.pom" title="例 11.1. 配置pom.xml以使用logback">例 11.1 “配置<code class="filename">pom.xml</code>以使用logback”</a>。除此以外，你需要在项目文件夹下面，执行一下命令：“<code class="code">mvn
                dependency:tree</code>”，确保没有jar包间接依赖了logback-classic。如果有的话，你可以用下面的配置来排除掉：</p><div class="example"><a id="d0e15163"><!--anchor d0e15163--></a><p class="title"><strong>例 11.5. 排除间接依赖的logback-classic</strong></p><div class="example-contents"><pre class="programlisting"><strong class="hl-tag" style="color: #000096">&lt;dependencyManagement&gt;</strong>
    <strong class="hl-tag" style="color: #000096">&lt;dependencies&gt;</strong>
        <strong class="hl-tag" style="color: #000096">&lt;dependency&gt;</strong>
            <strong class="hl-tag" style="color: #000096">&lt;groupId&gt;</strong>yourGroupId<strong class="hl-tag" style="color: #000096">&lt;/groupId&gt;</strong>
            <strong class="hl-tag" style="color: #000096">&lt;artifactId&gt;</strong>yourArtifactId<strong class="hl-tag" style="color: #000096">&lt;/artifactId&gt;</strong>
            <strong class="hl-tag" style="color: #000096">&lt;version&gt;</strong>yourVersion<strong class="hl-tag" style="color: #000096">&lt;/version&gt;</strong>
            <strong class="hl-tag" style="color: #000096">&lt;exclusions&gt;</strong>
                <strong class="hl-tag" style="color: #000096">&lt;exclusion&gt;</strong>
                    <strong class="hl-tag" style="color: #000096">&lt;groupId&gt;</strong>ch.qos.logback<strong class="hl-tag" style="color: #000096">&lt;/groupId&gt;</strong>
                    <strong class="hl-tag" style="color: #000096">&lt;artifactId&gt;</strong>logback-classic<strong class="hl-tag" style="color: #000096">&lt;/artifactId&gt;</strong>
                <strong class="hl-tag" style="color: #000096">&lt;/exclusion&gt;</strong>
            <strong class="hl-tag" style="color: #000096">&lt;/exclusions&gt;</strong>
        <strong class="hl-tag" style="color: #000096">&lt;/dependency&gt;</strong>
    <strong class="hl-tag" style="color: #000096">&lt;/dependencies&gt;</strong>
<strong class="hl-tag" style="color: #000096">&lt;/dependencyManagement&gt;</strong></pre></div></div><p>事实上，如果有其它的jar包依赖logback-classic，这本身就是有错误的。因为应用不应该直接依赖于这些包中的API ——
                    它们只应该依赖于日志框架API。任何应用都应该把下列和日志系统相关的依赖（如：slf4j-log4j12、logback-classic）设置成<code class="code">&lt;scope&gt;runtime&lt;/scope&gt;</code>的。</p></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="d0e15173"><!--anchor d0e15173--></a>11.3. 在WEB应用中配置日志系统</h2></div></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="d0e15176"><!--anchor d0e15176--></a>11.3.1. 设置WEB应用</h3></div></div></div><div class="example"><a id="webx.logging.webxml"><!--anchor webx.logging.webxml--></a><p class="title"><strong>例 11.6. 设置<code class="filename">/WEB-INF/web.xml</code></strong></p><div class="example-contents"><pre class="programlisting"><span class="hl-directive" style="color: maroon">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span>
<strong class="hl-tag" style="color: #000096">&lt;web-app</strong> <span class="hl-attribute" style="color: #F5844C">version</span>=<span class="hl-value" style="color: #993300">"2.4"</span> <span class="hl-attribute" style="color: #F5844C">xmlns</span>=<span class="hl-value" style="color: #993300">"http://java.sun.com/xml/ns/j2ee"</span>
    <span class="hl-attribute" style="color: #F5844C">xmlns:xsi</span>=<span class="hl-value" style="color: #993300">"http://www.w3.org/2001/XMLSchema-instance"</span>
    <span class="hl-attribute" style="color: #F5844C">xsi:schemaLocation</span>=<span class="hl-value" style="color: #993300">"
        http://java.sun.com/xml/ns/j2ee  http://java.sun.com/xml/ns/j2ee/web-app_2_4.xsd
    "</span><strong class="hl-tag" style="color: #000096">&gt;</strong>

    <strong class="hl-tag" style="color: #000096">&lt;context-param&gt;</strong>
        <strong class="hl-tag" style="color: #000096">&lt;param-name&gt;</strong>loggingRoot<strong class="hl-tag" style="color: #000096">&lt;/param-name&gt;</strong> <a id="co.log.webxml.param.loggingRoot"><!--anchor co.log.webxml.param.loggingRoot--></a><span class="calloutno"><img src="images/callouts/1.png" border="0"/></span>
        <strong class="hl-tag" style="color: #000096">&lt;param-value&gt;</strong>/tmp/logs<strong class="hl-tag" style="color: #000096">&lt;/param-value&gt;</strong>
    <strong class="hl-tag" style="color: #000096">&lt;/context-param&gt;</strong>
    <strong class="hl-tag" style="color: #000096">&lt;context-param&gt;</strong>
        <strong class="hl-tag" style="color: #000096">&lt;param-name&gt;</strong>loggingLevel<strong class="hl-tag" style="color: #000096">&lt;/param-name&gt;</strong> <a id="co.log.webxml.param.loggingLevel"><!--anchor co.log.webxml.param.loggingLevel--></a><span class="calloutno"><img src="images/callouts/2.png" border="0"/></span>
        <strong class="hl-tag" style="color: #000096">&lt;param-value&gt;</strong>INFO<strong class="hl-tag" style="color: #000096">&lt;/param-value&gt;</strong>
    <strong class="hl-tag" style="color: #000096">&lt;/context-param&gt;</strong>
    <strong class="hl-tag" style="color: #000096">&lt;context-param&gt;</strong>
        <strong class="hl-tag" style="color: #000096">&lt;param-name&gt;</strong>loggingCharset<strong class="hl-tag" style="color: #000096">&lt;/param-name&gt;</strong> <a id="co.log.webxml.param.loggingCharset"><!--anchor co.log.webxml.param.loggingCharset--></a><span class="calloutno"><img src="images/callouts/3.png" border="0"/></span>
        <strong class="hl-tag" style="color: #000096">&lt;param-value&gt;</strong>UTF-8<strong class="hl-tag" style="color: #000096">&lt;/param-value&gt;</strong>
    <strong class="hl-tag" style="color: #000096">&lt;/context-param&gt;</strong>
    <strong class="hl-tag" style="color: #000096">&lt;context-param&gt;</strong>
        <strong class="hl-tag" style="color: #000096">&lt;param-name&gt;</strong>log...<strong class="hl-tag" style="color: #000096">&lt;/param-name&gt;</strong> <a id="co.log.webxml.param.any"><!--anchor co.log.webxml.param.any--></a><span class="calloutno"><img src="images/callouts/4.png" border="0"/></span>
        <strong class="hl-tag" style="color: #000096">&lt;param-value&gt;</strong>...<strong class="hl-tag" style="color: #000096">&lt;/param-value&gt;</strong>
    <strong class="hl-tag" style="color: #000096">&lt;/context-param&gt;</strong>

    <strong class="hl-tag" style="color: #000096">&lt;listener&gt;</strong>
        <strong class="hl-tag" style="color: #000096">&lt;listener-class&gt;</strong>com.alibaba.citrus.logconfig.LogConfiguratorListener<strong class="hl-tag" style="color: #000096">&lt;/listener-class&gt;</strong> <a id="co.log.webxml.listener.conf"><!--anchor co.log.webxml.listener.conf--></a><span class="calloutno"><img src="images/callouts/5.png" border="0"/></span>
    <strong class="hl-tag" style="color: #000096">&lt;/listener&gt;</strong>

    <strong class="hl-tag" style="color: #000096">&lt;filter&gt;</strong>
        <strong class="hl-tag" style="color: #000096">&lt;filter-name&gt;</strong>mdc<strong class="hl-tag" style="color: #000096">&lt;/filter-name&gt;</strong>
        <strong class="hl-tag" style="color: #000096">&lt;filter-class&gt;</strong>com.alibaba.citrus.webx.servlet.SetLoggingContextFilter<strong class="hl-tag" style="color: #000096">&lt;/filter-class&gt;</strong> <a id="co.log.webxml.filter.mdc"><!--anchor co.log.webxml.filter.mdc--></a><span class="calloutno"><img src="images/callouts/6.png" border="0"/></span>
    <strong class="hl-tag" style="color: #000096">&lt;/filter&gt;</strong>

    <strong class="hl-tag" style="color: #000096">&lt;filter-mapping&gt;</strong>
        <strong class="hl-tag" style="color: #000096">&lt;filter-name&gt;</strong>mdc<strong class="hl-tag" style="color: #000096">&lt;/filter-name&gt;</strong>
        <strong class="hl-tag" style="color: #000096">&lt;url-pattern&gt;</strong>/*<strong class="hl-tag" style="color: #000096">&lt;/url-pattern&gt;</strong>
    <strong class="hl-tag" style="color: #000096">&lt;/filter-mapping&gt;</strong>

<strong class="hl-tag" style="color: #000096">&lt;/web-app&gt;</strong></pre><div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#co.log.webxml.param.loggingRoot"><span class="calloutno"><img src="images/callouts/1.png" border="0"/></span></a> <a href="#co.log.webxml.param.loggingLevel"><span class="calloutno"><img src="images/callouts/2.png" border="0"/></span></a> <a href="#co.log.webxml.param.loggingCharset"><span class="calloutno"><img src="images/callouts/3.png" border="0"/></span></a> <a href="#co.log.webxml.param.any"><span class="calloutno"><img src="images/callouts/4.png" border="0"/></span></a> </p></td><td valign="top" align="left"><p>指定日志系统的参数。</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#co.log.webxml.listener.conf"><span class="calloutno"><img src="images/callouts/5.png" border="0"/></span></a> </p></td><td valign="top" align="left"><p>在WEB应用启动的时候，这个listener会被激活，并初始化日志系统。</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#co.log.webxml.filter.mdc"><span class="calloutno"><img src="images/callouts/6.png" border="0"/></span></a> </p></td><td valign="top" align="left"><p>将当前请求的信息放到日志系统的MDC中（Mapped Diagnostic Context）。</p></td></tr></table></div></div></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="d0e15208"><!--anchor d0e15208--></a>11.3.1.1. 日志系统的参数</h4></div></div></div><p>可以在<code class="filename">/WEB-INF/web.xml</code>配置文件中集中定义日志系统的参数。</p><div class="table"><a id="d0e15216"><!--anchor d0e15216--></a><p class="title"><strong>表 11.4. 可配置的日志参数</strong></p><div class="table-contents"><table summary="可配置的日志参数" cellpadding="10" style="border: none;"><colgroup><col width="30%" class="c1"/><col width="70%" class="c2"/></colgroup><thead><tr><th style="border-right: 0.5pt solid #6666cc; border-bottom: 0.5pt solid #6666cc; ">参数名称</th><th style="border-bottom: 0.5pt solid #6666cc; ">说明</th></tr></thead><tbody><tr><td style="border-right: 0.5pt solid #6666cc; border-bottom: 0.5pt solid #6666cc; "><code class="code">loggingRoot</code></td><td style="border-bottom: 0.5pt solid #6666cc; ">指定保存日志文件的根目录。如不指定，默认为：“<code class="code">${user.home}/logs</code>”。</td></tr><tr><td style="border-right: 0.5pt solid #6666cc; border-bottom: 0.5pt solid #6666cc; "><code class="code">loggingLevel</code></td><td style="border-bottom: 0.5pt solid #6666cc; ">指定日志级别，低于指定级别的日志将不被输出。如不指定，默认为“<code class="code">INFO</code>”。</td></tr><tr><td style="border-right: 0.5pt solid #6666cc; border-bottom: 0.5pt solid #6666cc; "><code class="code">loggingCharset</code></td><td style="border-bottom: 0.5pt solid #6666cc; ">指定用来生成日志文件的字符集编码。如不指定，默认为当前操作系统的默认字符集编码。</td></tr><tr><td style="border-right: 0.5pt solid #6666cc; "><code class="code">log*</code></td><td style="">名称以“<code class="code">log</code>”开头的任意<code class="code">&lt;context-param&gt;</code>参数，都将被用作日志系统的参数。</td></tr></tbody></table></div></div><p>日志系统的参数可被替换到log4j或logback的配置中去，例如，在logback的配置文件中，你可以指定<code class="code">${loggingRoot}</code>来取得存放日志文件的根目录。</p><p>将日志参数配置在<code class="filename">/WEB-INF/web.xml</code>中，有如下优点：</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>使一套配置参数可同时应用于任意日志系统，包括logback和log4j。</p></li><li class="listitem"><p>便于管理。通常，我们可以利用maven的filtering机制，或者autoconfig插件来生成<code class="filename">/WEB-INF/web.xml</code>文件，以便定制上述参数。</p></li></ul></div></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="d0e15285"><!--anchor d0e15285--></a>11.3.1.2. 自动识别并初始化日志系统</h4></div></div></div><p><code class="code">LogConfiguratorListener</code>负责在系统启动的时候初始化日志系统。<code class="code">LogConfiguratorListener</code>会根据下面所列的条件，来自动识别出当前的日志系统，并正确地配置它：</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>假如你在maven的<code class="filename">pom.xml</code>中指定log4j为日志系统，那么该listener就会试图用<code class="filename">/WEB-INF/log4j.xml</code>来初始化日志系统。</p></li><li class="listitem"><p>假如你在maven的<code class="filename">pom.xml</code>中指定logback为日志系统，那么该listener就会试图用<code class="filename">/WEB-INF/logback.xml</code>来初始化日志系统。</p></li><li class="listitem"><p>假如你在maven的<code class="filename">pom.xml</code>中未指定任何日志系统（不存在logback-classic或slf4j-log4j12），那么listener会报错并失败，整个WEB应用会退出，服务器报告应用启动失败。</p></li><li class="listitem"><p>假如<code class="filename">/WEB-INF/logback.xml</code>（或<code class="filename">/WEB-INF/log4j.xml</code>）不存在，那么listener会用默认的配置文件来初始化日志。默认的配置会：</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem"><p>把<code class="code">WARN</code>级别以上的日志打印在<code class="code">STDERR</code>中，</p></li><li class="listitem"><p>把<code class="code">WARN</code>级别以下的日志打印在<code class="code">STDOUT</code>中。</p></li></ul></div><p>
                            </p></li></ul></div></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="d0e15349"><!--anchor d0e15349--></a>11.3.1.3. 初始化MDC</h4></div></div></div><p><code class="code">SetLoggingContextFilter</code>将当前请求的信息放到日志系统的MDC中（Mapped Diagnostic
                    Context）。这样，日志系统就可以打印出诸如下面所示的日志信息：</p><div class="example"><a id="d0e15356"><!--anchor d0e15356--></a><p class="title"><strong>例 11.7. 利用MDC输出的日志</strong></p><div class="example-contents"><pre class="screen">30377 [2010-06-02 15:24:29] - GET<a id="co.log.mdc.method"><!--anchor co.log.mdc.method--></a><span class="calloutno"><img src="images/callouts/1.png" border="0"/></span> /wrongpage.htm<a id="co.log.mdc.uri"><!--anchor co.log.mdc.uri--></a><span class="calloutno"><img src="images/callouts/2.png" border="0"/></span> [ip=127.0.0.1<a id="co.log.mdc.ip"><!--anchor co.log.mdc.ip--></a><span class="calloutno"><img src="images/callouts/3.png" border="0"/></span>, ref=http://localhost:8081/index<a id="co.log.mdc.ref"><!--anchor co.log.mdc.ref--></a><span class="calloutno"><img src="images/callouts/4.png" border="0"/></span>, ua=Mozilla/5.0 (Macintosh; U; Intel Mac OS X 10.6; zh-CN; rv:1.9.2.3) Gecko/20100401 Firefox/3.6.3<a id="co.log.mdc.agent"><!--anchor co.log.mdc.agent--></a><span class="calloutno"><img src="images/callouts/5.png" border="0"/></span>, sid=scnd32ei11a7<a id="co.log.mdc.sid"><!--anchor co.log.mdc.sid--></a><span class="calloutno"><img src="images/callouts/6.png" border="0"/></span>] ……</pre><div class="calloutlist"><p>这段日志信息中包含了如下信息：</p><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#co.log.mdc.method"><span class="calloutno"><img src="images/callouts/1.png" border="0"/></span></a> </p></td><td valign="top" align="left"><p>用户请求的类型：<code class="code">GET</code>。</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#co.log.mdc.uri"><span class="calloutno"><img src="images/callouts/2.png" border="0"/></span></a> </p></td><td valign="top" align="left"><p>请求的URI：<code class="code">/wrongpage.htm</code>。</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#co.log.mdc.ip"><span class="calloutno"><img src="images/callouts/3.png" border="0"/></span></a> </p></td><td valign="top" align="left"><p>用户IP：<code class="code">127.0.0.1</code>。</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#co.log.mdc.ref"><span class="calloutno"><img src="images/callouts/4.png" border="0"/></span></a> </p></td><td valign="top" align="left"><p>上一个页面的链接referrer：<code class="code">http://localhost:8081/index</code></p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#co.log.mdc.agent"><span class="calloutno"><img src="images/callouts/5.png" border="0"/></span></a> </p></td><td valign="top" align="left"><p>用户的浏览器：Mac版的mozilla浏览器。</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#co.log.mdc.sid"><span class="calloutno"><img src="images/callouts/6.png" border="0"/></span></a> </p></td><td valign="top" align="left"><p>Session ID：<code class="code">scnd32ei11a7</code>。</p></td></tr></table></div></div></div><p>用户客户端的详细信息，对于发现和追踪错误非常有帮助。</p><p><span class="emphasis"><em><code class="code">SetLoggingContextFilter</code>是一个可选的filter</em></span> ——
                        即使没有它，Webx的<code class="code">&lt;setLoggingContext /&gt;</code>
                    valve也会做同样的事情。但是把这些信息放在filter中，有利于及早记录用户的信息。 </p></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="d0e15419"><!--anchor d0e15419--></a>11.3.2. 定制<code class="filename">/WEB-INF/logback.xml</code>（或<code class="filename">/WEB-INF/log4j.xml</code>）</h3></div></div></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="d0e15428"><!--anchor d0e15428--></a>11.3.2.1. 可用的参数</h4></div></div></div><p>在日志配置文件中，你可以使用以下参数：</p><div class="table"><a id="d0e15433"><!--anchor d0e15433--></a><p class="title"><strong>表 11.5. 日志配置文件中可用的参数</strong></p><div class="table-contents"><table summary="日志配置文件中可用的参数" cellpadding="10" style="border: none;"><colgroup><col width="40%" class="c1"/><col width="60%" class="c2"/></colgroup><thead><tr><th style="border-bottom: 0.5pt solid #6666cc; " colspan="2">在<code class="filename">/WEB-INF/web.xml</code>中定义的所有日志参数</th></tr></thead><tbody><tr><td style="border-right: 0.5pt solid #6666cc; border-bottom: 0.5pt solid #6666cc; "><code class="code">${loggingRoot}</code></td><td style="border-bottom: 0.5pt solid #6666cc; ">代表保存日志文件的根目录。</td></tr><tr><td style="border-right: 0.5pt solid #6666cc; border-bottom: 0.5pt solid #6666cc; "><code class="code">${loggingCharset}</code></td><td style="border-bottom: 0.5pt solid #6666cc; ">代表用来生成日志文件的字符集编码。</td></tr><tr><td style="border-right: 0.5pt solid #6666cc; border-bottom: 0.5pt solid #6666cc; "><code class="code">${loggingLevel}</code></td><td style="border-bottom: 0.5pt solid #6666cc; ">代表日志级别，低于指定级别的日志将不被输出。</td></tr><tr><td style="border-right: 0.5pt solid #6666cc; "><code class="code">${log*}</code></td><td style="">自定义参数，其中“<code class="code">*</code>”代表任意名称。</td></tr></tbody></table><table summary="日志配置文件中可用的参数" cellpadding="10" style="border: none;"><colgroup><col width="40%" class="c1"/><col width="60%" class="c2"/></colgroup><thead><tr><th style="border-bottom: 0.5pt solid #6666cc; " colspan="2">由系统自动取得的参数</th></tr></thead><tbody><tr><td style="border-right: 0.5pt solid #6666cc; border-bottom: 0.5pt solid #6666cc; "><code class="code">${loggingHost}</code></td><td style="border-bottom: 0.5pt solid #6666cc; ">代表当前的服务器名称</td></tr><tr><td style="border-right: 0.5pt solid #6666cc; "><code class="code">${loggingAddress}</code></td><td style="">代表当前的服务器IP地址</td></tr></tbody></table></div></div></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="d0e15494"><!--anchor d0e15494--></a>11.3.2.2. 可用的MDC参数</h4></div></div></div><p>在appender pattern中，你可以使用以下MDC参数：</p><div class="table"><a id="d0e15499"><!--anchor d0e15499--></a><p class="title"><strong>表 11.6. 日志配置文件中可用的MDC参数</strong></p><div class="table-contents"><table summary="日志配置文件中可用的MDC参数" cellpadding="10" style="border: none;"><colgroup><col width="38%" class="c1"/><col width="62%" class="c2"/></colgroup><thead><tr><th style="border-right: 0.5pt solid #6666cc; border-bottom: 0.5pt solid #6666cc; ">参数名</th><th style="border-bottom: 0.5pt solid #6666cc; ">说明</th></tr></thead><tbody><tr><td style="border-right: 0.5pt solid #6666cc; border-bottom: 0.5pt solid #6666cc; "><code class="code">%X{productionMode}</code></td><td style="border-bottom: 0.5pt solid #6666cc; ">系统运行的模式。如果系统以开发模式运行，将会显示<code class="code">Development Mode</code>；否则将会显示<code class="code">Production Mode</code>。在生产环境中启动开发模式会引起严重的性能和安全问题。将系统运行的模式打印在日志中，可以作为一种提醒。</td></tr><tr><td style="border-right: 0.5pt solid #6666cc; border-bottom: 0.5pt solid #6666cc; "><code class="code">%X{method}</code></td><td style="border-bottom: 0.5pt solid #6666cc; ">请求类型，如：<code class="code">GET</code>或<code class="code">POST</code></td></tr><tr><td style="border-right: 0.5pt solid #6666cc; border-bottom: 0.5pt solid #6666cc; "><code class="code">%X{requestURL}</code></td><td style="border-bottom: 0.5pt solid #6666cc; ">完整的URL，如：<code class="code">http://localhost/test</code></td></tr><tr><td style="border-right: 0.5pt solid #6666cc; border-bottom: 0.5pt solid #6666cc; "><code class="code">%X{requestURLWithQueryString}</code></td><td style="border-bottom: 0.5pt solid #6666cc; ">完整的URL，以及query
                                        string，如：<code class="code">http://localhost/test?id=1</code></td></tr><tr><td style="border-right: 0.5pt solid #6666cc; border-bottom: 0.5pt solid #6666cc; "><code class="code">%X{requestURI}</code></td><td style="border-bottom: 0.5pt solid #6666cc; ">不包括host信息的URI，如：<code class="code">/test</code></td></tr><tr><td style="border-right: 0.5pt solid #6666cc; border-bottom: 0.5pt solid #6666cc; "><code class="code">%X{requestURIWithQueryString}</code></td><td style="border-bottom: 0.5pt solid #6666cc; ">不包括host信息的URI，以及query
                                    string，如：<code class="code">/test?id=1</code></td></tr><tr><td style="border-right: 0.5pt solid #6666cc; border-bottom: 0.5pt solid #6666cc; "><code class="code">%X{queryString}</code></td><td style="border-bottom: 0.5pt solid #6666cc; ">URL参数，如：<code class="code">id=1</code></td></tr><tr><td style="border-right: 0.5pt solid #6666cc; border-bottom: 0.5pt solid #6666cc; "><code class="code">%X{remoteAddr}</code></td><td style="border-bottom: 0.5pt solid #6666cc; ">客户端地址</td></tr><tr><td style="border-right: 0.5pt solid #6666cc; border-bottom: 0.5pt solid #6666cc; "><code class="code">%X{remoteHost}</code></td><td style="border-bottom: 0.5pt solid #6666cc; ">客户端域名</td></tr><tr><td style="border-right: 0.5pt solid #6666cc; border-bottom: 0.5pt solid #6666cc; "><code class="code">%X{userAgent}</code></td><td style="border-bottom: 0.5pt solid #6666cc; ">客户端浏览器信息</td></tr><tr><td style="border-right: 0.5pt solid #6666cc; border-bottom: 0.5pt solid #6666cc; "><code class="code">%X{referrer}</code></td><td style="border-bottom: 0.5pt solid #6666cc; ">上一个页面的URL</td></tr><tr><td style="border-right: 0.5pt solid #6666cc; border-bottom: 0.5pt solid #6666cc; "><code class="code">%X{cookies}</code></td><td style="border-bottom: 0.5pt solid #6666cc; ">所有cookies的名称，如：<code class="code">[cookie1, cookie2]</code></td></tr><tr><td style="border-right: 0.5pt solid #6666cc; border-bottom: 0.5pt solid #6666cc; "><code class="code">%X{cookie.*}</code></td><td style="border-bottom: 0.5pt solid #6666cc; ">特定cookie的值，如：<code class="code">%X{cookie.JSESSIONID}</code>，将显示当前session的ID</td></tr><tr><td style="border-right: 0.5pt solid #6666cc; "><code class="code">%X{*}</code></td><td style="">其它由应用程序或框架置入MDC的参数</td></tr></tbody></table></div></div></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="d0e15622"><!--anchor d0e15622--></a>11.3.2.3. Logback配置示例</h4></div></div></div><div class="example"><a id="d0e15625"><!--anchor d0e15625--></a><p class="title"><strong>例 11.8. Logback配置示例（<code class="filename">/WEB-INF/logback.xml</code>）</strong></p><div class="example-contents"><pre class="programlisting"><span class="hl-directive" style="color: maroon">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span>
<strong class="hl-tag" style="color: #000096">&lt;configuration</strong> <span class="hl-attribute" style="color: #F5844C">debug</span>=<span class="hl-value" style="color: #993300">"false"</span><strong class="hl-tag" style="color: #000096">&gt;</strong>
    <strong class="hl-tag" style="color: #000096">&lt;appender</strong> <span class="hl-attribute" style="color: #F5844C">name</span>=<span class="hl-value" style="color: #993300">"STDOUT"</span> <span class="hl-attribute" style="color: #F5844C">class</span>=<span class="hl-value" style="color: #993300">"ch.qos.logback.core.ConsoleAppender"</span><strong class="hl-tag" style="color: #000096">&gt;</strong>
        <strong class="hl-tag" style="color: #000096">&lt;target&gt;</strong>System.out<strong class="hl-tag" style="color: #000096">&lt;/target&gt;</strong>
        <strong class="hl-tag" style="color: #000096">&lt;encoding&gt;</strong>${loggingCharset}<strong class="hl-tag" style="color: #000096">&lt;/encoding&gt;</strong>
        <strong class="hl-tag" style="color: #000096">&lt;layout</strong> <span class="hl-attribute" style="color: #F5844C">class</span>=<span class="hl-value" style="color: #993300">"ch.qos.logback.classic.PatternLayout"</span><strong class="hl-tag" style="color: #000096">&gt;</strong>
            <strong class="hl-tag" style="color: #000096">&lt;pattern&gt;</strong><strong class="hl-tag" style="color: #000096">&lt;![CDATA[</strong>
%n%-4r [%d{yyyy-MM-dd HH:mm:ss}] %X{productionMode} - %X{method} %X{requestURIWithQueryString} [ip=%X{remoteAddr}, ref=%X{referrer}, ua=%X{userAgent}, sid=%X{cookie.JSESSIONID}]%n  %-5level %logger{35} - %m%n
            <strong class="hl-tag" style="color: #000096">]]&gt;</strong><strong class="hl-tag" style="color: #000096">&lt;/pattern&gt;</strong>
        <strong class="hl-tag" style="color: #000096">&lt;/layout&gt;</strong>
        <strong class="hl-tag" style="color: #000096">&lt;filter</strong> <span class="hl-attribute" style="color: #F5844C">class</span>=<span class="hl-value" style="color: #993300">"com.alibaba.citrus.logconfig.logback.LevelRangeFilter"</span><strong class="hl-tag" style="color: #000096">&gt;</strong>
            <strong class="hl-tag" style="color: #000096">&lt;levelMax&gt;</strong>INFO<strong class="hl-tag" style="color: #000096">&lt;/levelMax&gt;</strong>
        <strong class="hl-tag" style="color: #000096">&lt;/filter&gt;</strong>
    <strong class="hl-tag" style="color: #000096">&lt;/appender&gt;</strong>

    <strong class="hl-tag" style="color: #000096">&lt;appender</strong> <span class="hl-attribute" style="color: #F5844C">name</span>=<span class="hl-value" style="color: #993300">"STDERR"</span> <span class="hl-attribute" style="color: #F5844C">class</span>=<span class="hl-value" style="color: #993300">"ch.qos.logback.core.ConsoleAppender"</span><strong class="hl-tag" style="color: #000096">&gt;</strong>
        <strong class="hl-tag" style="color: #000096">&lt;target&gt;</strong>System.err<strong class="hl-tag" style="color: #000096">&lt;/target&gt;</strong>
        <strong class="hl-tag" style="color: #000096">&lt;encoding&gt;</strong>${loggingCharset}<strong class="hl-tag" style="color: #000096">&lt;/encoding&gt;</strong>
        <strong class="hl-tag" style="color: #000096">&lt;layout</strong> <span class="hl-attribute" style="color: #F5844C">class</span>=<span class="hl-value" style="color: #993300">"ch.qos.logback.classic.PatternLayout"</span><strong class="hl-tag" style="color: #000096">&gt;</strong>
            <strong class="hl-tag" style="color: #000096">&lt;pattern&gt;</strong><strong class="hl-tag" style="color: #000096">&lt;![CDATA[</strong>
%n%-4r [%d{yyyy-MM-dd HH:mm:ss}] %X{productionMode} - %X{method} %X{requestURIWithQueryString} [ip=%X{remoteAddr}, ref=%X{referrer}, ua=%X{userAgent}, sid=%X{cookie.JSESSIONID}]%n  %-5level %logger{35} - %m%n
            <strong class="hl-tag" style="color: #000096">]]&gt;</strong><strong class="hl-tag" style="color: #000096">&lt;/pattern&gt;</strong>
        <strong class="hl-tag" style="color: #000096">&lt;/layout&gt;</strong>
        <strong class="hl-tag" style="color: #000096">&lt;filter</strong> <span class="hl-attribute" style="color: #F5844C">class</span>=<span class="hl-value" style="color: #993300">"com.alibaba.citrus.logconfig.logback.LevelRangeFilter"</span><strong class="hl-tag" style="color: #000096">&gt;</strong>
            <strong class="hl-tag" style="color: #000096">&lt;levelMin&gt;</strong>WARN<strong class="hl-tag" style="color: #000096">&lt;/levelMin&gt;</strong>
        <strong class="hl-tag" style="color: #000096">&lt;/filter&gt;</strong>
    <strong class="hl-tag" style="color: #000096">&lt;/appender&gt;</strong>

    <strong class="hl-tag" style="color: #000096">&lt;appender</strong> <span class="hl-attribute" style="color: #F5844C">name</span>=<span class="hl-value" style="color: #993300">"PROJECT"</span> <span class="hl-attribute" style="color: #F5844C">class</span>=<span class="hl-value" style="color: #993300">"ch.qos.logback.core.FileAppender"</span><strong class="hl-tag" style="color: #000096">&gt;</strong>
        <strong class="hl-tag" style="color: #000096">&lt;file&gt;</strong>${loggingRoot}/${localHost}/petstore.log<strong class="hl-tag" style="color: #000096">&lt;/file&gt;</strong>
        <strong class="hl-tag" style="color: #000096">&lt;encoding&gt;</strong>${loggingCharset}<strong class="hl-tag" style="color: #000096">&lt;/encoding&gt;</strong>
        <strong class="hl-tag" style="color: #000096">&lt;append&gt;</strong>false<strong class="hl-tag" style="color: #000096">&lt;/append&gt;</strong>
        <strong class="hl-tag" style="color: #000096">&lt;layout</strong> <span class="hl-attribute" style="color: #F5844C">class</span>=<span class="hl-value" style="color: #993300">"ch.qos.logback.classic.PatternLayout"</span><strong class="hl-tag" style="color: #000096">&gt;</strong>
            <strong class="hl-tag" style="color: #000096">&lt;pattern&gt;</strong><strong class="hl-tag" style="color: #000096">&lt;![CDATA[</strong>
%n%-4r [%d{yyyy-MM-dd HH:mm:ss}] %X{productionMode} - %X{method} %X{requestURIWithQueryString} [ip=%X{remoteAddr}, ref=%X{referrer}, ua=%X{userAgent}, sid=%X{cookie.JSESSIONID}]%n  %-5level %logger{35} - %m%n
            <strong class="hl-tag" style="color: #000096">]]&gt;</strong><strong class="hl-tag" style="color: #000096">&lt;/pattern&gt;</strong>
        <strong class="hl-tag" style="color: #000096">&lt;/layout&gt;</strong>
    <strong class="hl-tag" style="color: #000096">&lt;/appender&gt;</strong>

    <strong class="hl-tag" style="color: #000096">&lt;root&gt;</strong>
        <strong class="hl-tag" style="color: #000096">&lt;level</strong> <span class="hl-attribute" style="color: #F5844C">value</span>=<span class="hl-value" style="color: #993300">"${loggingLevel}"</span><strong class="hl-tag" style="color: #000096"> /&gt;</strong>
        <strong class="hl-tag" style="color: #000096">&lt;appender-ref</strong> <span class="hl-attribute" style="color: #F5844C">ref</span>=<span class="hl-value" style="color: #993300">"STDERR"</span><strong class="hl-tag" style="color: #000096"> /&gt;</strong>
        <strong class="hl-tag" style="color: #000096">&lt;appender-ref</strong> <span class="hl-attribute" style="color: #F5844C">ref</span>=<span class="hl-value" style="color: #993300">"STDOUT"</span><strong class="hl-tag" style="color: #000096"> /&gt;</strong>
        <strong class="hl-tag" style="color: #000096">&lt;appender-ref</strong> <span class="hl-attribute" style="color: #F5844C">ref</span>=<span class="hl-value" style="color: #993300">"PROJECT"</span><strong class="hl-tag" style="color: #000096"> /&gt;</strong>
    <strong class="hl-tag" style="color: #000096">&lt;/root&gt;</strong>
<strong class="hl-tag" style="color: #000096">&lt;/configuration&gt;</strong></pre></div></div><p>更详细配置方法请参考logback官方文档：<a class="link" href="http://logback.qos.ch/manual/configuration.html" target="_top">http://logback.qos.ch/manual/configuration.html</a>。</p><p>请特别留意示例中参数的写法，如“<code class="code">${loggingRoot}</code>”；以及appender
                        pattern中MDC参数的的写法，如：“<code class="code">%X{method}</code>”、“<code class="code">%X{requestURIWithQueryString}</code>”等。
                </p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="d0e15648"><!--anchor d0e15648--></a>11.3.2.4. Log4j配置示例</h4></div></div></div><div class="example"><a id="d0e15651"><!--anchor d0e15651--></a><p class="title"><strong>例 11.9. Log4j配置示例（<code class="filename">/WEB-INF/log4j.xml</code>）</strong></p><div class="example-contents"><pre class="programlisting"><span class="hl-directive" style="color: maroon">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span>
<strong class="hl-tag" style="color: blue">&lt;!DOCTYPE log4j:configuration SYSTEM "log4j.dtd"&gt;</strong>
<strong class="hl-tag" style="color: #000096">&lt;log4j:configuration</strong> <span class="hl-attribute" style="color: #F5844C">xmlns:log4j</span>=<span class="hl-value" style="color: #993300">"http://jakarta.apache.org/log4j/"</span><strong class="hl-tag" style="color: #000096">&gt;</strong>
    <strong class="hl-tag" style="color: #000096">&lt;appender</strong> <span class="hl-attribute" style="color: #F5844C">name</span>=<span class="hl-value" style="color: #993300">"STDOUT"</span> <span class="hl-attribute" style="color: #F5844C">class</span>=<span class="hl-value" style="color: #993300">"org.apache.log4j.ConsoleAppender"</span><strong class="hl-tag" style="color: #000096">&gt;</strong>
        <strong class="hl-tag" style="color: #000096">&lt;param</strong> <span class="hl-attribute" style="color: #F5844C">name</span>=<span class="hl-value" style="color: #993300">"target"</span> <span class="hl-attribute" style="color: #F5844C">value</span>=<span class="hl-value" style="color: #993300">"System.out"</span><strong class="hl-tag" style="color: #000096"> /&gt;</strong>
        <strong class="hl-tag" style="color: #000096">&lt;param</strong> <span class="hl-attribute" style="color: #F5844C">name</span>=<span class="hl-value" style="color: #993300">"encoding"</span> <span class="hl-attribute" style="color: #F5844C">value</span>=<span class="hl-value" style="color: #993300">"${loggingCharset}"</span><strong class="hl-tag" style="color: #000096"> /&gt;</strong>
        <strong class="hl-tag" style="color: #000096">&lt;layout</strong> <span class="hl-attribute" style="color: #F5844C">class</span>=<span class="hl-value" style="color: #993300">"org.apache.log4j.PatternLayout"</span><strong class="hl-tag" style="color: #000096">&gt;</strong>
            <strong class="hl-tag" style="color: #000096">&lt;param</strong> <span class="hl-attribute" style="color: #F5844C">name</span>=<span class="hl-value" style="color: #993300">"ConversionPattern"</span>
                <span class="hl-attribute" style="color: #F5844C">value</span>=<span class="hl-value" style="color: #993300">"%n%-4r [%d{yyyy-MM-dd HH:mm:ss}] %X{productionMode} - %X{method} %X{requestURIWithQueryString} [ip=%X{remoteAddr}, ref=%X{referrer}, ua=%X{userAgent}, sid=%X{cookie.JSESSIONID}]%n  %-5level %logger{35} - %m%n"</span><strong class="hl-tag" style="color: #000096">
             /&gt;</strong>
        <strong class="hl-tag" style="color: #000096">&lt;/layout&gt;</strong>
        <strong class="hl-tag" style="color: #000096">&lt;filter</strong> <span class="hl-attribute" style="color: #F5844C">class</span>=<span class="hl-value" style="color: #993300">"org.apache.log4j.varia.LevelRangeFilter"</span><strong class="hl-tag" style="color: #000096">&gt;</strong>
            <strong class="hl-tag" style="color: #000096">&lt;param</strong> <span class="hl-attribute" style="color: #F5844C">name</span>=<span class="hl-value" style="color: #993300">"levelMax"</span> <span class="hl-attribute" style="color: #F5844C">value</span>=<span class="hl-value" style="color: #993300">"INFO"</span><strong class="hl-tag" style="color: #000096"> /&gt;</strong>
        <strong class="hl-tag" style="color: #000096">&lt;/filter&gt;</strong>
    <strong class="hl-tag" style="color: #000096">&lt;/appender&gt;</strong>

    <strong class="hl-tag" style="color: #000096">&lt;appender</strong> <span class="hl-attribute" style="color: #F5844C">name</span>=<span class="hl-value" style="color: #993300">"STDERR"</span> <span class="hl-attribute" style="color: #F5844C">class</span>=<span class="hl-value" style="color: #993300">"org.apache.log4j.ConsoleAppender"</span><strong class="hl-tag" style="color: #000096">&gt;</strong>
        <strong class="hl-tag" style="color: #000096">&lt;param</strong> <span class="hl-attribute" style="color: #F5844C">name</span>=<span class="hl-value" style="color: #993300">"target"</span> <span class="hl-attribute" style="color: #F5844C">value</span>=<span class="hl-value" style="color: #993300">"System.err"</span><strong class="hl-tag" style="color: #000096"> /&gt;</strong>
        <strong class="hl-tag" style="color: #000096">&lt;param</strong> <span class="hl-attribute" style="color: #F5844C">name</span>=<span class="hl-value" style="color: #993300">"encoding"</span> <span class="hl-attribute" style="color: #F5844C">value</span>=<span class="hl-value" style="color: #993300">"${loggingCharset}"</span><strong class="hl-tag" style="color: #000096"> /&gt;</strong>
        <strong class="hl-tag" style="color: #000096">&lt;layout</strong> <span class="hl-attribute" style="color: #F5844C">class</span>=<span class="hl-value" style="color: #993300">"org.apache.log4j.PatternLayout"</span><strong class="hl-tag" style="color: #000096">&gt;</strong>
            <strong class="hl-tag" style="color: #000096">&lt;param</strong> <span class="hl-attribute" style="color: #F5844C">name</span>=<span class="hl-value" style="color: #993300">"ConversionPattern"</span>
                <span class="hl-attribute" style="color: #F5844C">value</span>=<span class="hl-value" style="color: #993300">"%n%-4r [%d{yyyy-MM-dd HH:mm:ss}] %X{productionMode} - %X{method} %X{requestURIWithQueryString} [ip=%X{remoteAddr}, ref=%X{referrer}, ua=%X{userAgent}, sid=%X{cookie.JSESSIONID}]%n  %-5level %logger{35} - %m%n"</span><strong class="hl-tag" style="color: #000096">
             /&gt;</strong>
        <strong class="hl-tag" style="color: #000096">&lt;/layout&gt;</strong>
        <strong class="hl-tag" style="color: #000096">&lt;filter</strong> <span class="hl-attribute" style="color: #F5844C">class</span>=<span class="hl-value" style="color: #993300">"org.apache.log4j.varia.LevelRangeFilter"</span><strong class="hl-tag" style="color: #000096">&gt;</strong>
            <strong class="hl-tag" style="color: #000096">&lt;param</strong> <span class="hl-attribute" style="color: #F5844C">name</span>=<span class="hl-value" style="color: #993300">"levelMin"</span> <span class="hl-attribute" style="color: #F5844C">value</span>=<span class="hl-value" style="color: #993300">"WARN"</span><strong class="hl-tag" style="color: #000096"> /&gt;</strong>
        <strong class="hl-tag" style="color: #000096">&lt;/filter&gt;</strong>
    <strong class="hl-tag" style="color: #000096">&lt;/appender&gt;</strong>

    <strong class="hl-tag" style="color: #000096">&lt;appender</strong> <span class="hl-attribute" style="color: #F5844C">name</span>=<span class="hl-value" style="color: #993300">"PROJECT"</span> <span class="hl-attribute" style="color: #F5844C">class</span>=<span class="hl-value" style="color: #993300">"org.apache.log4j.FileAppender"</span><strong class="hl-tag" style="color: #000096">&gt;</strong>
        <strong class="hl-tag" style="color: #000096">&lt;param</strong> <span class="hl-attribute" style="color: #F5844C">name</span>=<span class="hl-value" style="color: #993300">"file"</span> <span class="hl-attribute" style="color: #F5844C">value</span>=<span class="hl-value" style="color: #993300">"${loggingRoot}/${localHost}/myapp.log"</span><strong class="hl-tag" style="color: #000096"> /&gt;</strong>
        <strong class="hl-tag" style="color: #000096">&lt;param</strong> <span class="hl-attribute" style="color: #F5844C">name</span>=<span class="hl-value" style="color: #993300">"encoding"</span> <span class="hl-attribute" style="color: #F5844C">value</span>=<span class="hl-value" style="color: #993300">"${loggingCharset}"</span><strong class="hl-tag" style="color: #000096"> /&gt;</strong>
        <strong class="hl-tag" style="color: #000096">&lt;param</strong> <span class="hl-attribute" style="color: #F5844C">name</span>=<span class="hl-value" style="color: #993300">"append"</span> <span class="hl-attribute" style="color: #F5844C">value</span>=<span class="hl-value" style="color: #993300">"true"</span><strong class="hl-tag" style="color: #000096"> /&gt;</strong>
        <strong class="hl-tag" style="color: #000096">&lt;layout</strong> <span class="hl-attribute" style="color: #F5844C">class</span>=<span class="hl-value" style="color: #993300">"org.apache.log4j.PatternLayout"</span><strong class="hl-tag" style="color: #000096">&gt;</strong>
            <strong class="hl-tag" style="color: #000096">&lt;param</strong> <span class="hl-attribute" style="color: #F5844C">name</span>=<span class="hl-value" style="color: #993300">"ConversionPattern"</span>
                <span class="hl-attribute" style="color: #F5844C">value</span>=<span class="hl-value" style="color: #993300">"%n%-4r [%d{yyyy-MM-dd HH:mm:ss}] %X{productionMode} - %X{method} %X{requestURIWithQueryString} [ip=%X{remoteAddr}, ref=%X{referrer}, ua=%X{userAgent}, sid=%X{cookie.JSESSIONID}]%n  %-5level %logger{35} - %m%n"</span><strong class="hl-tag" style="color: #000096">
             /&gt;</strong>
        <strong class="hl-tag" style="color: #000096">&lt;/layout&gt;</strong>
    <strong class="hl-tag" style="color: #000096">&lt;/appender&gt;</strong>

    <strong class="hl-tag" style="color: #000096">&lt;root&gt;</strong>
        <strong class="hl-tag" style="color: #000096">&lt;level</strong> <span class="hl-attribute" style="color: #F5844C">value</span>=<span class="hl-value" style="color: #993300">"${loggingLevel}"</span><strong class="hl-tag" style="color: #000096"> /&gt;</strong>
        <strong class="hl-tag" style="color: #000096">&lt;appender-ref</strong> <span class="hl-attribute" style="color: #F5844C">ref</span>=<span class="hl-value" style="color: #993300">"STDOUT"</span><strong class="hl-tag" style="color: #000096"> /&gt;</strong>
        <strong class="hl-tag" style="color: #000096">&lt;appender-ref</strong> <span class="hl-attribute" style="color: #F5844C">ref</span>=<span class="hl-value" style="color: #993300">"STDERR"</span><strong class="hl-tag" style="color: #000096"> /&gt;</strong>
        <strong class="hl-tag" style="color: #000096">&lt;appender-ref</strong> <span class="hl-attribute" style="color: #F5844C">ref</span>=<span class="hl-value" style="color: #993300">"PROJECT"</span><strong class="hl-tag" style="color: #000096"> /&gt;</strong>
    <strong class="hl-tag" style="color: #000096">&lt;/root&gt;</strong>
<strong class="hl-tag" style="color: #000096">&lt;/log4j:configuration&gt;</strong></pre></div></div><p>更详细配置方法请参考log4j官方文档：<a class="link" href="http://logging.apache.org/log4j/1.2/manual.html" target="_top">http://logging.apache.org/log4j/1.2/manual.html</a>。</p><p>请特别留意示例中参数的写法，如“<code class="code">${loggingRoot}</code>”；以及appender
                        pattern中MDC参数的的写法，如：“<code class="code">%X{method}</code>”、“<code class="code">%X{requestURIWithQueryString}</code>”等。</p></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="d0e15674"><!--anchor d0e15674--></a>11.3.3. 同时初始化多个日志系统</h3></div></div></div><p>在某些遗留系统中，有些代码直接用到了Log4j API（例如Log4j
                Appender）。假如，我们仍然希望SLF4J以logback作为日志系统，但是保持这些老代码继续不变地使用log4j来记录日志。这样我们就需要同时初始化logback和log4j。</p><div class="example"><a id="d0e15679"><!--anchor d0e15679--></a><p class="title"><strong>例 11.10. 同时初始化Logback和Log4j</strong></p><div class="example-contents"><p>首先，你需要确保在<code class="filename">pom.xml</code>中，同时包含log4j和logback-classic这两个依赖，但是请<span class="emphasis"><em>一定不要包含slf4j-log4j12</em></span>这个包，因为它会和logback-classic起冲突。</p><p>下面的配置在<a class="xref" href="logging.html#webx.logging.logback.example.pom" title="例 11.1. 配置pom.xml以使用logback">例 11.1 “配置<code class="filename">pom.xml</code>以使用logback”</a>基础上，添加了log4j的依赖：</p><pre class="programlisting"><strong class="hl-tag" style="color: #000096">&lt;dependencies&gt;</strong>
    <strong class="hl-tag" style="color: #000096">&lt;dependency&gt;</strong>
        <strong class="hl-tag" style="color: #000096">&lt;groupId&gt;</strong>org.slf4j<strong class="hl-tag" style="color: #000096">&lt;/groupId&gt;</strong>
        <strong class="hl-tag" style="color: #000096">&lt;artifactId&gt;</strong>slf4j-api<strong class="hl-tag" style="color: #000096">&lt;/artifactId&gt;</strong>
    <strong class="hl-tag" style="color: #000096">&lt;/dependency&gt;</strong>
    <strong class="hl-tag" style="color: #000096">&lt;dependency&gt;</strong>
        <strong class="hl-tag" style="color: #000096">&lt;groupId&gt;</strong>org.slf4j<strong class="hl-tag" style="color: #000096">&lt;/groupId&gt;</strong>
        <strong class="hl-tag" style="color: #000096">&lt;artifactId&gt;</strong>jcl-over-slf4j<strong class="hl-tag" style="color: #000096">&lt;/artifactId&gt;</strong>
    <strong class="hl-tag" style="color: #000096">&lt;/dependency&gt;</strong>
    <strong class="hl-tag" style="color: #000096">&lt;dependency&gt;</strong>
        <strong class="hl-tag" style="color: #000096">&lt;groupId&gt;</strong>ch.qos.logback<strong class="hl-tag" style="color: #000096">&lt;/groupId&gt;</strong>
        <strong class="hl-tag" style="color: #000096">&lt;artifactId&gt;</strong>logback-classic<strong class="hl-tag" style="color: #000096">&lt;/artifactId&gt;</strong>
    <strong class="hl-tag" style="color: #000096">&lt;/dependency&gt;</strong><span class="emphasis"><em>
    &lt;dependency&gt;
        &lt;groupId&gt;log4j&lt;/groupId&gt;
        &lt;artifactId&gt;log4j&lt;/artifactId&gt;
    &lt;/dependency&gt;</em></span>
<strong class="hl-tag" style="color: #000096">&lt;/dependencies&gt;</strong>

<strong class="hl-tag" style="color: #000096">&lt;dependencyManagement&gt;</strong>
    <strong class="hl-tag" style="color: #000096">&lt;dependencies&gt;</strong>
        <strong class="hl-tag" style="color: #000096">&lt;dependency&gt;</strong>
            <strong class="hl-tag" style="color: #000096">&lt;groupId&gt;</strong>org.slf4j<strong class="hl-tag" style="color: #000096">&lt;/groupId&gt;</strong>
            <strong class="hl-tag" style="color: #000096">&lt;artifactId&gt;</strong>slf4j-api<strong class="hl-tag" style="color: #000096">&lt;/artifactId&gt;</strong>
            <strong class="hl-tag" style="color: #000096">&lt;version&gt;</strong>1.7.5<strong class="hl-tag" style="color: #000096">&lt;/version&gt;</strong>
        <strong class="hl-tag" style="color: #000096">&lt;/dependency&gt;</strong>
        <strong class="hl-tag" style="color: #000096">&lt;dependency&gt;</strong>
            <strong class="hl-tag" style="color: #000096">&lt;groupId&gt;</strong>org.slf4j<strong class="hl-tag" style="color: #000096">&lt;/groupId&gt;</strong>
            <strong class="hl-tag" style="color: #000096">&lt;artifactId&gt;</strong>jcl-over-slf4j<strong class="hl-tag" style="color: #000096">&lt;/artifactId&gt;</strong>
            <strong class="hl-tag" style="color: #000096">&lt;version&gt;</strong>1.7.5<strong class="hl-tag" style="color: #000096">&lt;/version&gt;</strong>
        <strong class="hl-tag" style="color: #000096">&lt;/dependency&gt;</strong>
        <strong class="hl-tag" style="color: #000096">&lt;dependency&gt;</strong>
            <strong class="hl-tag" style="color: #000096">&lt;groupId&gt;</strong>commons-logging<strong class="hl-tag" style="color: #000096">&lt;/groupId&gt;</strong>
            <strong class="hl-tag" style="color: #000096">&lt;artifactId&gt;</strong>commons-logging<strong class="hl-tag" style="color: #000096">&lt;/artifactId&gt;</strong>
            <strong class="hl-tag" style="color: #000096">&lt;version&gt;</strong>1.1.3<strong class="hl-tag" style="color: #000096">&lt;/version&gt;</strong>
            <strong class="hl-tag" style="color: #000096">&lt;scope&gt;</strong>provided<strong class="hl-tag" style="color: #000096">&lt;/scope&gt;</strong>
        <strong class="hl-tag" style="color: #000096">&lt;/dependency&gt;</strong>
        <strong class="hl-tag" style="color: #000096">&lt;dependency&gt;</strong>
            <strong class="hl-tag" style="color: #000096">&lt;groupId&gt;</strong>ch.qos.logback<strong class="hl-tag" style="color: #000096">&lt;/groupId&gt;</strong>
            <strong class="hl-tag" style="color: #000096">&lt;artifactId&gt;</strong>logback-classic<strong class="hl-tag" style="color: #000096">&lt;/artifactId&gt;</strong>
            <strong class="hl-tag" style="color: #000096">&lt;version&gt;</strong>1.0.13<strong class="hl-tag" style="color: #000096">&lt;/version&gt;</strong>
            <strong class="hl-tag" style="color: #000096">&lt;scope&gt;</strong>runtime<strong class="hl-tag" style="color: #000096">&lt;/scope&gt;</strong>
        <strong class="hl-tag" style="color: #000096">&lt;/dependency&gt;</strong><span class="emphasis"><em>
        &lt;dependency&gt;
            &lt;groupId&gt;log4j&lt;/groupId&gt;
            &lt;artifactId&gt;log4j&lt;/artifactId&gt;
            &lt;version&gt;1.2.17&lt;/version&gt;
            &lt;scope&gt;runtime&lt;/scope&gt;
        &lt;/dependency&gt;</em></span>
    <strong class="hl-tag" style="color: #000096">&lt;/dependencies&gt;</strong>
<strong class="hl-tag" style="color: #000096">&lt;/dependencyManagement&gt;</strong></pre><p>然后，你需要在<code class="filename">/WEB-INF/web.xml</code>中增加<code class="code">logSystem</code>参数。</p><p>下面的配置在<a class="xref" href="logging.html#webx.logging.webxml" title="例 11.6. 设置/WEB-INF/web.xml">例 11.6 “设置<code class="filename">/WEB-INF/web.xml</code>”</a>基础上，添加了所需的参数：</p><pre class="programlisting"><strong class="hl-tag" style="color: #000096">&lt;web-app&gt;</strong>
<span class="emphasis"><em>
    &lt;context-param&gt;
        &lt;param-name&gt;logSystem&lt;/param-name&gt;
        &lt;param-value&gt;log4j, logback&lt;/param-value&gt;
    &lt;/context-param&gt;</em></span>
    ...

<strong class="hl-tag" style="color: #000096">&lt;/web-app&gt;</strong></pre><p>以上这段<code class="filename">/WEB-INF/web.xml</code>的配置，告诉<code class="code">LogConfiguratorListener</code>同时初始化两个日志系统：log4j和logback。它们的配置文件分别是：<code class="filename">/WEB-INF/log4j.xml</code>和<code class="filename">/WEB-INF/logback.xml</code>。假如文件不存在也没关系，<code class="code">LogConfiguratorListener</code>会用系统默认的配置文件来初始化它们。</p></div></div></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="d0e15736"><!--anchor d0e15736--></a>11.4. 常见错误及解决</h2></div></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="d0e15739"><!--anchor d0e15739--></a>11.4.1. 查错技巧</h3></div></div></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="webx.logging.init.info"><!--anchor webx.logging.init.info--></a>11.4.1.1. 检查提示信息</h4></div></div></div><p>分析错误前，<span class="emphasis"><em>先检查一下日志系统输出的提示信息，往往可以节省很多时间</em></span>。当<code class="code">LogConfiguratorListener</code>启动时，将会在<code class="code">STDERR</code>中打印信息，像下面这个样子：</p><div class="example"><a id="d0e15756"><!--anchor d0e15756--></a><p class="title"><strong>例 11.11. 日志初始化时的提示信息（<code class="code">STDERR</code>）</strong></p><div class="example-contents"><pre class="screen">2010-06-02 16:57:28.021:INFO:/:Initializing log4j system <a id="co.log.init.info.logsys"><!--anchor co.log.init.info.logsys--></a><span class="calloutno"><img src="images/callouts/1.png" border="0"/></span>
INFO: configuring "log4j" using file:/Users/…/WEB-INF/log4j.xml <a id="co.log.init.info.logconf"><!--anchor co.log.init.info.logconf--></a><span class="calloutno"><img src="images/callouts/2.png" border="0"/></span>
 - with property localAddress = 10.16.58.5 <a id="co.log.init.info.param1"><!--anchor co.log.init.info.param1--></a><span class="calloutno"><img src="images/callouts/3.png" border="0"/></span>
 - with property localHost = baobao-macbook-pro.local <a id="co.log.init.info.param2"><!--anchor co.log.init.info.param2--></a><span class="calloutno"><img src="images/callouts/4.png" border="0"/></span>
 - with property loggingCharset = UTF-8 <a id="co.log.init.info.param3"><!--anchor co.log.init.info.param3--></a><span class="calloutno"><img src="images/callouts/5.png" border="0"/></span>
 - with property loggingLevel = warn <a id="co.log.init.info.param4"><!--anchor co.log.init.info.param4--></a><span class="calloutno"><img src="images/callouts/6.png" border="0"/></span>
 - with property loggingRoot = /tmp/logs <a id="co.log.init.info.param5"><!--anchor co.log.init.info.param5--></a><span class="calloutno"><img src="images/callouts/7.png" border="0"/></span></pre><div class="calloutlist"><p>通过这些信息，你可以检查如下内容：</p><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#co.log.init.info.logsys"><span class="calloutno"><img src="images/callouts/1.png" border="0"/></span></a> </p></td><td valign="top" align="left"><p>是否选择了正确的日志系统，如：log4j或logback，抑或两样都有。</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#co.log.init.info.logconf"><span class="calloutno"><img src="images/callouts/2.png" border="0"/></span></a> </p></td><td valign="top" align="left"><p>是否选择了正确的日志配置文件，如：<code class="filename">/WEB-INF/log4j.xml</code>。</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#co.log.init.info.param1"><span class="calloutno"><img src="images/callouts/3.png" border="0"/></span></a> <a href="#co.log.init.info.param2"><span class="calloutno"><img src="images/callouts/4.png" border="0"/></span></a> <a href="#co.log.init.info.param3"><span class="calloutno"><img src="images/callouts/5.png" border="0"/></span></a> <a href="#co.log.init.info.param4"><span class="calloutno"><img src="images/callouts/6.png" border="0"/></span></a> <a href="#co.log.init.info.param5"><span class="calloutno"><img src="images/callouts/7.png" border="0"/></span></a> </p></td><td valign="top" align="left"><p>日志文件的参数，如根目录、字符集编码、日志级别等信息。</p></td></tr></table></div></div></div></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="webx.logging.jwhich"><!--anchor webx.logging.jwhich--></a>11.4.1.2. 查看class真实归属的jar包位置</h4></div></div></div><p>有时，因为各种原因导致应用找到了错误的jar包，从而产生神秘的错误。例如，你以为你使用了SLF4J的最新版，然而在服务器上存在一个SLF4J的老版本，并且其class
                    loader优先级比新版本更高。在这种情况下，应用会引用高优先级class loader中的老版本的class。这可能导致错误。</p><p>发现这类错误的有效的方法，是在应用程序的任意点设置断点（利用eclipse远程调试功能），当系统停留在断点处时，执行如下的java代码，查看其值：</p><div class="example"><a id="d0e15799"><!--anchor d0e15799--></a><p class="title"><strong>例 11.12. 查看class真实归属的jar包位置</strong></p><div class="example-contents"><pre class="programlisting">getClass().getClassLoader().getResource(getClass().getName().replace(<strong class="hl-string"><em style="color:navy">'.'</em></strong>, <strong class="hl-string"><em style="color:navy">'/'</em></strong>) + <strong class="hl-string"><em style="color:navy">".class"</em></strong>)</pre></div></div><p>另外，Webx开发模式所提供的详细出错页面中，也会列出stacktrace中每一个class的真实jar包位置。</p></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="d0e15806"><!--anchor d0e15806--></a>11.4.2. 异常信息：No log system exists</h3></div></div></div><p>报这个错的原因可能是：</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>不存在slf4j-log4j12、logback-classic等任何一个日志系统的实现。</p></li><li class="listitem"><p>Slf4j的版本和日志系统的版本不匹配，例如，slf4j为1.4.3版，而slf4j-log4j12为1.7.5版。</p></li></ul></div><p>解决方法：</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>用<code class="code">mvn dependency:tree</code>命令查看所有的依赖包，排除以上错误。</p></li><li class="listitem"><p>查看服务器环境（如jboss），查看是不是存在不正确版本的jar包，被优先于应用jar包而加载了。参见<a class="xref" href="logging.html#webx.logging.jwhich" title="11.4.1.2. 查看class真实归属的jar包位置">第 11.4.1.2 节 “查看class真实归属的jar包位置”</a>。</p></li></ul></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="d0e15832"><!--anchor d0e15832--></a>11.4.3. 异常信息：<code class="code">NoSuchMethodError</code>:
                    <code class="code">org.slf4j.MDC.getCopyOfContextMap()</code></h3></div></div></div><p>报这个错的原因是：</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>SLF4J的版本过老。MDC.getCopyOfContextMap()方法是从SLF4J
                            1.5.1时加入的，假如你的SLF4J是之前的版本，就会报错。</p></li></ul></div><p>解决方法：</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>用<code class="code">mvn dependency:tree</code>查看所有的依赖包，排除以上错误。</p></li><li class="listitem"><p>查看服务器环境（如jboss），查看是不是存在不正确版本的jar包，被优先于应用jar包而加载了。 </p></li></ul></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="d0e15858"><!--anchor d0e15858--></a>11.4.4. <code class="code">STDERR</code>输出：Class path contains multiple SLF4J bindings</h3></div></div></div><p>SLF4J在<code class="code">STDERR</code>报如下错误：</p><div class="example"><a id="d0e15868"><!--anchor d0e15868--></a><p class="title"><strong>例 11.13. Class path contains multiple SLF4J bindings</strong></p><div class="example-contents"><pre class="screen">SLF4J: Class path contains multiple SLF4J bindings.
SLF4J: Found binding in [jar:file:/…/WEB-INF/lib/logback-classic-0.9.18.jar!/org/slf4j/impl/StaticLoggerBinder.class]
SLF4J: Found binding in [jar:file:/…/WEB-INF/lib/slf4j-log4j12-1.5.11.jar!/org/slf4j/impl/StaticLoggerBinder.class]
SLF4J: See http://www.slf4j.org/codes.html#multiple_bindings for an explanation.</pre></div></div><p>报这个错的原因是：</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>classpath中存在多个日志系统，使SLF4J无所适从。</p></li></ul></div><p>解决方法：</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>SLF4J已经列出了classpath中所有的日志系统的位置。根据这些信息，你可以调整应用的依赖，或者整理服务器的环境，使之只剩下一个日志系统。</p></li></ul></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="d0e15885"><!--anchor d0e15885--></a>11.4.5. 看不到日志输出</h3></div></div></div><p>原因可能是日志的配置文件可能有错。</p><p>解决方法：</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>首先，查看<code class="code">LogConfiguratorListener</code>输出到<code class="code">STDERR</code>中的信息（参见<a class="xref" href="logging.html#webx.logging.init.info" title="11.4.1.1. 检查提示信息">第 11.4.1.1 节 “检查提示信息”</a>），确定系统：</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem"><p>选择了正确的日志系统；</p></li><li class="listitem"><p>选择了正确的配置文件；</p></li><li class="listitem"><p>设置了正确的参数（<code class="code">loggingRoot</code>、<code class="code">loggingLevel</code>等）。</p></li></ul></div><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[注意]" src="images/note.png"/></td><th align="left">注意</th></tr><tr><td align="left" valign="top"><p>在JBOSS环境中，<code class="code">STDOUT</code>和<code class="code">STDERR</code>会被重定向到Log4j中，然后被输出到一个文件中，通常是<code class="filename">log/server.log</code>。你必须从这个日志文件中查看<code class="code">LogConfiguratorListener</code>的输出。</p></td></tr></table></div></li><li class="listitem"><p>假如以上信息均正确，查看日志配置文件<code class="filename">/WEB-INF/log4j.xml</code>或<code class="filename">/WEB-INF/logback.xml</code>，是否引用了正确的参数，例如：<code class="code">${loggingRoot}</code>、<code class="code">${loggingLevel}</code>等。</p></li><li class="listitem"><p>检查文件系统权限，确保应用有权限创建和修改日志文件。</p></li><li class="listitem"><p>假设你使用log4j作为日志系统，以jboss作为应用服务器。在JBOSS环境中，当log4j被初始化后，<code class="code">STDOUT</code>和<code class="code">STDERR</code>可能会被重新配置到不同的appender中。原先用来记录STDOUT和STDERR的日志文件<code class="filename">log/server.log</code>将不会再被使用。建议你设置<code class="filename">/WEB-INF/log4j.xml</code>，增加如下内容：</p><div class="example"><a id="d0e15968"><!--anchor d0e15968--></a><p class="title"><strong>例 11.14. 在log4j中配置jboss服务器日志</strong></p><div class="example-contents"><pre class="programlisting"><strong class="hl-tag" style="color: #000096">&lt;appender</strong> <span class="hl-attribute" style="color: #F5844C">name</span>=<span class="hl-value" style="color: #993300">"JBOSS_APPENDER"</span> <span class="hl-attribute" style="color: #F5844C">class</span>=<span class="hl-value" style="color: #993300">"org.apache.log4j.FileAppender"</span><strong class="hl-tag" style="color: #000096">&gt;</strong>
    <strong class="hl-tag" style="color: #000096">&lt;param</strong> <span class="hl-attribute" style="color: #F5844C">name</span>=<span class="hl-value" style="color: #993300">"file"</span> <span class="hl-attribute" style="color: #F5844C">value</span>=<span class="hl-value" style="color: #993300">"${loggingRootJboss}/server.log"</span><strong class="hl-tag" style="color: #000096"> /&gt;</strong>
    <strong class="hl-tag" style="color: #000096">&lt;param</strong> <span class="hl-attribute" style="color: #F5844C">name</span>=<span class="hl-value" style="color: #993300">"encoding"</span> <span class="hl-attribute" style="color: #F5844C">value</span>=<span class="hl-value" style="color: #993300">"${loggingCharset}"</span><strong class="hl-tag" style="color: #000096"> /&gt;</strong>
    <strong class="hl-tag" style="color: #000096">&lt;param</strong> <span class="hl-attribute" style="color: #F5844C">name</span>=<span class="hl-value" style="color: #993300">"append"</span> <span class="hl-attribute" style="color: #F5844C">value</span>=<span class="hl-value" style="color: #993300">"true"</span><strong class="hl-tag" style="color: #000096"> /&gt;</strong>
    <strong class="hl-tag" style="color: #000096">&lt;layout</strong> <span class="hl-attribute" style="color: #F5844C">class</span>=<span class="hl-value" style="color: #993300">"org.apache.log4j.PatternLayout"</span><strong class="hl-tag" style="color: #000096">&gt;</strong>
        <strong class="hl-tag" style="color: #000096">&lt;param</strong> <span class="hl-attribute" style="color: #F5844C">name</span>=<span class="hl-value" style="color: #993300">"ConversionPattern"</span>
            <span class="hl-attribute" style="color: #F5844C">value</span>=<span class="hl-value" style="color: #993300">"%n%-4r [%d{yyyy-MM-dd HH:mm:ss}] %X{productionMode} - %X{method} %X{requestURIWithQueryString} [ip=%X{remoteAddr}, ref=%X{referrer}, ua=%X{userAgent}, sid=%X{cookie.JSESSIONID}]%n  %-5level %logger{35} - %m%n"</span><strong class="hl-tag" style="color: #000096">
         /&gt;</strong>
    <strong class="hl-tag" style="color: #000096">&lt;/layout&gt;</strong>
<strong class="hl-tag" style="color: #000096">&lt;/appender&gt;</strong>

<strong class="hl-tag" style="color: #000096">&lt;logger</strong> <span class="hl-attribute" style="color: #F5844C">name</span>=<span class="hl-value" style="color: #993300">"STDOUT"</span><strong class="hl-tag" style="color: #000096">&gt;</strong>
    <strong class="hl-tag" style="color: #000096">&lt;appender-ref</strong> <span class="hl-attribute" style="color: #F5844C">ref</span>=<span class="hl-value" style="color: #993300">"JBOSS_APPENDER"</span><strong class="hl-tag" style="color: #000096"> /&gt;</strong>
<strong class="hl-tag" style="color: #000096">&lt;/logger&gt;</strong>
<strong class="hl-tag" style="color: #000096">&lt;logger</strong> <span class="hl-attribute" style="color: #F5844C">name</span>=<span class="hl-value" style="color: #993300">"STDERR"</span><strong class="hl-tag" style="color: #000096">&gt;</strong>
    <strong class="hl-tag" style="color: #000096">&lt;appender-ref</strong> <span class="hl-attribute" style="color: #F5844C">ref</span>=<span class="hl-value" style="color: #993300">"JBOSS_APPENDER"</span><strong class="hl-tag" style="color: #000096"> /&gt;</strong>
<strong class="hl-tag" style="color: #000096">&lt;/logger&gt;</strong></pre><p>这里用到了一个新的变量：<code class="code">${loggingRootJboss}</code>，你需要把它定义在<code class="filename">/WEB-INF/web.xml</code>中。</p><pre class="programlisting"><span class="hl-directive" style="color: maroon">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span>
<strong class="hl-tag" style="color: #000096">&lt;web-app&gt;</strong>
    ...
    <strong class="hl-tag" style="color: #000096">&lt;context-param&gt;</strong>
        <strong class="hl-tag" style="color: #000096">&lt;param-name&gt;</strong>loggingRootJboss<strong class="hl-tag" style="color: #000096">&lt;/param-name&gt;</strong>
        <strong class="hl-tag" style="color: #000096">&lt;param-value&gt;</strong>${jboss}/log<strong class="hl-tag" style="color: #000096">&lt;/param-value&gt;</strong>
    <strong class="hl-tag" style="color: #000096">&lt;/context-param&gt;</strong>
    ...
<strong class="hl-tag" style="color: #000096">&lt;/web-app&gt;</strong></pre></div></div><p>如果你使用logback作为日志系统，则不需要作如上配置。</p></li></ul></div></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="d0e15985"><!--anchor d0e15985--></a>11.5. 本章总结</h2></div></div></div><p><code class="code">LogConfiguratorListener</code>目前只提供了logback和log4j的支持，尽管支持一种新的日志系统是非常容易的，但现在看来，这两种日志系统已经足够我们使用了。</p><p><code class="code">LogConfiguratorListener</code>以SLF4J为基础。SLF4J还提供了更多的功能：</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>除了log4j和logback以外，SLF4J还支持几种其它的日志系统；</p></li><li class="listitem"><p>除了jcl-over-slf4j以外，SLF4J还提供了几种对其它legacy日志系统的桥接功能。</p></li></ul></div><p>详情请见SLF4J的文档：<a class="link" href="http://www.slf4j.org/docs.html" target="_top">http://www.slf4j.org/docs.html</a>。</p></div></div><div class="navfooter"><hr/><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="firstapp.html">上一页</a> </td><td width="20%" align="center"><a accesskey="u" href="pt04.html">上一级</a></td><td width="40%" align="right"> <a accesskey="n" href="pt05.html">下一页</a></td></tr><tr><td width="40%" align="left" valign="top">第 10 章 创建第一个Webx应用 </td><td width="20%" align="center"><a accesskey="h" href="index.html">起始页</a></td><td width="40%" align="right" valign="top"> 部分 V. 辅助工具</td></tr></table></div></body></html>