<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html
  PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"><head><title>第 13 章 AutoConfig工具使用指南</title><link rel="stylesheet" type="text/css" href="docbook.css"/><meta name="generator" content="DocBook XSL Stylesheets V1.77.1"/><link rel="home" href="index.html" title="Webx框架指南"/><link rel="up" href="pt05.html" title="部分 V. 辅助工具"/><link rel="prev" href="springext-plugin.html" title="第 12 章 安装和使用SpringExt插件"/><link rel="next" href="autoexpand.html" title="第 14 章 AutoExpand工具使用指南"/><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/></head><body><div class="navheader"><table width="100%" summary="Navigation header"><tr><th colspan="3" align="center">第 13 章 AutoConfig工具使用指南</th></tr><tr><td width="20%" align="left"><a accesskey="p" href="springext-plugin.html">上一页</a> </td><th width="60%" align="center">部分 V. 辅助工具</th><td width="20%" align="right"> <a accesskey="n" href="autoexpand.html">下一页</a></td></tr></table><hr/></div><div xml:lang="zh-CN" class="chapter"><div class="titlepage"><div><div><h2 class="title"><a id="tool.autoconfig"><!--anchor tool.autoconfig--></a>第 13 章 AutoConfig工具使用指南</h2></div></div></div><div class="toc"><dl><dt><span class="section"><a href="autoconfig.html#d0e16798">13.1. 需求分析</a></span></dt><dd><dl><dt><span class="section"><a href="autoconfig.html#d0e16845">13.1.1. 解决方案</a></span></dt></dl></dd><dt><span class="section"><a href="autoconfig.html#d0e17089">13.2. AutoConfig的设计</a></span></dt><dd><dl><dt><span class="section"><a href="autoconfig.html#d0e17094">13.2.1. 角色与职责</a></span></dt><dt><span class="section"><a href="autoconfig.html#d0e17190">13.2.2. 分享二进制目标文件</a></span></dt><dt><span class="section"><a href="autoconfig.html#d0e17218">13.2.3. 部署二进制目标文件</a></span></dt><dt><span class="section"><a href="autoconfig.html#d0e17234">13.2.4. AutoConfig特性列表</a></span></dt></dl></dd><dt><span class="section"><a href="autoconfig.html#d0e17303">13.3. AutoConfig的使用 —— 开发者指南</a></span></dt><dd><dl><dt><span class="section"><a href="autoconfig.html#d0e17306">13.3.1. 建立AutoConfig目录结构</a></span></dt><dt><span class="section"><a href="autoconfig.html#d0e17446">13.3.2. 建立auto-config.xml描述文件</a></span></dt><dt><span class="section"><a href="autoconfig.html#d0e17757">13.3.3. 建立模板文件</a></span></dt></dl></dd><dt><span class="section"><a href="autoconfig.html#d0e17901">13.4. AutoConfig的使用 —— 部署者指南</a></span></dt><dd><dl><dt><span class="section"><a href="autoconfig.html#d0e17913">13.4.1. 在命令行中使用AutoConfig</a></span></dt><dt><span class="section"><a href="autoconfig.html#d0e18021">13.4.2. 在maven中使用AutoConfig</a></span></dt><dt><span class="section"><a href="autoconfig.html#d0e18061">13.4.3. 运行并观察AutoConfig的结果</a></span></dt><dt><span class="section"><a href="autoconfig.html#d0e18132">13.4.4. 共享properties文件</a></span></dt><dt><span class="section"><a href="autoconfig.html#d0e18370">13.4.5. AutoConfig常用命令</a></span></dt></dl></dd><dt><span class="section"><a href="autoconfig.html#d0e18622">13.5. 本章总结</a></span></dt></dl></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="d0e16798"><!--anchor d0e16798--></a>13.1. 需求分析</h2></div></div></div><p>在一个应用中，我们总是会遇到一些参数，例如：</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>数据库服务器IP地址、端口、用户名；</p></li><li class="listitem"><p>用来保存上传资料的目录。</p></li><li class="listitem"><p>一些参数，诸如是否打开cache、加密所用的密钥名称等等。</p></li></ul></div><p>这些参数有一个共性，那就是：<span class="emphasis"><em>它们和应用的逻辑无关，只和当前环境、当前系统用户相关</em></span>。以下场景很常见：</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>在开发、测试、发布阶段，使用不同的数据库服务器；</p></li><li class="listitem"><p>在开发阶段，使用Windows的A开发者将用户上传的文件存放在<code class="filename">d:\my_upload</code>目录中，而使用Linux的B开发者将同样的文件存放在<code class="filename">/home/myname/my_upload</code>目录中。</p></li><li class="listitem"><p>在开发阶段设置<code class="code">cache=off</code>，在生产环境中设置<code class="code">cache=on</code>。 </p></li></ul></div><p>很明显，<span class="emphasis"><em>这些参数不适合被“硬编码”在配置文件或代码中</em></span>。因为每一个从源码库中取得它们的人，都有可能需要修改它们，使之与自己的环境相匹配。</p><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="d0e16845"><!--anchor d0e16845--></a>13.1.1. 解决方案</h3></div></div></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="d0e16848"><!--anchor d0e16848--></a>13.1.1.1. 运行时替换的placeholders</h4></div></div></div><p>很多框架支持在运行时刻替换配置文件中的placeholder占位符。例如， Webx/Spring就有这个功能。</p><div class="example"><a id="d0e16853"><!--anchor d0e16853--></a><p class="title"><strong>例 13.1. 在Webx中定义placeholders</strong></p><div class="example-contents"><pre class="programlisting"><strong class="hl-tag" style="color: #000096">&lt;services:property-placeholder /&gt;</strong>

<strong class="hl-tag" style="color: #000096">&lt;services:webx-configuration&gt;</strong>
    <strong class="hl-tag" style="color: #000096">&lt;services:productionMode&gt;</strong>${productionMode:true}<strong class="hl-tag" style="color: #000096">&lt;/services:productionMode&gt;</strong>
<strong class="hl-tag" style="color: #000096">&lt;/services:webx-configuration&gt;</strong></pre></div></div><p>在上面这个例子中，你可以在启动应用时，加上JVM参数：“<code class="code">-DproductionMode=false|true</code>”来告诉系统用哪一种模式来工作。如果不指定，则取默认值“<code class="code">true</code>”。</p><p>运行时替换placeholder是一种非常实用的技术，它有如下优缺点：</p><div class="table"><a id="d0e16868"><!--anchor d0e16868--></a><p class="title"><strong>表 13.1. 运行时替换placeholders的优缺点</strong></p><div class="table-contents"><table summary="运行时替换placeholders的优缺点" cellpadding="10" style="border: none;"><colgroup><col width="50%" class="c1"/><col width="50%" class="c2"/></colgroup><thead><tr><th style="border-right: 0.5pt solid #6666cc; border-bottom: 0.5pt solid #6666cc; ">优点</th><th style="border-bottom: 0.5pt solid #6666cc; ">缺点</th></tr></thead><tbody><tr><td style="border-right: 0.5pt solid #6666cc; ">
                                    <div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>配置文件是静态的、不变的。即使采用不同的参数值，你也不需要更改配置文件本身。</p></li><li class="listitem"><p>你可以随时改变参数的值，只需要启动时指定不同的JVM参数、或指定不同的properties文件即可。</p></li><li class="listitem"><p>这种配置对于应用程序各组件是透明的 ——
                                                应用程序不需要做特别的编程，即可使用placeholders。</p></li></ul></div>
                                </td><td style="">
                                    <div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>并非所有框架都支持这种技术。</p></li><li class="listitem"><p>支持该技术的框架各有不同的用法。例如：Spring和Log4j都支持placeholder替换，然则它们的做法是完全不同的。Spring通过<code class="code">PropertyPlaceholderConfigurer</code>类来配置，而Log4j则需要在<code class="code">DomConfigurator</code>中把参数传进去。</p></li></ul></div>
                                </td></tr></tbody></table></div></div></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="d0e16911"><!--anchor d0e16911--></a>13.1.1.2. 中心配置服务器（Config Server）</h4></div></div></div><p>这也是一种运行时技术。它可以在运行时刻，将应用所需的参数推送到应用中。</p><p>它有如下优缺点：</p><div class="table"><a id="d0e16918"><!--anchor d0e16918--></a><p class="title"><strong>表 13.2. 中心配置服务器的优缺点</strong></p><div class="table-contents"><table summary="中心配置服务器的优缺点" cellpadding="10" style="border: none;"><colgroup><col width="50%" class="c1"/><col width="50%" class="c2"/></colgroup><thead><tr><th style="border-right: 0.5pt solid #6666cc; border-bottom: 0.5pt solid #6666cc; ">优点</th><th style="border-bottom: 0.5pt solid #6666cc; ">缺点</th></tr></thead><tbody><tr><td style="border-right: 0.5pt solid #6666cc; ">
                                    <div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>它可以集中管理所有应用的配置，避免可能的错误；</p></li><li class="listitem"><p>它可以在运行时改变参数的值，并推送到所有应用中。参数的更改可立即生效。</p></li></ul></div>
                                </td><td style="">
                                    <div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>需要一套独立的服务器系统。性能、可用性（availability）都是必须考虑的问题。</p></li><li class="listitem"><p>对应用不是透明的，有一定的侵入性。应用程序必须主动来配合该技术。因此，该技术不可能适用于所有情况，特别对于第三方提供的代码，很难使用该技术。</p></li><li class="listitem"><p>为了连接到中心配置服务器，你仍然需要配置适当的IP、端口等参数。你需要用其它技术来处理这些参数（例如placeholders）。</p></li></ul></div>
                                </td></tr></tbody></table></div></div></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="d0e16955"><!--anchor d0e16955--></a>13.1.1.3. Maven Filtering机制</h4></div></div></div><p>Maven提供了一种过滤机制，可以在资源文件被复制到目标目录的同时，替换其中的placeholders。</p><div class="example"><a id="d0e16960"><!--anchor d0e16960--></a><p class="title"><strong>例 13.2. 配置Maven Filtering机制</strong></p><div class="example-contents"><p>假设你的项目目录结构如下：</p><pre class="screen">web-project
 │  pom.xml
 │
 └─src
     └─main
         ├─java
         ├─resources
         └─webapp
             └─WEB-INF
                     web.xml</pre><p>在<code class="filename">pom.xml</code>中这样写：</p><pre class="programlisting"><strong class="hl-tag" style="color: #000096">&lt;build&gt;</strong>
    <strong class="hl-tag" style="color: #000096">&lt;filters&gt;</strong>
        <strong class="hl-tag" style="color: #000096">&lt;filter&gt;</strong>${user.home}/antx.properties<strong class="hl-tag" style="color: #000096">&lt;/filter&gt;</strong> <a id="co.autoconfig.mavenfilters.props"><!--anchor co.autoconfig.mavenfilters.props--></a><span class="calloutno"><img src="images/callouts/1.png" border="0"/></span>
    <strong class="hl-tag" style="color: #000096">&lt;/filters&gt;</strong>
    <strong class="hl-tag" style="color: #000096">&lt;resources&gt;</strong>
        <strong class="hl-tag" style="color: #000096">&lt;resource&gt;</strong>
            <strong class="hl-tag" style="color: #000096">&lt;directory&gt;</strong>src/main/resources<strong class="hl-tag" style="color: #000096">&lt;/directory&gt;</strong> <a id="co.autoconfig.mavenfilters.resources"><!--anchor co.autoconfig.mavenfilters.resources--></a><span class="calloutno"><img src="images/callouts/2.png" border="0"/></span>
            <strong class="hl-tag" style="color: #000096">&lt;includes&gt;</strong>
                <strong class="hl-tag" style="color: #000096">&lt;include&gt;</strong>**.xml<strong class="hl-tag" style="color: #000096">&lt;/include&gt;</strong>
            <strong class="hl-tag" style="color: #000096">&lt;/includes&gt;</strong>
            <strong class="hl-tag" style="color: #000096">&lt;filtering&gt;</strong>true<strong class="hl-tag" style="color: #000096">&lt;/filtering&gt;</strong>
        <strong class="hl-tag" style="color: #000096">&lt;/resource&gt;</strong>
        <strong class="hl-tag" style="color: #000096">&lt;resource&gt;</strong>
            <strong class="hl-tag" style="color: #000096">&lt;directory&gt;</strong>src/main/resources<strong class="hl-tag" style="color: #000096">&lt;/directory&gt;</strong>
            <strong class="hl-tag" style="color: #000096">&lt;excludes&gt;</strong>
                <strong class="hl-tag" style="color: #000096">&lt;exclude&gt;</strong>**.xml<strong class="hl-tag" style="color: #000096">&lt;/exclude&gt;</strong>
            <strong class="hl-tag" style="color: #000096">&lt;/excludes&gt;</strong>
        <strong class="hl-tag" style="color: #000096">&lt;/resource&gt;</strong>
    <strong class="hl-tag" style="color: #000096">&lt;/resources&gt;</strong>
    <strong class="hl-tag" style="color: #000096">&lt;plugins&gt;</strong>
        <strong class="hl-tag" style="color: #000096">&lt;plugin&gt;</strong>
            <strong class="hl-tag" style="color: #000096">&lt;artifactId&gt;</strong>maven-war-plugin<strong class="hl-tag" style="color: #000096">&lt;/artifactId&gt;</strong>
            <strong class="hl-tag" style="color: #000096">&lt;configuration&gt;</strong>
                <strong class="hl-tag" style="color: #000096">&lt;webResources&gt;</strong>
                    <strong class="hl-tag" style="color: #000096">&lt;resource&gt;</strong>
                        <strong class="hl-tag" style="color: #000096">&lt;directory&gt;</strong>src/main/webapp<strong class="hl-tag" style="color: #000096">&lt;/directory&gt;</strong> <a id="co.autoconfig.mavenfilters.resources.web"><!--anchor co.autoconfig.mavenfilters.resources.web--></a><span class="calloutno"><img src="images/callouts/3.png" border="0"/></span>
                        <strong class="hl-tag" style="color: #000096">&lt;includes&gt;</strong>
                            <strong class="hl-tag" style="color: #000096">&lt;include&gt;</strong>WEB-INF/**.xml<strong class="hl-tag" style="color: #000096">&lt;/include&gt;</strong>
                        <strong class="hl-tag" style="color: #000096">&lt;/includes&gt;</strong>
                        <strong class="hl-tag" style="color: #000096">&lt;filtering&gt;</strong>true<strong class="hl-tag" style="color: #000096">&lt;/filtering&gt;</strong>
                    <strong class="hl-tag" style="color: #000096">&lt;/resource&gt;</strong>
                    <strong class="hl-tag" style="color: #000096">&lt;resource&gt;</strong>
                        <strong class="hl-tag" style="color: #000096">&lt;directory&gt;</strong>src/main/webapp<strong class="hl-tag" style="color: #000096">&lt;/directory&gt;</strong>
                        <strong class="hl-tag" style="color: #000096">&lt;excludes&gt;</strong>
                            <strong class="hl-tag" style="color: #000096">&lt;include&gt;</strong>WEB-INF/**.xml<strong class="hl-tag" style="color: #000096">&lt;/include&gt;</strong>
                        <strong class="hl-tag" style="color: #000096">&lt;/excludes&gt;</strong>
                    <strong class="hl-tag" style="color: #000096">&lt;/resource&gt;</strong>
                <strong class="hl-tag" style="color: #000096">&lt;/webResources&gt;</strong>
            <strong class="hl-tag" style="color: #000096">&lt;/configuration&gt;</strong>
        <strong class="hl-tag" style="color: #000096">&lt;/plugin&gt;</strong>
    <strong class="hl-tag" style="color: #000096">&lt;/plugins&gt;</strong>
<strong class="hl-tag" style="color: #000096">&lt;/build&gt;</strong></pre><p>这段pom定义告诉maven：</p><div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#co.autoconfig.mavenfilters.props"><span class="calloutno"><img src="images/callouts/1.png" border="0"/></span></a> </p></td><td valign="top" align="left"><p>用指定的properties文件（<code class="filename">${user.home}/antx.properties</code>）中的值，替换文件中的placeholders。</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#co.autoconfig.mavenfilters.resources"><span class="calloutno"><img src="images/callouts/2.png" border="0"/></span></a> </p></td><td valign="top" align="left"><p>过滤<code class="filename">src/main/resources/</code>目录中的所有xml文件，替换其中的placeholders。</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#co.autoconfig.mavenfilters.resources.web"><span class="calloutno"><img src="images/callouts/3.png" border="0"/></span></a> </p></td><td valign="top" align="left"><p>过滤<code class="filename">src/webapp/WEB-INF/</code>目录中的所有xml文件，替换其中的placeholders。</p></td></tr></table></div></div></div><p>如果上述xml文件中，包含“<code class="code">${xxx.yyy.zzz}</code>”这样的placeholders，将被替换成properties文件中的相应值。</p><p>和运行时替换placeholders方案相比，Maven Filtering是一个build时进行的过程。它的优缺点是： </p><div class="table"><a id="d0e17008"><!--anchor d0e17008--></a><p class="title"><strong>表 13.3. Maven Filtering机制的优缺点</strong></p><div class="table-contents"><table summary="Maven Filtering机制的优缺点" cellpadding="10" style="border: none;"><colgroup><col width="50%" class="c1"/><col width="50%" class="c2"/></colgroup><thead><tr><th style="border-right: 0.5pt solid #6666cc; border-bottom: 0.5pt solid #6666cc; ">优点</th><th style="border-bottom: 0.5pt solid #6666cc; ">缺点</th></tr></thead><tbody><tr><td style="border-right: 0.5pt solid #6666cc; ">
                                    <div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>Maven
                                                filtering机制和应用所采用的技术、框架完全无关，对应用完全透明，通用性好。</p></li></ul></div>
                                </td><td style="">
                                    <div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>Maven
                                                filtering机制在build时刻永久性改变被过滤的配置文件的内容，build结束以后无法更改。这将导致一个问题：如果要改变配置文件的参数，必须获取源码并重新build。</p></li><li class="listitem"><p>缺少验证机制。当某个placeholder拼写错误；当properties中的值写错；当某配置文件中新增了一个placeholder，而你的properties文件中没有对应的值时，maven不会提醒你。而这些错误往往被拖延到应用程序运行时才会被报告出来。</p></li></ul></div>
                                </td></tr></tbody></table></div></div></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="d0e17039"><!--anchor d0e17039--></a>13.1.1.4. AutoConfig机制</h4></div></div></div><p>AutoConfig是一种类似于Maven
                    Filtering的<span class="emphasis"><em>build时刻的工具</em></span>。这意味着该机制与应用所采用的技术、框架完全无关，对应用完全透明，具有良好的通用性。同时，AutoConfig与运行时的配置技术并不冲突。它可以和运行时替换的placeholders以及中心配置服务器完美并存，互为补充。</p><p>AutoConfig书写placeholder的方法和Maven Filtering机制完全相同。换言之，Maven
                        Filtering的配置文件模板（前例中的<code class="filename">/WEB-INF/**.xml</code>）可以不加修改地用在AutoConfig中。</p><p>然而，autoconfig成功克服了Maven Filtering的主要问题。</p><div class="table"><a id="d0e17054"><!--anchor d0e17054--></a><p class="title"><strong>表 13.4. Maven Filtering和AutoConfig的比较</strong></p><div class="table-contents"><table summary="Maven Filtering和AutoConfig的比较" cellpadding="10" style="border: none;"><colgroup><col width="33%" class="c1"/><col width="33%" class="c2"/><col width="34%" class="c3"/></colgroup><thead><tr><th style="border-right: 0.5pt solid #6666cc; border-bottom: 0.5pt solid #6666cc; ">问题</th><th style="border-right: 0.5pt solid #6666cc; border-bottom: 0.5pt solid #6666cc; ">Maven Filtering</th><th style="border-bottom: 0.5pt solid #6666cc; ">AutoConfig</th></tr></thead><tbody><tr><td style="border-right: 0.5pt solid #6666cc; border-bottom: 0.5pt solid #6666cc; ">如何修改配置文件的参数？</td><td style="border-right: 0.5pt solid #6666cc; border-bottom: 0.5pt solid #6666cc; ">Maven Filtering必须获得源码并重新build；</td><td style="border-bottom: 0.5pt solid #6666cc; ">而AutoConfig不需要提取源码，也不需要重新build，即可改变<span class="emphasis"><em>目标文件</em></span>中所有配置文件中placeholders的值。</td></tr><tr><td style="border-right: 0.5pt solid #6666cc; ">如何确保placeholder替换的正确性？</td><td style="border-right: 0.5pt solid #6666cc; ">Maven Filtering不能验证placeholder值的缺失和错误；</td><td style="">但AutoConfig可以对placeholder及其值进行检查。</td></tr></tbody></table></div></div><p>接下来，我们将将详细介绍AutoConfig的使用方法。</p></div></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="d0e17089"><!--anchor d0e17089--></a>13.2. AutoConfig的设计</h2></div></div></div><p>很多人会把AutoConfig看作Maven Filtering机制的简单替代品。事实上，这两者的设计初衷有很大的区别。</p><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="d0e17094"><!--anchor d0e17094--></a>13.2.1. 角色与职责</h3></div></div></div><p>为了把事情说清楚，我们必须要定义两种角色：<span class="emphasis"><em>开发者（Developer）</em></span>和<span class="emphasis"><em>部署者（Deployer）</em></span>。</p><div class="table"><a id="d0e17105"><!--anchor d0e17105--></a><p class="title"><strong>表 13.5. 角色和职责</strong></p><div class="table-contents"><table summary="角色和职责" cellpadding="10" style="border: none;"><colgroup><col width="30%" class="c1"/><col width="70%" class="c2"/></colgroup><thead><tr><th style="border-right: 0.5pt solid #6666cc; border-bottom: 0.5pt solid #6666cc; ">角色名称</th><th style="border-bottom: 0.5pt solid #6666cc; ">职责</th></tr></thead><tbody><tr><td style="border-right: 0.5pt solid #6666cc; border-bottom: 0.5pt solid #6666cc; ">开发者</td><td style="border-bottom: 0.5pt solid #6666cc; ">
                                <div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>定义应用所需要的properties，及其限定条件；</p></li><li class="listitem"><p>提供包含placeholders的配置文件模板。</p></li></ul></div>
                            </td></tr><tr><td style="border-right: 0.5pt solid #6666cc; ">部署者</td><td style="">
                                <div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>根据所定义的properties，提供符合限定条件的属性值。</p></li><li class="listitem"><p>调用AutoConfig来生成目标配置文件。</p></li></ul></div>
                            </td></tr></tbody></table></div></div><p>例如，一个宠物店（petstore）的WEB应用中需要指定一个用来上传文件的目录。于是，</p><div class="table"><a id="d0e17146"><!--anchor d0e17146--></a><p class="title"><strong>表 13.6. Petstore应用中的角色和职责</strong></p><div class="table-contents"><table summary="Petstore应用中的角色和职责" cellpadding="10" style="border: none;"><colgroup><col width="50%" class="c1"/><col width="50%" class="c2"/></colgroup><thead><tr><th style="border-right: 0.5pt solid #6666cc; border-bottom: 0.5pt solid #6666cc; ">开发者</th><th style="border-bottom: 0.5pt solid #6666cc; ">部署者</th></tr></thead><tbody><tr><td style="border-right: 0.5pt solid #6666cc; ">
                                <p>开发者定义了一个property：<code class="code">petstore.upload_dir</code>，</p>
                                <p>限定条件为：“合法的文件系统的目录名”。</p>
                            </td><td style="">
                                <p>部署者取得petstore的二进制发布包，通过AutoConfig了解到，应用需要一个名为<code class="code">petstore.upload_dir</code>目录名。</p>
                                <p>部署者便指定一个目录给petstore，该目录名的具体值可能因不同的系统而异。</p>
                                <p>AutoConfig会检验该值是否符合限定条件（是否为合法目录名），如果检验通过，就生成配置文件，并将其中的<code class="code">${petstore.upload_dir}</code>替换成该目录名。</p>
                            </td></tr></tbody></table></div></div><p>需要注意的是，一个“物理人”所对应的“角色”不是一成不变的。例如：某“开发者”需要试运行应用，此时，他就变成“部署者”。</p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="d0e17190"><!--anchor d0e17190--></a>13.2.2. 分享二进制目标文件</h3></div></div></div><p>假设现在有两个team要互相合作，team A的开发者创建了project A，而team B的开发者创建了project B。假定project
                B依赖于project A。如果我们利用maven这样的build工具，那么最显而易见的合作方案是这样的：</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>Team A发布一个project A的版本到maven repository中。</p></li><li class="listitem"><p>Team B从maven repository中取得project A的二进制目标文件。</p></li></ul></div><p>这种方案有很多好处，</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>每个team都可以独立控制自己发布版本的节奏；</p></li><li class="listitem"><p>Team之间的关系较松散，唯一的关系纽带就是maven repository。</p></li><li class="listitem"><p>Team之间不需要共享源码。</p></li></ul></div><p>然而，假如project A中有一些配置文件中的placeholders需要被替换，如果使用Maven Filtering机制，就会出现问题。因为Maven
                Filtering只能在project A被build时替换其中的placeholders，一旦project A被发布到repository中，team
                B的人将无法修改任何project A中的配置参数。除非team B的人取得project A的源码，并重新build。这将带来很大的负担。</p><p>AutoConfig解决了这个问题。因为当team B的人从maven repository中取得project
                A的二进制包时，仍然有机会修改其配置文件里的placeholders。Team B的人甚至不需要了解project
                A里配置文件的任何细节，AutoConfig会自动发现所有的properties定义，并提示编辑。</p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="d0e17218"><!--anchor d0e17218--></a>13.2.3. 部署二进制目标文件</h3></div></div></div><p>部署应用的人（即部署者、deployer）也从中受益。因为deployer不再需要亲手去build源代码，而是从maven
                repository中取得二进制目标文件即可。</p><div class="figure"><a id="d0e17223"><!--anchor d0e17223--></a><div class="figure-contents"><div class="mediaobject"><img src="images/tool/co-op.png" alt="多团队多角色的合作"/></div></div><p class="title"><strong>图 13.1. 多团队多角色的合作</strong></p></div><p>从这个意义上讲，AutoConfig不应当被看成是一个build时的简单配置工具，而是一个“<span class="emphasis"><em>软件安装工具</em></span>”。如同我们安装一个Windows软件
                ——
                我们当然不需要从源码开始build它们，而是执行其安装程序，设定一些参数诸如安装目录、文档目录、可选项等。安装程序就会自动把软件设置好，确保软件可正确运行于当前的Windows环境中。</p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="d0e17234"><!--anchor d0e17234--></a>13.2.4. AutoConfig特性列表</h3></div></div></div><p>为了满足前面所说的目的，我们将AutoConfig设计成下面的样子：</p><div class="table"><a id="d0e17239"><!--anchor d0e17239--></a><p class="title"><strong>表 13.7. AutoConfig Features</strong></p><div class="table-contents"><table summary="AutoConfig Features" cellpadding="10" style="border: none;"><colgroup><col width="28%" class="c1"/><col width="72%" class="c2"/></colgroup><thead><tr><th style="border-right: 0.5pt solid #6666cc; border-bottom: 0.5pt solid #6666cc; ">名称</th><th style="border-bottom: 0.5pt solid #6666cc; ">描述</th></tr></thead><tbody><tr><td style="border-right: 0.5pt solid #6666cc; border-bottom: 0.5pt solid #6666cc; ">两种用法</td><td style="border-bottom: 0.5pt solid #6666cc; ">
                                <div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>既可独立使用（支持Windows和Unix-like平台）。</p></li><li class="listitem"><p>也可以作为maven插件来使用。</p></li></ul></div>
                            </td></tr><tr><td style="border-right: 0.5pt solid #6666cc; border-bottom: 0.5pt solid #6666cc; ">对目标文件而不是源文件进行配置</td><td style="border-bottom: 0.5pt solid #6666cc; ">
                                <div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>可对同一个目标文件反复配置。</p></li><li class="listitem"><p>配置时不依赖于项目源文件。</p></li><li class="listitem"><p>支持嵌套包文件，例如：ear包含war，war又包含jar。</p></li><li class="listitem"><p>高性能，特别对于嵌套的包文件。 </p></li></ul></div>
                            </td></tr><tr><td style="border-right: 0.5pt solid #6666cc; ">验证和编辑properties</td><td style="">
                                <div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>自动发现保存于war包、jar包、ear包中的properties定义。</p></li><li class="listitem"><p>验证properties的正确性。</p></li><li class="listitem"><p>交互式编辑properties。</p></li><li class="listitem"><p>当配置文件中出现未定义的placeholders时，提示报错。 </p></li></ul></div>
                            </td></tr></tbody></table></div></div></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="d0e17303"><!--anchor d0e17303--></a>13.3. AutoConfig的使用 —— 开发者指南</h2></div></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="d0e17306"><!--anchor d0e17306--></a>13.3.1. 建立AutoConfig目录结构</h3></div></div></div><p>和Maven
                    Filtering不同的是，AutoConfig是针对目标文件的配置工具。因此AutoConfig关心的目录结构是<span class="emphasis"><em>目标文件的目录结构</em></span>。不同的build工具，创建同一目标目录结构所需要的源文件的目录结构会各有不同。本文仅以maven标准目录结构为例，来说明源文件的目录结构编排。</p><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="d0e17314"><!--anchor d0e17314--></a>13.3.1.1. WAR包的目录结构</h4></div></div></div><p>这里所说的war包，可以是一个以zip方式打包的文件，也可以是一个展开的目录。下面以maven标准目录为例，说明项目源文件和目标文件的目录结构的对比：</p><div class="example"><a id="d0e17319"><!--anchor d0e17319--></a><p class="title"><strong>例 13.3. WAR包的源文件和目标文件目录结构</strong></p><div class="example-contents"><pre class="screen">war-project（源目录结构）               -&gt; war-project.war（目标目录结构）
 │  pom.xml
 │
 └─src
     └─main
         ├─java
         ├─resources                    -&gt; /WEB-INF/classes
         │      file1.xml                      file1.xml
         │      file2.xml                      file2.xml
         │
         └─webapp                       -&gt; /
             ├─<span class="emphasis"><em>META-INF</em></span>                 -&gt; <span class="emphasis"><em>/META-INF</em></span>
             │  └─<span class="emphasis"><em>autoconf</em></span>              -&gt; <span class="emphasis"><em>/META-INF/autoconf</em></span> <a id="co.autoconfig.war.config.dir"><!--anchor co.autoconfig.war.config.dir--></a><span class="calloutno"><img src="images/callouts/1.png" border="0"/></span>
             │        <span class="emphasis"><em>auto-config.xml</em></span>          <span class="emphasis"><em>auto-config.xml</em></span> <a id="co.autoconfig.war.config"><!--anchor co.autoconfig.war.config--></a><span class="calloutno"><img src="images/callouts/2.png" border="0"/></span>
             │
             └─WEB-INF                  -&gt; /WEB-INF
                   web.xml                     web.xml
                   file3.xml                   file3.xml</pre><div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#co.autoconfig.war.config.dir"><span class="calloutno"><img src="images/callouts/1.png" border="0"/></span></a> </p></td><td valign="top" align="left"><p><code class="filename">/META-INF/autoconf</code>目录用来存放AutoConfig的描述文件，以及可选的模板文件。</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#co.autoconfig.war.config"><span class="calloutno"><img src="images/callouts/2.png" border="0"/></span></a> </p></td><td valign="top" align="left"><p><code class="filename">auto-config.xml</code>是用来指导AutoConfig行为的关键描述文件。</p></td></tr></table></div></div></div><p>创建war包的AutoConfig机制，关键在于创建war目标文件中的<code class="filename">/META-INF/autoconf/auto-config.xml</code>描述文件。该描述文件对应的maven项目源文件为：<code class="filename">/src/main/webapp/META-INF/autoconf/auto-config.xml</code>。</p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="d0e17365"><!--anchor d0e17365--></a>13.3.1.2. JAR包的目录结构</h4></div></div></div><p>这里所说的jar包，可以是一个以zip方式打包的文件，也可以是一个展开的目录。下面以maven标准目录为例，说明项目源文件和目标文件的目录结构的对比：</p><div class="example"><a id="d0e17370"><!--anchor d0e17370--></a><p class="title"><strong>例 13.4. JAR包的源文件和目标文件目录结构</strong></p><div class="example-contents"><pre class="screen">jar-project（源目录结构）               -&gt; jar-project.jar（目标目录结构）
 │  pom.xml
 │
 └─src
     └─main
         ├─java
         └─resources                    -&gt; /
             │  file1.xml                      file1.xml
             │  file2.xml                      file2.xml
             │
             └─<span class="emphasis"><em>META-INF</em></span>                 -&gt; <span class="emphasis"><em>/META-INF</em></span>
                 └─<span class="emphasis"><em>autoconf</em></span>             -&gt; <span class="emphasis"><em>/META-INF/autoconf</em></span> <a id="co.autoconfig.jar.config.dir"><!--anchor co.autoconfig.jar.config.dir--></a><span class="calloutno"><img src="images/callouts/1.png" border="0"/></span>
                       <span class="emphasis"><em>auto-config.xml</em></span>         <span class="emphasis"><em>auto-config.xml</em></span> <a id="co.autoconfig.jar.config"><!--anchor co.autoconfig.jar.config--></a><span class="calloutno"><img src="images/callouts/2.png" border="0"/></span></pre><div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#co.autoconfig.jar.config.dir"><span class="calloutno"><img src="images/callouts/1.png" border="0"/></span></a> </p></td><td valign="top" align="left"><p><code class="filename">/META-INF/autoconf</code>目录用来存放AutoConfig的描述文件，以及可选的模板文件。</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#co.autoconfig.jar.config"><span class="calloutno"><img src="images/callouts/2.png" border="0"/></span></a> </p></td><td valign="top" align="left"><p><code class="filename">auto-config.xml</code>是用来指导AutoConfig行为的关键描述文件。</p></td></tr></table></div></div></div><p>创建jar包的AutoConfig机制，关键在于创建jar目标文件中的<code class="filename">/META-INF/autoconf/auto-config.xml</code>描述文件。该描述文件对应的maven项目源文件为：<code class="filename">/src/main/resources/META-INF/autoconf/auto-config.xml</code>。</p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="d0e17415"><!--anchor d0e17415--></a>13.3.1.3. 普通目录</h4></div></div></div><p>AutoConfig也支持对普通文件目录进行配置。</p><div class="example"><a id="d0e17420"><!--anchor d0e17420--></a><p class="title"><strong>例 13.5. 对普通的目录执行AutoConfig</strong></p><div class="example-contents"><pre class="screen">directory
 │  file1.xml
 │  file2.xml
 │
 └─<span class="emphasis"><em>conf</em></span> <a id="co.autoconfig.dir.config.dir"><!--anchor co.autoconfig.dir.config.dir--></a><span class="calloutno"><img src="images/callouts/1.png" border="0"/></span>
       <span class="emphasis"><em>auto-config.xml</em></span> <a id="co.autoconfig.dir.config"><!--anchor co.autoconfig.dir.config--></a><span class="calloutno"><img src="images/callouts/2.png" border="0"/></span></pre><div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#co.autoconfig.dir.config.dir"><span class="calloutno"><img src="images/callouts/1.png" border="0"/></span></a> </p></td><td valign="top" align="left"><p>默认情况下，AutoConfig在<code class="filename">/conf</code>目录中寻找AutoConfig的描述文件，以及可选的模板文件。</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#co.autoconfig.dir.config"><span class="calloutno"><img src="images/callouts/2.png" border="0"/></span></a> </p></td><td valign="top" align="left"><p><code class="filename">auto-config.xml</code>是用来指导AutoConfig行为的关键描述文件。</p></td></tr></table></div></div></div></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="d0e17446"><!--anchor d0e17446--></a>13.3.2. 建立auto-config.xml描述文件</h3></div></div></div><p>AutoConfig系统的核心就是<code class="filename">auto-config.xml</code>描述文件。该描述文件中包含两部分内容：</p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><p>定义properties：properties的名称、描述、默认值、约束条件等信息；</p></li><li class="listitem"><p>指定包含placeholders的模板文件。 </p></li></ol></div><p>下面是<code class="filename">auto-config.xml</code>文件的样子：（以petstore应用为例）</p><div class="example"><a id="d0e17466"><!--anchor d0e17466--></a><p class="title"><strong>例 13.6. AutoConfig描述文件示例</strong></p><div class="example-contents"><pre class="programlisting"><span class="hl-directive" style="color: maroon">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span>
<strong class="hl-tag" style="color: #000096">&lt;config&gt;</strong>
    <strong class="hl-tag" style="color: #000096">&lt;group&gt;</strong>

        <strong class="hl-tag" style="color: #000096">&lt;property</strong> <span class="hl-attribute" style="color: #F5844C">name</span>=<span class="hl-value" style="color: #993300">"petstore.work"</span>
                    <span class="hl-attribute" style="color: #F5844C">description</span>=<span class="hl-value" style="color: #993300">"应用程序的工作目录"</span><strong class="hl-tag" style="color: #000096"> /&gt;</strong> <a id="co.autoconfig.config.property1"><!--anchor co.autoconfig.config.property1--></a><span class="calloutno"><img src="images/callouts/1.png" border="0"/></span>

        <strong class="hl-tag" style="color: #000096">&lt;property</strong> <span class="hl-attribute" style="color: #F5844C">name</span>=<span class="hl-value" style="color: #993300">"petstore.loggingRoot"</span> 
                    <span class="hl-attribute" style="color: #F5844C">defaultValue</span>=<span class="hl-value" style="color: #993300">"${petstore.work}/logs"</span>
                    <span class="hl-attribute" style="color: #F5844C">description</span>=<span class="hl-value" style="color: #993300">"日志文件目录"</span><strong class="hl-tag" style="color: #000096"> /&gt;</strong> <a id="co.autoconfig.config.property2"><!--anchor co.autoconfig.config.property2--></a><span class="calloutno"><img src="images/callouts/2.png" border="0"/></span>

        <strong class="hl-tag" style="color: #000096">&lt;property</strong> <span class="hl-attribute" style="color: #F5844C">name</span>=<span class="hl-value" style="color: #993300">"petstore.upload"</span>
                    <span class="hl-attribute" style="color: #F5844C">defaultValue</span>=<span class="hl-value" style="color: #993300">"${petstore.work}/upload"</span>
                    <span class="hl-attribute" style="color: #F5844C">description</span>=<span class="hl-value" style="color: #993300">"上传文件的目录"</span><strong class="hl-tag" style="color: #000096"> /&gt;</strong> <a id="co.autoconfig.config.property3"><!--anchor co.autoconfig.config.property3--></a><span class="calloutno"><img src="images/callouts/3.png" border="0"/></span>

        <strong class="hl-tag" style="color: #000096">&lt;property</strong> <span class="hl-attribute" style="color: #F5844C">name</span>=<span class="hl-value" style="color: #993300">"petstore.loggingLevel"</span>
                    <span class="hl-attribute" style="color: #F5844C">defaultValue</span>=<span class="hl-value" style="color: #993300">"warn"</span>
                    <span class="hl-attribute" style="color: #F5844C">description</span>=<span class="hl-value" style="color: #993300">"日志文件级别"</span><strong class="hl-tag" style="color: #000096">&gt;</strong> <a id="co.autoconfig.config.property4"><!--anchor co.autoconfig.config.property4--></a><span class="calloutno"><img src="images/callouts/4.png" border="0"/></span>

            <strong class="hl-tag" style="color: #000096">&lt;validator</strong> <span class="hl-attribute" style="color: #F5844C">name</span>=<span class="hl-value" style="color: #993300">"choice"</span>
                         <span class="hl-attribute" style="color: #F5844C">choice</span>=<span class="hl-value" style="color: #993300">"trace, debug, info, warn, error"</span><strong class="hl-tag" style="color: #000096"> /&gt;</strong> <a id="co.autoconfig.config.validator"><!--anchor co.autoconfig.config.validator--></a><span class="calloutno"><img src="images/callouts/5.png" border="0"/></span>

        <strong class="hl-tag" style="color: #000096">&lt;/property&gt;</strong>

    <strong class="hl-tag" style="color: #000096">&lt;/group&gt;</strong>
    <strong class="hl-tag" style="color: #000096">&lt;script&gt;</strong>
        <strong class="hl-tag" style="color: #000096">&lt;generate</strong> <span class="hl-attribute" style="color: #F5844C">template</span>=<span class="hl-value" style="color: #993300">"WEB-INF/web.xml"</span><strong class="hl-tag" style="color: #000096"> /&gt;</strong> <a id="co.autoconfig.config.generate"><!--anchor co.autoconfig.config.generate--></a><span class="calloutno"><img src="images/callouts/6.png" border="0"/></span>
        <strong class="hl-tag" style="color: #000096">&lt;generate</strong> <span class="hl-attribute" style="color: #F5844C">template</span>=<span class="hl-value" style="color: #993300">"WEB-INF/common/resources.xml"</span><strong class="hl-tag" style="color: #000096"> /&gt;</strong>
    <strong class="hl-tag" style="color: #000096">&lt;/script&gt;</strong>
<strong class="hl-tag" style="color: #000096">&lt;/config&gt;</strong></pre><div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#co.autoconfig.config.property1"><span class="calloutno"><img src="images/callouts/1.png" border="0"/></span></a> <a href="#co.autoconfig.config.property2"><span class="calloutno"><img src="images/callouts/2.png" border="0"/></span></a> <a href="#co.autoconfig.config.property3"><span class="calloutno"><img src="images/callouts/3.png" border="0"/></span></a> <a href="#co.autoconfig.config.property4"><span class="calloutno"><img src="images/callouts/4.png" border="0"/></span></a> </p></td><td valign="top" align="left"><p>定义properties</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#co.autoconfig.config.validator"><span class="calloutno"><img src="images/callouts/5.png" border="0"/></span></a> </p></td><td valign="top" align="left"><p>定义property的验证规则（可选）</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#co.autoconfig.config.generate"><span class="calloutno"><img src="images/callouts/6.png" border="0"/></span></a> </p></td><td valign="top" align="left"><p>生成配置文件的指令。</p></td></tr></table></div></div></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="d0e17493"><!--anchor d0e17493--></a>13.3.2.1. 定义properties</h4></div></div></div><p>定义一个property的完整格式如下：</p><div class="example"><a id="d0e17498"><!--anchor d0e17498--></a><p class="title"><strong>例 13.7. 定义一个property</strong></p><div class="example-contents"><pre class="programlisting"><strong class="hl-tag" style="color: #000096">&lt;property</strong>
    <span class="hl-attribute" style="color: #F5844C">name</span>=<span class="hl-value" style="color: #993300">"..."</span>
    <span class="hl-attribute" style="color: #F5844C">[defaultValue</span>=<span class="hl-value" style="color: #993300">"..."</span><span class="hl-attribute" style="color: #F5844C">]</span>
    <span class="hl-attribute" style="color: #F5844C">[description</span>=<span class="hl-value" style="color: #993300">"..."</span><span class="hl-attribute" style="color: #F5844C">]</span>
    <span class="hl-attribute" style="color: #F5844C">[required</span>=<span class="hl-value" style="color: #993300">"true|false"</span><span class="hl-attribute" style="color: #F5844C">]</span><strong class="hl-tag" style="color: #000096">
&gt;</strong>
    <strong class="hl-tag" style="color: #000096">&lt;validator</strong> <span class="hl-attribute" style="color: #F5844C">name</span>=<span class="hl-value" style="color: #993300">"..."</span><strong class="hl-tag" style="color: #000096"> /&gt;</strong>
    <strong class="hl-tag" style="color: #000096">&lt;validator</strong> <span class="hl-attribute" style="color: #F5844C">name</span>=<span class="hl-value" style="color: #993300">"..."</span><strong class="hl-tag" style="color: #000096"> /&gt;</strong>
    ...
<strong class="hl-tag" style="color: #000096">&lt;/property&gt;</strong></pre></div></div><p>可用的property参数包括：</p><div class="table"><a id="d0e17505"><!--anchor d0e17505--></a><p class="title"><strong>表 13.8. 定义property时可用的参数</strong></p><div class="table-contents"><table summary="定义property时可用的参数" cellpadding="10" style="border: none;"><colgroup><col width="33%" class="c1"/><col width="67%" class="c2"/></colgroup><thead><tr><th style="border-right: 0.5pt solid #6666cc; border-bottom: 0.5pt solid #6666cc; ">参数名</th><th style="border-bottom: 0.5pt solid #6666cc; ">说明</th></tr></thead><tbody><tr><td style="border-right: 0.5pt solid #6666cc; border-bottom: 0.5pt solid #6666cc; "><code class="code">name</code></td><td style="border-bottom: 0.5pt solid #6666cc; ">Property名称。</td></tr><tr><td style="border-right: 0.5pt solid #6666cc; border-bottom: 0.5pt solid #6666cc; "><code class="code">defaultValue</code>（可选）</td><td style="border-bottom: 0.5pt solid #6666cc; ">默认值。默认值中可包含对其它property的引用，如<code class="code">${petstore.work}/logs</code>。</td></tr><tr><td style="border-right: 0.5pt solid #6666cc; border-bottom: 0.5pt solid #6666cc; "><code class="code">description</code>（可选）</td><td style="border-bottom: 0.5pt solid #6666cc; ">对字段的描述，这个描述会显示给deployer，这对他理解该property非常重要。</td></tr><tr><td style="border-right: 0.5pt solid #6666cc; "><code class="code">required</code>（可选）</td><td style="">是否“必填”，默认为<code class="code">true</code>。如果deployer未提供必填项的值，就会报错。</td></tr></tbody></table></div></div></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="d0e17551"><!--anchor d0e17551--></a>13.3.2.2. 定义property的验证规则</h4></div></div></div><p>目前，有以下几种验证器：</p><div class="table"><a id="d0e17556"><!--anchor d0e17556--></a><p class="title"><strong>表 13.9. 可用的property验证规则</strong></p><div class="table-contents"><table summary="可用的property验证规则" cellpadding="10" style="border: none;"><colgroup><col width="59%" class="c1"/><col width="41%" class="c2"/></colgroup><thead><tr><th style="border-right: 0.5pt solid #6666cc; border-bottom: 0.5pt solid #6666cc; ">验证规则</th><th style="border-bottom: 0.5pt solid #6666cc; ">说明</th></tr></thead><tbody><tr><td style="border-right: 0.5pt solid #6666cc; border-bottom: 0.5pt solid #6666cc; "><pre class="programlisting"><strong class="hl-tag" style="color: #000096">&lt;validator</strong> <span class="hl-attribute" style="color: #F5844C">name</span>=<span class="hl-value" style="color: #993300">"boolean"</span><strong class="hl-tag" style="color: #000096"> /&gt;</strong></pre></td><td style="border-bottom: 0.5pt solid #6666cc; "><p>Property值必须为<code class="code">true</code>或<code class="code">false</code>。</p></td></tr><tr><td style="border-right: 0.5pt solid #6666cc; border-bottom: 0.5pt solid #6666cc; "><pre class="programlisting"><strong class="hl-tag" style="color: #000096">&lt;validator</strong> <span class="hl-attribute" style="color: #F5844C">name</span>=<span class="hl-value" style="color: #993300">"choice"</span>
           <span class="hl-attribute" style="color: #F5844C">choice</span>=<span class="hl-value" style="color: #993300">"trace, debug, info, warn, error"</span><strong class="hl-tag" style="color: #000096"> /&gt;</strong></pre></td><td style="border-bottom: 0.5pt solid #6666cc; "><p>Property值必须为choice所定义的值之一。</p></td></tr><tr><td style="border-right: 0.5pt solid #6666cc; border-bottom: 0.5pt solid #6666cc; "><pre class="programlisting"><strong class="hl-tag" style="color: #000096">&lt;validator</strong> <span class="hl-attribute" style="color: #F5844C">name</span>=<span class="hl-value" style="color: #993300">"email"</span><strong class="hl-tag" style="color: #000096"> /&gt;</strong></pre></td><td style="border-bottom: 0.5pt solid #6666cc; "><p>Property值必须为合法的email格式。</p></td></tr><tr><td style="border-right: 0.5pt solid #6666cc; border-bottom: 0.5pt solid #6666cc; "><pre class="programlisting"><strong class="hl-tag" style="color: #000096">&lt;validator</strong> <span class="hl-attribute" style="color: #F5844C">name</span>=<span class="hl-value" style="color: #993300">"fileExist"</span>
           <span class="hl-attribute" style="color: #F5844C">[file</span>=<span class="hl-value" style="color: #993300">"WEB-INF/web.xml"</span><span class="hl-attribute" style="color: #F5844C">]</span><strong class="hl-tag" style="color: #000096"> /&gt;</strong></pre></td><td style="border-bottom: 0.5pt solid #6666cc; "><p>Property值必须为某个存在的文件或目录。</p>
                                    <p>如果指定了file，那就意味着property值所指的目录下，必须存在file所指的文件或子目录。</p></td></tr><tr><td style="border-right: 0.5pt solid #6666cc; border-bottom: 0.5pt solid #6666cc; "><pre class="programlisting"><strong class="hl-tag" style="color: #000096">&lt;validator</strong> <span class="hl-attribute" style="color: #F5844C">name</span>=<span class="hl-value" style="color: #993300">"hostExist"</span><strong class="hl-tag" style="color: #000096"> /&gt;</strong></pre></td><td style="border-bottom: 0.5pt solid #6666cc; "><p>Property值必须为合法的IP地址，或者可以解析得到的域名。 </p></td></tr><tr><td style="border-right: 0.5pt solid #6666cc; border-bottom: 0.5pt solid #6666cc; "><pre class="programlisting"><strong class="hl-tag" style="color: #000096">&lt;validator</strong> <span class="hl-attribute" style="color: #F5844C">name</span>=<span class="hl-value" style="color: #993300">"keyword"</span><strong class="hl-tag" style="color: #000096"> /&gt;</strong></pre></td><td style="border-bottom: 0.5pt solid #6666cc; "><p>Property值必须为字母、数字、下划线的组合。</p></td></tr><tr><td style="border-right: 0.5pt solid #6666cc; border-bottom: 0.5pt solid #6666cc; "><pre class="programlisting"><strong class="hl-tag" style="color: #000096">&lt;validator</strong> <span class="hl-attribute" style="color: #F5844C">name</span>=<span class="hl-value" style="color: #993300">"number"</span><strong class="hl-tag" style="color: #000096"> /&gt;</strong></pre></td><td style="border-bottom: 0.5pt solid #6666cc; "><p>Property值必须为数字的组合。</p></td></tr><tr><td style="border-right: 0.5pt solid #6666cc; border-bottom: 0.5pt solid #6666cc; "><pre class="programlisting"><strong class="hl-tag" style="color: #000096">&lt;validator</strong> <span class="hl-attribute" style="color: #F5844C">name</span>=<span class="hl-value" style="color: #993300">"regexp"</span>
           <span class="hl-attribute" style="color: #F5844C">regexp</span>=<span class="hl-value" style="color: #993300">"..."</span>
           <span class="hl-attribute" style="color: #F5844C">[mode</span>=<span class="hl-value" style="color: #993300">"exact|prefix|contain"</span><span class="hl-attribute" style="color: #F5844C">]</span><strong class="hl-tag" style="color: #000096"> /&gt;</strong></pre></td><td style="border-bottom: 0.5pt solid #6666cc; "><p>Property值必须符合regexp所指的正则表达式。</p>
                                    <p>其中，mode为匹配的方法：</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>完全匹配exact</p></li><li class="listitem"><p>前缀匹配prefix</p></li><li class="listitem"><p>包含contain</p></li></ul></div>
                                    <p>如未指定mode，默认mode为contain。</p></td></tr><tr><td style="border-right: 0.5pt solid #6666cc; "><pre class="programlisting"><strong class="hl-tag" style="color: #000096">&lt;validator</strong> <span class="hl-attribute" style="color: #F5844C">name</span>=<span class="hl-value" style="color: #993300">"url"</span>
           <span class="hl-attribute" style="color: #F5844C">[checkHostExist</span>=<span class="hl-value" style="color: #993300">"false"</span><span class="hl-attribute" style="color: #F5844C">]</span>
           <span class="hl-attribute" style="color: #F5844C">[protocols</span>=<span class="hl-value" style="color: #993300">"http, https"</span><span class="hl-attribute" style="color: #F5844C">]</span>
           <span class="hl-attribute" style="color: #F5844C">[endsWithSlash</span>=<span class="hl-value" style="color: #993300">"true"</span><span class="hl-attribute" style="color: #F5844C">]</span><strong class="hl-tag" style="color: #000096"> /&gt;</strong></pre></td><td style=""><p>Property值必须是合法URL。</p>
                                    <p>假如指定了<code class="code">checkHostExist=true</code>，那么还会检查域名或IP的正确性；</p>
                                    <p>假如指定了protocols，那么URL的协议必须为其中之一；</p>
                                    <p>假如指定了<code class="code">endsWithSlash=true</code>，那么URL必须以/结尾。</p></td></tr></tbody></table></div></div></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="d0e17672"><!--anchor d0e17672--></a>13.3.2.3. 生成配置文件的指令</h4></div></div></div><p>描述文件中，每个<code class="code">&lt;generate&gt;</code>标签指定了一个包含placeholders的配置文件模板，具体格式为：</p><div class="example"><a id="d0e17680"><!--anchor d0e17680--></a><p class="title"><strong>例 13.8. 生成配置文件的指令</strong></p><div class="example-contents"><pre class="programlisting"><strong class="hl-tag" style="color: #000096">&lt;generate</strong>
    <span class="hl-attribute" style="color: #F5844C">template</span>=<span class="hl-value" style="color: #993300">"..."</span>
    <span class="hl-attribute" style="color: #F5844C">[destfile</span>=<span class="hl-value" style="color: #993300">"..."</span><span class="hl-attribute" style="color: #F5844C">]</span>
    <span class="hl-attribute" style="color: #F5844C">[charset</span>=<span class="hl-value" style="color: #993300">"..."</span><span class="hl-attribute" style="color: #F5844C">]</span>
    <span class="hl-attribute" style="color: #F5844C">[outputCharset</span>=<span class="hl-value" style="color: #993300">"..."</span><span class="hl-attribute" style="color: #F5844C">]</span><strong class="hl-tag" style="color: #000096">
&gt;</strong></pre></div></div><p>下面是参数的说明：</p><div class="table"><a id="d0e17687"><!--anchor d0e17687--></a><p class="title"><strong>表 13.10. 生成配置文件的指令参数</strong></p><div class="table-contents"><table summary="生成配置文件的指令参数" cellpadding="10" style="border: none;"><colgroup><col width="24%" class="c1"/><col width="76%" class="c2"/></colgroup><thead><tr><th style="border-right: 0.5pt solid #6666cc; border-bottom: 0.5pt solid #6666cc; ">参数名</th><th style="border-bottom: 0.5pt solid #6666cc; ">说明</th></tr></thead><tbody><tr><td style="border-right: 0.5pt solid #6666cc; border-bottom: 0.5pt solid #6666cc; "><code class="code">template</code></td><td style="border-bottom: 0.5pt solid #6666cc; ">
                                    <p>需要配置的模板名。</p>
                                    <p>模板名为相对路径，相对于当前jar/war/ear包的根目录。</p>
                                </td></tr><tr><td style="border-right: 0.5pt solid #6666cc; border-bottom: 0.5pt solid #6666cc; "><code class="code">destfile</code>（可选）</td><td style="border-bottom: 0.5pt solid #6666cc; ">
                                    <p>目标文件。</p>
                                    <p>如不指定，表示目标文件和模板文件相同。</p>
                                </td></tr><tr><td style="border-right: 0.5pt solid #6666cc; border-bottom: 0.5pt solid #6666cc; "><code class="code">charset</code>（可选）</td><td style="border-bottom: 0.5pt solid #6666cc; ">
                                    <p>模板的字符集编码。</p>
                                    <p>XML文件不需要指定<code class="code">charset</code>，因为AutoConfig可以自动取得XML文件的字符集编码；</p>
                                    <p>对其它文件必须指定charset。</p>
                                </td></tr><tr><td style="border-right: 0.5pt solid #6666cc; "><code class="code">outputCharset</code>（可选）</td><td style="">
                                    <p>目标文件的输出字符集编码。</p>
                                    <p>如不指定，表示和模板charset相同。</p>
                                </td></tr></tbody></table></div></div></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="d0e17757"><!--anchor d0e17757--></a>13.3.3. 建立模板文件</h3></div></div></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="d0e17760"><!--anchor d0e17760--></a>13.3.3.1. 模板文件的位置</h4></div></div></div><p>定义完<code class="filename">auto-config.xml</code>描述文件以后，就可以创建模板了。模板放在哪里呢？举例说明。</p><div class="example"><a id="d0e17768"><!--anchor d0e17768--></a><p class="title"><strong>例 13.9. 模板文件的位置</strong></p><div class="example-contents"><p>假设在一个典型的WEB应用中，你的<code class="filename">auto-config.xml</code>中包含指定了如下模板：</p><pre class="programlisting"><span class="hl-directive" style="color: maroon">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span>
<strong class="hl-tag" style="color: #000096">&lt;config&gt;</strong>
    <strong class="hl-tag" style="color: #000096">&lt;group&gt;</strong>
        ...
    <strong class="hl-tag" style="color: #000096">&lt;/group&gt;</strong>
    <strong class="hl-tag" style="color: #000096">&lt;script&gt;</strong>
        <strong class="hl-tag" style="color: #000096">&lt;generate</strong> <span class="hl-attribute" style="color: #F5844C">template</span>=<span class="hl-value" style="color: #993300">"WEB-INF/classes/file1.xml"</span><strong class="hl-tag" style="color: #000096"> /&gt;</strong>
        <strong class="hl-tag" style="color: #000096">&lt;generate</strong> <span class="hl-attribute" style="color: #F5844C">template</span>=<span class="hl-value" style="color: #993300">"WEB-INF/classes/file2.xml"</span><strong class="hl-tag" style="color: #000096"> /&gt;</strong>
        <strong class="hl-tag" style="color: #000096">&lt;generate</strong> <span class="hl-attribute" style="color: #F5844C">template</span>=<span class="hl-value" style="color: #993300">"WEB-INF/file3.xml"</span><strong class="hl-tag" style="color: #000096"> /&gt;</strong>
    <strong class="hl-tag" style="color: #000096">&lt;/script&gt;</strong>
<strong class="hl-tag" style="color: #000096">&lt;/config&gt;</strong></pre><p>那么，你可以把<code class="filename">file1.xml</code>、<code class="filename">file2.xml</code>、<code class="filename">file3.xml</code>放在下面的位置：</p><pre class="screen">war-project（源目录结构）               -&gt; war-project.war（目标目录结构）
 │  pom.xml
 │
 └─src
     └─main
         ├─java
         ├─<span class="emphasis"><em>resources</em></span>                    -&gt; <span class="emphasis"><em>/WEB-INF/classes</em></span>
         │     <span class="emphasis"><em>file1.xml</em></span>                       <span class="emphasis"><em>file1.xml - 建议放在这里</em></span>
         │     <span class="emphasis"><em>file2.xml</em></span>                       <span class="emphasis"><em>file2.xml - 建议放在这里</em></span>
         │
         └─webapp
             ├─META-INF
             │  └─autoconf
             │      │  auto-config.xml
             │      │
             │      └─WEB-INF           -&gt; /WEB-INF
             │          │ file3.xml            file3.xml - 也可以放在这里
             │          │
             │          └─classes       -&gt; /WEB-INF/classes
             │                file1.xml        file1.xml - 也可以放在这里
             │                file2.xml        file2.xml - 也可以放在这里
             │
             └─<span class="emphasis"><em>WEB-INF</em></span>                  -&gt; <span class="emphasis"><em>/WEB-INF</em></span>
                   <span class="emphasis"><em>file3.xml</em></span>                   <span class="emphasis"><em>file3.xml - 建议放在这里</em></span></pre></div></div><p>AutoConfig的寻找模板的逻辑是：</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>如果在<code class="filename">auto-config.xml</code>所在的目录下发现模板文件，就使用它；</p></li><li class="listitem"><p>否则在包的根目录中查找模板文件；如果两处均未找到，则报错。</p></li></ul></div></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="d0e17832"><!--anchor d0e17832--></a>13.3.3.2. 模板的写法</h4></div></div></div><p>书写模板是很简单的事，你只要：</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>把需要配置的点替换成placeholder：“<code class="code">${property.name}</code>”。当然，你得确保property.name被定义在<code class="filename">auto-config.xml</code>中。</p></li><li class="listitem"><p>假如模板中包含<span class="emphasis"><em>不希望被替换的</em></span>运行时的placeholder“<span class="emphasis"><em><code class="code">$</code></em></span><code class="code">{...}</code>”，需要更改成“<span class="emphasis"><em><code class="code">${D}</code></em></span><code class="code">{...}</code>”
                                。</p></li></ul></div><div class="example"><a id="d0e17865"><!--anchor d0e17865--></a><p class="title"><strong>例 13.10. 模板示例</strong></p><div class="example-contents"><pre class="programlisting">...
<strong class="hl-tag" style="color: #000096">&lt;context-param&gt;</strong>
    <strong class="hl-tag" style="color: #000096">&lt;param-name&gt;</strong>loggingRoot<strong class="hl-tag" style="color: #000096">&lt;/param-name&gt;</strong>
    <strong class="hl-tag" style="color: #000096">&lt;param-value&gt;</strong><span class="emphasis"><em>${petstore.loggingRoot}</em></span><strong class="hl-tag" style="color: #000096">&lt;/param-value&gt;</strong>
<strong class="hl-tag" style="color: #000096">&lt;/context-param&gt;</strong>
<strong class="hl-tag" style="color: #000096">&lt;context-param&gt;</strong>
    <strong class="hl-tag" style="color: #000096">&lt;param-name&gt;</strong>loggingLevel<strong class="hl-tag" style="color: #000096">&lt;/param-name&gt;</strong>
    <strong class="hl-tag" style="color: #000096">&lt;param-value&gt;</strong><span class="emphasis"><em>${petstore.loggingLevel}</em></span><strong class="hl-tag" style="color: #000096">&lt;/param-value&gt;</strong>
<strong class="hl-tag" style="color: #000096">&lt;/context-param&gt;</strong>
...
<span class="emphasis"><em>${D}</em></span>{runtime.placeholder}</pre></div></div><p>此外，AutoConfig模板其实是由Velocity模板引擎来渲染的。因此，所有的placeholder必须能够通过velocity的语法。</p><div class="example"><a id="d0e17881"><!--anchor d0e17881--></a><p class="title"><strong>例 13.11. 使用不符合velocity语法的placeholders</strong></p><div class="example-contents"><p>例如，下面的placeholder被velocity看作非法：</p><pre class="programlisting">${my.property<span class="emphasis"><em>.2</em></span>}</pre><p>解决的办法是，改写成如下样式：</p><pre class="programlisting">${my<span class="emphasis"><em>_</em></span>property<span class="emphasis"><em>_2</em></span>}</pre></div></div></div></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="d0e17901"><!--anchor d0e17901--></a>13.4. AutoConfig的使用 —— 部署者指南</h2></div></div></div><p>部署者有两种方法可以使用AutoConfig：</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>在命令行上直接运行。</p></li><li class="listitem"><p>在maven中调用AutoConfig plugin。</p></li></ul></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="d0e17913"><!--anchor d0e17913--></a>13.4.1. 在命令行中使用AutoConfig</h3></div></div></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="tool.autoconfig.getbinary"><!--anchor tool.autoconfig.getbinary--></a>13.4.1.1. 取得可执行文件</h4></div></div></div><p>AutoConfig提供了Windows以及Unix-like（Linux、Mac
                    OS等）等平台上均可使用的native可执行程序。可执行程序文件被发布在Maven repository中。</p><p>如果你已经配置好了maven，那么可以让maven来帮你下载目标文件。</p><div class="example"><a id="d0e17923"><!--anchor d0e17923--></a><p class="title"><strong>例 13.12. 让maven帮忙下载AutoConfig可执行文件</strong></p><div class="example-contents"><p>请创建一个临时文件：<code class="filename">pom.xml</code>。</p><pre class="programlisting"><span class="hl-directive" style="color: maroon">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span>
<strong class="hl-tag" style="color: #000096">&lt;project</strong> <span class="hl-attribute" style="color: #F5844C">xmlns</span>=<span class="hl-value" style="color: #993300">"http://maven.apache.org/POM/4.0.0"</span>
    <span class="hl-attribute" style="color: #F5844C">xmlns:xsi</span>=<span class="hl-value" style="color: #993300">"http://www.w3.org/2001/XMLSchema-instance"</span>
    <span class="hl-attribute" style="color: #F5844C">xsi:schemaLocation</span>=<span class="hl-value" style="color: #993300">"http://maven.apache.org/POM/4.0.0 http://maven.apache.org/maven-v4_0_0.xsd"</span><strong class="hl-tag" style="color: #000096">&gt;</strong>
    <strong class="hl-tag" style="color: #000096">&lt;parent&gt;</strong>
        <strong class="hl-tag" style="color: #000096">&lt;groupId&gt;</strong>com.alibaba.citrus.tool<strong class="hl-tag" style="color: #000096">&lt;/groupId&gt;</strong>
        <strong class="hl-tag" style="color: #000096">&lt;artifactId&gt;</strong>antx-parent<strong class="hl-tag" style="color: #000096">&lt;/artifactId&gt;</strong>
        <strong class="hl-tag" style="color: #000096">&lt;version&gt;</strong>1.2<strong class="hl-tag" style="color: #000096">&lt;/version&gt;</strong> <a id="co.autoconfig.native.version"><!--anchor co.autoconfig.native.version--></a><span class="calloutno"><img src="images/callouts/1.png" border="0"/></span>
    <strong class="hl-tag" style="color: #000096">&lt;/parent&gt;</strong>
    <strong class="hl-tag" style="color: #000096">&lt;modelVersion&gt;</strong>4.0.0<strong class="hl-tag" style="color: #000096">&lt;/modelVersion&gt;</strong>
    <strong class="hl-tag" style="color: #000096">&lt;artifactId&gt;</strong>temp<strong class="hl-tag" style="color: #000096">&lt;/artifactId&gt;</strong>
<strong class="hl-tag" style="color: #000096">&lt;/project&gt;</strong></pre><div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#co.autoconfig.native.version"><span class="calloutno"><img src="images/callouts/1.png" border="0"/></span></a> </p></td><td valign="top" align="left"><p>文件中的parent pom的版本号（1.2）决定了你要取得的AutoConfig的版本号。</p></td></tr></table></div><p>然后在命令行上执行如下命令：</p><pre class="screen">mvn dependency:copy</pre></div></div><p>这样就取得了两个文件：</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p><code class="filename">autoconfig-1.2.tgz</code></p></li><li class="listitem"><p><code class="filename">autoexpand-1.2.tgz</code> -
                                    AutoExpand是另一个小工具。它是用来展开war、jar、ear包的。关于AutoExpand的详情，请见<a class="xref" href="autoexpand.html" title="第 14 章 AutoExpand工具使用指南">第 14 章 <em>AutoExpand工具使用指南</em></a>。</p></li></ul></div><p>你也可以直接去maven repository中手工下载以上两个包：</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p><a class="link" href="http://repo1.maven.org/maven2/com/alibaba/citrus/tool/antx-autoconfig/1.2/antx-autoconfig-1.2.tgz" target="_top">http://repo1.maven.org/maven2/com/alibaba/citrus/tool/antx-autoconfig/1.2/antx-autoconfig-1.2.tgz</a></p></li><li class="listitem"><p><a class="link" href="http://repo1.maven.org/maven2/com/alibaba/citrus/tool/antx-autoexpand/1.2/antx-autoexpand-1.2.tgz" target="_top">http://repo1.maven.org/maven2/com/alibaba/citrus/tool/antx-autoexpand/1.2/antx-autoexpand-1.2.tgz</a></p></li></ul></div><p>取得压缩包以后，可以用下面的命令来展开并安装工具。</p><div class="table"><a id="d0e17968"><!--anchor d0e17968--></a><p class="title"><strong>表 13.11. 展开并安装工具</strong></p><div class="table-contents"><table summary="展开并安装工具" cellpadding="10" style="border: none;"><colgroup><col width="50%" class="c1"/><col width="50%" class="c2"/></colgroup><thead><tr><th style="border-right: 0.5pt solid #6666cc; border-bottom: 0.5pt solid #6666cc; ">Unix-like系统</th><th style="border-bottom: 0.5pt solid #6666cc; ">Windows系统</th></tr></thead><tbody><tr><td style="border-right: 0.5pt solid #6666cc; ">
                                    <pre class="screen">tar zxvf autoconfig-1.2.tgz
tar zxvf autoexpand-1.2.tgz
cp autoconfig /usr/local/bin
cp autoexpand /usr/local/bin</pre>
                                </td><td style=""><pre class="screen">tar zxvf autoconfig-1.2.tgz
tar zxvf autoexpand-1.2.tgz
copy autoconfig.exe c:\windows\system32
copy autoexpand.exe c:\windows\system32</pre></td></tr></tbody></table></div></div></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="d0e17990"><!--anchor d0e17990--></a>13.4.1.2. 执行AutoConfig命令</h4></div></div></div><p>取得可执行文件以后，就可以试用一下：在命令行上输入<span class="command"><strong>autoconfig</strong></span>。不带参数的<span class="command"><strong>autoconfig</strong></span>命令会显示出如下帮助信息。 </p><div class="example"><a id="d0e18001"><!--anchor d0e18001--></a><p class="title"><strong>例 13.13. AutoConfig的帮助信息</strong></p><div class="example-contents"><pre class="screen">$ <span class="command"><strong>autoconfig</strong></span>
Detected system charset encoding: UTF-8
If your can't read the following text, specify correct one like this: 
  autoconfig -c mycharset

使用方法：autoconfig [可选参数] [目录名|包文件名]
                
可选参数：
 -c,--charset                输入/输出编码字符集
 -d,--include-descriptors
                             包含哪些配置描述文件，例如：conf/auto-config.xml，可使用*、**、?通配符，如有多项，用逗号分隔
 -D,--exclude-descriptors    排除哪些配置描述文件，可使用*、**、?通配符，如有多项，用逗号分隔
 -g,--gui                    图形用户界面（交互模式）
 -h,--help                   显示帮助信息
 -i,--interactive            交互模式：auto|on|off，默认为auto，无参数表示on
 -I,--non-interactive        非交互模式，相当于--interactive=off
 -n,--shared-props-name      共享的属性文件的名称
 -o,--output                 输出文件名或目录名
 -P,--exclude-packages       排除哪些打包文件，可使用*、**、?通配符，如有多项，用逗号分隔
 -p,--include-packages
                             包含哪些打包文件，例如：target/*.war，可使用*、**、?通配符，如有多项，用逗号分隔
 -s,--shared-props           共享的属性文件URL列表，以逗号分隔
 -T,--type                   文件类型，例如：war, jar, ear等
 -t,--text                   文本用户界面（交互模式）
 -u,--userprop               用户属性文件
 -v,--verbose                显示更多信息

总耗费时间：546毫秒</pre></div></div><p>最简单的AutoConfig命令如下：</p><div class="example"><a id="d0e18011"><!--anchor d0e18011--></a><p class="title"><strong>例 13.14. 最简单的AutoConfig命令</strong></p><div class="example-contents"><pre class="screen">autoconfig petstore.war</pre></div></div><p>无论<code class="filename">petstore.war</code>是一个zip包还是目录，AutoConfig都会正确地生成其中的配置文件。</p></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="d0e18021"><!--anchor d0e18021--></a>13.4.2. 在maven中使用AutoConfig</h3></div></div></div><p>AutoConfig也可以通过maven plugin来执行。</p><p>这种方式使用方式，方便了开发者试运行并测试应用程序。开发者可以在build项目的同时，把AutoConfig也配置好。然而对于非开发的应用测试人员、发布应用的系统管理员来说，最好的方法是使用独立可执行的AutoConfig来配置应用的二进制目标文件。</p><p>为了使用maven插件，你需要修改项目的<code class="filename">pom.xml</code>来设定它。请注意，一般来说，不要在parent
                    <code class="filename">pom.xml</code>中设定AutoConfig，因为这个设置会作用在每个子项目上，导致不必要的AutoConfig执行。只在生成最终目标文件的子项目<code class="filename">pom.xml</code>中设定AutoConfig就可以了。例如，对于一个web项目，你可以在生成war包的子项目上设置AutoConfig
                plugin。</p><div class="example"><a id="d0e18039"><!--anchor d0e18039--></a><p class="title"><strong>例 13.15. 在pom.xml中设定AutoConfig plugin</strong></p><div class="example-contents"><pre class="programlisting"><span class="hl-directive" style="color: maroon">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span>
<strong class="hl-tag" style="color: #000096">&lt;project</strong> <span class="hl-attribute" style="color: #F5844C">xmlns</span>=<span class="hl-value" style="color: #993300">"http://maven.apache.org/POM/4.0.0"</span>
    <span class="hl-attribute" style="color: #F5844C">xmlns:xsi</span>=<span class="hl-value" style="color: #993300">"http://www.w3.org/2001/XMLSchema-instance"</span>
    <span class="hl-attribute" style="color: #F5844C">xsi:schemaLocation</span>=<span class="hl-value" style="color: #993300">"http://maven.apache.org/POM/4.0.0 http://maven.apache.org/maven-v4_0_0.xsd"</span><strong class="hl-tag" style="color: #000096">&gt;</strong>
    ...
    <strong class="hl-tag" style="color: #000096">&lt;properties&gt;</strong>
        ...
        <em class="hl-comment" style="color: green">&lt;!-- 定义autoconfig的版本，建议将此行写在parent pom.xml中。 --&gt;</em>
        <strong class="hl-tag" style="color: #000096">&lt;autoconfig-plugin-version&gt;</strong>1.2<strong class="hl-tag" style="color: #000096">&lt;/autoconfig-plugin-version&gt;</strong>
    <strong class="hl-tag" style="color: #000096">&lt;/properties&gt;</strong>
    ...
    <strong class="hl-tag" style="color: #000096">&lt;build&gt;</strong>
        <strong class="hl-tag" style="color: #000096">&lt;plugins&gt;</strong>
            <strong class="hl-tag" style="color: #000096">&lt;plugin&gt;</strong>
                <strong class="hl-tag" style="color: #000096">&lt;groupId&gt;</strong>com.alibaba.citrus.tool<strong class="hl-tag" style="color: #000096">&lt;/groupId&gt;</strong>
                <strong class="hl-tag" style="color: #000096">&lt;artifactId&gt;</strong>autoconfig-maven-plugin<strong class="hl-tag" style="color: #000096">&lt;/artifactId&gt;</strong>
                <strong class="hl-tag" style="color: #000096">&lt;version&gt;</strong>${autoconfig-plugin-version}<strong class="hl-tag" style="color: #000096">&lt;/version&gt;</strong>
                <strong class="hl-tag" style="color: #000096">&lt;configuration&gt;</strong>
                    <em class="hl-comment" style="color: green">&lt;!-- 要进行AutoConfig的目标文件，默认为${project.artifact.file}。 
                    &lt;dest&gt;${project.artifact.file}&lt;/dest&gt;
                    --&gt;</em>
                    <em class="hl-comment" style="color: green">&lt;!-- 配置后，是否展开目标文件，默认为false，不展开。 
                    &lt;exploding&gt;true&lt;/exploding&gt;
                    --&gt;</em>
                    <em class="hl-comment" style="color: green">&lt;!-- 展开到指定目录，默认为${project.build.directory}/${project.build.finalName}。 
                    &lt;explodedDirectory&gt;
                        ${project.build.directory}/${project.build.finalName}
                    &lt;/explodedDirectory&gt;
                    --&gt;</em>
                <strong class="hl-tag" style="color: #000096">&lt;/configuration&gt;</strong>
                <strong class="hl-tag" style="color: #000096">&lt;executions&gt;</strong>
                    <strong class="hl-tag" style="color: #000096">&lt;execution&gt;</strong>
                        <strong class="hl-tag" style="color: #000096">&lt;phase&gt;</strong>package<strong class="hl-tag" style="color: #000096">&lt;/phase&gt;</strong>
                        <strong class="hl-tag" style="color: #000096">&lt;goals&gt;</strong>
                            <strong class="hl-tag" style="color: #000096">&lt;goal&gt;</strong>autoconfig<strong class="hl-tag" style="color: #000096">&lt;/goal&gt;</strong>
                        <strong class="hl-tag" style="color: #000096">&lt;/goals&gt;</strong>
                    <strong class="hl-tag" style="color: #000096">&lt;/execution&gt;</strong>
                <strong class="hl-tag" style="color: #000096">&lt;/executions&gt;</strong>
            <strong class="hl-tag" style="color: #000096">&lt;/plugin&gt;</strong>
        <strong class="hl-tag" style="color: #000096">&lt;/plugins&gt;</strong>
    <strong class="hl-tag" style="color: #000096">&lt;/build&gt;</strong>
<strong class="hl-tag" style="color: #000096">&lt;/project&gt;</strong></pre></div></div><p>这样，每次执行<code class="code">mvn package</code>或者<code class="code">mvn
                install</code>时，都会激活AutoConfig，对package目标文件进行配置。</p><p>想要避免AutoConfig，只需要一个额外的命令行参数：</p><div class="example"><a id="d0e18054"><!--anchor d0e18054--></a><p class="title"><strong>例 13.16. 避免执行AutoConfig</strong></p><div class="example-contents"><pre class="screen">mvn install <span class="emphasis"><em>–Dautoconfig.skip</em></span></pre></div></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="d0e18061"><!--anchor d0e18061--></a>13.4.3. 运行并观察AutoConfig的结果</h3></div></div></div><p>第一次执行AutoConfig，无论通过何种方式（独立命令行或maven插件），AutoConfig都会提示你修改user
                properties文件，以提供所需要的properties值。AutoConfig提供了一套基于文本的交互式界面来编辑这些properties。</p><div class="example"><a id="d0e18066"><!--anchor d0e18066--></a><p class="title"><strong>例 13.17. 交互式编辑properties</strong></p><div class="example-contents"><pre class="screen">╭───────────────────────┈┈┈┈
│
│ 您的配置文件需要被更新：
│
│ file:/.../<span class="emphasis"><em>antx.properties</em></span>
│
│ 这个文件包括了您个人的特殊设置，
│ 包括服务器端口、您的邮件地址等内容。
│
└───────┈┈┈┈┈┈┈┈┈┈┈

 如果不更新此文件，可能会导致配置文件的内容不完整。
 您需要现在更新此文件吗? [Yes][No] y</pre><p>当你通过交互式界面填写了所有properties的值，并通过了AutoConfig的验证以后，AutoConfig就开始生成配置文件：</p><pre class="screen">即将保存到文件"file:/.../antx.properties"中, 确定? [Yes][No] y

╭───────────────────────┈┈┈┈
│ 保存文件 file:/.../antx.properties...
│┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈
│petstore.loggingLevel  = warn
│petstore.loggingRoot   = ${petstore.work}/logs
│petstore.upload        = ${petstore.work}/upload
│petstore.work          = /tmp
└───────┈┈┈┈┈┈┈┈┈┈┈
 已保存至文件: file:/.../antx.properties
Loading file:/.../antx.properties
&lt;jar:file:/.../Work/my/apps/petstore-webx3/target/petstore.war!/&gt;
    <span class="emphasis"><em>Generating WEB-INF/web.xml [UTF-8] =&gt; WEB-INF/web.xml [UTF-8]</em></span>

&lt;jar:file:/.../Work/my/apps/petstore-webx3/target/petstore.war!/&gt;
    <span class="emphasis"><em>Generating WEB-INF/common/resources.xml [UTF-8] =&gt; WEB-INF/common/resources.xml [UTF-8]</em></span>

&lt;jar:file:/.../Work/my/apps/petstore-webx3/target/petstore.war!/&gt;
    <span class="emphasis"><em>Generating log file: META-INF/autoconf/auto-config.xml.log</em></span>

Expanding: /.../Work/my/apps/petstore-webx3/target/petstore.war
       To: /.../Work/my/apps/petstore-webx3/target/petstore
done.</pre><p>假如发现模板中某个placeholder，并未在<code class="filename">auto-config.xml</code>中定义，就会出现以下错误：</p><pre class="screen">ERROR - Undefined placeholders found in template:
- Template:   META-INF/autoconf/WEB-INF/web.xml
- Descriptor: META-INF/autoconf/auto-config.xml
- Base URL:   file:/.../Work/my/apps/petstore-webx3/target/petstore/
---------------------------------------------------------------
-&gt; petstore.loggingRoot
---------------------------------------------------------------</pre></div></div><p>出现错误以后，Maven会报错，并停止build过程。假如你不希望maven停止，可以用下面的命令来执行maven：</p><div class="example"><a id="d0e18096"><!--anchor d0e18096--></a><p class="title"><strong>例 13.18. 避免maven因为placeholder未定义而停止</strong></p><div class="example-contents"><pre class="screen">mvn ... <span class="emphasis"><em>–Dautoconfig.strict=false</em></span></pre></div></div><p>AutoConfig会生成一个日志文件，就在<code class="filename">auto-config.xml</code>所在的目录下，名字为：<code class="filename">auto-config.xml.log</code>。</p><div class="example"><a id="d0e18111"><!--anchor d0e18111--></a><p class="title"><strong>例 13.19. AutoConfig所生成的日志文件</strong></p><div class="example-contents"><pre class="screen">Last Configured at: Fri Jun 18 13:54:22 CST 2010

Base URL: file:/.../Work/my/apps/petstore-webx3/target/petstore/
Descriptor: META-INF/autoconf/auto-config.xml

Generating META-INF/autoconf/WEB-INF/web.xml [UTF-8] =&gt; WEB-INF/web.xml [UTF-8]
Generating META-INF/autoconf/WEB-INF/common/resources.xml [UTF-8] =&gt; WEB-INF/common/resources.xml [UTF-8]</pre></div></div><p>最后，让我们查看一下AutoConfig所生成的文件，其中所有的placeholders应当被替换成你所提供的值了。</p><div class="example"><a id="d0e18118"><!--anchor d0e18118--></a><p class="title"><strong>例 13.20. AutoConfig生成的结果</strong></p><div class="example-contents"><pre class="programlisting">...
<strong class="hl-tag" style="color: #000096">&lt;context-param&gt;</strong>
    <strong class="hl-tag" style="color: #000096">&lt;param-name&gt;</strong>loggingRoot<strong class="hl-tag" style="color: #000096">&lt;/param-name&gt;</strong>
    <strong class="hl-tag" style="color: #000096">&lt;param-value&gt;</strong><span class="emphasis"><em>/tmp/logs</em></span><strong class="hl-tag" style="color: #000096">&lt;/param-value&gt;</strong>
<strong class="hl-tag" style="color: #000096">&lt;/context-param&gt;</strong>
<strong class="hl-tag" style="color: #000096">&lt;context-param&gt;</strong>
    <strong class="hl-tag" style="color: #000096">&lt;param-name&gt;</strong>loggingLevel<strong class="hl-tag" style="color: #000096">&lt;/param-name&gt;</strong>
    <strong class="hl-tag" style="color: #000096">&lt;param-value&gt;</strong><span class="emphasis"><em>warn</em></span><strong class="hl-tag" style="color: #000096">&lt;/param-value&gt;</strong>
<strong class="hl-tag" style="color: #000096">&lt;/context-param&gt;</strong>
...
<span class="emphasis"><em>$</em></span>{runtime.placeholder}</pre></div></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="d0e18132"><!--anchor d0e18132--></a>13.4.4. 共享properties文件</h3></div></div></div><p>当需要配置的内容越来越多时，即使使用AutoConfig这样的机制，也会变得不胜其烦。</p><p>假如你的项目包含了好几个模块，而你只负责其中的一个模块。一般来说，你对其它模块的配置是什么并不清楚，事实上你也懒得去关心。但是你为了运行这个项目，你不得不去配置这些模块。假如模块A就是一个你不想关心的模块，但为了运行它，你需要告诉模块A一些参数：数据库连接的参数、域名、端口、文件目录、搜索引擎……可你并不清楚这些参数应该取什么值。</p><p>好在AutoConfig提供了一个共享properties文件的方法。 </p><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="d0e18141"><!--anchor d0e18141--></a>13.4.4.1. 共享的properties文件</h4></div></div></div><p>你可以创建一系列文件：<code class="filename">module-a-db.properites</code>，<code class="filename">module-a-searchengine.properties</code>等等。每个文件中都包含了某个运行环境中的关于module
                    A模块的配置参数。</p><p>现在，你可以不关心module A了！你只要使用下面的命令：</p><div class="example"><a id="d0e18154"><!--anchor d0e18154--></a><p class="title"><strong>例 13.21. 指定共享的properties文件</strong></p><div class="example-contents"><pre class="screen">autoconfig <span class="emphasis"><em>-s module-a-db.properties,module-a-searchengine.properties</em></span><a id="co.autoconfig.shared.specifiy"><!--anchor co.autoconfig.shared.specifiy--></a><span class="calloutno"><img src="images/callouts/1.png" border="0"/></span> ……</pre><div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#co.autoconfig.shared.specifiy"><span class="calloutno"><img src="images/callouts/1.png" border="0"/></span></a> </p></td><td valign="top" align="left"><p><code class="code">-s</code>参数代表“共享的properties文件”。</p></td></tr></table></div></div></div><p>同时，你的<code class="filename">antx.properties</code>也被简化了，因为这里只会保存你定义的配置项，而不会包含共享的配置项。</p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="d0e18174"><!--anchor d0e18174--></a>13.4.4.2. 共享整个目录</h4></div></div></div><p>假如共享的文件很多的话，AutoConfig还有一个贴心的功能，你可以把这些文件按目录来组织：</p><div class="example"><a id="d0e18179"><!--anchor d0e18179--></a><p class="title"><strong>例 13.22. 按目录组织要被共享的properties文件</strong></p><div class="example-contents"><pre class="screen">shared-properties/
 ├─<span class="emphasis"><em>test/</em></span>                                 // 测试环境的共享配置
 │    module-a-db.properties
 │    module-a-searchengine.properties
 │    module-b.properties
 └─<span class="emphasis"><em>prod/</em></span>                                 // 生产环境的共享配置
       module-a-db.properties
       module-a-searchengine.properties
       module-b.properties</pre></div></div><p>然后，你可以直接在AutoConfig中引用目录：</p><div class="example"><a id="d0e18192"><!--anchor d0e18192--></a><p class="title"><strong>例 13.23. 共享指定目录中的所有properties文件</strong></p><div class="example-contents"><pre class="screen">autoconfig -s <span class="emphasis"><em>shared-propertes/test/</em></span> ……</pre></div></div><p>AutoConfig就会为你装载这个目录下的所有共享配置文件。（注意，<span class="emphasis"><em>目录必须以斜杠“/”结尾</em></span>）</p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="d0e18205"><!--anchor d0e18205--></a>13.4.4.3. 将共享目录放在http、https或ssh服务器上</h4></div></div></div><p>AutoConfig还支持从http、https或ssh服务器上取得共享配置文件，只需要将前面例子中的文件名改成http或ssh的URI就可以了：</p><div class="example"><a id="d0e18210"><!--anchor d0e18210--></a><p class="title"><strong>例 13.24. 共享远程服务器上的properties文件或目录</strong></p><div class="example-contents"><pre class="screen">autoconfig -s <span class="emphasis"><em>http://share.alibaba.com</em></span>/shared-propertes/test/<a id="co.autoconfig.shared.http"><!--anchor co.autoconfig.shared.http--></a><span class="calloutno"><img src="images/callouts/1.png" border="0"/></span> ……
autoconfig -s <span class="emphasis"><em>http://myname@share.alibaba.com</em></span>/shared-propertes/test/<a id="co.autoconfig.shared.http.withuser"><!--anchor co.autoconfig.shared.http.withuser--></a><span class="calloutno"><img src="images/callouts/2.png" border="0"/></span> ……
autoconfig -s <span class="emphasis"><em>https://share.alibaba.com</em></span>/shared-propertes/test/<a id="co.autoconfig.shared.https"><!--anchor co.autoconfig.shared.https--></a><span class="calloutno"><img src="images/callouts/3.png" border="0"/></span> ……
autoconfig -s <span class="emphasis"><em>https://myname@share.alibaba.com</em></span>/shared-propertes/test/<a id="co.autoconfig.shared.https.withuser"><!--anchor co.autoconfig.shared.https.withuser--></a><span class="calloutno"><img src="images/callouts/4.png" border="0"/></span> ……
autoconfig -s <span class="emphasis"><em>ssh://myname@share.alibaba.com</em></span>/shared-propertes/test/<a id="co.autoconfig.shared.ssh"><!--anchor co.autoconfig.shared.ssh--></a><span class="calloutno"><img src="images/callouts/5.png" border="0"/></span> ……</pre><div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#co.autoconfig.shared.http"><span class="calloutno"><img src="images/callouts/1.png" border="0"/></span></a> </p></td><td valign="top" align="left"><p>共享远程http服务器上的properties文件。</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#co.autoconfig.shared.http.withuser"><span class="calloutno"><img src="images/callouts/2.png" border="0"/></span></a> </p></td><td valign="top" align="left"><p>共享远程http服务器上的properties文件，指定登录用户名。</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#co.autoconfig.shared.https"><span class="calloutno"><img src="images/callouts/3.png" border="0"/></span></a> </p></td><td valign="top" align="left"><p>共享远程https服务器上的properties文件。</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#co.autoconfig.shared.https.withuser"><span class="calloutno"><img src="images/callouts/4.png" border="0"/></span></a> </p></td><td valign="top" align="left"><p>共享远程https服务器上的properties文件，指定登录用户名。</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#co.autoconfig.shared.ssh"><span class="calloutno"><img src="images/callouts/5.png" border="0"/></span></a> </p></td><td valign="top" align="left"><p>共享远程ssh服务器上的properties文件，必须指定用户名。</p></td></tr></table></div></div></div><p>由于Subversion、Git服务器是支持HTTP/HTTPS协议的，因此将properties文件存放在Subversion或Git服务器上，也是一个极好的办法。由于采用了Subversion或Git，properties文件的版本管理问题也被一举解决了。</p><p>需要注意的是，访问http和ssh有可能需要验证用户和密码。当需要验证时，AutoConfig会提示你输入用户名和密码。输入以后，密码将被保存在<span class="emphasis"><em><code class="filename">$HOME/passwd.autoconfig</code></em></span>文件中，以后就不需要重复提问了。
                </p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="d0e18264"><!--anchor d0e18264--></a>13.4.4.4. 在多种配置项中切换</h4></div></div></div><p>当你使用前文所述的<code class="code">autoconfig
                        –s</code>命令来生成<code class="filename">antx.properties</code>文件时，你会发现<code class="filename">antx.properties</code>中增加了几行特别的内容：</p><div class="example"><a id="d0e18278"><!--anchor d0e18278--></a><p class="title"><strong>例 13.25. 包含共享文件、目录信息的<code class="filename">antx.properties</code>文件</strong></p><div class="example-contents"><pre class="screen">antx.properties.<span class="emphasis"><em>default</em></span>  = http://share.alibaba.com/shared-propertes/test/</pre><p>如果你在<code class="code">-s</code>参数中指定了多项共享properties文件或目录，那么<code class="filename">antx.properties</code>中将会这样：</p><pre class="screen">antx.properties.<span class="emphasis"><em>default.1</em></span>  = http://share.alibaba.com/shared-propertes/test/
antx.properties.<span class="emphasis"><em>default.2</em></span>  = file:/shared-properties/test/my-1.properites
antx.properties.<span class="emphasis"><em>default.3</em></span>  = file:/shared-properties/test/my-2.properites</pre></div></div><p>事实上，AutoConfig还支持多组共享配置，请试用下面的命令：</p><div class="example"><a id="d0e18310"><!--anchor d0e18310--></a><p class="title"><strong>例 13.26. 使用多组共享配置</strong></p><div class="example-contents"><pre class="screen">autoconfig -s http://share.alibaba.com/shared-propertes/test/ <span class="emphasis"><em>-n test</em></span><a id="co.autoconfig.shared.multi.name"><!--anchor co.autoconfig.shared.multi.name--></a><span class="calloutno"><img src="images/callouts/1.png" border="0"/></span> ……</pre><div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#co.autoconfig.shared.multi.name"><span class="calloutno"><img src="images/callouts/1.png" border="0"/></span></a> </p></td><td valign="top" align="left"><p>为当前共享配置定义一个名字，以后可以用这个名字来简化命令。</p></td></tr></table></div><p>这时，antx.properties就会是这个样子：</p><pre class="screen">antx.properties = <span class="emphasis"><em>test</em></span>
antx.properties.<span class="emphasis"><em>test</em></span> = http://share.alibaba.com/shared-propertes/test/</pre><p>再执行：</p><pre class="screen">autoconfig -s http://share.alibaba.com/shared-propertes/prod/ <span class="emphasis"><em>-n prod</em></span> ……</pre><p>antx.properties就会变成这个样子：</p><pre class="screen">antx.properties = <span class="emphasis"><em>prod</em></span>
antx.properties.test = http://share.alibaba.com/shared-propertes/test/
antx.properties.<span class="emphasis"><em>prod</em></span> = http://share.alibaba.com/shared-propertes/prod/</pre><p>以后再执行，就不需要再指定<code class="code">-s</code>参数了，只需用<code class="code">-n</code>参数选择一组共享properties文件即可。例如：</p><pre class="screen">autoconfig <span class="emphasis"><em>-n prod</em></span><a id="co.autoconfig.shared.multi.prod"><!--anchor co.autoconfig.shared.multi.prod--></a><span class="calloutno"><img src="images/callouts/1.png" border="0"/></span> ……                      // 使用prod生产环境的参数
autoconfig <span class="emphasis"><em>-n test</em></span><a id="co.autoconfig.shared.multi.test"><!--anchor co.autoconfig.shared.multi.test--></a><span class="calloutno"><img src="images/callouts/2.png" border="0"/></span> ……                      // 使用test测试环境的参数
autoconfig <a id="co.autoconfig.shared.multi.last"><!--anchor co.autoconfig.shared.multi.last--></a><span class="calloutno"><img src="images/callouts/3.png" border="0"/></span> ……                             // 不指定，则使用最近一次所选择的共享文件</pre></div></div></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="d0e18370"><!--anchor d0e18370--></a>13.4.5. AutoConfig常用命令</h3></div></div></div><p>下面罗列了AutoConfig的常用的命令及参数：</p><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="d0e18375"><!--anchor d0e18375--></a>13.4.5.1. 指定交互式界面的charset</h4></div></div></div><p>一般不需要特别指定charset，除非AutoConfig自动识别系统编码出错，导致显示乱码。</p><div class="informaltable"><table cellpadding="10" style="border: none;"><colgroup><col width="30%" class="c1"/><col width="70%" class="c2"/></colgroup><tbody><tr><td style="border-right: 0.5pt solid #6666cc; border-bottom: 0.5pt solid #6666cc; ">运行AutoConfig独立可执行程序</td><td style="border-bottom: 0.5pt solid #6666cc; ">
                                    <pre class="screen">autoconfig ... <span class="emphasis"><em>-c GBK</em></span></pre>
                                </td></tr><tr><td style="border-right: 0.5pt solid #6666cc; ">运行AutoConfig maven插件</td><td style="">
                                    <pre class="screen">mvn ... <span class="emphasis"><em>-Dautoconfig.charset=GBK</em></span></pre>
                                </td></tr></tbody></table></div></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="d0e18405"><!--anchor d0e18405--></a>13.4.5.2. 指定交互模式</h4></div></div></div><p>默认情况下，交互模式为自动（auto）。仅当user
                    properties中的值不满足auto-config.xml中的定义时，才会交互式地引导用户提供properties值。</p><p>但你可以强制打开交互模式： </p><div class="informaltable"><table cellpadding="10" style="border: none;"><colgroup><col width="30%" class="c1"/><col width="70%" class="c2"/></colgroup><tbody><tr><td style="border-right: 0.5pt solid #6666cc; border-bottom: 0.5pt solid #6666cc; ">运行AutoConfig独立可执行程序</td><td style="border-bottom: 0.5pt solid #6666cc; ">
                                    <pre class="screen">autoconfig ... <span class="emphasis"><em>–i</em></span>
autoconfig ... <span class="emphasis"><em>–i on</em></span></pre>
                                </td></tr><tr><td style="border-right: 0.5pt solid #6666cc; ">运行AutoConfig maven插件</td><td style="">
                                    <pre class="screen">mvn ... <span class="emphasis"><em>-Dautoconfig.interactive</em></span>
mvn ...  <span class="emphasis"><em>-Dautoconfig.interactive=true</em></span></pre>
                                </td></tr></tbody></table></div><p>或强制关闭交互模式：</p><div class="informaltable"><table cellpadding="10" style="border: none;"><colgroup><col width="30%" class="c1"/><col width="70%" class="c2"/></colgroup><tbody><tr><td style="border-right: 0.5pt solid #6666cc; border-bottom: 0.5pt solid #6666cc; ">运行AutoConfig独立可执行程序</td><td style="border-bottom: 0.5pt solid #6666cc; ">
                                    <pre class="screen">autoconfig ... <span class="emphasis"><em>–I</em></span>
autoconfig ... <span class="emphasis"><em>–i off</em></span></pre>
                                </td></tr><tr><td style="border-right: 0.5pt solid #6666cc; ">运行AutoConfig maven插件</td><td style="">
                                    <pre class="screen">mvn ...  <span class="emphasis"><em>-Dautoconfig.interactive=false</em></span></pre>
                                </td></tr></tbody></table></div></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="d0e18473"><!--anchor d0e18473--></a>13.4.5.3. 指定user properties</h4></div></div></div><p>默认情况下，AutoConfig会按下列顺序查找user properties：</p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><p><code class="filename">当前目录/antx.properties</code></p></li><li class="listitem"><p><code class="filename">当前用户HOME目录/antx.properties</code>
                            </p></li></ol></div><p>但你可以指定一个自己的properties文件，用下面的命令：</p><div class="informaltable"><table cellpadding="10" style="border: none;"><colgroup><col width="30%" class="c1"/><col width="70%" class="c2"/></colgroup><tbody><tr><td style="border-right: 0.5pt solid #6666cc; border-bottom: 0.5pt solid #6666cc; ">运行AutoConfig独立可执行程序</td><td style="border-bottom: 0.5pt solid #6666cc; ">
                                    <pre class="screen">autoconfig ... <span class="emphasis"><em>–u my.props</em></span></pre>
                                </td></tr><tr><td style="border-right: 0.5pt solid #6666cc; ">运行AutoConfig maven插件</td><td style="">
                                    <pre class="screen">mvn ... <span class="emphasis"><em>-Dautoconfig.userProperties=my.props</em></span></pre>
                                </td></tr></tbody></table></div></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="d0e18515"><!--anchor d0e18515--></a>13.4.5.4. 显示详细的信息</h4></div></div></div><p>默认情况下，AutoConfig只输出重要的信息，但有时你想了解更多内部的情况，只需要用下面的命令：</p><div class="informaltable"><table cellpadding="10" style="border: none;"><colgroup><col width="30%" class="c1"/><col width="70%" class="c2"/></colgroup><tbody><tr><td style="border-right: 0.5pt solid #6666cc; border-bottom: 0.5pt solid #6666cc; ">运行AutoConfig独立可执行程序</td><td style="border-bottom: 0.5pt solid #6666cc; ">
                                    <pre class="screen">autoconfig ... <span class="emphasis"><em>–v</em></span></pre>
                                </td></tr><tr><td style="border-right: 0.5pt solid #6666cc; ">运行AutoConfig maven插件</td><td style="">不适用</td></tr></tbody></table></div></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="d0e18540"><!--anchor d0e18540--></a>13.4.5.5. 指定输出文件</h4></div></div></div><p>默认情况下，AutoConfig所生成的配置文件以及日志信息会直接输出到当前包文件或目录中。例如以下命令会改变<code class="filename">petstore.war</code>的内容：</p><pre class="screen">autoconfig petstore.war</pre><p>但你可以指定另一个输出文件或目录，这样，原来的文件或目录就不会被修改：</p><div class="informaltable"><table cellpadding="10" style="border: none;"><colgroup><col width="30%" class="c1"/><col width="70%" class="c2"/></colgroup><tbody><tr><td style="border-right: 0.5pt solid #6666cc; border-bottom: 0.5pt solid #6666cc; ">运行AutoConfig独立可执行程序</td><td style="border-bottom: 0.5pt solid #6666cc; ">
                                    <pre class="screen">autoconfig petstore.war <span class="emphasis"><em>–o petstore-configured.war</em></span></pre>
                                </td></tr><tr><td style="border-right: 0.5pt solid #6666cc; ">运行AutoConfig maven插件</td><td style="">不适用</td></tr></tbody></table></div></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="d0e18572"><!--anchor d0e18572--></a>13.4.5.6. 避免执行AutoConfig</h4></div></div></div><p>将AutoConfig和maven package
                    phase绑定以后，每次build都会激活AutoConfig。假如你想跳过这一步，只需要下面的命令：</p><div class="informaltable"><table cellpadding="10" style="border: none;"><colgroup><col width="30%" class="c1"/><col width="70%" class="c2"/></colgroup><tbody><tr><td style="border-right: 0.5pt solid #6666cc; border-bottom: 0.5pt solid #6666cc; ">运行AutoConfig独立可执行程序</td><td style="border-bottom: 0.5pt solid #6666cc; ">不适用</td></tr><tr><td style="border-right: 0.5pt solid #6666cc; ">运行AutoConfig maven插件</td><td style="">
                                    <pre class="screen">mvn ... <span class="emphasis"><em>-Dautoconfig.skip</em></span></pre>
                                </td></tr></tbody></table></div></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="d0e18597"><!--anchor d0e18597--></a>13.4.5.7. 避免中断maven build</h4></div></div></div><p>默认情况下，假如发现有未定义的placeholders，AutoConfig会报错并中止maven的执行。假如你不想中断maven
                    build，可以这样做：</p><div class="informaltable"><table cellpadding="10" style="border: none;"><colgroup><col width="30%" class="c1"/><col width="70%" class="c2"/></colgroup><tbody><tr><td style="border-right: 0.5pt solid #6666cc; border-bottom: 0.5pt solid #6666cc; ">运行AutoConfig独立可执行程序</td><td style="border-bottom: 0.5pt solid #6666cc; ">不适用</td></tr><tr><td style="border-right: 0.5pt solid #6666cc; ">运行AutoConfig maven插件</td><td style="">
                                    <pre class="screen">mvn ... <span class="emphasis"><em>-Dautoconfig.strict=false</em></span></pre>
                                </td></tr></tbody></table></div></div></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="d0e18622"><!--anchor d0e18622--></a>13.5. 本章总结</h2></div></div></div><p>AutoConfig是一个简单而有用的小工具，弥补了Maven Filtering及类似机制的不足。但它还有不少改进的余地。</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>界面不够直观。如果能够通过GUI或WEB界面来配置，就更好了。</p></li><li class="listitem"><p>Properties validator目前不易扩展。</p></li><li class="listitem"><p>缺少集成环境的支持。</p></li></ul></div></div></div><div class="navfooter"><hr/><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="springext-plugin.html">上一页</a> </td><td width="20%" align="center"><a accesskey="u" href="pt05.html">上一级</a></td><td width="40%" align="right"> <a accesskey="n" href="autoexpand.html">下一页</a></td></tr><tr><td width="40%" align="left" valign="top">第 12 章 安装和使用SpringExt插件 </td><td width="20%" align="center"><a accesskey="h" href="index.html">起始页</a></td><td width="40%" align="right" valign="top"> 第 14 章 AutoExpand工具使用指南</td></tr></table></div></body></html>