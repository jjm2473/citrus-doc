<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html
  PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"><head><title>第 9 章 表单验证服务指南</title><link rel="stylesheet" type="text/css" href="docbook.css"/><meta name="generator" content="DocBook XSL Stylesheets V1.77.1"/><link rel="home" href="index.html" title="Webx框架指南"/><link rel="up" href="pt03.html" title="部分 III. Webx应用支持服务"/><link rel="prev" href="pt03.html" title="部分 III. Webx应用支持服务"/><link rel="next" href="pt04.html" title="部分 IV. Webx应用实作"/><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/></head><body><div class="navheader"><table width="100%" summary="Navigation header"><tr><th colspan="3" align="center">第 9 章 表单验证服务指南</th></tr><tr><td width="20%" align="left"><a accesskey="p" href="pt03.html">上一页</a> </td><th width="60%" align="center">部分 III. Webx应用支持服务</th><td width="20%" align="right"> <a accesskey="n" href="pt04.html">下一页</a></td></tr></table><hr/></div><div xml:lang="zh-CN" class="chapter"><div class="titlepage"><div><div><h2 class="title"><a id="webx.form"><!--anchor webx.form--></a>第 9 章 表单验证服务指南</h2></div></div></div><div class="toc"><dl><dt><span class="section"><a href="form.html#d0e10831">9.1. 表单概述</a></span></dt><dd><dl><dt><span class="section"><a href="form.html#d0e10834">9.1.1. 什么是表单验证</a></span></dt><dt><span class="section"><a href="form.html#d0e10883">9.1.2. 表单验证的形式</a></span></dt></dl></dd><dt><span class="section"><a href="form.html#d0e11104">9.2. 设计</a></span></dt><dd><dl><dt><span class="section"><a href="form.html#d0e11107">9.2.1. 验证逻辑与表现逻辑分离</a></span></dt><dt><span class="section"><a href="form.html#d0e11121">9.2.2. 验证逻辑和应用代码分离</a></span></dt><dt><span class="section"><a href="form.html#d0e11138">9.2.3. 表单验证的流程</a></span></dt></dl></dd><dt><span class="section"><a href="form.html#d0e11211">9.3. 使用表单验证服务</a></span></dt><dd><dl><dt><span class="section"><a href="form.html#d0e11244">9.3.1. 创建新数据</a></span></dt><dt><span class="section"><a href="form.html#d0e11643">9.3.2. 修改老数据</a></span></dt><dt><span class="section"><a href="form.html#d0e11782">9.3.3. 批量创建或修改数据</a></span></dt></dl></dd><dt><span class="section"><a href="form.html#d0e11945">9.4. 表单验证服务详解</a></span></dt><dd><dl><dt><span class="section"><a href="form.html#d0e11948">9.4.1. 配置详解</a></span></dt><dt><span class="section"><a href="form.html#d0e12891">9.4.2. Validators</a></span></dt><dt><span class="section"><a href="form.html#d0e14091">9.4.3. Form Tool</a></span></dt><dt><span class="section"><a href="form.html#d0e14313">9.4.4. Field keys的格式</a></span></dt><dt><span class="section"><a href="form.html#d0e14502">9.4.5. 外部验证</a></span></dt></dl></dd><dt><span class="section"><a href="form.html#d0e14560">9.5. 本章总结</a></span></dt></dl></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="d0e10831"><!--anchor d0e10831--></a>9.1. 表单概述</h2></div></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="d0e10834"><!--anchor d0e10834--></a>9.1.1. 什么是表单验证</h3></div></div></div><p>在WEB应用中，表单验证是非常重要的一环。表单验证，顾名思义，就是确保用户所填写的数据符合应用的要求。例如下面这个“注册新帐户”的表单：</p><div class="figure"><a id="d0e10839"><!--anchor d0e10839--></a><div class="figure-contents"><div class="mediaobject"><img src="images/form/form-sample.png" alt="一个典型的表单页面"/></div></div><p class="title"><strong>图 9.1. 一个典型的表单页面</strong></p></div><p>在这个表单中，各字段需要符合以下规则：</p><div class="table"><a id="d0e10847"><!--anchor d0e10847--></a><p class="title"><strong>表 9.1. 注册新帐户的规则</strong></p><div class="table-contents"><table summary="注册新帐户的规则" cellpadding="10" style="border: none;"><colgroup><col width="38%" class="c1"/><col width="62%" class="c2"/></colgroup><thead><tr><th style="border-right: 0.5pt solid #6666cc; border-bottom: 0.5pt solid #6666cc; ">字段名</th><th style="border-bottom: 0.5pt solid #6666cc; ">规则</th></tr></thead><tbody><tr><td style="border-right: 0.5pt solid #6666cc; border-bottom: 0.5pt solid #6666cc; " rowspan="2">用户名</td><td style="border-bottom: 0.5pt solid #6666cc; ">必须由字母、数字、下划线构成。 · 用户名的</td></tr><tr><td style="border-bottom: 0.5pt solid #6666cc; ">长度必须在某个范围内，例如，4-10个字符。</td></tr><tr><td style="border-right: 0.5pt solid #6666cc; border-bottom: 0.5pt solid #6666cc; " rowspan="2">密码</td><td style="border-bottom: 0.5pt solid #6666cc; ">长度必须在某个范围内，例如，4-10个字符。</td></tr><tr><td style="border-bottom: 0.5pt solid #6666cc; ">密码和用户名不能相同，以保证基本的安全性。</td></tr><tr><td style="border-right: 0.5pt solid #6666cc; ">确认密码（再输一遍密码）</td><td style="">必须和密码相同，确保用户没有打字错误。</td></tr></tbody></table></div></div><p>从技术上讲，表单验证完全可以用手工书写代码的方式来实现。但是这样做既无趣，又容易出错，而且难以维护 ——
                特别是当你需要修改验证规则时。因此，几乎所有的WEB框架都提供了表单验证的功能，使你能方便、快速地书写或修改表单验证的规则。</p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="d0e10883"><!--anchor d0e10883--></a>9.1.2. 表单验证的形式</h3></div></div></div><p>验证WEB页面中的表单有如下几种形式：</p><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="d0e10888"><!--anchor d0e10888--></a>9.1.2.1. 服务端批量验证</h4></div></div></div><div class="figure"><a id="d0e10891"><!--anchor d0e10891--></a><div class="figure-contents"><div class="mediaobject"><img src="images/form/server-side-validation.png" alt="服务端批量验证"/></div></div><p class="title"><strong>图 9.2. 服务端批量验证</strong></p></div><p>服务端批量验证是最传统验证形式，它将所有表单字段一次性提交给服务器来验证。服务器对所有表单进行批量的验证后，根据验证的结果跳转到不同的结果页面。</p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="d0e10899"><!--anchor d0e10899--></a>9.1.2.2. 客户端验证</h4></div></div></div><div class="figure"><a id="d0e10902"><!--anchor d0e10902--></a><div class="figure-contents"><div class="mediaobject"><img src="images/form/client-side-validation.png" alt="客户端验证"/></div></div><p class="title"><strong>图 9.3. 客户端验证</strong></p></div><p>客户端验证是利用Java Script对用户输入的数据进行逐个验证。 </p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="d0e10910"><!--anchor d0e10910--></a>9.1.2.3. 服务端异步验证</h4></div></div></div><div class="figure"><a id="d0e10913"><!--anchor d0e10913--></a><div class="figure-contents"><div class="mediaobject"><img src="images/form/async-validation.png" alt="服务端异步验证"/></div></div><p class="title"><strong>图 9.4. 服务端异步验证</strong></p></div><p>服务器异步验证是利用Java
                    Script发出异步AJAX请求，来要求服务器验证单个或多个字段。如果网络延迟不明显，那么服务器异步验证给用户的体验类似于客户端验证。</p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="d0e10921"><!--anchor d0e10921--></a>9.1.2.4. 混合式验证</h4></div></div></div><p>以上几种验证手段各有优缺点：</p><div class="table"><a id="d0e10926"><!--anchor d0e10926--></a><p class="title"><strong>表 9.2. 各种表单验证的优缺点比较</strong></p><div class="table-contents"><table summary="各种表单验证的优缺点比较" cellpadding="10" style="border: none;"><colgroup><col width="16%" class="c1"/><col width="17%" class="c2"/><col width="17%" class="c3"/><col width="16%" class="c4"/><col width="17%" class="c5"/><col width="17%" class="c6"/></colgroup><thead><tr><th style="border-right: 0.5pt solid #6666cc; border-bottom: 0.5pt solid #6666cc; ">验证形式</th><th style="border-right: 0.5pt solid #6666cc; border-bottom: 0.5pt solid #6666cc; ">功能性</th><th style="border-right: 0.5pt solid #6666cc; border-bottom: 0.5pt solid #6666cc; ">网络负荷</th><th style="border-right: 0.5pt solid #6666cc; border-bottom: 0.5pt solid #6666cc; ">用户体验</th><th style="border-right: 0.5pt solid #6666cc; border-bottom: 0.5pt solid #6666cc; ">简单性</th><th style="border-bottom: 0.5pt solid #6666cc; ">可靠性</th></tr></thead><tbody><tr><th style="border-right: 0.5pt solid #6666cc; border-bottom: 0.5pt solid #6666cc; ">服务端批量验证</th><td style="border-right: 0.5pt solid #6666cc; border-bottom: 0.5pt solid #6666cc; ">
                                    <p><span class="emphasis"><em>强</em></span>。</p>
                                    <p>由于验证逻辑存在于服务器上，可访问服务器的一切资源，功能最强。</p>
                                </td><td style="border-right: 0.5pt solid #6666cc; border-bottom: 0.5pt solid #6666cc; ">
                                    <p>高。</p>
                                    <p>当用户填错任意一个字段时，所有的字段都必须在浏览器和服务器之间来回传输一次。所以它会给网络传输带来较高的负荷。</p>
                                </td><td style="border-right: 0.5pt solid #6666cc; border-bottom: 0.5pt solid #6666cc; ">
                                    <p>差。</p>
                                    <p>由于网络负荷较高，造成的响应迟缓。此外，验证失败时必须整个页面被刷新。这些会给用户带来不好的体验。</p>
                                </td><td style="border-right: 0.5pt solid #6666cc; border-bottom: 0.5pt solid #6666cc; ">
                                    <p><span class="emphasis"><em>简单</em></span>。</p>
                                    <p>它的实现比较简单。</p>
                                </td><td style="border-bottom: 0.5pt solid #6666cc; ">
                                    <p><span class="emphasis"><em>可靠</em></span>。</p>
                                    <p>相对于其它几种方式，服务端批量验证也是最可靠的方式。因为Java Script可能会失效（因为浏览器不支持、Java
                                        Script被关闭、网站受攻击等原因），但服务器批量验证总不会失效。</p>
                                </td></tr><tr><th style="border-right: 0.5pt solid #6666cc; border-bottom: 0.5pt solid #6666cc; ">客户端验证</th><td style="border-right: 0.5pt solid #6666cc; border-bottom: 0.5pt solid #6666cc; ">
                                    <p>弱。</p>
                                    <p>由于验证逻辑存在于用户浏览器上，不能访问服务器资源，因此有一些功能无法实现，例如：检查验证码、确认注册用户ID未被占用等。</p>
                                </td><td style="border-right: 0.5pt solid #6666cc; border-bottom: 0.5pt solid #6666cc; ">
                                    <p><span class="emphasis"><em>无</em></span>。</p>
                                    <p>在验证时，不需要网络通信，不存在网络负荷。</p>
                                </td><td style="border-right: 0.5pt solid #6666cc; border-bottom: 0.5pt solid #6666cc; ">
                                    <p><span class="emphasis"><em>好</em></span>。</p>
                                    <p>响应速度极快，用户体验最好。</p>
                                </td><td style="border-right: 0.5pt solid #6666cc; " rowspan="2">
                                    <p>复杂。</p>
                                    <p>因为需要JS编程。</p>
                                </td><td style="" rowspan="2">
                                    <p>不可靠。</p>
                                    <p>由于下列原因，Java Script可能会失效，使得客户端验证被跳过：</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>浏览器不支持</p></li><li class="listitem"><p>Java Script被关闭</p></li><li class="listitem"><p>网站受攻击</p></li></ul></div>
                                </td></tr><tr><th style="border-right: 0.5pt solid #6666cc; ">服务端异步验证</th><td style="border-right: 0.5pt solid #6666cc; ">
                                    <p><span class="emphasis"><em>强</em></span>。</p>
                                    <p>由于验证逻辑存在于服务器上，可访问服务器的一切资源，功能也很强。</p>
                                </td><td style="border-right: 0.5pt solid #6666cc; ">
                                    <p>低。</p>
                                    <p>每次验证，只需要发送当前被验证字段的数据即可，网络负荷较小。</p>
                                </td><td style="border-right: 0.5pt solid #6666cc; ">
                                    <p>较好。</p>
                                    <p>由于网络负荷小，用户响应远快于服务端批量验证，用户体验好。</p>
                                </td></tr></tbody></table></div></div><p>没有一种验证方法是完美的。但把它们结合起来就可以克服各自的缺点，达到较完美的境地：</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>对所有字段做服务器端批量验证，即便Java Script失效，服务器验证可作为最后的防线。</p></li><li class="listitem"><p>只要有可能，就对字段做客户端验证，确保最迅速的响应和较好的用户体验。</p></li><li class="listitem"><p>对于必须访问服务器资源的验证逻辑，例如检查验证码、确认注册帐户ID未被占用等，采用服务器异步验证，提高用户体验。</p></li></ul></div><p>以上混合形式的验证无疑是好的，但是它的实现也比较复杂。</p><p><span class="emphasis"><em>目前Webx所提供的表单验证服务并没有实现客户端验证和服务端异步验证</em></span>。这些功能将在后续版本中实现。在现阶段中，应用开发者必须手工编码Java
                    Script来实现客户端验证和服务端异步验证。</p></div></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="d0e11104"><!--anchor d0e11104--></a>9.2. 设计</h2></div></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="d0e11107"><!--anchor d0e11107--></a>9.2.1. 验证逻辑与表现逻辑分离</h3></div></div></div><p>很容易想到的一种表单验证的实现，就是将表单验证的逻辑内嵌在页面模板中。例如，某些WEB框架实现了一些用来验证表单的JSP tags。类似下面的样子：</p><div class="example"><a id="d0e11112"><!--anchor d0e11112--></a><p class="title"><strong>例 9.1. 将验证逻辑内嵌在页面模板中</strong></p><div class="example-contents"><pre class="programlisting"><strong class="hl-tag" style="color: #000096">&lt;input</strong> <span class="hl-attribute" style="color: #F5844C">type</span>=<span class="hl-value" style="color: #993300">"text"</span> <span class="hl-attribute" style="color: #F5844C">name</span>=<span class="hl-value" style="color: #993300">"loginId"</span> <span class="hl-attribute" style="color: #F5844C">value</span>=<span class="hl-value" style="color: #993300">"${loginId}"</span><strong class="hl-tag" style="color: #000096"> /&gt;</strong>
<strong class="hl-tag" style="color: #000096">&lt;form:required</strong> <span class="hl-attribute" style="color: #F5844C">value</span>=<span class="hl-value" style="color: #993300">"${loginId}"</span><strong class="hl-tag" style="color: #000096">&gt;</strong>
  <strong class="hl-tag" style="color: #000096">&lt;strong&gt;</strong>Login ID is required.<strong class="hl-tag" style="color: #000096">&lt;/strong&gt;</strong>
<strong class="hl-tag" style="color: #000096">&lt;/form:required&gt;</strong>
<strong class="hl-tag" style="color: #000096">&lt;form:regexp</strong> <span class="hl-attribute" style="color: #F5844C">value</span>=<span class="hl-value" style="color: #993300">"${loginId}"</span> <span class="hl-attribute" style="color: #F5844C">pattern</span>=<span class="hl-value" style="color: #993300">"^\w+$"</span><strong class="hl-tag" style="color: #000096">&gt;</strong>
  <strong class="hl-tag" style="color: #000096">&lt;strong&gt;</strong>Login ID is invalid.<strong class="hl-tag" style="color: #000096">&lt;/strong&gt;</strong>
<strong class="hl-tag" style="color: #000096">&lt;/form:regexp&gt;</strong></pre></div></div><p>将验证逻辑内嵌在页面模板中最大的问题是，验证逻辑和页面的表现逻辑完全混合在一起。当你需要修改验证规则时，你必须找出所有的页面，从复杂的HTML代码中，一个不漏地找到并修改它们。这是一件费时费力的工作，而且很容易出错。另一方面，嵌在页面模板中的验证规则是不能被多个页面共享和复用的。</p><p>Webx表单验证服务主张验证逻辑和页面表现逻辑完全分离。所有的验证规则都写在一个单独的配置文件中 ——
                页面模板是不需要关心这些验证规则的。当你需要修改验证规则时，只需要修改独立的配置文件就可以了，并不用修改页面模板。</p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="d0e11121"><!--anchor d0e11121--></a>9.2.2. 验证逻辑和应用代码分离</h3></div></div></div><p>另一种容易想到的方法，是把表单验证的逻辑写在Java代码中。例如，在Java代码中直接调用验证逻辑。更高级一点，也许可以通过annotation机制在Java代码中定义验证逻辑，像下面的样子：</p><div class="example"><a id="d0e11126"><!--anchor d0e11126--></a><p class="title"><strong>例 9.2. 将验证逻辑内嵌在Java代码中</strong></p><div class="example-contents"><pre class="programlisting"><strong class="hl-keyword" style="color: maroon">public</strong> <strong class="hl-keyword" style="color: maroon">class</strong> LoginAction {
    <em><span class="hl-annotation" style="color: gray">@Required</span></em>
    <em><span class="hl-annotation" style="color: gray">@Regexp("^\\w+$")</span></em>
    <strong class="hl-keyword" style="color: maroon">private</strong> String loginId;
    …
}</pre></div></div><p>这样做的问题是，当你需要修改验证规则时，你必须一个不漏地找到所有定义annotations的那些代码，并修改它们。另一方面，annotation机制不容易扩展，很难方便地增加新的验证方案。</p><p>Webx表单验证服务主张<span class="emphasis"><em>验证逻辑和应用代码完全分离</em></span>。所有的验证规则都写在一个单独的配置文件中 ——
                应用程序的代码是不需要关心这些验证规则的。当你需要修改验证规则时，只需要修改独立的配置文件就可以了，并不需要修改程序代码。</p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="d0e11138"><!--anchor d0e11138--></a>9.2.3. 表单验证的流程</h3></div></div></div><div class="table"><a id="d0e11141"><!--anchor d0e11141--></a><p class="title"><strong>表 9.3. 一个基本的表单验证流程</strong></p><div class="table-contents"><table summary="一个基本的表单验证流程" cellpadding="10" style="border: none;"><colgroup><col width="11%" class="c1"/><col width="22%" align="right" class="c2"/><col width="22%" class="c3"/><col width="45%" align="center" class="c4"/></colgroup><thead><tr><th style="border-right: 0.5pt solid #6666cc; border-bottom: 0.5pt solid #6666cc; ">步骤</th><th style="border-right: 0.5pt solid #6666cc; border-bottom: 0.5pt solid #6666cc; " align="right">客户端浏览器</th><th style="border-right: 0.5pt solid #6666cc; border-bottom: 0.5pt solid #6666cc; ">WEB服务器</th><th style="border-bottom: 0.5pt solid #6666cc; " align="center">页面效果</th></tr></thead><tbody><tr><td style="border-right: 0.5pt solid #6666cc; border-bottom: 0.5pt solid #6666cc; " rowspan="2">1.</td><td style="border-right: 0.5pt solid #6666cc; border-bottom: 0.5pt solid #6666cc; " align="right">请求表单页面 →</td><td style="border-right: 0.5pt solid #6666cc; border-bottom: 0.5pt solid #6666cc; "> </td><td style="border-bottom: 0.5pt solid #6666cc; " rowspan="2" align="center" valign="middle">
                                <div class="informalfigure"><div class="mediaobject"><img src="images/form/form-sample-empty.png"/></div></div>
                            </td></tr><tr><td style="border-right: 0.5pt solid #6666cc; border-bottom: 0.5pt solid #6666cc; " align="right"> </td><td style="border-right: 0.5pt solid #6666cc; border-bottom: 0.5pt solid #6666cc; ">← 返回空白表单</td></tr><tr><td style="border-right: 0.5pt solid #6666cc; border-bottom: 0.5pt solid #6666cc; " rowspan="2">2.</td><td style="border-right: 0.5pt solid #6666cc; border-bottom: 0.5pt solid #6666cc; " align="right">用户填写表单，并提交 →</td><td style="border-right: 0.5pt solid #6666cc; border-bottom: 0.5pt solid #6666cc; "> </td><td style="border-bottom: 0.5pt solid #6666cc; " rowspan="2" align="center" valign="middle">
                                <div class="informalfigure"><div class="mediaobject"><img src="images/form/form-sample-validation-failed.png"/></div></div>
                            </td></tr><tr><td style="border-right: 0.5pt solid #6666cc; border-bottom: 0.5pt solid #6666cc; " align="right"> </td><td style="border-right: 0.5pt solid #6666cc; border-bottom: 0.5pt solid #6666cc; ">← 验证表单数据，如果验证有错，则返回包含错误信息的表单页面，并提示出错信息。</td></tr><tr><td style="border-right: 0.5pt solid #6666cc; " rowspan="2">3.</td><td style="border-right: 0.5pt solid #6666cc; border-bottom: 0.5pt solid #6666cc; " align="right">用户修改表单，并再次提交（重复该步骤直至验证成功） →</td><td style="border-right: 0.5pt solid #6666cc; border-bottom: 0.5pt solid #6666cc; "> </td><td style="" rowspan="2" align="center" valign="middle">
                                <div class="informalfigure"><div class="mediaobject"><img src="images/form/form-sample-validation-succ.png"/></div></div>
                            </td></tr><tr><td style="border-right: 0.5pt solid #6666cc; " align="right"> </td><td style="border-right: 0.5pt solid #6666cc; ">← 验证表单数据，如果验证通过，则转至下一个页面。通常是显示成功信息。</td></tr></tbody></table></div></div></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="d0e11211"><!--anchor d0e11211--></a>9.3. 使用表单验证服务</h2></div></div></div><p>Webx表单验证服务可用来支持以下几种类型的表单需求：</p><div class="table"><a id="d0e11216"><!--anchor d0e11216--></a><p class="title"><strong>表 9.4. 几种表单需求</strong></p><div class="table-contents"><table summary="几种表单需求" cellpadding="10" style="border: none;"><colgroup><col width="27%" class="c1"/><col width="73%" class="c2"/></colgroup><thead><tr><th style="border-right: 0.5pt solid #6666cc; border-bottom: 0.5pt solid #6666cc; ">需求名称</th><th style="border-bottom: 0.5pt solid #6666cc; ">说明</th></tr></thead><tbody><tr><td style="border-right: 0.5pt solid #6666cc; border-bottom: 0.5pt solid #6666cc; ">创建新数据</td><td style="border-bottom: 0.5pt solid #6666cc; ">也就是让用户在一个空白的表单上填写数据，并验证之。例如，注册一个新帐户。</td></tr><tr><td style="border-right: 0.5pt solid #6666cc; border-bottom: 0.5pt solid #6666cc; ">修改老数据</td><td style="border-bottom: 0.5pt solid #6666cc; ">也就是让用户在已填有数据的表单上进行修改，并验证之。例如，修改帐户信息。</td></tr><tr><td style="border-right: 0.5pt solid #6666cc; ">批量创建、修改数据</td><td style="">也就是在一个表单中，一次性创建、修改多个数据对象。例如，管理员批量审核帐户。</td></tr></tbody></table></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="d0e11244"><!--anchor d0e11244--></a>9.3.1. 创建新数据</h3></div></div></div><p>下面的例子实现了“注册一个新帐户”的功能。</p><p>为了实现表单验证的功能，需要由三个部分配合起来工作：</p><div class="table"><a id="d0e11251"><!--anchor d0e11251--></a><p class="title"><strong>表 9.5. 验证表单所需的部件</strong></p><div class="table-contents"><table summary="验证表单所需的部件" cellpadding="10" style="border: none;"><colgroup><col width="27%" class="c1"/><col width="73%" class="c2"/></colgroup><thead><tr><th style="border-right: 0.5pt solid #6666cc; border-bottom: 0.5pt solid #6666cc; ">部件名称</th><th style="border-bottom: 0.5pt solid #6666cc; ">说明</th></tr></thead><tbody><tr><td style="border-right: 0.5pt solid #6666cc; border-bottom: 0.5pt solid #6666cc; ">验证规则</td><td style="border-bottom: 0.5pt solid #6666cc; ">也就是form service的配置文件。</td></tr><tr><td style="border-right: 0.5pt solid #6666cc; border-bottom: 0.5pt solid #6666cc; ">页面模板</td><td style="border-bottom: 0.5pt solid #6666cc; ">通过<code class="code">$form</code>工具，生成表单页面。</td></tr><tr><td style="border-right: 0.5pt solid #6666cc; ">Java代码</td><td style="">接收表单数据，并作后续处理。</td></tr></tbody></table></div></div><p>下面逐个介绍。</p><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="d0e11284"><!--anchor d0e11284--></a>9.3.1.1. 定义验证规则</h4></div></div></div><p>表单验证服务是一个基于Spring和Spring Ext的服务，可利用Schema来配置。示例如下：</p><div class="example"><a id="d0e11289"><!--anchor d0e11289--></a><p class="title"><strong>例 9.3. 表单验证规则示例</strong></p><div class="example-contents"><pre class="programlisting"><strong class="hl-tag" style="color: #000096">&lt;beans:beans</strong> <span class="hl-attribute" style="color: #F5844C">xmlns:xsi</span>=<span class="hl-value" style="color: #993300">"http://www.w3.org/2001/XMLSchema-instance"</span>
    <span class="hl-attribute" style="color: #F5844C">xmlns:services</span>=<span class="hl-value" style="color: #993300">"http://www.alibaba.com/schema/services"</span>
    <span class="hl-attribute" style="color: #F5844C">xmlns:fm-conditions</span>=<span class="hl-value" style="color: #993300">"http://www.alibaba.com/schema/services/form/conditions"</span>
    <span class="hl-attribute" style="color: #F5844C">xmlns:fm-validators</span>=<span class="hl-value" style="color: #993300">"http://www.alibaba.com/schema/services/form/validators"</span>
    <span class="hl-attribute" style="color: #F5844C">xmlns:beans</span>=<span class="hl-value" style="color: #993300">"http://www.springframework.org/schema/beans"</span>
    <span class="hl-attribute" style="color: #F5844C">xmlns:p</span>=<span class="hl-value" style="color: #993300">"http://www.springframework.org/schema/p"</span>
    <span class="hl-attribute" style="color: #F5844C">xsi:schemaLocation</span>=<span class="hl-value" style="color: #993300">"
        http://www.alibaba.com/schema/services
            http://localhost:8080/schema/services.xsd
        http://www.alibaba.com/schema/services/form/conditions
            http://localhost:8080/schema/services-form-conditions.xsd
        http://www.alibaba.com/schema/services/form/validators
            http://localhost:8080/schema/services-form-validators.xsd
        http://www.springframework.org/schema/beans
            http://localhost:8080/schema/www.springframework.org/schema/beans/spring-beans.xsd
    "</span><strong class="hl-tag" style="color: #000096">&gt;</strong>

    <strong class="hl-tag" style="color: #000096">&lt;services:form</strong> <span class="hl-attribute" style="color: #F5844C">xmlns</span>=<span class="hl-value" style="color: #993300">"http://www.alibaba.com/schema/services/form/validators"</span><strong class="hl-tag" style="color: #000096">&gt;</strong> <a id="co.form.rules.form"><!--anchor co.form.rules.form--></a><span class="calloutno"><img src="images/callouts/1.png" border="0"/></span>
        <strong class="hl-tag" style="color: #000096">&lt;services:group</strong> <span class="hl-attribute" style="color: #F5844C">name</span>=<span class="hl-value" style="color: #993300">"register"</span><strong class="hl-tag" style="color: #000096">&gt;</strong> <a id="co.form.rules.group"><!--anchor co.form.rules.group--></a><span class="calloutno"><img src="images/callouts/2.png" border="0"/></span>

            <strong class="hl-tag" style="color: #000096">&lt;services:field</strong> <span class="hl-attribute" style="color: #F5844C">name</span>=<span class="hl-value" style="color: #993300">"userId"</span> <span class="hl-attribute" style="color: #F5844C">displayName</span>=<span class="hl-value" style="color: #993300">"登录名"</span><strong class="hl-tag" style="color: #000096">&gt;</strong> <a id="co.form.rules.field"><!--anchor co.form.rules.field--></a><span class="calloutno"><img src="images/callouts/3.png" border="0"/></span>
                <strong class="hl-tag" style="color: #000096">&lt;required-validator&gt;</strong> <a id="co.form.rules.validator"><!--anchor co.form.rules.validator--></a><span class="calloutno"><img src="images/callouts/4.png" border="0"/></span>
                    <strong class="hl-tag" style="color: #000096">&lt;message&gt;</strong>必须填写 ${displayName}<strong class="hl-tag" style="color: #000096">&lt;/message&gt;</strong> <a id="co.form.rules.validator.msg"><!--anchor co.form.rules.validator.msg--></a><span class="calloutno"><img src="images/callouts/5.png" border="0"/></span>
                <strong class="hl-tag" style="color: #000096">&lt;/required-validator&gt;</strong>
                <strong class="hl-tag" style="color: #000096">&lt;regexp-validator</strong> <span class="hl-attribute" style="color: #F5844C">pattern</span>=<span class="hl-value" style="color: #993300">"^[A-Za-z_][A-Za-z_0-9]*$"</span><strong class="hl-tag" style="color: #000096">&gt;</strong>
                    <strong class="hl-tag" style="color: #000096">&lt;message&gt;</strong>${displayName} 必须由字母、数字、下划线构成<strong class="hl-tag" style="color: #000096">&lt;/message&gt;</strong>
                <strong class="hl-tag" style="color: #000096">&lt;/regexp-validator&gt;</strong>
                <strong class="hl-tag" style="color: #000096">&lt;string-length-validator</strong> <span class="hl-attribute" style="color: #F5844C">minLength</span>=<span class="hl-value" style="color: #993300">"4"</span> <span class="hl-attribute" style="color: #F5844C">maxLength</span>=<span class="hl-value" style="color: #993300">"10"</span><strong class="hl-tag" style="color: #000096">&gt;</strong>
                    <strong class="hl-tag" style="color: #000096">&lt;message&gt;</strong>${displayName} 最少必须由${minLength}个字组成，最多不能超过${maxLength}个字<strong class="hl-tag" style="color: #000096">&lt;/message&gt;</strong>
                <strong class="hl-tag" style="color: #000096">&lt;/string-length-validator&gt;</strong>
            <strong class="hl-tag" style="color: #000096">&lt;/services:field&gt;</strong>

            <strong class="hl-tag" style="color: #000096">&lt;services:field</strong> <span class="hl-attribute" style="color: #F5844C">name</span>=<span class="hl-value" style="color: #993300">"password"</span> <span class="hl-attribute" style="color: #F5844C">displayName</span>=<span class="hl-value" style="color: #993300">"密码"</span><strong class="hl-tag" style="color: #000096">&gt;</strong>
                <strong class="hl-tag" style="color: #000096">&lt;required-validator&gt;</strong>
                    <strong class="hl-tag" style="color: #000096">&lt;message&gt;</strong>必须填写 ${displayName}<strong class="hl-tag" style="color: #000096">&lt;/message&gt;</strong>
                <strong class="hl-tag" style="color: #000096">&lt;/required-validator&gt;</strong>
                <strong class="hl-tag" style="color: #000096">&lt;string-length-validator</strong> <span class="hl-attribute" style="color: #F5844C">minLength</span>=<span class="hl-value" style="color: #993300">"4"</span> <span class="hl-attribute" style="color: #F5844C">maxLength</span>=<span class="hl-value" style="color: #993300">"10"</span><strong class="hl-tag" style="color: #000096">&gt;</strong>
                    <strong class="hl-tag" style="color: #000096">&lt;message&gt;</strong>${displayName} 最少必须由${minLength}个字组成，最多不能超过${maxLength}个字<strong class="hl-tag" style="color: #000096">&lt;/message&gt;</strong>
                <strong class="hl-tag" style="color: #000096">&lt;/string-length-validator&gt;</strong>
                <strong class="hl-tag" style="color: #000096">&lt;string-compare-validator</strong> <span class="hl-attribute" style="color: #F5844C">notEqualTo</span>=<span class="hl-value" style="color: #993300">"userId"</span><strong class="hl-tag" style="color: #000096">&gt;</strong>
                    <strong class="hl-tag" style="color: #000096">&lt;message&gt;</strong>${displayName} 不能与 ${userId.displayName} 相同<strong class="hl-tag" style="color: #000096">&lt;/message&gt;</strong>
                <strong class="hl-tag" style="color: #000096">&lt;/string-compare-validator&gt;</strong>
            <strong class="hl-tag" style="color: #000096">&lt;/services:field&gt;</strong>

            <strong class="hl-tag" style="color: #000096">&lt;services:field</strong> <span class="hl-attribute" style="color: #F5844C">name</span>=<span class="hl-value" style="color: #993300">"passwordConfirm"</span> <span class="hl-attribute" style="color: #F5844C">displayName</span>=<span class="hl-value" style="color: #993300">"密码验证"</span><strong class="hl-tag" style="color: #000096">&gt;</strong>
                <strong class="hl-tag" style="color: #000096">&lt;required-validator&gt;</strong>
                    <strong class="hl-tag" style="color: #000096">&lt;message&gt;</strong>必须填写 ${displayName}<strong class="hl-tag" style="color: #000096">&lt;/message&gt;</strong>
                <strong class="hl-tag" style="color: #000096">&lt;/required-validator&gt;</strong>
                <strong class="hl-tag" style="color: #000096">&lt;string-compare-validator</strong> <span class="hl-attribute" style="color: #F5844C">equalTo</span>=<span class="hl-value" style="color: #993300">"password"</span><strong class="hl-tag" style="color: #000096">&gt;</strong>
                    <strong class="hl-tag" style="color: #000096">&lt;message&gt;</strong>${displayName} 必须和 ${password.displayName} 相同<strong class="hl-tag" style="color: #000096">&lt;/message&gt;</strong>
                <strong class="hl-tag" style="color: #000096">&lt;/string-compare-validator&gt;</strong>
            <strong class="hl-tag" style="color: #000096">&lt;/services:field&gt;</strong>

        <strong class="hl-tag" style="color: #000096">&lt;/services:group&gt;</strong>

    <strong class="hl-tag" style="color: #000096">&lt;/services:form&gt;</strong>

<strong class="hl-tag" style="color: #000096">&lt;/beans:beans&gt;</strong></pre><div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#co.form.rules.form"><span class="calloutno"><img src="images/callouts/1.png" border="0"/></span></a> </p></td><td valign="top" align="left"><p><code class="code">&lt;form&gt;</code>代表表单验证服务的配置。从这里开始定义表单验证的规则。</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#co.form.rules.group"><span class="calloutno"><img src="images/callouts/2.png" border="0"/></span></a> </p></td><td valign="top" align="left"><p>可以定义多个groups，每个group有一个唯一的名称，例如：“<code class="code">register</code>”。每个group代表了一组需要验证的字段（field）。</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#co.form.rules.field"><span class="calloutno"><img src="images/callouts/3.png" border="0"/></span></a> </p></td><td valign="top" align="left"><p>每个field有一个在组中唯一的名称，例如：“<code class="code">userId</code>”、“<code class="code">password</code>”等。</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#co.form.rules.validator"><span class="calloutno"><img src="images/callouts/4.png" border="0"/></span></a> </p></td><td valign="top" align="left"><p>每个field又包含了多个验证规则（validator）。</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#co.form.rules.validator.msg"><span class="calloutno"><img src="images/callouts/5.png" border="0"/></span></a> </p></td><td valign="top" align="left"><p>每个验证规则都包含了一段文字描述（message），如果用户填写的数据没有通过当前的规则的验证，那么用户将会看到这段文字描述，以解释出错的原因。</p></td></tr></table></div></div></div><div class="figure"><a id="d0e11331"><!--anchor d0e11331--></a><div class="figure-contents"><div class="mediaobject"><img src="images/form/form-structure.png" alt="表单验证配置文件的结构"/></div></div><p class="title"><strong>图 9.5. 表单验证配置文件的结构</strong></p></div></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="d0e11337"><!--anchor d0e11337--></a>9.3.1.2. 创建表单页面</h4></div></div></div><p>创建表单页面需要使用一个pull tool工具，配置如下：</p><div class="example"><a id="d0e11342"><!--anchor d0e11342--></a><p class="title"><strong>例 9.4. 表单验证pull tool的配置</strong></p><div class="example-contents"><pre class="programlisting"><strong class="hl-tag" style="color: #000096">&lt;services:pull</strong> <span class="hl-attribute" style="color: #F5844C">xmlns</span>=<span class="hl-value" style="color: #993300">"http://www.alibaba.com/schema/services/pull/factories"</span><strong class="hl-tag" style="color: #000096">&gt;</strong>
    <strong class="hl-tag" style="color: #000096">&lt;form-tool /&gt;</strong>
    ...
<strong class="hl-tag" style="color: #000096">&lt;/services:pull&gt;</strong></pre></div></div><p>上面的配置定义了一个$form工具。现在你可以在模板中直接使用它。</p><div class="example"><a id="d0e11349"><!--anchor d0e11349--></a><p class="title"><strong>例 9.5. 表单验证的页面模板示例</strong></p><div class="example-contents"><pre class="programlisting">#macro (registerMessage $field) <a id="co.form.vm.msg.macro"><!--anchor co.form.vm.msg.macro--></a><span class="calloutno"><img src="images/callouts/1.png" border="0"/></span>
    #if (!$field.valid) $field.message #end
#end

<strong class="hl-tag" style="color: #000096">&lt;form</strong> <span class="hl-attribute" style="color: #F5844C">action</span>=<span class="hl-value" style="color: #993300">""</span> <span class="hl-attribute" style="color: #F5844C">method</span>=<span class="hl-value" style="color: #993300">"post"</span><strong class="hl-tag" style="color: #000096">&gt;</strong> <a id="co.form.vm.form"><!--anchor co.form.vm.form--></a><span class="calloutno"><img src="images/callouts/2.png" border="0"/></span>
  <strong class="hl-tag" style="color: #000096">&lt;input</strong> <span class="hl-attribute" style="color: #F5844C">type</span>=<span class="hl-value" style="color: #993300">"hidden"</span> <span class="hl-attribute" style="color: #F5844C">name</span>=<span class="hl-value" style="color: #993300">"action"</span> <span class="hl-attribute" style="color: #F5844C">value</span>=<span class="hl-value" style="color: #993300">"UserAccountAction"</span><strong class="hl-tag" style="color: #000096">/&gt;</strong> <a id="co.form.vm.action"><!--anchor co.form.vm.action--></a><span class="calloutno"><img src="images/callouts/3.png" border="0"/></span>

  #set ($group = $form.register.defaultInstance) <a id="co.form.vm.default.instance"><!--anchor co.form.vm.default.instance--></a><span class="calloutno"><img src="images/callouts/4.png" border="0"/></span>
  
  <strong class="hl-tag" style="color: #000096">&lt;p&gt;</strong>用户注册<strong class="hl-tag" style="color: #000096">&lt;/p&gt;</strong>

  <strong class="hl-tag" style="color: #000096">&lt;dl&gt;</strong>
    <strong class="hl-tag" style="color: #000096">&lt;dt&gt;</strong>用户名<strong class="hl-tag" style="color: #000096">&lt;/dt&gt;</strong>
    <strong class="hl-tag" style="color: #000096">&lt;dd&gt;</strong>
        <strong class="hl-tag" style="color: #000096">&lt;div&gt;</strong>
            <strong class="hl-tag" style="color: #000096">&lt;input</strong> <span class="hl-attribute" style="color: #F5844C">type</span>=<span class="hl-value" style="color: #993300">"text"</span> <span class="hl-attribute" style="color: #F5844C">name</span>=<span class="hl-value" style="color: #993300">"$group.userId.key"</span> <span class="hl-attribute" style="color: #F5844C">value</span>=<span class="hl-value" style="color: #993300">"$!group.userId.value"</span><strong class="hl-tag" style="color: #000096">/&gt;</strong> <a id="co.form.vm.field1"><!--anchor co.form.vm.field1--></a><span class="calloutno"><img src="images/callouts/5.png" border="0"/></span>
        <strong class="hl-tag" style="color: #000096">&lt;/div&gt;</strong>
        <strong class="hl-tag" style="color: #000096">&lt;div</strong> <span class="hl-attribute" style="color: #F5844C">class</span>=<span class="hl-value" style="color: #993300">"errorMessage"</span><strong class="hl-tag" style="color: #000096">&gt;</strong>
            #registerMessage ($group.userId) <a id="co.form.vm.msg1"><!--anchor co.form.vm.msg1--></a><span class="calloutno"><img src="images/callouts/6.png" border="0"/></span>
        <strong class="hl-tag" style="color: #000096">&lt;/div&gt;</strong>
    <strong class="hl-tag" style="color: #000096">&lt;/dd&gt;</strong>

    <strong class="hl-tag" style="color: #000096">&lt;dt&gt;</strong>密码<strong class="hl-tag" style="color: #000096">&lt;/dt&gt;</strong>
    <strong class="hl-tag" style="color: #000096">&lt;dd&gt;</strong>
        <strong class="hl-tag" style="color: #000096">&lt;div&gt;</strong>
            <strong class="hl-tag" style="color: #000096">&lt;input</strong> <span class="hl-attribute" style="color: #F5844C">type</span>=<span class="hl-value" style="color: #993300">"password"</span> <span class="hl-attribute" style="color: #F5844C">name</span>=<span class="hl-value" style="color: #993300">"$group.password.key"</span> <span class="hl-attribute" style="color: #F5844C">value</span>=<span class="hl-value" style="color: #993300">"$!group.password.value"</span><strong class="hl-tag" style="color: #000096">/&gt;</strong> <a id="co.form.vm.field2"><!--anchor co.form.vm.field2--></a><span class="calloutno"><img src="images/callouts/7.png" border="0"/></span>
        <strong class="hl-tag" style="color: #000096">&lt;/div&gt;</strong>
        <strong class="hl-tag" style="color: #000096">&lt;div</strong> <span class="hl-attribute" style="color: #F5844C">class</span>=<span class="hl-value" style="color: #993300">"errorMessage"</span><strong class="hl-tag" style="color: #000096">&gt;</strong>
            #registerMessage ($group.password) <a id="co.form.vm.msg2"><!--anchor co.form.vm.msg2--></a><span class="calloutno"><img src="images/callouts/8.png" border="0"/></span>
        <strong class="hl-tag" style="color: #000096">&lt;/div&gt;</strong>
    <strong class="hl-tag" style="color: #000096">&lt;/dd&gt;</strong>

    <strong class="hl-tag" style="color: #000096">&lt;dt&gt;</strong>再输一遍密码<strong class="hl-tag" style="color: #000096">&lt;/dt&gt;</strong>
    <strong class="hl-tag" style="color: #000096">&lt;dd&gt;</strong>
        <strong class="hl-tag" style="color: #000096">&lt;div&gt;</strong>
            <strong class="hl-tag" style="color: #000096">&lt;input</strong> <span class="hl-attribute" style="color: #F5844C">type</span>=<span class="hl-value" style="color: #993300">"password"</span> <span class="hl-attribute" style="color: #F5844C">name</span>=<span class="hl-value" style="color: #993300">"$group.passwordConfirm.key"</span> <span class="hl-attribute" style="color: #F5844C">value</span>=<span class="hl-value" style="color: #993300">"$!group.passwordConfirm.value"</span><strong class="hl-tag" style="color: #000096">/&gt;</strong> <a id="co.form.vm.field3"><!--anchor co.form.vm.field3--></a><span class="calloutno"><img src="images/callouts/9.png" border="0"/></span>
        <strong class="hl-tag" style="color: #000096">&lt;/div&gt;</strong>
        <strong class="hl-tag" style="color: #000096">&lt;div</strong> <span class="hl-attribute" style="color: #F5844C">class</span>=<span class="hl-value" style="color: #993300">"errorMessage"</span><strong class="hl-tag" style="color: #000096">&gt;</strong>
            #registerMessage ($group.passwordConfirm) <a id="co.form.vm.msg3"><!--anchor co.form.vm.msg3--></a><span class="calloutno"><img src="images/callouts/10.png" border="0"/></span>
        <strong class="hl-tag" style="color: #000096">&lt;/div&gt;</strong>
    <strong class="hl-tag" style="color: #000096">&lt;/dd&gt;</strong>
  <strong class="hl-tag" style="color: #000096">&lt;/dl&gt;</strong>
  
  <strong class="hl-tag" style="color: #000096">&lt;p&gt;</strong>
      <strong class="hl-tag" style="color: #000096">&lt;input</strong> <span class="hl-attribute" style="color: #F5844C">type</span>=<span class="hl-value" style="color: #993300">"submit"</span> <span class="hl-attribute" style="color: #F5844C">name</span>=<span class="hl-value" style="color: #993300">"event_submit_do_register"</span> <span class="hl-attribute" style="color: #F5844C">value</span>=<span class="hl-value" style="color: #993300">"立即注册！"</span><strong class="hl-tag" style="color: #000096">/&gt;</strong> <a id="co.form.vm.submit"><!--anchor co.form.vm.submit--></a><span class="calloutno"><img src="images/callouts/11.png" border="0"/></span>
  <strong class="hl-tag" style="color: #000096">&lt;/p&gt;</strong>

<strong class="hl-tag" style="color: #000096">&lt;/form&gt;</strong></pre><div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#co.form.vm.form"><span class="calloutno"><img src="images/callouts/2.png" border="0"/></span></a> </p></td><td valign="top" align="left"><p>HTML form的action值为空，意思是把表单提交给当前页面。</p><p>这样，当用户填写表单有错时，应用会停留在当前表单页面，将表单数据连同错误提示一起显示给用户，要求用户修改。如果表单验证通过，应用必须通过重定向操作来转向下一个页面。</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#co.form.vm.default.instance"><span class="calloutno"><img src="images/callouts/4.png" border="0"/></span></a> </p></td><td valign="top" align="left"><p>创建一个<code class="code">register</code> group的实例。</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#co.form.vm.field1"><span class="calloutno"><img src="images/callouts/5.png" border="0"/></span></a> <a href="#co.form.vm.field2"><span class="calloutno"><img src="images/callouts/7.png" border="0"/></span></a> <a href="#co.form.vm.field3"><span class="calloutno"><img src="images/callouts/9.png" border="0"/></span></a> </p></td><td valign="top" align="left"><p>利用新创建的group对象来生成表单字段，包括生成字段的名称<code class="code">$group.field.key</code>，以及字段的值为<code class="code">$!group.field.value</code>。</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#co.form.vm.msg.macro"><span class="calloutno"><img src="images/callouts/1.png" border="0"/></span></a> </p></td><td valign="top" align="left"><p>定义velocity宏：仅当field验证通过时（即<code class="code">$group.field.valid=true</code>），才显示错误信息。</p><p>对于空白表单和通过验证的字段而言，<code class="code">$group.field.valid</code>为<code class="code">true</code>。</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#co.form.vm.msg1"><span class="calloutno"><img src="images/callouts/6.png" border="0"/></span></a> <a href="#co.form.vm.msg2"><span class="calloutno"><img src="images/callouts/8.png" border="0"/></span></a> <a href="#co.form.vm.msg3"><span class="calloutno"><img src="images/callouts/10.png" border="0"/></span></a> </p></td><td valign="top" align="left"><p>如果验证失败的话，显示验证出错消息。这里通过前面所定义的velocity宏来简化代码。</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#co.form.vm.action"><span class="calloutno"><img src="images/callouts/3.png" border="0"/></span></a> </p></td><td valign="top" align="left"><p>根据这参数，表单将会被交给<code class="code">UserAccountAction</code>来处理。Action的职责是调用表单验证过程。假如验证通过，就保存数据，并重定向到下一个页面。</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#co.form.vm.submit"><span class="calloutno"><img src="images/callouts/11.png" border="0"/></span></a> </p></td><td valign="top" align="left"><p>根据这个参数，表单被提交以后，系统会调用当前action（即<code class="code">UserAccountAction</code>）的<code class="code">doRegister()</code>方法。每个action类中，可以包含多个处理数据的动作，例如<code class="code">doCreate</code>、<code class="code">doUpdate</code>、<code class="code">doDelete</code>等。</p></td></tr></table></div></div></div><p>上面的Velocity页面模板演示了怎样利用表单验证服务创建一个帐户注册的HTML表单。关键技术解释如下：</p><div class="variablelist"><dl class="variablelist"><dt><span class="term">创建group实例</span></dt><dd><p><code class="code">$form.register.defaultInstance</code>将会对<code class="code">register</code>
                                group创建一个默认的实例。绝大多数情况下，只需要创建唯一的default
                                instance就足够了。但后面我们会讲到创建多实例的例子。</p><p>所创建的group instance（如<code class="code">register</code>）必须先在规则配置文件中被定义。</p><div class="figure"><a id="d0e11457"><!--anchor d0e11457--></a><div class="figure-contents"><div class="mediaobject"><img src="images/form/new-group-instance.png" alt="创建一个group实例"/></div></div><p class="title"><strong>图 9.6. 创建一个group实例</strong></p></div></dd><dt><span class="term">生成表单字段</span></dt><dd><p>一个表单字段包含名称和值两个部分。</p><p>字段的名称为<code class="code">$group.field.key</code>。表单验证服务会自动生成一个字段名。这个字段名被设计成仅供系统内部解读的，而不是让外界的系统或人来解读的。它看起来是这个样子的：“<code class="code">_fm.r._0.p</code>”。<span class="emphasis"><em>外界的系统不应该依赖于这个名称</em></span>。</p><p>字段的值为<code class="code">$!group.field.value</code>。它的初始值（即用户填写数据之前）是<code class="code">null</code>。但你也可以在配置文件中为它指定一个默认的初始值，例如：</p><div class="example"><a id="d0e11488"><!--anchor d0e11488--></a><p class="title"><strong>例 9.6. 在表单验证规则中添加默认值</strong></p><div class="example-contents"><pre class="programlisting"><strong class="hl-tag" style="color: #000096">&lt;services:field</strong> <span class="hl-attribute" style="color: #F5844C">name</span>=<span class="hl-value" style="color: #993300">"myfield"</span> <span class="hl-attribute" style="color: #F5844C">defaultValue</span>=<span class="hl-value" style="color: #993300">"mydefault"</span> <span class="hl-attribute" style="color: #F5844C">...&gt;</span></pre></div></div><p>因为值可能是<code class="code">null</code>，因此在velocity中，需要以“<code class="code">$!</code>”来标记它 ——
                                    Velocity认为<code class="code">null</code>是一个错误，除非你以<code class="code">$!</code>来标记它，告诉velocity忽略它。</p><p>需要注意的是，<span class="emphasis"><em>默认值只会影响field的初始值</em></span>。一旦用户填写并提交了表单，那么<code class="code">$group.field.value</code>的值将保持用户所填写的值不变
                                —— 不论验证失败或成功。 </p></dd><dt><span class="term">页面展现</span></dt><dd><p>一般来说，你需要定义CSS风格以便让表单的field和错误信息能以适当的格式来显示给用户。展现效果可能是像这个样子：</p><div class="figure"><a id="d0e11521"><!--anchor d0e11521--></a><div class="figure-contents"><div class="mediaobject"><img src="images/form/form-sample-validation-failed.png" alt="在页面中显示表单验证错误信息"/></div></div><p class="title"><strong>图 9.7. 在页面中显示表单验证错误信息</strong></p></div><p>表单系统不应该干预页面的具体展现方法，以下内容均和表单系统无关。例如：</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>Field展现的方式：textbox、checkbox、hidden field？</p></li><li class="listitem"><p>错误信息的颜色、显示位置。</p></li></ul></div></dd></dl></div></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="d0e11536"><!--anchor d0e11536--></a>9.3.1.3. 创建Java代码（action）</h4></div></div></div><p>用户提交表单后，由服务器端的Java代码读取并验证用户的数据。</p><p>在Webx中，这个功能通常由action来完成。前文已经提到，在HTML表单中，设置<code class="code">action</code>字段，以及<code class="code">event_submit_do_register</code>提交按钮，就可以让Webx框架调用<code class="code">UserAccountAction.doRegister()</code>方法。</p><p>下面是<code class="code">UserAccountAction</code>类的实现代码：</p><div class="example"><a id="d0e11557"><!--anchor d0e11557--></a><p class="title"><strong>例 9.7. 创建用于处理提交数据的action代码</strong></p><div class="example-contents"><pre class="programlisting"><strong class="hl-keyword" style="color: maroon">public</strong> <strong class="hl-keyword" style="color: maroon">class</strong> UserAccountAction {
    <em><span class="hl-annotation" style="color: gray">@Autowired</span></em>
    <strong class="hl-keyword" style="color: maroon">private</strong> FormService formService; <a id="co.form.action.inject.formservice"><!--anchor co.form.action.inject.formservice--></a><span class="calloutno"><img src="images/callouts/1.png" border="0"/></span>

    <strong class="hl-keyword" style="color: maroon">public</strong> <strong class="hl-keyword" style="color: maroon">void</strong> doRegister(Navigator nav) <strong class="hl-keyword" style="color: maroon">throws</strong> Exception {
        Form form = formService.getForm(); <a id="co.form.action.get.form"><!--anchor co.form.action.get.form--></a><span class="calloutno"><img src="images/callouts/2.png" border="0"/></span>

        <strong class="hl-keyword" style="color: maroon">if</strong> (form.isValid()) { <a id="co.form.action.form.isvalid"><!--anchor co.form.action.form.isvalid--></a><span class="calloutno"><img src="images/callouts/3.png" border="0"/></span>
            Group group = form.getGroup(<strong class="hl-string"><em style="color:navy">"register"</em></strong>); <a id="co.form.action.get.group"><!--anchor co.form.action.get.group--></a><span class="calloutno"><img src="images/callouts/4.png" border="0"/></span>

            MyUser user = <strong class="hl-keyword" style="color: maroon">new</strong> MyUser(); <a id="co.form.action.populate.bean1"><!--anchor co.form.action.populate.bean1--></a><span class="calloutno"><img src="images/callouts/5.png" border="0"/></span>
            group.setProperties(user); <a id="co.form.action.populate.bean2"><!--anchor co.form.action.populate.bean2--></a><span class="calloutno"><img src="images/callouts/6.png" border="0"/></span>
            save(user);

            <em class="hl-comment" style="color: green">// 跳转到注册成功页面</em>
            nav.redirectTo(<strong class="hl-string"><em style="color:navy">"registerSuccess"</em></strong>); <a id="co.form.action.redirect"><!--anchor co.form.action.redirect--></a><span class="calloutno"><img src="images/callouts/7.png" border="0"/></span>
        }
    }
}</pre><div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#co.form.action.inject.formservice"><span class="calloutno"><img src="images/callouts/1.png" border="0"/></span></a> </p></td><td valign="top" align="left"><p>注入form服务。</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#co.form.action.get.form"><span class="calloutno"><img src="images/callouts/2.png" border="0"/></span></a> </p></td><td valign="top" align="left"><p>取得form对象，form对象中包含若干groups。</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#co.form.action.form.isvalid"><span class="calloutno"><img src="images/callouts/3.png" border="0"/></span></a> </p></td><td valign="top" align="left"><p>仅当表单验证成功时，才执行下去。</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#co.form.action.get.group"><span class="calloutno"><img src="images/callouts/4.png" border="0"/></span></a> </p></td><td valign="top" align="left"><p>取得group对象。Group对象的名称必须和配置文件以及模板中的group名称相同。</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#co.form.action.populate.bean1"><span class="calloutno"><img src="images/callouts/5.png" border="0"/></span></a> <a href="#co.form.action.populate.bean2"><span class="calloutno"><img src="images/callouts/6.png" border="0"/></span></a> </p></td><td valign="top" align="left"><p>将group中的数据灌入bean中。</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#co.form.action.redirect"><span class="calloutno"><img src="images/callouts/7.png" border="0"/></span></a> </p></td><td valign="top" align="left"><p>处理完数据以后，利用Webx navigation接口跳转到“注册成功”页面。</p></td></tr></table></div></div></div><p>例子中的<code class="code">MyUser</code>对象是一个简单的Java Bean：</p><div class="example"><a id="d0e11600"><!--anchor d0e11600--></a><p class="title"><strong>例 9.8. 被灌入group数据的Java Bean</strong></p><div class="example-contents"><pre class="programlisting"><strong class="hl-keyword" style="color: maroon">public</strong> <strong class="hl-keyword" style="color: maroon">static</strong> <strong class="hl-keyword" style="color: maroon">class</strong> MyUser {
    <strong class="hl-keyword" style="color: maroon">private</strong> String userId;
    <strong class="hl-keyword" style="color: maroon">private</strong> String password;

    <strong class="hl-keyword" style="color: maroon">public</strong> String getUserId() {
        <strong class="hl-keyword" style="color: maroon">return</strong> userId;
    }

    <strong class="hl-keyword" style="color: maroon">public</strong> <strong class="hl-keyword" style="color: maroon">void</strong> setUserId(String userId) {
        <strong class="hl-keyword" style="color: maroon">this</strong>.userId = userId;
    }

    <strong class="hl-keyword" style="color: maroon">public</strong> String getPassword() {
        <strong class="hl-keyword" style="color: maroon">return</strong> password;
    }

    <strong class="hl-keyword" style="color: maroon">public</strong> <strong class="hl-keyword" style="color: maroon">void</strong> setPassword(String password) {
        <strong class="hl-keyword" style="color: maroon">this</strong>.password = password;
    }
}</pre></div></div><p><code class="code">Group.setProperties()</code>方法将fields的值映射到同名的Java Bean
                    properties中。然而这个对应关系是可以改变的，后文会再次讲到该问题。</p><p>是不是有点复杂？事实上，<span class="emphasis"><em>上面的代码可以通过Webx的参数注入机制加以简化</em></span>。下面的代码可以完成完全相同的功能，但是代码却短得多。然而，<span class="emphasis"><em>理解前面的较复杂代码，将有助于你理解下面的简化代码</em></span>。</p><div class="example"><a id="d0e11617"><!--anchor d0e11617--></a><p class="title"><strong>例 9.9. 创建用于处理提交数据的action代码（Annotations简化版）</strong></p><div class="example-contents"><pre class="programlisting"><strong class="hl-keyword" style="color: maroon">public</strong> <strong class="hl-keyword" style="color: maroon">class</strong> UserAccountAction {
    <strong class="hl-keyword" style="color: maroon">public</strong> <strong class="hl-keyword" style="color: maroon">void</strong> doRegister(<em><span class="hl-annotation" style="color: gray">@FormGroup("register")</span></em> MyUser user, Navigator nav) <strong class="hl-keyword" style="color: maroon">throws</strong> Exception {
        save(user);
        nav.redirectTo(<strong class="hl-string"><em style="color:navy">"registerSuccess"</em></strong>);
    }
}</pre></div></div><p>在这个简化版代码中，@FormGroup注解完成了前面复杂代码中的大部分功能，包括：</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>验证表单，如果<span class="emphasis"><em>失败则不执行action</em></span>，否则执行<code class="code">doRegister</code>方法。</p></li><li class="listitem"><p>取得form和<code class="code">register</code>
                                    group对象，并将group中的数据注入到<code class="code">MyUser</code>对象中。 </p></li></ul></div></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="d0e11643"><!--anchor d0e11643--></a>9.3.2. 修改老数据</h3></div></div></div><p>在前面的例子中，我们利用表单创建了一个新数据 ——
                注册新帐户。它是从一个空白表单开始的，也就是说，在用户填写表单之前，表单是没有内容的，或只包含默认值的。另一种常见情况是修改老数据。例如“修改帐户资料”。和创建新数据的例子不同，在用户填写表单之前，表单里已经包含了从数据库中取得的老数据。</p><p>在创建新数据的模板和代码中，稍微添加一点东西，就可以实现修改老数据的功能。</p><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="d0e11650"><!--anchor d0e11650--></a>9.3.2.1. 用screen来读取数据</h4></div></div></div><p>修改老数据的第一步，是要取得老的数据。例如，取得要修改的帐户信息。在Webx中，这个任务是由screen来完成的：</p><div class="example"><a id="d0e11655"><!--anchor d0e11655--></a><p class="title"><strong>例 9.10. 用screen取得表单验证的初始数据</strong></p><div class="example-contents"><pre class="programlisting"><strong class="hl-keyword" style="color: maroon">public</strong> <strong class="hl-keyword" style="color: maroon">class</strong> UserAccount {
    <em><span class="hl-annotation" style="color: gray">@Autowired</span></em>
    <strong class="hl-keyword" style="color: maroon">private</strong> UserManager userManager; <a id="co.form.modifydata.screen.bizobj"><!--anchor co.form.modifydata.screen.bizobj--></a><span class="calloutno"><img src="images/callouts/1.png" border="0"/></span>

    <strong class="hl-keyword" style="color: maroon">public</strong> <strong class="hl-keyword" style="color: maroon">void</strong> execute(Context context) <strong class="hl-keyword" style="color: maroon">throws</strong> Exception {
        User user = userManager.getUser(getCurrentUser().getId());
        context.put(<strong class="hl-string"><em style="color:navy">"user"</em></strong>, user); <a id="co.form.modifydata.screen.putcontext"><!--anchor co.form.modifydata.screen.putcontext--></a><span class="calloutno"><img src="images/callouts/2.png" border="0"/></span>
    }
}</pre><div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#co.form.modifydata.screen.bizobj"><span class="calloutno"><img src="images/callouts/1.png" border="0"/></span></a> </p></td><td valign="top" align="left"><p><code class="code">UserManager</code>是一个业务接口。通过它，可以从数据库中取得当前登录帐户的信息。</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#co.form.modifydata.screen.putcontext"><span class="calloutno"><img src="images/callouts/2.png" border="0"/></span></a> </p></td><td valign="top" align="left"><p>随后，screen代码把所取得的user对象放到context中，这样，就可以在模板中用<code class="code">$user</code>来引用它。</p></td></tr></table></div></div></div></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="d0e11676"><!--anchor d0e11676--></a>9.3.2.2. 表单页面</h4></div></div></div><div class="example"><a id="d0e11679"><!--anchor d0e11679--></a><p class="title"><strong>例 9.11. 用来修改数据的页面模板</strong></p><div class="example-contents"><pre class="programlisting">#set ($group = $form.userAccount.defaultInstance)

$group.mapTo($user) <a id="co.form.modifydata.vm.mapto"><!--anchor co.form.modifydata.vm.mapto--></a><span class="calloutno"><img src="images/callouts/1.png" border="0"/></span>
...
<strong class="hl-tag" style="color: #000096">&lt;input</strong> <span class="hl-attribute" style="color: #F5844C">type</span>=<span class="hl-value" style="color: #993300">"hidden"</span> <span class="hl-attribute" style="color: #F5844C">name</span>=<span class="hl-value" style="color: #993300">"$group.userId.key"</span> <span class="hl-attribute" style="color: #F5844C">value</span>=<span class="hl-value" style="color: #993300">"$!group.userId.value"</span><strong class="hl-tag" style="color: #000096">/&gt;</strong> <a id="co.form.modifydata.vm.pk"><!--anchor co.form.modifydata.vm.pk--></a><span class="calloutno"><img src="images/callouts/2.png" border="0"/></span>
...

<strong class="hl-tag" style="color: #000096">&lt;input</strong> <span class="hl-attribute" style="color: #F5844C">type</span>=<span class="hl-value" style="color: #993300">"text"</span> <span class="hl-attribute" style="color: #F5844C">name</span>=<span class="hl-value" style="color: #993300">"$group.lastName.key"</span> <span class="hl-attribute" style="color: #F5844C">value</span>=<span class="hl-value" style="color: #993300">"$!group.lastName.value"</span><strong class="hl-tag" style="color: #000096">/&gt;</strong>
...
#userAccountMessage ($group.lastName)
...
<strong class="hl-tag" style="color: #000096">&lt;input</strong> <span class="hl-attribute" style="color: #F5844C">type</span>=<span class="hl-value" style="color: #993300">"submit"</span> <span class="hl-attribute" style="color: #F5844C">name</span>=<span class="hl-value" style="color: #993300">"event_submit_do_update"</span> <span class="hl-attribute" style="color: #F5844C">value</span>=<span class="hl-value" style="color: #993300">"修改"</span><strong class="hl-tag" style="color: #000096">/&gt;</strong> <a id="co.form.modifydata.vm.submit"><!--anchor co.form.modifydata.vm.submit--></a><span class="calloutno"><img src="images/callouts/3.png" border="0"/></span></pre><div class="calloutlist"><p>在前面“创建新数据”的页面上，加上和修改一点内容：</p><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#co.form.modifydata.vm.mapto"><span class="calloutno"><img src="images/callouts/1.png" border="0"/></span></a> </p></td><td valign="top" align="left"><p><code class="code">mapTo</code>的功能是填充表单。</p><p>这行代码的意思是：用screen中所取得的user对象的值来填充表单，作为表单的初始值。和<code class="code">Group.setProperties()</code>方法相反，<code class="code">mapTo</code>将Java
                                Bean properties的值映射到同名的fields中。</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#co.form.modifydata.vm.pk"><span class="calloutno"><img src="images/callouts/2.png" border="0"/></span></a> </p></td><td valign="top" align="left"><p>保存主键。</p><p>和创建新数据不同，在修改老数据时，一般需要在表单中包含主键。这个主键（user
                                id）在数据库中唯一识别这一数据对象（user）。</p><p>应该避免用户改变主键。最简便的方法，就是用hidden字段来保存主键。</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#co.form.modifydata.vm.submit"><span class="calloutno"><img src="images/callouts/3.png" border="0"/></span></a> </p></td><td valign="top" align="left"><p>这个submit按钮将引导webx执行<code class="code">UserAccountAction.doUpdate</code>方法。</p></td></tr></table></div></div></div><p>需要注意的是，调用<code class="code">mapTo</code>在下列情况下是无效的：</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>当<code class="code">$user</code>对象不存在（值为<code class="code">null</code>）时，<code class="code">mapTo</code>不做任何事。这样，<span class="emphasis"><em>你就可以让“创建新帐户”和“修改帐户信息”共用同一个模板</em></span>。在新表单中，由于<code class="code">$user</code>不存在，所以<code class="code">mapTo</code>失效；而在更新表单中，就可以从<code class="code">$user</code>中取得初始的数据。</p></li><li class="listitem"><p>当用户提交表单以后，<code class="code">mapTo</code>不做任何事。因为<code class="code">mapTo</code>只会影响表单的初始数据。一旦用户修改并提交数据以后，<code class="code">mapTo</code>就不会改变用户所修改的数据。</p></li></ul></div></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="d0e11760"><!--anchor d0e11760--></a>9.3.2.3. 用action来处理数据</h4></div></div></div><p>修改老数据的action代码和创建新数据的action代码几乎相同，而且它们可以共享同一个<code class="code">UserAccountAction</code>类：</p><div class="example"><a id="d0e11768"><!--anchor d0e11768--></a><p class="title"><strong>例 9.12. 用来保存提交数据的action</strong></p><div class="example-contents"><pre class="programlisting"><strong class="hl-keyword" style="color: maroon">public</strong> <strong class="hl-keyword" style="color: maroon">class</strong> UserAccountAction {
    <strong class="hl-keyword" style="color: maroon">public</strong> <strong class="hl-keyword" style="color: maroon">void</strong> doRegister(...) <strong class="hl-keyword" style="color: maroon">throws</strong> Exception {
        ...
    }

    <strong class="hl-keyword" style="color: maroon">public</strong> <strong class="hl-keyword" style="color: maroon">void</strong> doUpdate(<em><span class="hl-annotation" style="color: gray">@FormGroup("userAccount")</span></em> MyUser user, <a id="co.form.modifiydata.action.obj"><!--anchor co.form.modifiydata.action.obj--></a><span class="calloutno"><img src="images/callouts/1.png" border="0"/></span>
                         Navigator nav) <strong class="hl-keyword" style="color: maroon">throws</strong> Exception {
        save(user);
        nav.redirectTo(<strong class="hl-string"><em style="color:navy">"updateSuccess"</em></strong>);
    }
}</pre><div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#co.form.modifiydata.action.obj"><span class="calloutno"><img src="images/callouts/1.png" border="0"/></span></a> </p></td><td valign="top" align="left"><p>通过annotation取得的<code class="code">MyUser</code>对象中，包含了通过hidden字段传过来的user
                                id，以及其它所有字段的值。</p></td></tr></table></div></div></div></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="d0e11782"><!--anchor d0e11782--></a>9.3.3. 批量创建或修改数据</h3></div></div></div><p>有时，我们需要在一个表单页面中批量创建或修改一批数据。例如，后台管理界面中，管理员可以一次审核10个帐户的信息。每个帐户的信息格式都是相同的：姓名、性别、年龄、地址等。表单验证服务完全支持这样的表单。</p><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="d0e11787"><!--anchor d0e11787--></a>9.3.3.1. 用screen来读取批量数据</h4></div></div></div><p>假如你希望做的是批量修改数据，很显然，你需要在screen代码中取得所有需要修改的数据。</p><div class="example"><a id="d0e11792"><!--anchor d0e11792--></a><p class="title"><strong>例 9.13. 批量读取数据的screen</strong></p><div class="example-contents"><pre class="programlisting"><strong class="hl-keyword" style="color: maroon">public</strong> <strong class="hl-keyword" style="color: maroon">class</strong> BatchUserAccount {
    <em><span class="hl-annotation" style="color: gray">@Autowired</span></em>
    <strong class="hl-keyword" style="color: maroon">private</strong> UserManager userManager;

    <strong class="hl-keyword" style="color: maroon">public</strong> <strong class="hl-keyword" style="color: maroon">void</strong> execute(Context context) <strong class="hl-keyword" style="color: maroon">throws</strong> Exception {
        List&lt;User&gt; users = userManager.getUsers(getIds()); <a id="co.form.batch.screen.putcontext"><!--anchor co.form.batch.screen.putcontext--></a><span class="calloutno"><img src="images/callouts/1.png" border="0"/></span>
        context.put(<strong class="hl-string"><em style="color:navy">"users"</em></strong>, users);
    }
}</pre><div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#co.form.batch.screen.putcontext"><span class="calloutno"><img src="images/callouts/1.png" border="0"/></span></a> </p></td><td valign="top" align="left"><p>和修改单个数据的screen代码不同的是，你需要一次性读取多个数据对象，并置入到context中。</p></td></tr></table></div></div></div></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="d0e11803"><!--anchor d0e11803--></a>9.3.3.2. 表单页面</h4></div></div></div><div class="example"><a id="d0e11806"><!--anchor d0e11806--></a><p class="title"><strong>例 9.14. 批量创建、修改数据的表单页面模板</strong></p><div class="example-contents"><pre class="programlisting"><strong class="hl-tag" style="color: #000096">&lt;form</strong> <span class="hl-attribute" style="color: #F5844C">action</span>=<span class="hl-value" style="color: #993300">""</span> <span class="hl-attribute" style="color: #F5844C">method</span>=<span class="hl-value" style="color: #993300">"post"</span><strong class="hl-tag" style="color: #000096">&gt;</strong>
  <strong class="hl-tag" style="color: #000096">&lt;input</strong> <span class="hl-attribute" style="color: #F5844C">type</span>=<span class="hl-value" style="color: #993300">"hidden"</span> <span class="hl-attribute" style="color: #F5844C">name</span>=<span class="hl-value" style="color: #993300">"action"</span> <span class="hl-attribute" style="color: #F5844C">value</span>=<span class="hl-value" style="color: #993300">"UserAccountAction"</span><strong class="hl-tag" style="color: #000096">/&gt;</strong>

  #foreach($user in $users) <a id="co.form.batch.vm.forloop"><!--anchor co.form.batch.vm.forloop--></a><span class="calloutno"><img src="images/callouts/1.png" border="0"/></span>
    #set ($group = $form.userAccount.getInstance($user.id)) <a id="co.form.batch.vm.getinstance"><!--anchor co.form.batch.vm.getinstance--></a><span class="calloutno"><img src="images/callouts/2.png" border="0"/></span>

    $group.mapTo($user)

    ...
    <strong class="hl-tag" style="color: #000096">&lt;input</strong> <span class="hl-attribute" style="color: #F5844C">type</span>=<span class="hl-value" style="color: #993300">"hidden"</span> <span class="hl-attribute" style="color: #F5844C">name</span>=<span class="hl-value" style="color: #993300">"$group.userId.key"</span> <span class="hl-attribute" style="color: #F5844C">value</span>=<span class="hl-value" style="color: #993300">"$!group.userId.value"</span><strong class="hl-tag" style="color: #000096">/&gt;</strong>

    ...
    <strong class="hl-tag" style="color: #000096">&lt;input</strong> <span class="hl-attribute" style="color: #F5844C">type</span>=<span class="hl-value" style="color: #993300">"text"</span> <span class="hl-attribute" style="color: #F5844C">name</span>=<span class="hl-value" style="color: #993300">"$group.lastName.key"</span> <span class="hl-attribute" style="color: #F5844C">value</span>=<span class="hl-value" style="color: #993300">"$!group.lastName.value"</span><strong class="hl-tag" style="color: #000096">/&gt;</strong>
    ...
    #userAccountMessage ($group.lastName)
    ...

  #end
  ...
  <strong class="hl-tag" style="color: #000096">&lt;input</strong> <span class="hl-attribute" style="color: #F5844C">type</span>=<span class="hl-value" style="color: #993300">"submit"</span> <span class="hl-attribute" style="color: #F5844C">name</span>=<span class="hl-value" style="color: #993300">"event_submit_do_batch_edit"</span> <span class="hl-attribute" style="color: #F5844C">value</span>=<span class="hl-value" style="color: #993300">"批量修改"</span><strong class="hl-tag" style="color: #000096">/&gt;</strong> <a id="co.form.batch.vm.submit"><!--anchor co.form.batch.vm.submit--></a><span class="calloutno"><img src="images/callouts/3.png" border="0"/></span>
<strong class="hl-tag" style="color: #000096">&lt;/form&gt;</strong></pre><div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#co.form.batch.vm.forloop"><span class="calloutno"><img src="images/callouts/1.png" border="0"/></span></a> </p></td><td valign="top" align="left"><p>为了批量创建、修改数据，需要在表单页面中利用<code class="code">foreach</code>循环来遍历数据对象。其中，<code class="code">$users</code>是由screen放入context中的对象列表。</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#co.form.batch.vm.getinstance"><span class="calloutno"><img src="images/callouts/2.png" border="0"/></span></a> </p></td><td valign="top" align="left"><p>对每个数据对象创建一个group实例。</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#co.form.batch.vm.submit"><span class="calloutno"><img src="images/callouts/3.png" border="0"/></span></a> </p></td><td valign="top" align="left"><p>指定action事件。这个submit按钮将引导webx执行<code class="code">UserAccountAction.doBatchEdit</code>方法。</p></td></tr></table></div></div></div><p>在前面的例子中，我们一直使用<code class="code">$form.xyz.defaultInstance</code>来创建默认的group实例。而这里，我们改变了用法：<code class="code">$form.userAccount.getInstance($user.id)</code>。每次调用该方法，就对一个group生成了一个实例（instance）。</p><div class="figure"><a id="d0e11844"><!--anchor d0e11844--></a><div class="figure-contents"><div class="mediaobject"><img src="images/form/multiple-group-instances.png" alt="创建多个group实例"/></div></div><p class="title"><strong>图 9.8. 创建多个group实例</strong></p></div><p>每个instance必须以不同的id来区分。最简单的方法，就是采用数据对象的唯一id来作为group
                        instance的id。在这个例子中，我们采用<code class="code">$user</code>的唯一id（<code class="code">$user.id</code>）来区分group
                    instances。</p><p>前文讲过，default instance的field
                            key是这个样子的：“<code class="code">_fm.r.</code><span class="emphasis"><em><code class="code">_0</code></em></span><code class="code">.p</code>”。类似的，通过<code class="code">getInstance("</code><span class="emphasis"><em><code class="code">myid</code></em></span><code class="code">")</code>方法所取得的group中的field
                        key是这样的：“<code class="code">_fm.u.</code><span class="emphasis"><em><code class="code">myid</code></em></span><code class="code">.n</code>”。很明显，form
                    service就是依赖于field key中所包含的group instance id来区分同一group的不同instances的。</p><p>因为field key将作为HTML的一部分，所以group
                        instance的id必须为满足下面的条件：<span class="emphasis"><em>只包含英文字母、数字、下划线、短横线的字符串</em></span>。</p><p>页面的其它部分和创建、修改单个数据的代码完全相同。只不过它们被循环生成了多次。 最后的结果是类似下面的样子：</p><div class="figure"><a id="d0e11891"><!--anchor d0e11891--></a><div class="figure-contents"><div class="mediaobject"><img src="images/form/batch-edit-form.png" alt="批量修改数据的页面示例"/></div></div><p class="title"><strong>图 9.9. 批量修改数据的页面示例</strong></p></div></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="d0e11897"><!--anchor d0e11897--></a>9.3.3.3. 用action来处理数据</h4></div></div></div><p>和前面的例子类似，我们先用传统的方法来写action以便阐明原理，再用annotation来简化action代码。</p><div class="example"><a id="d0e11902"><!--anchor d0e11902--></a><p class="title"><strong>例 9.15. 用来批量处理数据的action</strong></p><div class="example-contents"><pre class="programlisting"><strong class="hl-keyword" style="color: maroon">public</strong> <strong class="hl-keyword" style="color: maroon">class</strong> UserAccountAction {
    <em><span class="hl-annotation" style="color: gray">@Autowired</span></em>
    <strong class="hl-keyword" style="color: maroon">private</strong> FormService formService;

    <strong class="hl-keyword" style="color: maroon">public</strong> <strong class="hl-keyword" style="color: maroon">void</strong> doBatchEdit(Navigator nav) <strong class="hl-keyword" style="color: maroon">throws</strong> Exception {
        Form form = formService.getForm();

        <strong class="hl-keyword" style="color: maroon">if</strong> (form.isValid()) {
            Collection&lt;Group&gt; groups = form.getGroups(<strong class="hl-string"><em style="color:navy">"userAccount"</em></strong>); <a id="co.form.batch.action.getgroups"><!--anchor co.form.batch.action.getgroups--></a><span class="calloutno"><img src="images/callouts/1.png" border="0"/></span>

            <strong class="hl-keyword" style="color: maroon">for</strong> (Group group : groups) {
                MyUser user = <strong class="hl-keyword" style="color: maroon">new</strong> MyUser();

                group.setProperties(user);
                save(user);
            }

            nav.redirectTo(<strong class="hl-string"><em style="color:navy">"success"</em></strong>);
        }
    }
}</pre><div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#co.form.batch.action.getgroups"><span class="calloutno"><img src="images/callouts/1.png" border="0"/></span></a> </p></td><td valign="top" align="left"><p>通过这个方法，可以取得所有名称为“<code class="code">userAccount</code>”的group
                                    instances，包括：<code class="code">user1</code>、<code class="code">user2</code>、……。</p></td></tr></table></div></div></div><p>取得group实例，除了例子中的<code class="code">form.getGroups(groupName)</code>这种形式以外，还有以下几种变化：</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>取得所有的group instances，无论其名称是什么：<code class="code">Collection&lt;Group&gt; groups =
                                    form.getGroups(); </code></p></li><li class="listitem"><p>取得指定group名称和instance key的group instances：<code class="code">Group user1Group =
                                    form.getGroup("userAccount", "user1"); </code></p></li></ul></div><p>下面是一个简化版的action，实现完全相同的功能。</p><div class="example"><a id="d0e11940"><!--anchor d0e11940--></a><p class="title"><strong>例 9.16. 用来批量处理数据的action（Annotation简化版）</strong></p><div class="example-contents"><pre class="programlisting"><strong class="hl-keyword" style="color: maroon">public</strong> <strong class="hl-keyword" style="color: maroon">class</strong> UserAccountAction {
    <strong class="hl-keyword" style="color: maroon">public</strong> <strong class="hl-keyword" style="color: maroon">void</strong> doBatchEdit(<em><span class="hl-annotation" style="color: gray">@FormGroup("userAccount")</span></em> MyUser[] users,
                            Navigator nav) <strong class="hl-keyword" style="color: maroon">throws</strong> Exception {
        <strong class="hl-keyword" style="color: maroon">for</strong> (MyUser user : users) {
            save(user);
        }

        nav.redirectTo(<strong class="hl-string"><em style="color:navy">"success"</em></strong>);
    }
}</pre></div></div></div></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="d0e11945"><!--anchor d0e11945--></a>9.4. 表单验证服务详解</h2></div></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="d0e11948"><!--anchor d0e11948--></a>9.4.1. 配置详解</h3></div></div></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="d0e11951"><!--anchor d0e11951--></a>9.4.1.1. 基本配置</h4></div></div></div><div class="example"><a id="d0e11954"><!--anchor d0e11954--></a><p class="title"><strong>例 9.17. 表单验证服务的基本配置</strong></p><div class="example-contents"><pre class="programlisting"><strong class="hl-tag" style="color: #000096">&lt;services:form</strong> <span class="hl-attribute" style="color: #F5844C">xmlns</span>=<span class="hl-value" style="color: #993300">"http://www.alibaba.com/schema/services/form/validators"</span><strong class="hl-tag" style="color: #000096">&gt;</strong> <a id="co.form.basic.service"><!--anchor co.form.basic.service--></a><span class="calloutno"><img src="images/callouts/1.png" border="0"/></span>

    <strong class="hl-tag" style="color: #000096">&lt;services:group</strong> <span class="hl-attribute" style="color: #F5844C">name</span>=<span class="hl-value" style="color: #993300">"group1"</span><strong class="hl-tag" style="color: #000096">&gt;</strong> <a id="co.form.basic.group"><!--anchor co.form.basic.group--></a><span class="calloutno"><img src="images/callouts/2.png" border="0"/></span>
        <strong class="hl-tag" style="color: #000096">&lt;services:field</strong> <span class="hl-attribute" style="color: #F5844C">name</span>=<span class="hl-value" style="color: #993300">"field1"</span><strong class="hl-tag" style="color: #000096">&gt;</strong> <a id="co.form.basic.field"><!--anchor co.form.basic.field--></a><span class="calloutno"><img src="images/callouts/3.png" border="0"/></span>
            <strong class="hl-tag" style="color: #000096">&lt;validator /&gt;</strong> <a id="co.form.basic.validator"><!--anchor co.form.basic.validator--></a><span class="calloutno"><img src="images/callouts/4.png" border="0"/></span>
            <strong class="hl-tag" style="color: #000096">&lt;validator /&gt;</strong>
            ...
        <strong class="hl-tag" style="color: #000096">&lt;/services:field&gt;</strong>

        <strong class="hl-tag" style="color: #000096">&lt;services:field</strong> <span class="hl-attribute" style="color: #F5844C">name</span>=<span class="hl-value" style="color: #993300">"field2"</span><strong class="hl-tag" style="color: #000096"> /&gt;</strong>
        ...
    <strong class="hl-tag" style="color: #000096">&lt;/services:group&gt;</strong>

    <strong class="hl-tag" style="color: #000096">&lt;services:group</strong> <span class="hl-attribute" style="color: #F5844C">name</span>=<span class="hl-value" style="color: #993300">"group2"</span><strong class="hl-tag" style="color: #000096">&gt;</strong>
        ...
    <strong class="hl-tag" style="color: #000096">&lt;/services:group&gt;</strong>

    ...
<strong class="hl-tag" style="color: #000096">&lt;/services:form&gt;</strong></pre><div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#co.form.basic.service"><span class="calloutno"><img src="images/callouts/1.png" border="0"/></span></a> </p></td><td valign="top" align="left"><p>开始配置表单验证服务。</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#co.form.basic.group"><span class="calloutno"><img src="images/callouts/2.png" border="0"/></span></a> </p></td><td valign="top" align="left"><p>每个表单验证服务可包含多个groups。</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#co.form.basic.field"><span class="calloutno"><img src="images/callouts/3.png" border="0"/></span></a> </p></td><td valign="top" align="left"><p>每个group可包含多个fields。</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#co.form.basic.validator"><span class="calloutno"><img src="images/callouts/4.png" border="0"/></span></a> </p></td><td valign="top" align="left"><p>每个field可包含多个validators。</p></td></tr></table></div></div></div></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="d0e11980"><!--anchor d0e11980--></a>9.4.1.2. Post Only参数</h4></div></div></div><div class="example"><a id="d0e11983"><!--anchor d0e11983--></a><p class="title"><strong>例 9.18. 配置Post Only参数</strong></p><div class="example-contents"><pre class="programlisting"><strong class="hl-tag" style="color: #000096">&lt;services:form</strong> <span class="hl-attribute" style="color: #F5844C">postOnlyByDefault</span>=<span class="hl-value" style="color: #993300">"true"</span><strong class="hl-tag" style="color: #000096">&gt;</strong> <a id="co.form.postonly.default"><!--anchor co.form.postonly.default--></a><span class="calloutno"><img src="images/callouts/1.png" border="0"/></span>
    <strong class="hl-tag" style="color: #000096">&lt;services:group</strong> <span class="hl-attribute" style="color: #F5844C">name</span>=<span class="hl-value" style="color: #993300">"group1"</span> <span class="hl-attribute" style="color: #F5844C">postOnly</span>=<span class="hl-value" style="color: #993300">"true"</span><strong class="hl-tag" style="color: #000096"> /&gt;</strong> <a id="co.form.postonly.group"><!--anchor co.form.postonly.group--></a><span class="calloutno"><img src="images/callouts/2.png" border="0"/></span>
<strong class="hl-tag" style="color: #000096">&lt;/services:form&gt;</strong></pre><div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#co.form.postonly.default"><span class="calloutno"><img src="images/callouts/1.png" border="0"/></span></a> </p></td><td valign="top" align="left"><p>如果不指定，<code class="code">postOnlyByDefault</code>的默认值为<code class="code">true</code>。</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#co.form.postonly.group"><span class="calloutno"><img src="images/callouts/2.png" border="0"/></span></a> </p></td><td valign="top" align="left"><p>如果不指定，那么<code class="code">postOnly</code>的值取决于<code class="code">postOnlyByDefault</code>。这意味着如果什么也不设置，所有<code class="code">postOnly</code>的实际值均为<code class="code">true</code>。</p></td></tr></table></div></div></div><p>如果一个group被设置成<code class="code">postOnly=true</code>，那么，这个group将不接受通过GET方法提交的数据，只允许通过POST方式提交数据。这样可以略略增加系统的安全性，增加CSRF攻击的难度。</p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="d0e12022"><!--anchor d0e12022--></a>9.4.1.3. Trimming参数</h4></div></div></div><div class="example"><a id="d0e12025"><!--anchor d0e12025--></a><p class="title"><strong>例 9.19. 配置Trimming参数</strong></p><div class="example-contents"><pre class="programlisting"><strong class="hl-tag" style="color: #000096">&lt;services:form&gt;</strong>
    <strong class="hl-tag" style="color: #000096">&lt;services:group</strong> <span class="hl-attribute" style="color: #F5844C">name</span>=<span class="hl-value" style="color: #993300">"group1"</span> <span class="hl-attribute" style="color: #F5844C">trimmingByDefault</span>=<span class="hl-value" style="color: #993300">"true"</span><strong class="hl-tag" style="color: #000096">&gt;</strong> <a id="co.form.trimming.default"><!--anchor co.form.trimming.default--></a><span class="calloutno"><img src="images/callouts/1.png" border="0"/></span>
        <strong class="hl-tag" style="color: #000096">&lt;services:field</strong> <span class="hl-attribute" style="color: #F5844C">name</span>=<span class="hl-value" style="color: #993300">"field1"</span> <span class="hl-attribute" style="color: #F5844C">trimming</span>=<span class="hl-value" style="color: #993300">"true"</span><strong class="hl-tag" style="color: #000096"> /&gt;</strong> <a id="co.form.trimming.field"><!--anchor co.form.trimming.field--></a><span class="calloutno"><img src="images/callouts/2.png" border="0"/></span>
    <strong class="hl-tag" style="color: #000096">&lt;/services:group&gt;</strong>
<strong class="hl-tag" style="color: #000096">&lt;/services:form&gt;</strong></pre><div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#co.form.trimming.default"><span class="calloutno"><img src="images/callouts/1.png" border="0"/></span></a> </p></td><td valign="top" align="left"><p>如果不指定，<code class="code">trimmingByDefault</code>的默认值为<code class="code">true</code>。</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#co.form.trimming.field"><span class="calloutno"><img src="images/callouts/2.png" border="0"/></span></a> </p></td><td valign="top" align="left"><p>如果不指定，<code class="code">trimming</code>的值取决于<code class="code">trimmingByDefault</code>。这意味着如果什么也不设置，所有<code class="code">trimming</code>的实际值均为<code class="code">true</code>。</p></td></tr></table></div></div></div><p>用户所提交的字符串数据中，两端的空白往往是无意义的。这些空白可能会影响验证规则的准确性。</p><p>如果设置了<code class="code">trimming=true</code>参数，那么表单系统可以自动剪除字段值两端的空白字符，例如把<code class="code">“ my name
                        ”</code>（两端有空白）转变成<code class="code">“my name”</code>（两端无空白）。</p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="d0e12072"><!--anchor d0e12072--></a>9.4.1.4. Display Name参数</h4></div></div></div><div class="example"><a id="d0e12075"><!--anchor d0e12075--></a><p class="title"><strong>例 9.20. 配置Display Name参数</strong></p><div class="example-contents"><pre class="programlisting"><strong class="hl-tag" style="color: #000096">&lt;services:field</strong> <span class="hl-attribute" style="color: #F5844C">name</span>=<span class="hl-value" style="color: #993300">"field1"</span> <span class="hl-attribute" style="color: #F5844C">displayName</span>=<span class="hl-value" style="color: #993300">"我的字段"</span><strong class="hl-tag" style="color: #000096">&gt;</strong> <a id="co.form.displayname"><!--anchor co.form.displayname--></a><span class="calloutno"><img src="images/callouts/1.png" border="0"/></span>
    <strong class="hl-tag" style="color: #000096">&lt;required-validator&gt;</strong>
        <strong class="hl-tag" style="color: #000096">&lt;message&gt;</strong>必须填写${displayName}<strong class="hl-tag" style="color: #000096">&lt;/message&gt;</strong> <a id="co.form.displayname.ref"><!--anchor co.form.displayname.ref--></a><span class="calloutno"><img src="images/callouts/2.png" border="0"/></span>
    <strong class="hl-tag" style="color: #000096">&lt;/required-validator&gt;</strong>
<strong class="hl-tag" style="color: #000096">&lt;/services:field&gt;</strong></pre><div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#co.form.displayname"><span class="calloutno"><img src="images/callouts/1.png" border="0"/></span></a> </p></td><td valign="top" align="left"><p>如果未指定<code class="code">displayName</code>，那么其默认为field名称。也就是的“<code class="code">field1</code>”。</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#co.form.displayname.ref"><span class="calloutno"><img src="images/callouts/2.png" border="0"/></span></a> </p></td><td valign="top" align="left"><p>在validator
                                message中，可以引用<code class="code">${displayName}</code>。这样做的好处是，validator
                                message可以被复制给其它的field，而不是需要更动其信息内容。</p></td></tr></table></div></div></div><p>Display Name是对当前field的一个描述信息。</p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="d0e12102"><!--anchor d0e12102--></a>9.4.1.5. 类型转换</h4></div></div></div><div class="example"><a id="d0e12105"><!--anchor d0e12105--></a><p class="title"><strong>例 9.21. 类型转换的配置</strong></p><div class="example-contents"><pre class="programlisting"><strong class="hl-tag" style="color: #000096">&lt;services:form</strong> <span class="hl-attribute" style="color: #F5844C">converterQuiet</span>=<span class="hl-value" style="color: #993300">"true"</span><strong class="hl-tag" style="color: #000096">&gt;</strong> <a id="co.form.convtype.quiet"><!--anchor co.form.convtype.quiet--></a><span class="calloutno"><img src="images/callouts/1.png" border="0"/></span>
    <strong class="hl-tag" style="color: #000096">&lt;services:property-editor-registrar</strong>
        <span class="hl-attribute" style="color: #F5844C">class</span>=<span class="hl-value" style="color: #993300">"com.alibaba.citrus.service.configuration.support.CustomDateRegistrar"</span>
        <span class="hl-attribute" style="color: #F5844C">p:format</span>=<span class="hl-value" style="color: #993300">"yyyy-MM-dd"</span><strong class="hl-tag" style="color: #000096"> /&gt;</strong> <a id="co.form.convtype.editor"><!--anchor co.form.convtype.editor--></a><span class="calloutno"><img src="images/callouts/2.png" border="0"/></span>
<strong class="hl-tag" style="color: #000096">&lt;/services:form&gt;</strong></pre><div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#co.form.convtype.quiet"><span class="calloutno"><img src="images/callouts/1.png" border="0"/></span></a> </p></td><td valign="top" align="left"><p>如果<code class="code">converterQuiet=true</code>，那么类型转换失败时，将取得默认值。否则，抛出异常。<code class="code">converterQuiet</code>的默认值为<code class="code">true</code>。</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#co.form.convtype.editor"><span class="calloutno"><img src="images/callouts/2.png" border="0"/></span></a> </p></td><td valign="top" align="left"><p>类型转换采用Spring Property
                                    Editor机制。你可以通过注册新的registrar来增加新的类型转换方法。这段配置增加了一种将日期转成字符串的方式（用<code class="code">yyyy-MM-dd</code>格式）。</p></td></tr></table></div></div></div><p>下面的操作将用到类型转换：</p><div class="table"><a id="d0e12135"><!--anchor d0e12135--></a><p class="title"><strong>表 9.6. 何时用到类型转换？</strong></p><div class="table-contents"><table summary="何时用到类型转换？" cellpadding="10" style="border: none;"><colgroup><col width="50%" class="c1"/><col width="50%" class="c2"/></colgroup><thead><tr><th style="border-right: 0.5pt solid #6666cc; border-bottom: 0.5pt solid #6666cc; ">操作</th><th style="border-bottom: 0.5pt solid #6666cc; ">说明</th></tr></thead><tbody><tr><td style="border-right: 0.5pt solid #6666cc; border-bottom: 0.5pt solid #6666cc; "><code class="code">Group.setProperties(bean)</code></td><td style="border-bottom: 0.5pt solid #6666cc; ">将Group中的所有fields值注入bean properties。</td></tr><tr><td style="border-right: 0.5pt solid #6666cc; "><code class="code">Group.mapTo(bean)</code></td><td style="">用bean properties中的值初始化group fields。</td></tr></tbody></table></div></div></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="d0e12160"><!--anchor d0e12160--></a>9.4.1.6. 国际化</h4></div></div></div><p>表单验证失败时，将在页面上显示错误信息。有两种方法可以定义错误信息：</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>将错误信息直接定义在配置文件中。前文的例子所用的都是这种方案。</p></li><li class="listitem"><p>将错误信息定义在Spring Message Source中，从而支持国际化。</p></li></ul></div><p>为了将使用国际化（多语言）的错误信息，首先需要定义Spring Message Source。</p><div class="example"><a id="d0e12174"><!--anchor d0e12174--></a><p class="title"><strong>例 9.22. 在Spring Message Source中定义错误信息</strong></p><div class="example-contents"><pre class="programlisting"><strong class="hl-tag" style="color: #000096">&lt;bean</strong> <span class="hl-attribute" style="color: #F5844C">id</span>=<span class="hl-value" style="color: #993300">"messageSource"</span>
       <span class="hl-attribute" style="color: #F5844C">xmlns</span>=<span class="hl-value" style="color: #993300">"http://www.springframework.org/schema/beans"</span>
       <span class="hl-attribute" style="color: #F5844C">class</span>=<span class="hl-value" style="color: #993300">"org.springframework.context.support.ReloadableResourceBundleMessageSource"</span>
       <span class="hl-attribute" style="color: #F5844C">p:defaultEncoding</span>=<span class="hl-value" style="color: #993300">"GB18030"</span><strong class="hl-tag" style="color: #000096">&gt;</strong>
    <strong class="hl-tag" style="color: #000096">&lt;property</strong> <span class="hl-attribute" style="color: #F5844C">name</span>=<span class="hl-value" style="color: #993300">"basenames"</span><strong class="hl-tag" style="color: #000096">&gt;</strong>
        <strong class="hl-tag" style="color: #000096">&lt;list&gt;</strong>
            <strong class="hl-tag" style="color: #000096">&lt;value&gt;</strong>form_msgs<strong class="hl-tag" style="color: #000096">&lt;/value&gt;</strong> <a id="co.form.i18n.msgsrc"><!--anchor co.form.i18n.msgsrc--></a><span class="calloutno"><img src="images/callouts/1.png" border="0"/></span>
        <strong class="hl-tag" style="color: #000096">&lt;/list&gt;</strong>
    <strong class="hl-tag" style="color: #000096">&lt;/property&gt;</strong>
<strong class="hl-tag" style="color: #000096">&lt;/bean&gt;</strong></pre><div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#co.form.i18n.msgsrc"><span class="calloutno"><img src="images/callouts/1.png" border="0"/></span></a> </p></td><td valign="top" align="left"><p>这段配置告诉spring去读取<code class="code">form_msgs</code>开头的resource bundle文件，例如：</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>form_msgs.properties</p></li><li class="listitem"><p>form_msgs_zh_CN.properties</p></li><li class="listitem"><p>form.msgs_zh_TW.properties</p></li></ul></div></td></tr></table></div></div></div><p>请注意，Spring是从<code class="code">ResourceLoader</code>中读取resource
                    bundle文件的。因此，你可能需要配置Resource Loading以帮助spring找到这些消息文件。关于资源装载，请参见<a class="xref" href="resourceloading.html" title="第 5 章 Resource Loading服务指南">第 5 章 <em>Resource Loading服务指南</em></a>。</p><p>使用message
                            source以后，你可以省略validator中的<code class="code">message</code>标签，但是<span class="emphasis"><em>每个validator必须指定<code class="code">id</code></em></span>。表单系统将会从message
                        source中查找指定的key：“<code class="code">form.&lt;GroupName&gt;.&lt;FieldName&gt;.&lt;ValidatorID&gt;</code>”。</p><div class="example"><a id="d0e12218"><!--anchor d0e12218--></a><p class="title"><strong>例 9.23. 配置validator ID</strong></p><div class="example-contents"><pre class="programlisting"><strong class="hl-tag" style="color: #000096">&lt;services:form&gt;</strong>
    <strong class="hl-tag" style="color: #000096">&lt;services:group</strong> <span class="hl-attribute" style="color: #F5844C">name</span>=<span class="hl-value" style="color: #993300">"register"</span><strong class="hl-tag" style="color: #000096">&gt;</strong>
        <strong class="hl-tag" style="color: #000096">&lt;services:field</strong> <span class="hl-attribute" style="color: #F5844C">name</span>=<span class="hl-value" style="color: #993300">"userId"</span><strong class="hl-tag" style="color: #000096">&gt;</strong>
            <strong class="hl-tag" style="color: #000096">&lt;required-validator</strong> <span class="hl-attribute" style="color: #F5844C">id</span>=<span class="hl-value" style="color: #993300">"required"</span><strong class="hl-tag" style="color: #000096"> /&gt;</strong> <a id="co.form.i18n.validator.id"><!--anchor co.form.i18n.validator.id--></a><span class="calloutno"><img src="images/callouts/1.png" border="0"/></span>
        <strong class="hl-tag" style="color: #000096">&lt;/services:field&gt;</strong>
    <strong class="hl-tag" style="color: #000096">&lt;/services:group&gt;</strong>
<strong class="hl-tag" style="color: #000096">&lt;/services:form&gt;</strong></pre><div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#co.form.i18n.validator.id"><span class="calloutno"><img src="images/callouts/1.png" border="0"/></span></a> </p></td><td valign="top" align="left"><p>指定了validator
                                    ID为<code class="code">required</code>，根据格式“<code class="code">form.&lt;GroupName&gt;.&lt;FieldName&gt;.&lt;ValidatorID&gt;</code>”，当前validator
                                    message的key为：“<code class="code">form.register.userId.required</code>”。</p></td></tr></table></div></div></div><p>假设message source定义文件及内容如下：</p><div class="table"><a id="d0e12240"><!--anchor d0e12240--></a><p class="title"><strong>表 9.7. Message Source的内容</strong></p><div class="table-contents"><table summary="Message Source的内容" cellpadding="10" style="border: none;"><colgroup><col width="37%" class="c1"/><col width="63%" class="c2"/></colgroup><thead><tr><th style="border-right: 0.5pt solid #6666cc; border-bottom: 0.5pt solid #6666cc; ">文件名</th><th style="border-bottom: 0.5pt solid #6666cc; ">内容</th></tr></thead><tbody><tr><td style="border-right: 0.5pt solid #6666cc; border-bottom: 0.5pt solid #6666cc; "><code class="filename">form_msgs_zh_CN.properties</code></td><td style="border-bottom: 0.5pt solid #6666cc; ">
                                    <pre class="programlisting"><span class="hl-attribute" style="color: #F5844C">form.register.userId.required </span>= 必须填写用户名</pre>
                                </td></tr><tr><td style="border-right: 0.5pt solid #6666cc; "><code class="filename">form_msgs.properties</code></td><td style="">
                                    <pre class="programlisting"><span class="hl-attribute" style="color: #F5844C">form.register.userId.required </span>= User ID is required</pre>
                                </td></tr></tbody></table></div></div><p>对于以上的message
                        source内容，在中文环境中（<code class="code">locale=zh_CN</code>），将显示错误信息“<code class="code">必须填写用户名</code>”；而在英文环境中（<code class="code">locale=en_US</code>），将显示默认的错误信息“<code class="code">User
                        ID is required</code>”。</p><p>系统的当前locale是由<code class="code">SetLocaleRequestContext</code>来决定的。关于<code class="code">SetLocaleRequestContext</code>的设定和使用，请参见<a class="xref" href="requestcontexts.html" title="第 7 章 Request Contexts功能指南">第 7 章 <em>Request Contexts功能指南</em></a>。</p><p>此外，你还可以可以改变message source中key的前缀。</p><div class="example"><a id="d0e12297"><!--anchor d0e12297--></a><p class="title"><strong>例 9.24. 改变message source key的前缀</strong></p><div class="example-contents"><pre class="programlisting"><strong class="hl-tag" style="color: #000096">&lt;services:form</strong> <span class="hl-attribute" style="color: #F5844C">messageCodePrefix</span>=<span class="hl-value" style="color: #993300">"myform"</span><strong class="hl-tag" style="color: #000096">&gt;</strong>
    ...
<strong class="hl-tag" style="color: #000096">&lt;/services:form&gt;</strong></pre></div></div><p>上面的配置将指导表单系统在message
                        source中查找指定的key：“<span class="emphasis"><em><code class="code">myform</code></em></span><code class="code">.GroupName.FieldName.ValidatorID</code>”。</p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="d0e12310"><!--anchor d0e12310--></a>9.4.1.7. 切分表单服务</h4></div></div></div><p>在实际的应用中，有时一个表单规则的配置文件会很长。将一个长文件切分成几个较短的文件，更有利于管理。表单验证服务支持导入多个form表单服务，从而实现分割较长配置文件的功能。</p><div class="example"><a id="d0e12315"><!--anchor d0e12315--></a><p class="title"><strong>例 9.25. 切分表单服务</strong></p><div class="example-contents"><p>主配置文件：<code class="filename">form.xml</code>：</p><pre class="programlisting"><span class="hl-directive" style="color: maroon">&lt;?xml version="1.0" encoding="UTF-8" ?&gt;</span>
<strong class="hl-tag" style="color: #000096">&lt;beans:beans</strong> <span class="hl-attribute" style="color: #F5844C">xmlns:xsi</span>=<span class="hl-value" style="color: #993300">"http://www.w3.org/2001/XMLSchema-instance"</span>
    <span class="hl-attribute" style="color: #F5844C">xmlns:services</span>=<span class="hl-value" style="color: #993300">"http://www.alibaba.com/schema/services"</span>
    <span class="hl-attribute" style="color: #F5844C">xmlns:beans</span>=<span class="hl-value" style="color: #993300">"http://www.springframework.org/schema/beans"</span><strong class="hl-tag" style="color: #000096">&gt;</strong>

    <strong class="hl-tag" style="color: #000096">&lt;beans:import</strong> <span class="hl-attribute" style="color: #F5844C">resource</span>=<span class="hl-value" style="color: #993300">"inc/form_part1.xml"</span><strong class="hl-tag" style="color: #000096"> /&gt;</strong> <a id="co.form.importform.import1"><!--anchor co.form.importform.import1--></a><span class="calloutno"><img src="images/callouts/1.png" border="0"/></span>
    <strong class="hl-tag" style="color: #000096">&lt;beans:import</strong> <span class="hl-attribute" style="color: #F5844C">resource</span>=<span class="hl-value" style="color: #993300">"inc/form_part2.xml"</span><strong class="hl-tag" style="color: #000096"> /&gt;</strong> <a id="co.form.importform.import2"><!--anchor co.form.importform.import2--></a><span class="calloutno"><img src="images/callouts/2.png" border="0"/></span>

    <strong class="hl-tag" style="color: #000096">&lt;services:form</strong> <span class="hl-attribute" style="color: #F5844C">xmlns</span>=<span class="hl-value" style="color: #993300">"http://www.alibaba.com/schema/services/form/validators"</span> <span class="hl-attribute" style="color: #F5844C">primary</span>=<span class="hl-value" style="color: #993300">"true"</span><strong class="hl-tag" style="color: #000096">&gt;</strong> <a id="co.form.importform.form"><!--anchor co.form.importform.form--></a><span class="calloutno"><img src="images/callouts/3.png" border="0"/></span>
        <strong class="hl-tag" style="color: #000096">&lt;services:import</strong> <span class="hl-attribute" style="color: #F5844C">form</span>=<span class="hl-value" style="color: #993300">"part1"</span><strong class="hl-tag" style="color: #000096"> /&gt;</strong> <a id="co.form.importform.import.part1"><!--anchor co.form.importform.import.part1--></a><span class="calloutno"><img src="images/callouts/4.png" border="0"/></span>
        <strong class="hl-tag" style="color: #000096">&lt;services:import</strong> <span class="hl-attribute" style="color: #F5844C">form</span>=<span class="hl-value" style="color: #993300">"part2"</span><strong class="hl-tag" style="color: #000096"> /&gt;</strong> <a id="co.form.importform.import.part2"><!--anchor co.form.importform.import.part2--></a><span class="calloutno"><img src="images/callouts/5.png" border="0"/></span>

        ...
    <strong class="hl-tag" style="color: #000096">&lt;/services:form&gt;</strong>

<strong class="hl-tag" style="color: #000096">&lt;/beans:beans&gt;</strong></pre><div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#co.form.importform.import1"><span class="calloutno"><img src="images/callouts/1.png" border="0"/></span></a> <a href="#co.form.importform.import2"><span class="calloutno"><img src="images/callouts/2.png" border="0"/></span></a> </p></td><td valign="top" align="left"><p>导入包含着子表单服务的spring配置。</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#co.form.importform.form"><span class="calloutno"><img src="images/callouts/3.png" border="0"/></span></a> </p></td><td valign="top" align="left"><p>定义主表单服务时，<span class="emphasis"><em>必须指定<code class="code">primary="true"</code></em></span>。否则spring将无法区分主从表单服务，从而导致注入<code class="code">FormService</code>时失败。</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#co.form.importform.import.part1"><span class="calloutno"><img src="images/callouts/4.png" border="0"/></span></a> <a href="#co.form.importform.import.part2"><span class="calloutno"><img src="images/callouts/5.png" border="0"/></span></a> </p></td><td valign="top" align="left"><p>导入指定ID的子表单服务。</p></td></tr></table></div><p>子表单服务的配置文件：<code class="filename">inc/form_part1.xml</code>和<code class="filename">inc/form_part2.xml</code>：</p><pre class="programlisting"><em class="hl-comment" style="color: green">&lt;!-- inc/form_part1.xml --&gt;</em>
<strong class="hl-tag" style="color: #000096">&lt;beans:beans</strong> <span class="hl-attribute" style="color: #F5844C">xmlns:xsi</span>=<span class="hl-value" style="color: #993300">"http://www.w3.org/2001/XMLSchema-instance"</span>
    <span class="hl-attribute" style="color: #F5844C">xmlns:services</span>=<span class="hl-value" style="color: #993300">"http://www.alibaba.com/schema/services"</span>
    <span class="hl-attribute" style="color: #F5844C">xmlns:beans</span>=<span class="hl-value" style="color: #993300">"http://www.springframework.org/schema/beans"</span><strong class="hl-tag" style="color: #000096">&gt;</strong>

    <strong class="hl-tag" style="color: #000096">&lt;services:form</strong> <span class="hl-attribute" style="color: #F5844C">id</span>=<span class="hl-value" style="color: #993300">"part1"</span><strong class="hl-tag" style="color: #000096">&gt;</strong> <a id="co.form.importform.part1"><!--anchor co.form.importform.part1--></a><span class="calloutno"><img src="images/callouts/1.png" border="0"/></span>
        ...
    <strong class="hl-tag" style="color: #000096">&lt;/services:form&gt;</strong>

<strong class="hl-tag" style="color: #000096">&lt;/beans:beans&gt;</strong>

<em class="hl-comment" style="color: green">&lt;!-- inc/form_part2.xml --&gt;</em>
<strong class="hl-tag" style="color: #000096">&lt;beans:beans</strong> <span class="hl-attribute" style="color: #F5844C">xmlns:xsi</span>=<span class="hl-value" style="color: #993300">"http://www.w3.org/2001/XMLSchema-instance"</span>
    <span class="hl-attribute" style="color: #F5844C">xmlns:services</span>=<span class="hl-value" style="color: #993300">"http://www.alibaba.com/schema/services"</span>
    <span class="hl-attribute" style="color: #F5844C">xmlns:beans</span>=<span class="hl-value" style="color: #993300">"http://www.springframework.org/schema/beans"</span><strong class="hl-tag" style="color: #000096">&gt;</strong>

    <strong class="hl-tag" style="color: #000096">&lt;services:form</strong> <span class="hl-attribute" style="color: #F5844C">id</span>=<span class="hl-value" style="color: #993300">"part2"</span><strong class="hl-tag" style="color: #000096">&gt;</strong> <a id="co.form.importform.part2"><!--anchor co.form.importform.part2--></a><span class="calloutno"><img src="images/callouts/2.png" border="0"/></span>
        ...
    <strong class="hl-tag" style="color: #000096">&lt;/services:form&gt;</strong>

<strong class="hl-tag" style="color: #000096">&lt;/beans:beans&gt;</strong></pre><div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#co.form.importform.part1"><span class="calloutno"><img src="images/callouts/1.png" border="0"/></span></a> <a href="#co.form.importform.part2"><span class="calloutno"><img src="images/callouts/2.png" border="0"/></span></a> </p></td><td valign="top" align="left"><p><span class="emphasis"><em>子表单服务必须指定ID。</em></span></p></td></tr></table></div></div></div><p>导入子表单服务，意味着将子表单服务中的所有groups导入到主表单的空间。主表单中的groups将会覆盖被导入子表单中的groups。也就是说，假如主表单中存在一个group，它的名字和被导入的子表单中的group同名，那么子表单中的group将被忽略。</p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="d0e12374"><!--anchor d0e12374--></a>9.4.1.8. Group的继承和导入</h4></div></div></div><p>在实际应用中，你会发现有一些groups的定义很相似。继承和导入的目的是让这些相似的groups之间可以共享共同的参数、字段和验证规则，避免重复定义。</p><p>下面是group继承的用法： </p><div class="example"><a id="d0e12381"><!--anchor d0e12381--></a><p class="title"><strong>例 9.26. 继承一个group</strong></p><div class="example-contents"><pre class="programlisting"><strong class="hl-tag" style="color: #000096">&lt;services:form&gt;</strong>
    <strong class="hl-tag" style="color: #000096">&lt;services:group</strong> <span class="hl-attribute" style="color: #F5844C">name</span>=<span class="hl-value" style="color: #993300">"baseGroup"</span><strong class="hl-tag" style="color: #000096">&gt;</strong>
        <strong class="hl-tag" style="color: #000096">&lt;services:field</strong> <span class="hl-attribute" style="color: #F5844C">name</span>=<span class="hl-value" style="color: #993300">"field1"</span><strong class="hl-tag" style="color: #000096"> &gt;</strong>
            <strong class="hl-tag" style="color: #000096">&lt;validator1 /&gt;</strong>
            <strong class="hl-tag" style="color: #000096">&lt;validator2 /&gt;</strong>
        <strong class="hl-tag" style="color: #000096">&lt;/services:field&gt;</strong>
        <strong class="hl-tag" style="color: #000096">&lt;services:field</strong> <span class="hl-attribute" style="color: #F5844C">name</span>=<span class="hl-value" style="color: #993300">"field2"</span><strong class="hl-tag" style="color: #000096"> /&gt;</strong>
        <strong class="hl-tag" style="color: #000096">&lt;services:field</strong> <span class="hl-attribute" style="color: #F5844C">name</span>=<span class="hl-value" style="color: #993300">"field3"</span><strong class="hl-tag" style="color: #000096"> /&gt;</strong>
    <strong class="hl-tag" style="color: #000096">&lt;/services:group&gt;</strong>

    <strong class="hl-tag" style="color: #000096">&lt;services:group</strong> <span class="hl-attribute" style="color: #F5844C">name</span>=<span class="hl-value" style="color: #993300">"subGroup"</span> <span class="hl-attribute" style="color: #F5844C">extends</span>=<span class="hl-value" style="color: #993300">"baseGroup"</span><strong class="hl-tag" style="color: #000096">&gt;</strong>
        <strong class="hl-tag" style="color: #000096">&lt;services:field</strong> <span class="hl-attribute" style="color: #F5844C">name</span>=<span class="hl-value" style="color: #993300">"field1"</span><strong class="hl-tag" style="color: #000096">&gt;</strong>
            <strong class="hl-tag" style="color: #000096">&lt;validator3 /&gt;</strong>
        <strong class="hl-tag" style="color: #000096">&lt;/services:field&gt;</strong>
        <strong class="hl-tag" style="color: #000096">&lt;services:field</strong> <span class="hl-attribute" style="color: #F5844C">name</span>=<span class="hl-value" style="color: #993300">"field4"</span><strong class="hl-tag" style="color: #000096"> /&gt;</strong>
    <strong class="hl-tag" style="color: #000096">&lt;/services:group&gt;</strong>

<strong class="hl-tag" style="color: #000096">&lt;/services:form&gt;</strong></pre></div></div><p>这段配置中，<code class="code">subGroup</code>继承了<code class="code">baseGroup</code>。其效果是：</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p><code class="code">baseGroup</code>的参数（<code class="code">postOnly</code>、<code class="code">trimmingByDefault</code>）被<code class="code">subGroup</code>继承，除非<code class="code">subGroup</code>明确指定了该参数。</p></li><li class="listitem"><p><code class="code">baseGroup</code>中fields被<code class="code">subGroup</code>继承。具体来说：</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem"><p><code class="code">baseGroup</code>中不同名的fields被直接添加到<code class="code">subGroup</code>中。</p></li><li class="listitem"><p><code class="code">baseGroup</code>中同名的fields被<code class="code">subGroup</code>中的继承。具体来说：</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: square; "><li class="listitem"><p><code class="code">baseGroup</code>
                                                  field的参数（<code class="code">name</code>、<code class="code">displayName</code>、<code class="code">defaultValue</code>、<code class="code">trimming</code>、<code class="code">propertyName</code>）被<code class="code">subGroup</code>
                                                  field继承，除非<code class="code">subGroup</code>
                                                  field明确指定了该参数。</p></li><li class="listitem"><p><code class="code">baseGroup</code>
                                                  field中的validators被全部添加到<code class="code">subGroup</code>
                                                  field中。 </p></li></ul></div></li></ul></div></li></ul></div><p>因此，上面配置所定义的<code class="code">subGroup</code>和下面配置中的完全等效：</p><div class="example"><a id="d0e12477"><!--anchor d0e12477--></a><p class="title"><strong>例 9.27. Group继承的效果</strong></p><div class="example-contents"><pre class="programlisting"><strong class="hl-tag" style="color: #000096">&lt;services:form&gt;</strong>
    <strong class="hl-tag" style="color: #000096">&lt;services:group</strong> <span class="hl-attribute" style="color: #F5844C">name</span>=<span class="hl-value" style="color: #993300">"subGroup"</span><strong class="hl-tag" style="color: #000096">&gt;</strong>
        <strong class="hl-tag" style="color: #000096">&lt;services:field</strong> <span class="hl-attribute" style="color: #F5844C">name</span>=<span class="hl-value" style="color: #993300">"field1"</span><strong class="hl-tag" style="color: #000096">&gt;</strong>
            <strong class="hl-tag" style="color: #000096">&lt;validator1 /&gt;</strong><em class="hl-comment" style="color: green">&lt;!-- 来自baseGroup --&gt;</em>
            <strong class="hl-tag" style="color: #000096">&lt;validator2 /&gt;</strong><em class="hl-comment" style="color: green">&lt;!-- 来自baseGroup --&gt;</em>
            <strong class="hl-tag" style="color: #000096">&lt;validator3 /&gt;</strong>
        <strong class="hl-tag" style="color: #000096">&lt;/services:field&gt;</strong>
        <strong class="hl-tag" style="color: #000096">&lt;services:field</strong> <span class="hl-attribute" style="color: #F5844C">name</span>=<span class="hl-value" style="color: #993300">"field2"</span><strong class="hl-tag" style="color: #000096"> /&gt;</strong><em class="hl-comment" style="color: green">&lt;!-- 来自baseGroup --&gt;</em>
        <strong class="hl-tag" style="color: #000096">&lt;services:field</strong> <span class="hl-attribute" style="color: #F5844C">name</span>=<span class="hl-value" style="color: #993300">"field3"</span><strong class="hl-tag" style="color: #000096"> /&gt;</strong><em class="hl-comment" style="color: green">&lt;!-- 来自baseGroup --&gt;</em>
        <strong class="hl-tag" style="color: #000096">&lt;services:field</strong> <span class="hl-attribute" style="color: #F5844C">name</span>=<span class="hl-value" style="color: #993300">"field4"</span><strong class="hl-tag" style="color: #000096"> /&gt;</strong>
    <strong class="hl-tag" style="color: #000096">&lt;/services:group&gt;</strong>
<strong class="hl-tag" style="color: #000096">&lt;/services:form&gt;</strong></pre></div></div><p>另一种和继承类似的功能是导入：</p><div class="example"><a id="d0e12484"><!--anchor d0e12484--></a><p class="title"><strong>例 9.28. 导入groups和fields</strong></p><div class="example-contents"><pre class="programlisting"><strong class="hl-tag" style="color: #000096">&lt;services:form&gt;</strong>
    <strong class="hl-tag" style="color: #000096">&lt;services:group</strong> <span class="hl-attribute" style="color: #F5844C">name</span>=<span class="hl-value" style="color: #993300">"group1"</span><strong class="hl-tag" style="color: #000096">&gt;</strong>
        <strong class="hl-tag" style="color: #000096">&lt;services:field</strong> <span class="hl-attribute" style="color: #F5844C">name</span>=<span class="hl-value" style="color: #993300">"field1"</span><strong class="hl-tag" style="color: #000096"> /&gt;</strong>
        <strong class="hl-tag" style="color: #000096">&lt;services:field</strong> <span class="hl-attribute" style="color: #F5844C">name</span>=<span class="hl-value" style="color: #993300">"field2"</span><strong class="hl-tag" style="color: #000096"> /&gt;</strong>
        <strong class="hl-tag" style="color: #000096">&lt;services:field</strong> <span class="hl-attribute" style="color: #F5844C">name</span>=<span class="hl-value" style="color: #993300">"field3"</span><strong class="hl-tag" style="color: #000096"> /&gt;</strong>
    <strong class="hl-tag" style="color: #000096">&lt;/services:group&gt;</strong>

    <strong class="hl-tag" style="color: #000096">&lt;services:group</strong> <span class="hl-attribute" style="color: #F5844C">name</span>=<span class="hl-value" style="color: #993300">"group2"</span><strong class="hl-tag" style="color: #000096">&gt;</strong>
        <strong class="hl-tag" style="color: #000096">&lt;services:import</strong> <span class="hl-attribute" style="color: #F5844C">group</span>=<span class="hl-value" style="color: #993300">"group1"</span><strong class="hl-tag" style="color: #000096"> /&gt;</strong> <a id="co.form.import.group"><!--anchor co.form.import.group--></a><span class="calloutno"><img src="images/callouts/1.png" border="0"/></span>
        <strong class="hl-tag" style="color: #000096">&lt;services:field</strong> <span class="hl-attribute" style="color: #F5844C">name</span>=<span class="hl-value" style="color: #993300">"field4"</span><strong class="hl-tag" style="color: #000096"> /&gt;</strong>
    <strong class="hl-tag" style="color: #000096">&lt;/services:group&gt;</strong>

    <strong class="hl-tag" style="color: #000096">&lt;services:group</strong> <span class="hl-attribute" style="color: #F5844C">name</span>=<span class="hl-value" style="color: #993300">"group3"</span><strong class="hl-tag" style="color: #000096">&gt;</strong>
        <strong class="hl-tag" style="color: #000096">&lt;services:import</strong> <span class="hl-attribute" style="color: #F5844C">group</span>=<span class="hl-value" style="color: #993300">"group1"</span> <span class="hl-attribute" style="color: #F5844C">field</span>=<span class="hl-value" style="color: #993300">"field1"</span><strong class="hl-tag" style="color: #000096"> /&gt;</strong> <a id="co.form.import.field"><!--anchor co.form.import.field--></a><span class="calloutno"><img src="images/callouts/2.png" border="0"/></span>
       <strong class="hl-tag" style="color: #000096">&lt;services:field</strong> <span class="hl-attribute" style="color: #F5844C">name</span>=<span class="hl-value" style="color: #993300">"field5"</span><strong class="hl-tag" style="color: #000096"> /&gt;</strong>
    <strong class="hl-tag" style="color: #000096">&lt;/services:group&gt;</strong>

<strong class="hl-tag" style="color: #000096">&lt;/services:form&gt;</strong></pre><div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#co.form.import.group"><span class="calloutno"><img src="images/callouts/1.png" border="0"/></span></a> </p></td><td valign="top" align="left"><p>导入<code class="code">group1</code>中的全部fields。导入以后，<code class="code">group2</code>拥有的fields包括：<code class="code">field1</code>、<code class="code">field2</code>、<code class="code">field3</code>和<code class="code">field4</code>。其中，<code class="code">field1</code>、<code class="code">field2</code>、<code class="code">field3</code>均来自于<code class="code">group1</code>。</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#co.form.import.field"><span class="calloutno"><img src="images/callouts/2.png" border="0"/></span></a> </p></td><td valign="top" align="left"><p>导入<code class="code">group1</code>中的一个field。导入以后，<code class="code">group3</code>拥有的fields包括：<code class="code">field1</code>和<code class="code">field5</code>。其中，<code class="code">field1</code>来自于<code class="code">group1</code>。</p></td></tr></table></div></div></div><p>导入有两种形式，导入全部fields和导入一个field。</p><p>导入和继承都可以使group共享一些内容，但是，</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>继承只能有一个base group，而导入可以有多次import；</p></li><li class="listitem"><p>继承会合并同名的fields，而导入时则禁止同名fields的。在上例中，假如<code class="code">group2</code>已经有了<code class="code">field1</code>，那么再次导入<code class="code">group1</code>的<code class="code">field1</code>将会报错。</p></li></ul></div></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="d0e12571"><!--anchor d0e12571--></a>9.4.1.9. 设置默认值</h4></div></div></div><p>
                    </p><div class="example"><a id="d0e12576"><!--anchor d0e12576--></a><p class="title"><strong>例 9.29. 设置表单字段的默认值</strong></p><div class="example-contents"><pre class="programlisting"><strong class="hl-tag" style="color: #000096">&lt;services:field</strong> <span class="hl-attribute" style="color: #F5844C">name</span>=<span class="hl-value" style="color: #993300">"field1"</span> <span class="hl-attribute" style="color: #F5844C">defaultValue</span>=<span class="hl-value" style="color: #993300">"defaultValue"</span><strong class="hl-tag" style="color: #000096"> /&gt;</strong></pre></div></div><p>
                </p><p>当表单被创建时，所有的字段值默认都是空的 ——
                        除非你指定了<code class="code">defaultValue</code>。需要注意的是，<span class="emphasis"><em>默认值只影响初始表单。对于用户已经提交数据的表单不起作用</em></span>。</p><p>假如一个field需要多个值，例如多选的checkbox，那么它可以设置一个具有多值的默认值。方法是：用逗号分隔多值。像下面的样子：</p><div class="example"><a id="d0e12592"><!--anchor d0e12592--></a><p class="title"><strong>例 9.30. 设置多个值作为表单字段的默认值</strong></p><div class="example-contents"><pre class="programlisting"><strong class="hl-tag" style="color: #000096">&lt;services:field</strong> <span class="hl-attribute" style="color: #F5844C">name</span>=<span class="hl-value" style="color: #993300">"field1"</span> <span class="hl-attribute" style="color: #F5844C">defaultValue</span>=<span class="hl-value" style="color: #993300">"defaultValue1, defaultValue2, defaultValue3"</span><strong class="hl-tag" style="color: #000096"> /&gt;</strong></pre></div></div></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="d0e12597"><!--anchor d0e12597--></a>9.4.1.10. Fields和properties</h4></div></div></div><p>Fields和properties是两个重要词汇。</p><div class="variablelist"><dl class="variablelist"><dt><span class="term">Fields</span></dt><dd><p>Fields是指HTML表单中的form
                                fields，例如一个文本框textbox、复选框checkbox、hidden字段等。</p><p>Fields也是表单验证的基本单元。</p></dd><dt><span class="term">Properties</span></dt><dd><p>Properties是指Java
                                    bean中的数据成员，例如：<code class="code">setName(String)</code>方法定义了一个property：<code class="code">name</code>。</p></dd></dl></div><p>而在表单验证服务中，</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p><code class="code">Group.setProperties(bean)</code>方法将fields中的值注入到bean的properties中。</p></li><li class="listitem"><p><code class="code">Group.mapTo(bean)</code>方法将bean
                                properties的值设置成fields的初始值。</p></li></ul></div><p>一般情况下，field的名称就是property的名称。然而有一些情况下，property名称和field名称会有出入。这时可以这样设置：</p><div class="example"><a id="d0e12638"><!--anchor d0e12638--></a><p class="title"><strong>例 9.31. 设置不同的property和field名称</strong></p><div class="example-contents"><pre class="programlisting">&lt;services:field name="homeAddress" propertyName="home.address" /&gt;</pre></div></div><p>其中，“<code class="code">homeAddress</code>”为field名称。如果不指定<code class="code">propertyName</code>的话，表单系统认为property名称也是“<code class="code">homeAddress</code>”。然而在这里，指定了property名称为“<code class="code">home.address</code>”
                    —— spring支持这种多级的property。在上面的配置中，</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>当做<code class="code">Group.setProperties()</code>时，会执行<code class="code">bean.getHome().setAddress(value)</code>；</p></li><li class="listitem"><p>而做<code class="code">Group.mapTo()</code>时，会执行<code class="code">bean.getHome().getAddress()</code>。
                            </p></li></ul></div></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="webx.form.validator.messages"><!--anchor webx.form.validator.messages--></a>9.4.1.11. Validator messages</h4></div></div></div><p>每一个validator都可以附带一段message文字，这段文字会在validator验证失败时显示给用户看。配置validator
                    message可以有下面两种写法：</p><div class="example"><a id="d0e12681"><!--anchor d0e12681--></a><p class="title"><strong>例 9.32. Validator message的两种写法</strong></p><div class="example-contents"><pre class="programlisting"><strong class="hl-tag" style="color: #000096">&lt;string-length-validator</strong> <span class="hl-attribute" style="color: #F5844C">minLength</span>=<span class="hl-value" style="color: #993300">"4"</span> <span class="hl-attribute" style="color: #F5844C">maxLength</span>=<span class="hl-value" style="color: #993300">"10"</span><strong class="hl-tag" style="color: #000096">&gt;</strong>
    <strong class="hl-tag" style="color: #000096">&lt;message&gt;</strong>登录名最少必须由4个字组成，最多不能超过10个字<strong class="hl-tag" style="color: #000096">&lt;/message&gt;</strong>
<strong class="hl-tag" style="color: #000096">&lt;/string-length-validator&gt;</strong></pre><p>或者，你可以这样写：</p><pre class="programlisting"><strong class="hl-tag" style="color: #000096">&lt;string-length-validator</strong> <span class="hl-attribute" style="color: #F5844C">minLength</span>=<span class="hl-value" style="color: #993300">"4"</span> <span class="hl-attribute" style="color: #F5844C">maxLength</span>=<span class="hl-value" style="color: #993300">"10"</span><strong class="hl-tag" style="color: #000096">&gt;</strong>
    <strong class="hl-tag" style="color: #000096">&lt;message&gt;</strong>${displayName} 最少必须由${minLength}个字组成，最多不能超过${maxLength}个字<strong class="hl-tag" style="color: #000096">&lt;/message&gt;</strong>
<strong class="hl-tag" style="color: #000096">&lt;/string-length-validator&gt;</strong></pre></div></div><p>第二种形式使用了替换变量，例如：<code class="code">${displayName}</code>等。这种方法有较多好处：</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>易复制 ——
                                    假如有多个fields中都包含<code class="code">string-length-validator</code>，由于每个fields的名称（<code class="code">displayName</code>）、validator的参数（<code class="code">minLength</code>、<code class="code">maxLength</code>）都不同，第一种形式是不可复制的，而第二种形式是通用的、可复制的。</p></li><li class="listitem"><p>易维护 ——
                                当validator的参数被修改时，例如<code class="code">minLength</code>被修改，对于第一种形式，你必须同时修改message字符串
                                —— 这很可能被忘记；而第二种形式就不需要修改message字符串。 </p></li></ul></div><p>事实上，validator message是一个JEXL表达式，其格式详见：<a class="link" href="http://commons.apache.org/jexl/reference/syntax.html" target="_top">http://commons.apache.org/jexl/reference/syntax.html</a>。
                    下面列出了在message中可用的变量和工具。</p><div class="table"><a id="d0e12721"><!--anchor d0e12721--></a><p class="title"><strong>表 9.8. Validator message中可用的变量和工具</strong></p><div class="table-contents"><table summary="Validator message中可用的变量和工具" cellpadding="10" style="border: none;"><colgroup><col width="28%" class="c1"/><col width="22%" class="c2"/><col width="50%" class="c3"/></colgroup><thead><tr><th style="border-right: 0.5pt solid #6666cc; border-bottom: 0.5pt solid #6666cc; ">分类</th><th style="border-bottom: 0.5pt solid #6666cc; " colspan="2">可用的变量和工具</th></tr></thead><tbody><tr><td style="border-right: 0.5pt solid #6666cc; border-bottom: 0.5pt solid #6666cc; ">当前Validator中的所有properties</td><td style="border-bottom: 0.5pt solid #6666cc; " colspan="2">
                                    <p>不同的validator有不同的properties。</p>
                                    <p>例如，对于<code class="code">&lt;string-length-validator minLength="4"
                                            maxLength="10"&gt;</code>，</p>
                                    <p>可取得的变量包括<code class="code">${minLength}</code>、<code class="code">${maxLength}</code></p>
                                </td></tr><tr><td style="border-right: 0.5pt solid #6666cc; border-bottom: 0.5pt solid #6666cc; " rowspan="6">当前Field对象中的所有properties</td><td style="border-right: 0.5pt solid #6666cc; border-bottom: 0.5pt solid #6666cc; "><code class="code">${displayName}</code></td><td style="border-bottom: 0.5pt solid #6666cc; ">Field显示名</td></tr><tr><td style="border-right: 0.5pt solid #6666cc; border-bottom: 0.5pt solid #6666cc; "><code class="code">${defaultValue}</code></td><td style="border-bottom: 0.5pt solid #6666cc; ">默认值（<code class="code">String</code>）</td></tr><tr><td style="border-right: 0.5pt solid #6666cc; border-bottom: 0.5pt solid #6666cc; "><code class="code">${defaultValues}</code></td><td style="border-bottom: 0.5pt solid #6666cc; ">默认值数组（<code class="code">String[]</code>）</td></tr><tr><td style="border-right: 0.5pt solid #6666cc; border-bottom: 0.5pt solid #6666cc; "><code class="code">${value}</code></td><td style="border-bottom: 0.5pt solid #6666cc; ">当前field的值（<code class="code">Object</code>）</td></tr><tr><td style="border-right: 0.5pt solid #6666cc; border-bottom: 0.5pt solid #6666cc; "><code class="code">${values}</code></td><td style="border-bottom: 0.5pt solid #6666cc; ">当前field的一组值（<code class="code">Object[]</code>）</td></tr><tr><td style="border-bottom: 0.5pt solid #6666cc; " colspan="2">特定类型的值，例如：<code class="code">${booleanValue}</code>、<code class="code">${intValue}</code>等。
                                </td></tr><tr><td style="border-right: 0.5pt solid #6666cc; border-bottom: 0.5pt solid #6666cc; ">当前Group中的其它Field对象</td><td style="border-bottom: 0.5pt solid #6666cc; " colspan="2">
                                    <p>例如：<code class="code">${userId}</code>，<code class="code">${password}</code>等。</p>
                                    <p>如果想取得其值，必须这样写：<code class="code">${userId.value}</code></p>
                                    <p>也可取得其它Field
                                            properties，例如：<code class="code">${userId.displayName}</code></p>
                                </td></tr><tr><td style="border-right: 0.5pt solid #6666cc; border-bottom: 0.5pt solid #6666cc; ">当前的Group对象</td><td style="border-bottom: 0.5pt solid #6666cc; " colspan="2"><code class="code">${group}</code></td></tr><tr><td style="border-right: 0.5pt solid #6666cc; border-bottom: 0.5pt solid #6666cc; ">当前的Form对象</td><td style="border-bottom: 0.5pt solid #6666cc; " colspan="2"><code class="code">${form}</code></td></tr><tr><td style="border-right: 0.5pt solid #6666cc; border-bottom: 0.5pt solid #6666cc; ">System properties</td><td style="border-bottom: 0.5pt solid #6666cc; " colspan="2">
                                    <p>所有从<code class="code">System.getProperties()</code>中取得的值，</p>
                                    <p>例如：<code class="code">${user.dir}</code>、<code class="code">${java.home}</code>等</p>
                                </td></tr><tr><td style="border-right: 0.5pt solid #6666cc; ">小工具</td><td style="" colspan="2">
                                    <p><code class="code">${utils}</code>，其中包含了很多静态方法。</p>
                                    <p>例如：<code class="code">${utils.repeat("a",
                                            10)}</code>将会生成10个“<code class="code">a</code>”。</p>
                                    <p>详见<code class="classname">com.alibaba.citrus.util.Utils</code>类的API文档。</p>
                                </td></tr></tbody></table></div></div></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="d0e12891"><!--anchor d0e12891--></a>9.4.2. Validators</h3></div></div></div><p>每个field都可以包含多个validators。Validators是用来验证当前field的正确性的。表单验证系统提供了很多常用的validators。然而，如果不够用，你还可以随时扩展出新的validators。</p><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="d0e12896"><!--anchor d0e12896--></a>9.4.2.1. 验证必选项：<code class="code">&lt;required-validator&gt;</code></h4></div></div></div><div class="example"><a id="d0e12901"><!--anchor d0e12901--></a><p class="title"><strong>例 9.33. 配置<code class="code">&lt;required-validator&gt;</code></strong></p><div class="example-contents"><pre class="programlisting"><strong class="hl-tag" style="color: #000096">&lt;services:field</strong> <span class="hl-attribute" style="color: #F5844C">name</span>=<span class="hl-value" style="color: #993300">"field1"</span> <span class="hl-attribute" style="color: #F5844C">displayName</span>=<span class="hl-value" style="color: #993300">"我的字段"</span><strong class="hl-tag" style="color: #000096">&gt;</strong>
    <strong class="hl-tag" style="color: #000096">&lt;required-validator&gt;</strong>
        <strong class="hl-tag" style="color: #000096">&lt;message&gt;</strong>必须填写${displayName}<strong class="hl-tag" style="color: #000096">&lt;/message&gt;</strong>
    <strong class="hl-tag" style="color: #000096">&lt;/required-validator&gt;</strong>
<strong class="hl-tag" style="color: #000096">&lt;/services:field&gt;</strong></pre></div></div><p>这是最常用的一个验证器。它的功能是确保用户填写了字段，即确保字段值非空。</p><p>需要注意的是，必选项验证器会受到<code class="code">trimming</code>参数的影响。假如<code class="code">trimming=true</code>（默认值），而用户输入了一组空白字符，那么仍然被认为“字段值为空”；反之，如果<code class="code">trimming=false</code>，当用户输入空白时，会被认为“字段值非空”。</p><p>除了必选项验证器以外，其它<span class="emphasis"><em>绝大多数的验证器并不会判断字段值是否为空</em></span>。例如：</p><div class="example"><a id="d0e12926"><!--anchor d0e12926--></a><p class="title"><strong>例 9.34. 绝大多数的验证器并不会判断字段值是否为空</strong></p><div class="example-contents"><pre class="programlisting"><strong class="hl-tag" style="color: #000096">&lt;services:field</strong> <span class="hl-attribute" style="color: #F5844C">name</span>=<span class="hl-value" style="color: #993300">"userId"</span> <span class="hl-attribute" style="color: #F5844C">displayName</span>=<span class="hl-value" style="color: #993300">"登录名"</span><strong class="hl-tag" style="color: #000096">&gt;</strong>
    <strong class="hl-tag" style="color: #000096">&lt;regexp-validator</strong> <span class="hl-attribute" style="color: #F5844C">pattern</span>=<span class="hl-value" style="color: #993300">"^[A-Za-z_][A-Za-z_0-9]*$"</span><strong class="hl-tag" style="color: #000096">&gt;</strong>
        <strong class="hl-tag" style="color: #000096">&lt;message&gt;</strong>${displayName} 必须由字母、数字、下划线构成<strong class="hl-tag" style="color: #000096">&lt;/message&gt;</strong>
    <strong class="hl-tag" style="color: #000096">&lt;/regexp-validator&gt;</strong>
<strong class="hl-tag" style="color: #000096">&lt;/services:field&gt;</strong></pre></div></div><p>在这个例子中，<span class="emphasis"><em>即便用户什么也没填，<code class="code">&lt;regexp-validator&gt;</code>也会通过验证</em></span>。换言之，<code class="code">&lt;regexp-validator&gt;</code>只负责当字段值非空时，检查其是否符合特写的格式。</p><p>因此通常需要将必选项验证器和其它验证器配合起来验证。如下例：</p><div class="example"><a id="d0e12944"><!--anchor d0e12944--></a><p class="title"><strong>例 9.35. 将必选项验证器和其它验证器配合起来验证</strong></p><div class="example-contents"><pre class="programlisting"><strong class="hl-tag" style="color: #000096">&lt;services:field</strong> <span class="hl-attribute" style="color: #F5844C">name</span>=<span class="hl-value" style="color: #993300">"userId"</span> <span class="hl-attribute" style="color: #F5844C">displayName</span>=<span class="hl-value" style="color: #993300">"登录名"</span><strong class="hl-tag" style="color: #000096">&gt;</strong>
    <strong class="hl-tag" style="color: #000096">&lt;required-validator&gt;</strong>
        <strong class="hl-tag" style="color: #000096">&lt;message&gt;</strong>必须填写 ${displayName}<strong class="hl-tag" style="color: #000096">&lt;/message&gt;</strong>
    <strong class="hl-tag" style="color: #000096">&lt;/required-validator&gt;</strong>
    <strong class="hl-tag" style="color: #000096">&lt;regexp-validator</strong> <span class="hl-attribute" style="color: #F5844C">pattern</span>=<span class="hl-value" style="color: #993300">"^[A-Za-z_][A-Za-z_0-9]*$"</span><strong class="hl-tag" style="color: #000096">&gt;</strong>
        <strong class="hl-tag" style="color: #000096">&lt;message&gt;</strong>${displayName} 必须由字母、数字、下划线构成<strong class="hl-tag" style="color: #000096">&lt;/message&gt;</strong>
    <strong class="hl-tag" style="color: #000096">&lt;/regexp-validator&gt;</strong>
<strong class="hl-tag" style="color: #000096">&lt;/services:field&gt;</strong></pre></div></div><p>这样配置以后，就可以确保：</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>字段值非空；</p></li><li class="listitem"><p>字段值符合特定格式。 </p></li></ul></div></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="d0e12958"><!--anchor d0e12958--></a>9.4.2.2. 验证字符串长度：<code class="code">&lt;string-length-validator&gt;</code></h4></div></div></div><div class="example"><a id="d0e12963"><!--anchor d0e12963--></a><p class="title"><strong>例 9.36. 配置<code class="code">&lt;string-length-validator&gt;</code></strong></p><div class="example-contents"><pre class="programlisting"><strong class="hl-tag" style="color: #000096">&lt;services:field</strong> <span class="hl-attribute" style="color: #F5844C">name</span>=<span class="hl-value" style="color: #993300">"field1"</span> <span class="hl-attribute" style="color: #F5844C">displayName</span>=<span class="hl-value" style="color: #993300">"我的字段"</span><strong class="hl-tag" style="color: #000096">&gt;</strong>
    <strong class="hl-tag" style="color: #000096">&lt;string-length-validator</strong> <span class="hl-attribute" style="color: #F5844C">minLength</span>=<span class="hl-value" style="color: #993300">"4"</span> <span class="hl-attribute" style="color: #F5844C">maxLength</span>=<span class="hl-value" style="color: #993300">"10"</span><strong class="hl-tag" style="color: #000096">&gt;</strong>
        <strong class="hl-tag" style="color: #000096">&lt;message&gt;</strong>${displayName} 最少必须由${minLength}个字组成，最多不能超过${maxLength}个字<strong class="hl-tag" style="color: #000096">&lt;/message&gt;</strong>
    <strong class="hl-tag" style="color: #000096">&lt;/string-length-validator&gt;</strong>
<strong class="hl-tag" style="color: #000096">&lt;/services:field&gt;</strong></pre></div></div><p>该验证器确保用户输入的字段值的字符数在确定的范围内。</p><p>可用的参数：</p><div class="table"><a id="d0e12974"><!--anchor d0e12974--></a><p class="title"><strong>表 9.9. <code class="code">&lt;string-length-validator&gt;</code>的可用参数： </strong></p><div class="table-contents"><table summary="&lt;string-length-validator&gt;的可用参数： " cellpadding="10" style="border: none;"><colgroup><col width="23%" class="c1"/><col width="77%" class="c2"/></colgroup><thead><tr><th style="border-right: 0.5pt solid #6666cc; border-bottom: 0.5pt solid #6666cc; ">参数名</th><th style="border-bottom: 0.5pt solid #6666cc; ">说明</th></tr></thead><tbody><tr><td style="border-right: 0.5pt solid #6666cc; border-bottom: 0.5pt solid #6666cc; "><code class="code">minLength</code></td><td style="border-bottom: 0.5pt solid #6666cc; ">代表最少字符数，如不设置<code class="code">minLength</code>代表最代表不设下限。</td></tr><tr><td style="border-right: 0.5pt solid #6666cc; "><code class="code">maxLength</code></td><td style="">代表最多字符数，如果不设置<code class="code">maxLength</code>则代表不设上限，允许任意多个字符。</td></tr></tbody></table></div></div></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="d0e13007"><!--anchor d0e13007--></a>9.4.2.3. 验证字符串字节长度：<code class="code">&lt;string-byte-length-validator&gt;</code></h4></div></div></div><div class="example"><a id="d0e13012"><!--anchor d0e13012--></a><p class="title"><strong>例 9.37. <code class="code">&lt;string-byte-length-validator&gt;</code>的配置</strong></p><div class="example-contents"><pre class="programlisting"><strong class="hl-tag" style="color: #000096">&lt;services:field</strong> <span class="hl-attribute" style="color: #F5844C">name</span>=<span class="hl-value" style="color: #993300">"field1"</span> <span class="hl-attribute" style="color: #F5844C">displayName</span>=<span class="hl-value" style="color: #993300">"我的字段"</span><strong class="hl-tag" style="color: #000096">&gt;</strong>
    <strong class="hl-tag" style="color: #000096">&lt;string-byte-length-validator</strong> <span class="hl-attribute" style="color: #F5844C">minLength</span>=<span class="hl-value" style="color: #993300">"4"</span> <span class="hl-attribute" style="color: #F5844C">maxLength</span>=<span class="hl-value" style="color: #993300">"10"</span> <span class="hl-attribute" style="color: #F5844C">charset</span>=<span class="hl-value" style="color: #993300">"UTF-8"</span><strong class="hl-tag" style="color: #000096">&gt;</strong>
        <strong class="hl-tag" style="color: #000096">&lt;message&gt;</strong>${displayName} 最少必须由${minLength}个字节组成，最多不能超过${maxLength}个字节<strong class="hl-tag" style="color: #000096">&lt;/message&gt;</strong>
    <strong class="hl-tag" style="color: #000096">&lt;/string-byte-length-validator&gt;</strong>
<strong class="hl-tag" style="color: #000096">&lt;/services:field&gt;</strong></pre></div></div><p>该验证器也是用来验证字符值的长度的。但是和前面所讲的<code class="code">&lt;string-length-validator&gt;</code>不同的是，<code class="code">&lt;string-byte-length-validator&gt;</code>会将字符串先转换成字节串，然后判断这个字节串的长度。</p><p>为什么需要判定字节的长度呢？因为在数据库中，常用字节长度而不是字符长度来表示一个字段的长度的。例如：<code class="code">varchar(20)</code>代表该数据库字段可接受的字节长度为20字节，超过部分将被截断。20字节可填入：</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>20个英文字母、数字，</p></li><li class="listitem"><p>或者6个UTF-8编码的汉字，</p></li><li class="listitem"><p>或者10个GBK编码的汉字。</p></li></ul></div><p>可见20字节所能容纳的字符数是不确定的，取决于字符的类型（中文、英文、数字等），以及字符集编码的类型（<code class="code">ISO-8859-1</code>、<code class="code">UTF-8</code>、<code class="code">GBK</code>等）。</p><p>可用的参数：</p><div class="table"><a id="d0e13055"><!--anchor d0e13055--></a><p class="title"><strong>表 9.10. <code class="code">&lt;string-byte-length-validator&gt;</code>的可用参数：</strong></p><div class="table-contents"><table summary="&lt;string-byte-length-validator&gt;的可用参数：" cellpadding="10" style="border: none;"><colgroup><col width="23%" class="c1"/><col width="77%" class="c2"/></colgroup><thead><tr><th style="border-right: 0.5pt solid #6666cc; border-bottom: 0.5pt solid #6666cc; ">参数名</th><th style="border-bottom: 0.5pt solid #6666cc; ">说明</th></tr></thead><tbody><tr><td style="border-right: 0.5pt solid #6666cc; border-bottom: 0.5pt solid #6666cc; "><code class="code">minLength</code></td><td style="border-bottom: 0.5pt solid #6666cc; ">代表最少字节数，如不设置<code class="code">minLength</code>代表最代表不设下限。</td></tr><tr><td style="border-right: 0.5pt solid #6666cc; border-bottom: 0.5pt solid #6666cc; "><code class="code">maxLength</code></td><td style="border-bottom: 0.5pt solid #6666cc; ">代表最多字节数，如果不设置<code class="code">maxLength</code>则代表不设上限，允许任意多个字符。</td></tr><tr><td style="border-right: 0.5pt solid #6666cc; "><code class="code">charset</code></td><td style="">用来将字符串转换成字节，如不设置，则取当前线程的上下文编码。</td></tr></tbody></table></div></div></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="d0e13094"><!--anchor d0e13094--></a>9.4.2.4. 比较字符串：<code class="code">&lt;string-compare-validator&gt;</code></h4></div></div></div><div class="example"><a id="d0e13099"><!--anchor d0e13099--></a><p class="title"><strong>例 9.38. <code class="code">&lt;string-compare-validator&gt;</code>的配置</strong></p><div class="example-contents"><pre class="programlisting"><strong class="hl-tag" style="color: #000096">&lt;services:field</strong> <span class="hl-attribute" style="color: #F5844C">name</span>=<span class="hl-value" style="color: #993300">"field1"</span> <span class="hl-attribute" style="color: #F5844C">displayName</span>=<span class="hl-value" style="color: #993300">"我的字段"</span><strong class="hl-tag" style="color: #000096">&gt;</strong>
    <strong class="hl-tag" style="color: #000096">&lt;string-compare-validator</strong> <span class="hl-attribute" style="color: #F5844C">notEqualTo</span>=<span class="hl-value" style="color: #993300">"field2"</span><strong class="hl-tag" style="color: #000096">&gt;</strong>
        <strong class="hl-tag" style="color: #000096">&lt;message&gt;</strong>${displayName} 不能与 ${field2.displayName} 相同<strong class="hl-tag" style="color: #000096">&lt;/message&gt;</strong>
    <strong class="hl-tag" style="color: #000096">&lt;/string-compare-validator&gt;</strong>
<strong class="hl-tag" style="color: #000096">&lt;/services:field&gt;</strong></pre></div></div><p>该验证器将当前字段的值和另一个字段比较。</p><p>可用的参数：</p><div class="table"><a id="d0e13110"><!--anchor d0e13110--></a><p class="title"><strong>表 9.11. <code class="code">&lt;string-compare-validator&gt;</code>的可用参数：</strong></p><div class="table-contents"><table summary="&lt;string-compare-validator&gt;的可用参数：" cellpadding="10" style="border: none;"><colgroup><col width="23%" class="c1"/><col width="77%" class="c2"/></colgroup><thead><tr><th style="border-right: 0.5pt solid #6666cc; border-bottom: 0.5pt solid #6666cc; ">参数名</th><th style="border-bottom: 0.5pt solid #6666cc; ">说明</th></tr></thead><tbody><tr><td style="border-right: 0.5pt solid #6666cc; border-bottom: 0.5pt solid #6666cc; "><code class="code">equalTo</code></td><td style="border-bottom: 0.5pt solid #6666cc; ">确保当前字段值和指定的另一字段的值相同。</td></tr><tr><td style="border-right: 0.5pt solid #6666cc; border-bottom: 0.5pt solid #6666cc; "><code class="code">notEqualTo</code></td><td style="border-bottom: 0.5pt solid #6666cc; ">确保当前字段值和指定的另一字段的值不相同。</td></tr><tr><td style="border-right: 0.5pt solid #6666cc; "><code class="code">ignoreCase</code></td><td style="">如果为<code class="code">true</code>，则比较时忽略大小写。默认为<code class="code">false</code>，即比较大小写。</td></tr></tbody></table></div></div></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="d0e13149"><!--anchor d0e13149--></a>9.4.2.5. 用正则表达式验证：<code class="code">&lt;regexp-validator&gt;</code></h4></div></div></div><div class="example"><a id="d0e13154"><!--anchor d0e13154--></a><p class="title"><strong>例 9.39. <code class="code">&lt;regexp-validator&gt;</code>的配置</strong></p><div class="example-contents"><pre class="programlisting"><strong class="hl-tag" style="color: #000096">&lt;services:field</strong> <span class="hl-attribute" style="color: #F5844C">name</span>=<span class="hl-value" style="color: #993300">"field1"</span> <span class="hl-attribute" style="color: #F5844C">displayName</span>=<span class="hl-value" style="color: #993300">"我的字段"</span><strong class="hl-tag" style="color: #000096">&gt;</strong>
    <strong class="hl-tag" style="color: #000096">&lt;regexp-validator</strong> <span class="hl-attribute" style="color: #F5844C">pattern</span>=<span class="hl-value" style="color: #993300">"^[A-Za-z_][A-Za-z_0-9]*$"</span><strong class="hl-tag" style="color: #000096">&gt;</strong>
        <strong class="hl-tag" style="color: #000096">&lt;message&gt;</strong>${displayName} 必须由字母、数字、下划线构成<strong class="hl-tag" style="color: #000096">&lt;/message&gt;</strong>
    <strong class="hl-tag" style="color: #000096">&lt;/regexp-validator&gt;</strong>
<strong class="hl-tag" style="color: #000096">&lt;/services:field&gt;</strong></pre></div></div><p>该验证器用正则表达式来验证字符串的格式。</p><p>可用的参数：</p><div class="table"><a id="d0e13165"><!--anchor d0e13165--></a><p class="title"><strong>表 9.12. <code class="code">&lt;regexp-validator&gt;</code>的可用参数：</strong></p><div class="table-contents"><table summary="&lt;regexp-validator&gt;的可用参数：" cellpadding="10" style="border: none;"><colgroup><col width="23%" class="c1"/><col width="77%" class="c2"/></colgroup><thead><tr><th style="border-right: 0.5pt solid #6666cc; border-bottom: 0.5pt solid #6666cc; ">参数名</th><th style="border-bottom: 0.5pt solid #6666cc; ">说明</th></tr></thead><tbody><tr><td style="border-right: 0.5pt solid #6666cc; "><code class="code">pattern</code></td><td style="">
                                    <p>用来匹配字符串的正则表达式。需要注意的是：</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>表达式为部分匹配，例如：表达式“<code class="code">abc</code>”可以匹配用户输入“<code class="code">xabcy</code>”。如果期望匹配完整字符串，必须使用“<code class="code">^</code>”和“<code class="code">$</code>”标识符。例如表达式“<code class="code">^abc$</code>”只能匹配“<code class="code">abc</code>”而不能匹配“<code class="code">xabcy</code>”。</p></li><li class="listitem"><p>表达式支持否定匹配，例如：表达式“<code class="code">!abc</code>”可以匹配所有不包含“<code class="code">abc</code>”的字符串。</p></li></ul></div>
                                </td></tr></tbody></table></div></div></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="d0e13223"><!--anchor d0e13223--></a>9.4.2.6. 验证电子邮件地址：<code class="code">&lt;mail-address-validator&gt;</code></h4></div></div></div><div class="example"><a id="d0e13228"><!--anchor d0e13228--></a><p class="title"><strong>例 9.40. <code class="code">&lt;mail-address-validator&gt;</code>的配置</strong></p><div class="example-contents"><pre class="programlisting"><strong class="hl-tag" style="color: #000096">&lt;services:field</strong> <span class="hl-attribute" style="color: #F5844C">name</span>=<span class="hl-value" style="color: #993300">"field1"</span> <span class="hl-attribute" style="color: #F5844C">displayName</span>=<span class="hl-value" style="color: #993300">"我的字段"</span><strong class="hl-tag" style="color: #000096">&gt;</strong>
    <strong class="hl-tag" style="color: #000096">&lt;mail-address-validator&gt;</strong>
        <strong class="hl-tag" style="color: #000096">&lt;message&gt;</strong>${displayName} 必须是合法电子邮件地址<strong class="hl-tag" style="color: #000096">&lt;/message&gt;</strong>
    <strong class="hl-tag" style="color: #000096">&lt;/mail-address-validator&gt;</strong>
<strong class="hl-tag" style="color: #000096">&lt;/services:field&gt;</strong></pre></div></div><p>该验证器用来确保用户输入了合法的电子邮件地址。</p><p>事实上，该验证器使用了一个比较宽松的正则表达式来验证电子邮件地址：“<code class="code">^\S+@[^\.]\S*$</code>”。假如你觉得这个正则表达式不足以验证你所需要的邮件地址，你可以利用<code class="code">&lt;regexp-validator&gt;</code>和自定义的正则表达式来直接验证。</p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="d0e13245"><!--anchor d0e13245--></a>9.4.2.7. 验证数字：<code class="code">&lt;number-validator&gt;</code></h4></div></div></div><div class="example"><a id="d0e13250"><!--anchor d0e13250--></a><p class="title"><strong>例 9.41. <code class="code">&lt;number-validator&gt;</code>的配置</strong></p><div class="example-contents"><pre class="programlisting"><strong class="hl-tag" style="color: #000096">&lt;services:field</strong> <span class="hl-attribute" style="color: #F5844C">name</span>=<span class="hl-value" style="color: #993300">"field1"</span> <span class="hl-attribute" style="color: #F5844C">displayName</span>=<span class="hl-value" style="color: #993300">"我的字段1"</span><strong class="hl-tag" style="color: #000096">&gt;</strong>
    <strong class="hl-tag" style="color: #000096">&lt;number-validator&gt;</strong>
        <strong class="hl-tag" style="color: #000096">&lt;message&gt;</strong>${displayName} 必须是数字<strong class="hl-tag" style="color: #000096">&lt;/message&gt;</strong>
    <strong class="hl-tag" style="color: #000096">&lt;/number-validator&gt;</strong>
<strong class="hl-tag" style="color: #000096">&lt;/services:field&gt;</strong>
<strong class="hl-tag" style="color: #000096">&lt;services:field</strong> <span class="hl-attribute" style="color: #F5844C">name</span>=<span class="hl-value" style="color: #993300">"field2"</span> <span class="hl-attribute" style="color: #F5844C">displayName</span>=<span class="hl-value" style="color: #993300">"我的字段2"</span><strong class="hl-tag" style="color: #000096">&gt;</strong>
    <strong class="hl-tag" style="color: #000096">&lt;number-validator</strong> <span class="hl-attribute" style="color: #F5844C">numberType</span>=<span class="hl-value" style="color: #993300">"int"</span> <span class="hl-attribute" style="color: #F5844C">lessThan</span>=<span class="hl-value" style="color: #993300">"100"</span><strong class="hl-tag" style="color: #000096">&gt;</strong>
        <strong class="hl-tag" style="color: #000096">&lt;message&gt;</strong>${displayName} 必须是小于${lessThan}的整数<strong class="hl-tag" style="color: #000096">&lt;/message&gt;</strong>
    <strong class="hl-tag" style="color: #000096">&lt;/number-validator&gt;</strong>
<strong class="hl-tag" style="color: #000096">&lt;/services:field&gt;</strong></pre></div></div><p>该验证器用来确保用户输入了合法的数字。数字的合法性包括：格式的合法和范围的合法。</p><p>可用的参数： </p><div class="table"><a id="d0e13261"><!--anchor d0e13261--></a><p class="title"><strong>表 9.13. <code class="code">&lt;number-validator&gt;</code>的可用参数：</strong></p><div class="table-contents"><table summary="&lt;number-validator&gt;的可用参数：" cellpadding="10" style="border: none;"><colgroup><col width="23%" class="c1"/><col width="77%" class="c2"/></colgroup><thead><tr><th style="border-right: 0.5pt solid #6666cc; border-bottom: 0.5pt solid #6666cc; ">参数名</th><th style="border-bottom: 0.5pt solid #6666cc; ">说明</th></tr></thead><tbody><tr><td style="border-right: 0.5pt solid #6666cc; border-bottom: 0.5pt solid #6666cc; "><code class="code">numberType</code></td><td style="border-bottom: 0.5pt solid #6666cc; ">数字的类型。可用的类型为：<code class="code">int</code>、<code class="code">long</code>、<code class="code">float</code>、<code class="code">double</code>、<code class="code">bigDecimal</code>。如不设置，默认值为<code class="code">int</code>。</td></tr><tr><td style="border-right: 0.5pt solid #6666cc; border-bottom: 0.5pt solid #6666cc; "><code class="code">equalTo</code></td><td style="border-bottom: 0.5pt solid #6666cc; ">可选数字范围：要求数字<span class="emphasis"><em>等于</em></span>指定值。</td></tr><tr><td style="border-right: 0.5pt solid #6666cc; border-bottom: 0.5pt solid #6666cc; "><code class="code">notEqualTo</code></td><td style="border-bottom: 0.5pt solid #6666cc; ">可选数字范围：要求数字<span class="emphasis"><em>不等于</em></span>指定值。</td></tr><tr><td style="border-right: 0.5pt solid #6666cc; border-bottom: 0.5pt solid #6666cc; "><code class="code">lessThan</code></td><td style="border-bottom: 0.5pt solid #6666cc; ">可选数字范围：要求数字<span class="emphasis"><em>小于</em></span>指定值。</td></tr><tr><td style="border-right: 0.5pt solid #6666cc; border-bottom: 0.5pt solid #6666cc; "><code class="code">lessThanOrEqualTo</code></td><td style="border-bottom: 0.5pt solid #6666cc; ">可选数字范围：要求数字<span class="emphasis"><em>小于或等于</em></span>指定值。</td></tr><tr><td style="border-right: 0.5pt solid #6666cc; border-bottom: 0.5pt solid #6666cc; "><code class="code">greaterThan</code></td><td style="border-bottom: 0.5pt solid #6666cc; ">可选数字范围：要求数字<span class="emphasis"><em>大于</em></span>指定值。</td></tr><tr><td style="border-right: 0.5pt solid #6666cc; "><code class="code">greaterThanOrEqualTo</code></td><td style="">可选数字范围：要求数字<span class="emphasis"><em>大于或等于</em></span>指定值。</td></tr></tbody></table></div></div></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="d0e13354"><!--anchor d0e13354--></a>9.4.2.8. 比较数字：<code class="code">&lt;number-compare-validator&gt;</code></h4></div></div></div><div class="example"><a id="d0e13359"><!--anchor d0e13359--></a><p class="title"><strong>例 9.42. <code class="code">&lt;number-compare-validator&gt;</code>的配置</strong></p><div class="example-contents"><pre class="programlisting"><strong class="hl-tag" style="color: #000096">&lt;services:field</strong> <span class="hl-attribute" style="color: #F5844C">name</span>=<span class="hl-value" style="color: #993300">"field1"</span> <span class="hl-attribute" style="color: #F5844C">displayName</span>=<span class="hl-value" style="color: #993300">"我的字段"</span><strong class="hl-tag" style="color: #000096">&gt;</strong>
    <strong class="hl-tag" style="color: #000096">&lt;number-compare-validator</strong> <span class="hl-attribute" style="color: #F5844C">greaterThanOrEqualTo</span>=<span class="hl-value" style="color: #993300">"field2"</span> <span class="hl-attribute" style="color: #F5844C">lessThan</span>=<span class="hl-value" style="color: #993300">"field3"</span><strong class="hl-tag" style="color: #000096">&gt;</strong>
        <strong class="hl-tag" style="color: #000096">&lt;message&gt;</strong>${displayName} 必须是位于 ${field2.displayName} 和 ${field3.displayName}之间的数字<strong class="hl-tag" style="color: #000096">&lt;/message&gt;</strong>
    <strong class="hl-tag" style="color: #000096">&lt;/number-compare-validator&gt;</strong>
<strong class="hl-tag" style="color: #000096">&lt;/services:field&gt;</strong></pre></div></div><p>该验证器将当前字段的值和另一个字段比较。</p><p>可用的参数： </p><div class="table"><a id="d0e13370"><!--anchor d0e13370--></a><p class="title"><strong>表 9.14. <code class="code">&lt;number-compare-validator&gt;</code>的可用参数：</strong></p><div class="table-contents"><table summary="&lt;number-compare-validator&gt;的可用参数：" cellpadding="10" style="border: none;"><colgroup><col width="23%" class="c1"/><col width="77%" class="c2"/></colgroup><thead><tr><th style="border-right: 0.5pt solid #6666cc; border-bottom: 0.5pt solid #6666cc; ">参数名</th><th style="border-bottom: 0.5pt solid #6666cc; ">说明</th></tr></thead><tbody><tr><td style="border-right: 0.5pt solid #6666cc; border-bottom: 0.5pt solid #6666cc; "><code class="code">numberType</code></td><td style="border-bottom: 0.5pt solid #6666cc; ">数字的类型。可用的类型为：<code class="code">int</code>、<code class="code">long</code>、<code class="code">float</code>、<code class="code">double</code>、<code class="code">bigDecimal</code>。如不设置，默认值为<code class="code">int</code>。</td></tr><tr><td style="border-right: 0.5pt solid #6666cc; border-bottom: 0.5pt solid #6666cc; "><code class="code">equalTo</code></td><td style="border-bottom: 0.5pt solid #6666cc; ">可选数字范围：要求数字<span class="emphasis"><em>等于</em></span>指定字段的值。</td></tr><tr><td style="border-right: 0.5pt solid #6666cc; border-bottom: 0.5pt solid #6666cc; "><code class="code">notEqualTo</code></td><td style="border-bottom: 0.5pt solid #6666cc; ">可选数字范围：要求数字<span class="emphasis"><em>不等于</em></span>指定字段的值。</td></tr><tr><td style="border-right: 0.5pt solid #6666cc; border-bottom: 0.5pt solid #6666cc; "><code class="code">lessThan</code></td><td style="border-bottom: 0.5pt solid #6666cc; ">可选数字范围：要求数字<span class="emphasis"><em>小于</em></span>指定字段的值。</td></tr><tr><td style="border-right: 0.5pt solid #6666cc; border-bottom: 0.5pt solid #6666cc; "><code class="code">lessThanOrEqualTo</code></td><td style="border-bottom: 0.5pt solid #6666cc; ">可选数字范围：要求数字<span class="emphasis"><em>小于或等于</em></span>指定字段的值。</td></tr><tr><td style="border-right: 0.5pt solid #6666cc; border-bottom: 0.5pt solid #6666cc; "><code class="code">greaterThan</code></td><td style="border-bottom: 0.5pt solid #6666cc; ">可选数字范围：要求数字<span class="emphasis"><em>大于</em></span>指定字段的值。</td></tr><tr><td style="border-right: 0.5pt solid #6666cc; "><code class="code">greaterThanOrEqualTo</code></td><td style="">可选数字范围：要求数字<span class="emphasis"><em>大于或等于</em></span>指定字段的值。</td></tr></tbody></table></div></div></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="d0e13463"><!--anchor d0e13463--></a>9.4.2.9. 验证日期：<code class="code">&lt;date-validator&gt;</code></h4></div></div></div><div class="example"><a id="d0e13468"><!--anchor d0e13468--></a><p class="title"><strong>例 9.43. <code class="code">&lt;date-validator&gt;</code>的配置</strong></p><div class="example-contents"><pre class="programlisting"><strong class="hl-tag" style="color: #000096">&lt;services:field</strong> <span class="hl-attribute" style="color: #F5844C">name</span>=<span class="hl-value" style="color: #993300">"field1"</span> <span class="hl-attribute" style="color: #F5844C">displayName</span>=<span class="hl-value" style="color: #993300">"我的字段"</span><strong class="hl-tag" style="color: #000096">&gt;</strong>
    <strong class="hl-tag" style="color: #000096">&lt;date-validator</strong> <span class="hl-attribute" style="color: #F5844C">format</span>=<span class="hl-value" style="color: #993300">"yyyy-MM-dd"</span><strong class="hl-tag" style="color: #000096">&gt;</strong>
        <strong class="hl-tag" style="color: #000096">&lt;message&gt;</strong>${displayName} 必须是日期，格式为 ${format}<strong class="hl-tag" style="color: #000096">&lt;/message&gt;</strong>
    <strong class="hl-tag" style="color: #000096">&lt;/date-validator&gt;</strong>
<strong class="hl-tag" style="color: #000096">&lt;/services:field&gt;</strong></pre></div></div><p>该验证器用来确保用户输入正确的日期格式，也可以限定日期的范围。</p><p>可用的参数： </p><div class="table"><a id="d0e13479"><!--anchor d0e13479--></a><p class="title"><strong>表 9.15. <code class="code">&lt;date-validator&gt;</code>的可用参数：</strong></p><div class="table-contents"><table summary="&lt;date-validator&gt;的可用参数：" cellpadding="10" style="border: none;"><colgroup><col width="23%" class="c1"/><col width="77%" class="c2"/></colgroup><thead><tr><th style="border-right: 0.5pt solid #6666cc; border-bottom: 0.5pt solid #6666cc; ">参数名</th><th style="border-bottom: 0.5pt solid #6666cc; ">说明</th></tr></thead><tbody><tr><td style="border-right: 0.5pt solid #6666cc; border-bottom: 0.5pt solid #6666cc; "><code class="code">format</code></td><td style="border-bottom: 0.5pt solid #6666cc; ">日期的格式，如不指定，默认为<code class="code">yyyy-MM-dd</code>。</td></tr><tr><td style="border-right: 0.5pt solid #6666cc; border-bottom: 0.5pt solid #6666cc; "><code class="code">minDate</code></td><td style="border-bottom: 0.5pt solid #6666cc; ">可选的日期范围：最早的日期。该日期格式也是用<code class="code">format</code>参数来表示的。</td></tr><tr><td style="border-right: 0.5pt solid #6666cc; "><code class="code">maxDate</code></td><td style="">可选的日期范围：最晚的日期。该日期格式也是用<code class="code">format</code>参数来表示的。</td></tr></tbody></table></div></div></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="d0e13521"><!--anchor d0e13521--></a>9.4.2.10. 验证上传文件：<code class="code">&lt;uploaded-file-validator&gt;</code></h4></div></div></div><div class="example"><a id="d0e13526"><!--anchor d0e13526--></a><p class="title"><strong>例 9.44. <code class="code">&lt;uploaded-file-validator&gt;</code>的配置</strong></p><div class="example-contents"><pre class="programlisting"><strong class="hl-tag" style="color: #000096">&lt;services:field</strong> <span class="hl-attribute" style="color: #F5844C">name</span>=<span class="hl-value" style="color: #993300">"picture"</span> <span class="hl-attribute" style="color: #F5844C">displayName</span>=<span class="hl-value" style="color: #993300">"产品图片"</span><strong class="hl-tag" style="color: #000096">&gt;</strong>
    <strong class="hl-tag" style="color: #000096">&lt;uploaded-file-validator</strong> <span class="hl-attribute" style="color: #F5844C">extension</span>=<span class="hl-value" style="color: #993300">"jpg, gif, png"</span><strong class="hl-tag" style="color: #000096">&gt;</strong>
        <strong class="hl-tag" style="color: #000096">&lt;message&gt;</strong>${displayName}不是合法的图片文件<strong class="hl-tag" style="color: #000096">&lt;/message&gt;</strong>
    <strong class="hl-tag" style="color: #000096">&lt;/uploaded-file-validator&gt;</strong>
    <strong class="hl-tag" style="color: #000096">&lt;uploaded-file-validator</strong> <span class="hl-attribute" style="color: #F5844C">maxSize</span>=<span class="hl-value" style="color: #993300">"100K"</span><strong class="hl-tag" style="color: #000096">&gt;</strong>
        <strong class="hl-tag" style="color: #000096">&lt;message&gt;</strong>${displayName}不能超过${maxSize}字节<strong class="hl-tag" style="color: #000096">&lt;/message&gt;</strong>
    <strong class="hl-tag" style="color: #000096">&lt;/uploaded-file-validator&gt;</strong>
<strong class="hl-tag" style="color: #000096">&lt;/services:field&gt;</strong></pre></div></div><p>该验证器用来验证用户上传文件的大小、类型等信息。</p><p>可用的参数： </p><div class="table"><a id="d0e13537"><!--anchor d0e13537--></a><p class="title"><strong>表 9.16. <code class="code">&lt;date-validator&gt;</code>的可用参数：</strong></p><div class="table-contents"><table summary="&lt;date-validator&gt;的可用参数：" cellpadding="10" style="border: none;"><colgroup><col width="23%" class="c1"/><col width="77%" class="c2"/></colgroup><thead><tr><th style="border-right: 0.5pt solid #6666cc; border-bottom: 0.5pt solid #6666cc; ">参数名</th><th style="border-bottom: 0.5pt solid #6666cc; ">说明</th></tr></thead><tbody><tr><td style="border-right: 0.5pt solid #6666cc; border-bottom: 0.5pt solid #6666cc; "><code class="code">minSize</code></td><td style="border-bottom: 0.5pt solid #6666cc; ">最小文件尺寸。可使用K/M等单位，例如：<code class="code">10K</code>、<code class="code">1M</code>等。</td></tr><tr><td style="border-right: 0.5pt solid #6666cc; border-bottom: 0.5pt solid #6666cc; "><code class="code">maxSize</code></td><td style="border-bottom: 0.5pt solid #6666cc; ">最大文件尺寸。可使用K/M等单位，例如：<code class="code">10K</code>、<code class="code">1M</code>等。</td></tr><tr><td style="border-right: 0.5pt solid #6666cc; border-bottom: 0.5pt solid #6666cc; "><code class="code">extension</code></td><td style="border-bottom: 0.5pt solid #6666cc; ">
                                    <p>允许的文件名后缀，多个后缀以逗号分隔。例如：<code class="code">gif</code>、<code class="code">jpg</code>、<code class="code">png</code>。</p>
                                    <p>注意，文件名是由浏览器传递给服务器的，因此<span class="emphasis"><em>验证器并不能保证保证文件确实是文件名后缀声明的格式</em></span>。</p>
                                    <p>例如，<code class="code">xxx.jpg</code>有可能是一个<code class="code">exe</code>可执行文件。
                                    </p>
                                </td></tr><tr><td style="border-right: 0.5pt solid #6666cc; "><code class="code">contentType</code></td><td style="">
                                    <p>允许的文件类型，多个类型以逗号分隔。</p>
                                    <p>例如：<code class="code">image/gif</code>, <code class="code">image/jpeg</code>,
                                            <code class="code">image/pjpeg</code>, <code class="code">image/jpg</code>,
                                            <code class="code">image/png</code>。</p>
                                    <p>注意，<code class="code">contentType</code>是由浏览器传递给服务器的，因此<span class="emphasis"><em>验证器并不能保证文件确实是浏览器所声明的格式</em></span>。</p>
                                    <p>其次，有些浏览器不会传送<code class="code">contentType</code>。因此<span class="emphasis"><em>推荐使用<code class="code">extension</code>文件名后缀验证</em></span>，来取代<code class="code">contentType</code>验证。
                                    </p>
                                </td></tr></tbody></table></div></div><p>注意：（请补充阅读<a class="xref" href="requestcontexts.html" title="第 7 章 Request Contexts功能指南">第 7 章 <em>Request Contexts功能指南</em></a>）</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>上传文件验证只能检查浏览器所声称的文件名后缀和类型，并不能保证文件名后缀和类型属实。如果你希望进一步检查文件的内容，可以结合<code class="code">request-contexts/parser/filter</code>的功能。</p></li><li class="listitem"><p>假如设置了<code class="code">request-contexts/parser/uploaded-file-whitelist</code>，那么不符合要求的文件会在进入表单验证之前被删除。因此上传文件验证器的<code class="code">extension</code>参数必须存在于<code class="code">uploaded-file-whitelist.extensions</code>列表当中。</p></li><li class="listitem"><p>Upload服务可限制请求的总尺寸，大于该尺寸的请求会被全部忽略，以保证服务器的安全性 ——
                                这意味着对于这类超大请求，你根本读不到这个请求中的所有参数，当然也不可能执行到表单验证的阶段。</p></li><li class="listitem"><p>Upload服务可以限制每个上传文件的尺寸，大于指定尺寸的文件会被删除。但只要请求的总尺寸还是在许可范围内，那么除了被删文件以外，其它的参数和文件还是可以被取得的。因此，上传文件验证器的maxSize必须小于upload服务中设置的单个文件的最大尺寸才有意义。
                            </p></li></ul></div></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="d0e13689"><!--anchor d0e13689--></a>9.4.2.11. 验证CSRF token</h4></div></div></div><p>CSRF是跨站请求伪造（Cross-site request
                    forgery）的意思，它是一种常见的WEB网站攻击方法。攻击者通过各种方法伪造一个请求，模仿用户提交表单的行为，从而达到修改用户的数据，或者执行特定任务的目的。为了假冒用户的身份，CSRF攻击常常和XSS攻击配合起来做，但也可以通过其它手段，例如诱使用户点击一个包含攻击的链接。</p><p>通过CSRF token，可以确保该请求确实是用户本人填写表单并提交的，而不是第三者伪造的，从而避免CSRF攻击。CSRF
                    token验证器是用来确保表单中包含了CSRF token。</p><p>CSRF token的验证是每个表单都需要的安全功能，所以通常可利用group的继承功能来定义CSRF token验证器。</p><div class="example"><a id="d0e13698"><!--anchor d0e13698--></a><p class="title"><strong>例 9.45. <code class="code">&lt;csrf-validator&gt;</code>的配置</strong></p><div class="example-contents"><pre class="programlisting"><strong class="hl-tag" style="color: #000096">&lt;services:group</strong> <span class="hl-attribute" style="color: #F5844C">name</span>=<span class="hl-value" style="color: #993300">"csrfTokenCheckGroup"</span><strong class="hl-tag" style="color: #000096">&gt;</strong>
    <strong class="hl-tag" style="color: #000096">&lt;services:field</strong> <span class="hl-attribute" style="color: #F5844C">name</span>=<span class="hl-value" style="color: #993300">"csrfToken"</span><strong class="hl-tag" style="color: #000096">&gt;</strong>
        <strong class="hl-tag" style="color: #000096">&lt;csrf-validator&gt;</strong>
            <strong class="hl-tag" style="color: #000096">&lt;message&gt;</strong>您提交的表单已过期<strong class="hl-tag" style="color: #000096">&lt;/message&gt;</strong>
        <strong class="hl-tag" style="color: #000096">&lt;/csrf-validator&gt;</strong>
    <strong class="hl-tag" style="color: #000096">&lt;/services:field&gt;</strong>
<strong class="hl-tag" style="color: #000096">&lt;/services:group&gt;</strong>

<strong class="hl-tag" style="color: #000096">&lt;services:group</strong> <span class="hl-attribute" style="color: #F5844C">name</span>=<span class="hl-value" style="color: #993300">"group1"</span> <span class="hl-attribute" style="color: #F5844C">extends</span>=<span class="hl-value" style="color: #993300">"csrfTokenCheckGroup"</span><strong class="hl-tag" style="color: #000096">&gt;</strong>
    ...
<strong class="hl-tag" style="color: #000096">&lt;/services:group&gt;</strong></pre></div></div><p>除了表单验证以外，实现CSRF验证还需要其它几个步骤：</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>定义pull tool。</p><div class="example"><a id="d0e13711"><!--anchor d0e13711--></a><p class="title"><strong>例 9.46. 定义CSRF pull tool</strong></p><div class="example-contents"><pre class="programlisting"><strong class="hl-tag" style="color: #000096">&lt;services:pull</strong> <span class="hl-attribute" style="color: #F5844C">xmlns</span>=<span class="hl-value" style="color: #993300">"http://www.alibaba.com/schema/services/pull/factories"</span><strong class="hl-tag" style="color: #000096">&gt;</strong>
    ...
    <strong class="hl-tag" style="color: #000096">&lt;csrfToken /&gt;</strong> <a id="co.form.csrf.tokentool"><!--anchor co.form.csrf.tokentool--></a><span class="calloutno"><img src="images/callouts/1.png" border="0"/></span>
    ...
<strong class="hl-tag" style="color: #000096">&lt;/services:pull&gt;</strong></pre><div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#co.form.csrf.tokentool"><span class="calloutno"><img src="images/callouts/1.png" border="0"/></span></a> </p></td><td valign="top" align="left"><p>定义了pull tool以后，可以在模板中以<code class="code">$csrfToken</code>来引用它。</p></td></tr></table></div></div></div></li><li class="listitem"><p>在每一个表单中创建一个保存着CSRF token的hidden字段。</p><div class="example"><a id="d0e13728"><!--anchor d0e13728--></a><p class="title"><strong>例 9.47. 在模板中插入包含CSRF token的hidden字段</strong></p><div class="example-contents"><pre class="programlisting"><strong class="hl-tag" style="color: #000096">&lt;form</strong> <span class="hl-attribute" style="color: #F5844C">action</span>=<span class="hl-value" style="color: #993300">""</span> <span class="hl-attribute" style="color: #F5844C">method</span>=<span class="hl-value" style="color: #993300">"post"</span><strong class="hl-tag" style="color: #000096">&gt;</strong>
  $csrfToken.hiddenField <a id="co.form.csrf.hiddenfield"><!--anchor co.form.csrf.hiddenfield--></a><span class="calloutno"><img src="images/callouts/1.png" border="0"/></span>
  <strong class="hl-tag" style="color: #000096">&lt;input</strong> <span class="hl-attribute" style="color: #F5844C">type</span>=<span class="hl-value" style="color: #993300">"hidden"</span> <span class="hl-attribute" style="color: #F5844C">name</span>=<span class="hl-value" style="color: #993300">"action"</span> <span class="hl-attribute" style="color: #F5844C">value</span>=<span class="hl-value" style="color: #993300">"LoginAction"</span><strong class="hl-tag" style="color: #000096">/&gt;</strong>
  ...
<strong class="hl-tag" style="color: #000096">&lt;/form&gt;</strong></pre><div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#co.form.csrf.hiddenfield"><span class="calloutno"><img src="images/callouts/1.png" border="0"/></span></a> </p></td><td valign="top" align="left"><p>调用<code class="code">$csrfToken.hiddenField</code>以后将创建一个包含CSRF long
                                        live
                                            token的hidden字段，等同于调用<code class="code">$csrfToken.longLiveHiddenField</code>。</p><p>有两种CSRF token，你也可以用下面两种方法来创建它们：</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem"><p>创建unique
                                                  token：<code class="code">$csrfToken.uniqueHiddenField</code>。这种类型的token不仅能防止CSRF攻击，还能防止重复提交表单。</p></li><li class="listitem"><p>创建long live
                                                  token：<code class="code">$csrfToken.longLiveHiddenField</code>。这种类型的token只能防止CSRF攻击，不能防止重复提交表单。</p></li></ul></div></td></tr></table></div></div></div></li><li class="listitem"><p>在pipeline中验证token。</p><div class="example"><a id="d0e13763"><!--anchor d0e13763--></a><p class="title"><strong>例 9.48. </strong></p><div class="example-contents"><pre class="programlisting"><strong class="hl-tag" style="color: #000096">&lt;services:pipeline</strong> <span class="hl-attribute" style="color: #F5844C">xmlns</span>=<span class="hl-value" style="color: #993300">"http://www.alibaba.com/schema/services/pipeline/valves"</span><strong class="hl-tag" style="color: #000096">&gt;</strong>
    ...
    <strong class="hl-tag" style="color: #000096">&lt;checkCsrfToken /&gt;</strong> <a id="co.form.csrf.valve"><!--anchor co.form.csrf.valve--></a><span class="calloutno"><img src="images/callouts/1.png" border="0"/></span>
    ...
<strong class="hl-tag" style="color: #000096">&lt;/services:pipeline&gt;</strong></pre><div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#co.form.csrf.valve"><span class="calloutno"><img src="images/callouts/1.png" border="0"/></span></a> </p></td><td valign="top" align="left"><p>此处可以指定一个<code class="code">tokenKey</code>参数。如果不指定，将使用默认的token
                                            key：<code class="code">_csrf_token</code>。</p></td></tr></table></div></div></div></li><li class="listitem"><p>在表单验证中指定<code class="code">postOnly=true</code>（默认值），有助于提高CSRF攻击的难度。</p><div class="example"><a id="d0e13785"><!--anchor d0e13785--></a><p class="title"><strong>例 9.49. 配置Post Only参数</strong></p><div class="example-contents"><pre class="programlisting"><strong class="hl-tag" style="color: #000096">&lt;services:form</strong> <span class="hl-attribute" style="color: #F5844C">postOnlyByDefault</span>=<span class="hl-value" style="color: #993300">"true"</span><strong class="hl-tag" style="color: #000096">&gt;</strong>
<strong class="hl-tag" style="color: #000096">&lt;/services:form&gt;</strong></pre></div></div></li></ul></div></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="d0e13790"><!--anchor d0e13790--></a>9.4.2.12. Custom Error – 由action来验证数据</h4></div></div></div><p>有一些情况下，由validator来验证数据并不方便。例如，当我们注册帐户时，即便用户名的格式完全正确（由字母和数字构成，并在指定的字数范围之内），也有可能注册不成功的。原因是当前用户名已经被其它用户注册使用了。而判断用户名是否可用，最简单的办法是在action中通过访问数据库来确定。</p><p>Custom Error“验证器”就是用来满足这个需求。</p><div class="example"><a id="d0e13797"><!--anchor d0e13797--></a><p class="title"><strong>例 9.50. &lt;custom-error&gt;的配置</strong></p><div class="example-contents"><pre class="programlisting"><strong class="hl-tag" style="color: #000096">&lt;services:group</strong> <span class="hl-attribute" style="color: #F5844C">name</span>=<span class="hl-value" style="color: #993300">"register"</span><strong class="hl-tag" style="color: #000096">&gt;</strong>
    <strong class="hl-tag" style="color: #000096">&lt;services:field</strong> <span class="hl-attribute" style="color: #F5844C">name</span>=<span class="hl-value" style="color: #993300">"userId"</span> <span class="hl-attribute" style="color: #F5844C">displayName</span>=<span class="hl-value" style="color: #993300">"登录名"</span><strong class="hl-tag" style="color: #000096">&gt;</strong>
        <strong class="hl-tag" style="color: #000096">&lt;required-validator&gt;</strong>
            <strong class="hl-tag" style="color: #000096">&lt;message&gt;</strong>必须填写 ${displayName}<strong class="hl-tag" style="color: #000096">&lt;/message&gt;</strong>
        <strong class="hl-tag" style="color: #000096">&lt;/required-validator&gt;</strong>
        <strong class="hl-tag" style="color: #000096">&lt;regexp-validator</strong> <span class="hl-attribute" style="color: #F5844C">pattern</span>=<span class="hl-value" style="color: #993300">"^[A-Za-z_][A-Za-z_0-9]*$"</span><strong class="hl-tag" style="color: #000096">&gt;</strong>
            <strong class="hl-tag" style="color: #000096">&lt;message&gt;</strong>${displayName} 必须由字母、数字、下划线构成<strong class="hl-tag" style="color: #000096">&lt;/message&gt;</strong>
        <strong class="hl-tag" style="color: #000096">&lt;/regexp-validator&gt;</strong>
        <strong class="hl-tag" style="color: #000096">&lt;string-length-validator</strong> <span class="hl-attribute" style="color: #F5844C">minLength</span>=<span class="hl-value" style="color: #993300">"4"</span> <span class="hl-attribute" style="color: #F5844C">maxLength</span>=<span class="hl-value" style="color: #993300">"10"</span><strong class="hl-tag" style="color: #000096">&gt;</strong>
            <strong class="hl-tag" style="color: #000096">&lt;message&gt;</strong>${displayName} 最少必须由${minLength}个字组成，最多不能超过${maxLength}个字<strong class="hl-tag" style="color: #000096">&lt;/message&gt;</strong>
        <strong class="hl-tag" style="color: #000096">&lt;/string-length-validator&gt;</strong>
        <strong class="hl-tag" style="color: #000096">&lt;custom-error</strong> <span class="hl-attribute" style="color: #F5844C">id</span>=<span class="hl-value" style="color: #993300">"duplicatedUserId"</span><strong class="hl-tag" style="color: #000096">&gt;</strong> <a id="co.form.customerr"><!--anchor co.form.customerr--></a><span class="calloutno"><img src="images/callouts/1.png" border="0"/></span>
            <strong class="hl-tag" style="color: #000096">&lt;message&gt;</strong>登录名“${userId}”已经被人注掉了，请尝试另一个名字<strong class="hl-tag" style="color: #000096">&lt;/message&gt;</strong>
        <strong class="hl-tag" style="color: #000096">&lt;/custom-error&gt;</strong>
    <strong class="hl-tag" style="color: #000096">&lt;/services:field&gt;</strong>
    ...
<strong class="hl-tag" style="color: #000096">&lt;/services:group&gt;</strong></pre><div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#co.form.customerr"><span class="calloutno"><img src="images/callouts/1.png" border="0"/></span></a> </p></td><td valign="top" align="left"><p>Custom Error“验证器”不做任何验证 —— 它把验证的责任交给action来做。但是除此以外，它和其它验证器完全相同 ——
                                你可以设置message，甚至可以用message
                                source来实现国际化的错误提示。你不需要把错误提示写在代码中，或者启用另一种错误提示方案。</p></td></tr></table></div></div></div><p>对于custom error，需要在action中有相应的支持，否则不会自动生效：</p><div class="example"><a id="d0e13810"><!--anchor d0e13810--></a><p class="title"><strong>例 9.51. 用来生成custom error的action代码</strong></p><div class="example-contents"><pre class="programlisting"><strong class="hl-keyword" style="color: maroon">public</strong> <strong class="hl-keyword" style="color: maroon">void</strong> doRegister(<em><span class="hl-annotation" style="color: gray">@FormField(name = "userId", group = "register")</span></em> CustomErrors err, <a id="co.form.customerr.inject"><!--anchor co.form.customerr.inject--></a><span class="calloutno"><img src="images/callouts/1.png" border="0"/></span>
                           ...) <strong class="hl-keyword" style="color: maroon">throws</strong> Exception {
    <strong class="hl-keyword" style="color: maroon">try</strong> {
        ...
    } <strong class="hl-keyword" style="color: maroon">catch</strong> (DuplicatedUserException e) {
        Map&lt;String, Object&gt; params = createHashMap();
        params.put(<strong class="hl-string"><em style="color:navy">"userId"</em></strong>, user.getUserId());

        err.setMessage(<strong class="hl-string"><em style="color:navy">"duplicatedUserId"</em></strong>, params); <a id="co.form.customerr.setmsg"><!--anchor co.form.customerr.setmsg--></a><span class="calloutno"><img src="images/callouts/2.png" border="0"/></span>
    }
}</pre><div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#co.form.customerr.inject"><span class="calloutno"><img src="images/callouts/1.png" border="0"/></span></a> </p></td><td valign="top" align="left"><p>注入<code class="code">CustomErrors</code>接口。和注入Field的方法相同，通过<code class="code">@FormField</code>注解指明<code class="code">CustomErrors</code>所在的
                                group名称以及field名称。</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#co.form.customerr.setmsg"><span class="calloutno"><img src="images/callouts/2.png" border="0"/></span></a> </p></td><td valign="top" align="left"><p>调用<code class="code">CustomeErrors.setMessage()</code>方法。其中，“<code class="code">duplicatedUserId</code>”就是配置文件中<code class="code">&lt;custom-error&gt;</code>的<code class="code">id</code>。</p><p>第二个参数<code class="code">params</code>是可选的。它是一个<code class="code">Map</code>，其中的所有值，都可以在<code class="code">&lt;custom-error&gt;</code>的<code class="code">message</code>中访问到。例如，这里指定的<code class="code">userId</code>参数值，就可以被<code class="code">message</code>表达式<code class="code">${userId}</code>所访问。</p></td></tr></table></div></div></div></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="d0e13870"><!--anchor d0e13870--></a>9.4.2.13. 条件验证</h4></div></div></div><p>条件验证就是让某些validator仅在条件满足时才验证。条件验证有两种，单分支和多分支验证。</p><div class="example"><a id="d0e13875"><!--anchor d0e13875--></a><p class="title"><strong>例 9.52. 单分支条件验证</strong></p><div class="example-contents"><pre class="programlisting"><strong class="hl-tag" style="color: #000096">&lt;services:field</strong> <span class="hl-attribute" style="color: #F5844C">name</span>=<span class="hl-value" style="color: #993300">"other"</span> <span class="hl-attribute" style="color: #F5844C">displayName</span>=<span class="hl-value" style="color: #993300">"其它建议"</span><strong class="hl-tag" style="color: #000096">&gt;</strong>
    <strong class="hl-tag" style="color: #000096">&lt;if</strong> <span class="hl-attribute" style="color: #F5844C">test</span>=<span class="hl-value" style="color: #993300">"commentCode.value == 'other'"</span><strong class="hl-tag" style="color: #000096">&gt;</strong>
        <strong class="hl-tag" style="color: #000096">&lt;required-validator&gt;</strong>
            <strong class="hl-tag" style="color: #000096">&lt;message&gt;</strong>必须填写 ${displayName}<strong class="hl-tag" style="color: #000096">&lt;/message&gt;</strong>
        <strong class="hl-tag" style="color: #000096">&lt;/required-validator&gt;</strong>
    <strong class="hl-tag" style="color: #000096">&lt;/if&gt;</strong>
<strong class="hl-tag" style="color: #000096">&lt;/services:field&gt;</strong></pre></div></div><div class="example"><a id="d0e13880"><!--anchor d0e13880--></a><p class="title"><strong>例 9.53. 多分支条件验证</strong></p><div class="example-contents"><pre class="programlisting"><strong class="hl-tag" style="color: #000096">&lt;services:field</strong> <span class="hl-attribute" style="color: #F5844C">name</span>=<span class="hl-value" style="color: #993300">"field1"</span> <span class="hl-attribute" style="color: #F5844C">displayName</span>=<span class="hl-value" style="color: #993300">"我的字段"</span><strong class="hl-tag" style="color: #000096">&gt;</strong>
    <strong class="hl-tag" style="color: #000096">&lt;choose&gt;</strong>
        <strong class="hl-tag" style="color: #000096">&lt;when</strong> <span class="hl-attribute" style="color: #F5844C">test</span>=<span class="hl-value" style="color: #993300">"expr1"</span><strong class="hl-tag" style="color: #000096">&gt;</strong>
            <strong class="hl-tag" style="color: #000096">&lt;validator /&gt;</strong>
        <strong class="hl-tag" style="color: #000096">&lt;/when&gt;</strong>
        <strong class="hl-tag" style="color: #000096">&lt;when</strong> <span class="hl-attribute" style="color: #F5844C">test</span>=<span class="hl-value" style="color: #993300">"expr2"</span><strong class="hl-tag" style="color: #000096">&gt;</strong>
            <strong class="hl-tag" style="color: #000096">&lt;validator /&gt;</strong>
            <strong class="hl-tag" style="color: #000096">&lt;validator /&gt;</strong>
        <strong class="hl-tag" style="color: #000096">&lt;/when&gt;</strong>
        <strong class="hl-tag" style="color: #000096">&lt;otherwise&gt;</strong>
            <strong class="hl-tag" style="color: #000096">&lt;validator /&gt;</strong>
        <strong class="hl-tag" style="color: #000096">&lt;/otherwise&gt;</strong>
    <strong class="hl-tag" style="color: #000096">&lt;/choose&gt;</strong>
<strong class="hl-tag" style="color: #000096">&lt;/services:field&gt;</strong></pre></div></div><p>在上面的配置示例中，<code class="code">&lt;if&gt;</code>和<code class="code">&lt;when&gt;</code>都支持的<code class="code">test</code>参数，其内容为JEXL表达式。其格式详见：<a class="link" href="http://commons.apache.org/jexl/reference/syntax.html" target="_top">http://commons.apache.org/jexl/reference/syntax.html</a>。JEXL表达式中可用的变量同Validator messages中可用的变量，请参见：<a class="xref" href="form.html#webx.form.validator.messages" title="9.4.1.11. Validator messages">第 9.4.1.11 节 “Validator messages”</a>。 除此之外，条件分支还支持任意自定义的条件，方法是： </p><div class="example"><a id="d0e13900"><!--anchor d0e13900--></a><p class="title"><strong>例 9.54. 在条件验证中自定义条件</strong></p><div class="example-contents"><pre class="programlisting"><strong class="hl-tag" style="color: #000096">&lt;if</strong> <span class="hl-attribute" style="color: #F5844C">xmlns:fm-conditions</span>=<span class="hl-value" style="color: #993300">"http://www.alibaba.com/schema/services/form/conditions"</span><strong class="hl-tag" style="color: #000096">&gt;</strong>
    <strong class="hl-tag" style="color: #000096">&lt;fm-conditions:condition</strong> <span class="hl-attribute" style="color: #F5844C">class</span>=<span class="hl-value" style="color: #993300">"xxx"</span><strong class="hl-tag" style="color: #000096"> /&gt;</strong> <a id="co.form.conditional.if"><!--anchor co.form.conditional.if--></a><span class="calloutno"><img src="images/callouts/1.png" border="0"/></span>
<strong class="hl-tag" style="color: #000096">&lt;/if&gt;</strong>
...
<strong class="hl-tag" style="color: #000096">&lt;when</strong> <span class="hl-attribute" style="color: #F5844C">xmlns:fm-conditions</span>=<span class="hl-value" style="color: #993300">"http://www.alibaba.com/schema/services/form/conditions"</span><strong class="hl-tag" style="color: #000096">&gt;</strong>
    <strong class="hl-tag" style="color: #000096">&lt;fm-conditions:condition</strong> <span class="hl-attribute" style="color: #F5844C">class</span>=<span class="hl-value" style="color: #993300">"xxx"</span><strong class="hl-tag" style="color: #000096"> /&gt;</strong> <a id="co.form.conditional.when"><!--anchor co.form.conditional.when--></a><span class="calloutno"><img src="images/callouts/2.png" border="0"/></span>
<strong class="hl-tag" style="color: #000096">&lt;/when&gt;</strong></pre><div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#co.form.conditional.if"><span class="calloutno"><img src="images/callouts/1.png" border="0"/></span></a> <a href="#co.form.conditional.when"><span class="calloutno"><img src="images/callouts/2.png" border="0"/></span></a> </p></td><td valign="top" align="left"><p>实现类只需要实现<code class="code">Condition</code>接口就可以了。</p></td></tr></table></div></div></div></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="d0e13916"><!--anchor d0e13916--></a>9.4.2.14. 多值验证</h4></div></div></div><p>HTML表单字段均支持多值。比如：</p><div class="example"><a id="d0e13921"><!--anchor d0e13921--></a><p class="title"><strong>例 9.55. 具有多值的HTML表单字段</strong></p><div class="example-contents"><pre class="programlisting"><strong class="hl-tag" style="color: #000096">&lt;p&gt;</strong>你喜欢吃哪些食物？<strong class="hl-tag" style="color: #000096">&lt;/p&gt;</strong>
<strong class="hl-tag" style="color: #000096">&lt;input</strong> <span class="hl-attribute" style="color: #F5844C">type</span>=<span class="hl-value" style="color: #993300">"checkbox"</span> <span class="hl-attribute" style="color: #F5844C">name</span>=<span class="hl-value" style="color: #993300">"poll"</span> <span class="hl-attribute" style="color: #F5844C">value</span>=<span class="hl-value" style="color: #993300">"italian"</span><strong class="hl-tag" style="color: #000096"> /&gt;</strong> 意大利菜
<strong class="hl-tag" style="color: #000096">&lt;input</strong> <span class="hl-attribute" style="color: #F5844C">type</span>=<span class="hl-value" style="color: #993300">"checkbox"</span> <span class="hl-attribute" style="color: #F5844C">name</span>=<span class="hl-value" style="color: #993300">"poll"</span> <span class="hl-attribute" style="color: #F5844C">value</span>=<span class="hl-value" style="color: #993300">"french"</span><strong class="hl-tag" style="color: #000096"> /&gt;</strong> 法国菜
<strong class="hl-tag" style="color: #000096">&lt;input</strong> <span class="hl-attribute" style="color: #F5844C">type</span>=<span class="hl-value" style="color: #993300">"checkbox"</span> <span class="hl-attribute" style="color: #F5844C">name</span>=<span class="hl-value" style="color: #993300">"poll"</span> <span class="hl-attribute" style="color: #F5844C">value</span>=<span class="hl-value" style="color: #993300">"chinese"</span><strong class="hl-tag" style="color: #000096"> /&gt;</strong> 中国菜</pre><p>当用户选择了多个复选框并提交以后，在表单系统中体现为数组：</p><pre class="programlisting">field.getName();   <em class="hl-comment" style="color: green">// "poll"</em>
field.getValues(); <em class="hl-comment" style="color: green">// "italian", "french", "chinese"</em></pre></div></div><p>不仅仅是复选框，任何其它类型的输入框（textbox、hidden field、file
                    upload等）都支持多值。然而前面所说的所有validator只对field中的第一个值进行验证。假如我希望对多个值同时进行验证，该怎么办呢？表单验证服务提供了一组用于多值验证的validators。</p><div class="section"><div class="titlepage"><div><div><h5 class="title"><a id="d0e13932"><!--anchor d0e13932--></a>9.4.2.14.1. 验证值的数量</h5></div></div></div><div class="example"><a id="d0e13935"><!--anchor d0e13935--></a><p class="title"><strong>例 9.56. <code class="code">&lt;multi-values-count-validator&gt;</code>的配置</strong></p><div class="example-contents"><pre class="programlisting"><strong class="hl-tag" style="color: #000096">&lt;services:field</strong> <span class="hl-attribute" style="color: #F5844C">name</span>=<span class="hl-value" style="color: #993300">"poll"</span> <span class="hl-attribute" style="color: #F5844C">displayName</span>=<span class="hl-value" style="color: #993300">"调查"</span><strong class="hl-tag" style="color: #000096">&gt;</strong>
    <strong class="hl-tag" style="color: #000096">&lt;multi-values-count-validator</strong> <span class="hl-attribute" style="color: #F5844C">minCount</span>=<span class="hl-value" style="color: #993300">"1"</span> <span class="hl-attribute" style="color: #F5844C">maxCount</span>=<span class="hl-value" style="color: #993300">"3"</span><strong class="hl-tag" style="color: #000096">&gt;</strong> <a id="co.form.mvalues.count"><!--anchor co.form.mvalues.count--></a><span class="calloutno"><img src="images/callouts/1.png" border="0"/></span>
        <strong class="hl-tag" style="color: #000096">&lt;message&gt;</strong>至少选择${minCount}项，最多选择${maxCount}项<strong class="hl-tag" style="color: #000096">&lt;/message&gt;</strong>
    <strong class="hl-tag" style="color: #000096">&lt;/multi-values-count-validator&gt;</strong>
<strong class="hl-tag" style="color: #000096">&lt;/services:field&gt;</strong></pre><div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#co.form.mvalues.count"><span class="calloutno"><img src="images/callouts/1.png" border="0"/></span></a> </p></td><td valign="top" align="left"><p>对用户提交的值的数量进行验证，迫使用户选择1-3项他喜欢的食物。</p></td></tr></table></div></div></div></div><div class="section"><div class="titlepage"><div><div><h5 class="title"><a id="d0e13948"><!--anchor d0e13948--></a>9.4.2.14.2. 要求所有值均通过验证</h5></div></div></div><div class="example"><a id="d0e13951"><!--anchor d0e13951--></a><p class="title"><strong>例 9.57. <code class="code">&lt;all-of-values&gt;</code>的配置</strong></p><div class="example-contents"><pre class="programlisting"><strong class="hl-tag" style="color: #000096">&lt;all-of-values&gt;</strong>
    <strong class="hl-tag" style="color: #000096">&lt;message&gt;</strong>${allMessages}<strong class="hl-tag" style="color: #000096">&lt;/message&gt;</strong>
    <strong class="hl-tag" style="color: #000096">&lt;validator /&gt;</strong>
    <strong class="hl-tag" style="color: #000096">&lt;validator /&gt;</strong>
<strong class="hl-tag" style="color: #000096">&lt;/all-of-values&gt;</strong></pre></div></div><p>只有当前字段的所有值都符合要求，<code class="code">&lt;all-of-values&gt;</code>验证才会通过。其<code class="code">message</code>支持<code class="code">${allMessages}</code>，它是一个<code class="code">List</code>列表，可以用来显示所有未通过验证的validators的消息。</p></div><div class="section"><div class="titlepage"><div><div><h5 class="title"><a id="d0e13972"><!--anchor d0e13972--></a>9.4.2.14.3. 要求任意一个值通过验证</h5></div></div></div><div class="example"><a id="d0e13975"><!--anchor d0e13975--></a><p class="title"><strong>例 9.58. <code class="code">&lt;any-of-values&gt;</code>的配置</strong></p><div class="example-contents"><pre class="programlisting"><strong class="hl-tag" style="color: #000096">&lt;any-of-values&gt;</strong>
    <strong class="hl-tag" style="color: #000096">&lt;message&gt;</strong>至少有一个${displayName}要符合要求<strong class="hl-tag" style="color: #000096">&lt;/message&gt;</strong>
    <strong class="hl-tag" style="color: #000096">&lt;validator /&gt;</strong>
    <strong class="hl-tag" style="color: #000096">&lt;validator /&gt;</strong>
<strong class="hl-tag" style="color: #000096">&lt;/any-of-values&gt;</strong></pre></div></div><p>只要当前字段有一个值通过验证，<code class="code">&lt;any-of-values&gt;</code>验证就会通过。其<code class="code">message</code>支持<code class="code">${valueIndex}</code>代表被验证通过的值的序号；支持<code class="code">${allMessages}</code>，它是一个<code class="code">List</code>列表，可以用来显示所有未通过验证的validators的消息。</p></div><div class="section"><div class="titlepage"><div><div><h5 class="title"><a id="d0e13999"><!--anchor d0e13999--></a>9.4.2.14.4. 要求任意一个值都不通过验证</h5></div></div></div><div class="example"><a id="d0e14002"><!--anchor d0e14002--></a><p class="title"><strong>例 9.59. <code class="code">&lt;none-of-values&gt;</code>的配置</strong></p><div class="example-contents"><pre class="programlisting"><strong class="hl-tag" style="color: #000096">&lt;none-of-values&gt;</strong>
    <strong class="hl-tag" style="color: #000096">&lt;message&gt;</strong>所有${displayName}都不能符合要求<strong class="hl-tag" style="color: #000096">&lt;/message&gt;</strong>
    <strong class="hl-tag" style="color: #000096">&lt;validator /&gt;</strong>
    <strong class="hl-tag" style="color: #000096">&lt;validator /&gt;</strong>
<strong class="hl-tag" style="color: #000096">&lt;/none-of-values&gt;</strong></pre></div></div><p>只要当前字段有一个值通过验证，<code class="code">&lt;none-of-values&gt;</code>验证就会失败。</p></div></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="d0e14014"><!--anchor d0e14014--></a>9.4.2.15. 组合验证</h4></div></div></div><p>组合验证就是将validators组合起来，类似于Java中的and（<code class="code">&amp;&amp;</code>）、or（<code class="code">||</code>）、not（<code class="code">!</code>）等操作符的功能。</p><div class="section"><div class="titlepage"><div><div><h5 class="title"><a id="d0e14028"><!--anchor d0e14028--></a>9.4.2.15.1. 要求所有validators通过验证</h5></div></div></div><div class="example"><a id="d0e14031"><!--anchor d0e14031--></a><p class="title"><strong>例 9.60. <code class="code">&lt;all-of&gt;</code>的配置</strong></p><div class="example-contents"><pre class="programlisting"><strong class="hl-tag" style="color: #000096">&lt;all-of&gt;</strong>
    <strong class="hl-tag" style="color: #000096">&lt;validator /&gt;</strong>
    <strong class="hl-tag" style="color: #000096">&lt;validator /&gt;</strong>
<strong class="hl-tag" style="color: #000096">&lt;/all-of&gt;</strong></pre></div></div><p>只要有一个validator通不过验证，就失败。<code class="code">&lt;all-of&gt;</code>不需要设置<code class="code">message</code>，它的<code class="code">message</code>就是第一个没有通过验证的validator的<code class="code">message</code>。</p></div><div class="section"><div class="titlepage"><div><div><h5 class="title"><a id="d0e14052"><!--anchor d0e14052--></a>9.4.2.15.2. 要求任意一个validators通过验证</h5></div></div></div><div class="example"><a id="d0e14055"><!--anchor d0e14055--></a><p class="title"><strong>例 9.61. <code class="code">&lt;any-of&gt;</code>的配置</strong></p><div class="example-contents"><pre class="programlisting"><strong class="hl-tag" style="color: #000096">&lt;any-of&gt;</strong>
    <strong class="hl-tag" style="color: #000096">&lt;message&gt;</strong>${allMessages}<strong class="hl-tag" style="color: #000096">&lt;/message&gt;</strong>
    <strong class="hl-tag" style="color: #000096">&lt;validator /&gt;</strong>
    <strong class="hl-tag" style="color: #000096">&lt;validator /&gt;</strong>
<strong class="hl-tag" style="color: #000096">&lt;/any-of&gt;</strong></pre></div></div><p>只要有一个validator通过验证，<code class="code">&lt;any-of&gt;</code>验证就会通过。其<code class="code">message</code>支持<code class="code">${allMessages}</code>，它是一个<code class="code">List</code>列表，可以用来可以用来显示所有未通过验证的validators的消息。</p></div><div class="section"><div class="titlepage"><div><div><h5 class="title"><a id="d0e14076"><!--anchor d0e14076--></a>9.4.2.15.3. 要求任何一个validators都通不过验证</h5></div></div></div><div class="example"><a id="d0e14079"><!--anchor d0e14079--></a><p class="title"><strong>例 9.62. <code class="code">&lt;none-of&gt;</code>的配置</strong></p><div class="example-contents"><pre class="programlisting"><strong class="hl-tag" style="color: #000096">&lt;none-of&gt;</strong>
    <strong class="hl-tag" style="color: #000096">&lt;message&gt;</strong>${displayName}不符合要求<strong class="hl-tag" style="color: #000096">&lt;/message&gt;</strong>
    <strong class="hl-tag" style="color: #000096">&lt;validator /&gt;</strong>
    <strong class="hl-tag" style="color: #000096">&lt;validator /&gt;</strong>
<strong class="hl-tag" style="color: #000096">&lt;/none-of&gt;</strong></pre></div></div><p>只要有一个validator通过验证，<code class="code">&lt;none-of&gt;</code>验证就会失败。</p></div></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="d0e14091"><!--anchor d0e14091--></a>9.4.3. Form Tool</h3></div></div></div><p>Form Tool是一个pull tool工具，配置如下：</p><div class="example"><a id="d0e14096"><!--anchor d0e14096--></a><p class="title"><strong>例 9.63. Form Tool的配置</strong></p><div class="example-contents"><pre class="programlisting">&lt;services:pull xmlns="http://www.alibaba.com/schema/services/pull/factories"&gt;
    &lt;form-tool /&gt;
    ...
&lt;/services:pull&gt;</pre></div></div><p>上面的配置定义了一个<code class="code">$form</code>工具。可以在模板中直接使用它。下页简单介绍在模板中，<code class="code">$form</code>工具的用法。</p><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="d0e14109"><!--anchor d0e14109--></a>9.4.3.1. Form API</h4></div></div></div><div class="table"><a id="d0e14112"><!--anchor d0e14112--></a><p class="title"><strong>表 9.17. 有关Form的API</strong></p><div class="table-contents"><table summary="有关Form的API" cellpadding="10" style="border: none;"><colgroup><col width="58%" class="c1"/><col width="42%" class="c2"/></colgroup><thead><tr><th style="border-right: 0.5pt solid #6666cc; border-bottom: 0.5pt solid #6666cc; ">API用法</th><th style="border-bottom: 0.5pt solid #6666cc; ">说明</th></tr></thead><tbody><tr><td style="border-right: 0.5pt solid #6666cc; border-bottom: 0.5pt solid #6666cc; "><code class="code">#if ($form.valid) ... #end</code></td><td style="border-bottom: 0.5pt solid #6666cc; ">判断当前form是否验证为合法，或者未经过验证。</td></tr><tr><td style="border-right: 0.5pt solid #6666cc; border-bottom: 0.5pt solid #6666cc; "><code class="code">#set ($group =
                                    $form.group1.defaultInstance)</code></td><td style="border-bottom: 0.5pt solid #6666cc; ">取得<code class="code">group1</code>的默认实例，如果不存在，则创建之。</td></tr><tr><td style="border-right: 0.5pt solid #6666cc; border-bottom: 0.5pt solid #6666cc; "><code class="code">#set ($group =
                                    $form.group1.getInstance("id"))</code></td><td style="border-bottom: 0.5pt solid #6666cc; ">取得<code class="code">group1</code>的指定<code class="code">id</code>的实例，如果不存在，则创建之。</td></tr><tr><td style="border-right: 0.5pt solid #6666cc; border-bottom: 0.5pt solid #6666cc; "><code class="code">#set ($group = $form.group1.getInstance("id",
                                        false))</code></td><td style="border-bottom: 0.5pt solid #6666cc; ">取得<code class="code">group1</code>的指定<code class="code">id</code>的实例，如果不存在，则返回<code class="code">null</code>。</td></tr><tr><td style="border-right: 0.5pt solid #6666cc; border-bottom: 0.5pt solid #6666cc; "><code class="code">#foreach ($group in $form.groups) ...
                                    #end</code></td><td style="border-bottom: 0.5pt solid #6666cc; ">遍历当前form中所有group实例。</td></tr><tr><td style="border-right: 0.5pt solid #6666cc; "><code class="code">#foreach ($group in $form.getGroups("group1")) …
                                        #end</code></td><td style="">遍历当前form中所有名为<code class="code">group1</code>的实例。</td></tr></tbody></table></div></div></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="d0e14182"><!--anchor d0e14182--></a>9.4.3.2. Group API</h4></div></div></div><div class="table"><a id="d0e14185"><!--anchor d0e14185--></a><p class="title"><strong>表 9.18. 有关Group的API</strong></p><div class="table-contents"><table summary="有关Group的API" cellpadding="10" style="border: none;"><colgroup><col width="58%" class="c1"/><col width="42%" class="c2"/></colgroup><thead><tr><th style="border-right: 0.5pt solid #6666cc; border-bottom: 0.5pt solid #6666cc; ">API用法</th><th style="border-bottom: 0.5pt solid #6666cc; ">说明</th></tr></thead><tbody><tr><td style="border-right: 0.5pt solid #6666cc; border-bottom: 0.5pt solid #6666cc; "><code class="code">#if ($group.valid) … #end</code></td><td style="border-bottom: 0.5pt solid #6666cc; ">判断当前group是否验证为合法，或者未经过验证（即初始表单）</td></tr><tr><td style="border-right: 0.5pt solid #6666cc; border-bottom: 0.5pt solid #6666cc; "><code class="code">#if ($group.validated) ... #end</code></td><td style="border-bottom: 0.5pt solid #6666cc; ">判断当前group是否经过验证（初始表单为未经过验证的表单） </td></tr><tr><td style="border-right: 0.5pt solid #6666cc; border-bottom: 0.5pt solid #6666cc; "><code class="code">$group.field1</code></td><td style="border-bottom: 0.5pt solid #6666cc; ">取得field1</td></tr><tr><td style="border-right: 0.5pt solid #6666cc; border-bottom: 0.5pt solid #6666cc; "><code class="code">#foreach ($field in $group.fields) ...
                                    #end</code></td><td style="border-bottom: 0.5pt solid #6666cc; ">遍历当前group中所有的fields</td></tr><tr><td style="border-right: 0.5pt solid #6666cc; "><code class="code">$group.mapTo($bean)</code></td><td style="">将bean中的properties设置成group的初始值。
                                    该操作只对初始表单有效。如果bean为null则忽略该操作。</td></tr></tbody></table></div></div></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="d0e14228"><!--anchor d0e14228--></a>9.4.3.3. Field API</h4></div></div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term">创建一个HTML表单字段</span></dt><dd><div class="example"><a id="d0e14236"><!--anchor d0e14236--></a><p class="title"><strong>例 9.64. 创建一个HTML表单字段</strong></p><div class="example-contents"><pre class="programlisting">$field.displayName
<strong class="hl-tag" style="color: #000096">&lt;input</strong> <span class="hl-attribute" style="color: #F5844C">type</span>=<span class="hl-value" style="color: #993300">"text"</span> <span class="hl-attribute" style="color: #F5844C">name</span>=<span class="hl-value" style="color: #993300">"$field.key"</span> <span class="hl-attribute" style="color: #F5844C">value</span>=<span class="hl-value" style="color: #993300">"$!field.value"</span><strong class="hl-tag" style="color: #000096"> /&gt;</strong></pre></div></div><p>其中，<code class="code">displayName</code>来自于配置文件。将<code class="code">displayName</code>显示在页面中的好处是，确保页面与出错信息的措辞一致。</p></dd><dt><span class="term">判断验证合法性，并显示错误消息</span></dt><dd><div class="example"><a id="d0e14253"><!--anchor d0e14253--></a><p class="title"><strong>例 9.65. 判断验证合法性，并显示错误消息</strong></p><div class="example-contents"><pre class="programlisting">#if (!$field.valid)
  <strong class="hl-tag" style="color: #000096">&lt;div</strong> <span class="hl-attribute" style="color: #F5844C">class</span>=<span class="hl-value" style="color: #993300">"error"</span><strong class="hl-tag" style="color: #000096">&gt;</strong>$field.message<strong class="hl-tag" style="color: #000096">&lt;/div&gt;</strong>
#end</pre></div></div></dd><dt><span class="term">取得多值</span></dt><dd><div class="example"><a id="d0e14262"><!--anchor d0e14262--></a><p class="title"><strong>例 9.66. 取得多值</strong></p><div class="example-contents"><pre class="programlisting">#foreach ($value in $field.values) ... #end</pre></div></div></dd><dt><span class="term">创建checkbox和radiobox的默认值</span></dt><dd><div class="example"><a id="d0e14271"><!--anchor d0e14271--></a><p class="title"><strong>例 9.67. 创建checkbox和radiobox的默认值</strong></p><div class="example-contents"><pre class="programlisting"><strong class="hl-tag" style="color: #000096">&lt;input</strong> <span class="hl-attribute" style="color: #F5844C">type</span>=<span class="hl-value" style="color: #993300">"hidden"</span> <span class="hl-attribute" style="color: #F5844C">name</span>=<span class="hl-value" style="color: #993300">"$field.absentKey"</span> <span class="hl-attribute" style="color: #F5844C">value</span>=<span class="hl-value" style="color: #993300">"$value"</span><strong class="hl-tag" style="color: #000096"> /&gt;</strong></pre><p>或者简化为：</p><pre class="programlisting">$field.getAbsentHiddenField($value)</pre></div></div><p>Checkbox和radiobox有一个特性，当用户没有选中它们时，它们是没有值的（就像不存在一样）。这点对于表单验证会带来不便。</p><p>表单服务支持一种特殊的<code class="code">absentKey</code>。通过它，可以为checkbox/radiobox设置默认值。这样，当用户没有选中任何checkbox或radiobox时，这个值就成为field的值。</p></dd><dt><span class="term">创建附件</span></dt><dd><p>Field可以带一个附件。附件是一个对象，被序列化保存在hidden字段中。在下一次请求的时候，附件可以被恢复成对象。通过附件，可以让应用程序在表单中携带一些附加信息。
                                    下页的代码会生成一个hidden字段，将<code class="code">$obj</code>序列化保存在其中： </p><div class="example"><a id="d0e14296"><!--anchor d0e14296--></a><p class="title"><strong>例 9.68. 创建附件</strong></p><div class="example-contents"><pre class="programlisting">$field.setAttachment($obj)
$field.attachmentHiddenField</pre><p>当你要取得它时，只要这样：</p><pre class="programlisting">#set ($obj = $field.attachment)</pre><p>判断是否有附件：</p><pre class="programlisting">#if ($field.hasAttachment()) … #end</pre><p>清除附件：</p><pre class="programlisting">$field.cleanAttachment()</pre></div></div></dd></dl></div></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="d0e14313"><!--anchor d0e14313--></a>9.4.4. Field keys的格式</h3></div></div></div><p>表单验证服务所生成的field key是这样的：“<code class="code">_fm.r._0.p</code>”。它是由几部分组成： </p><div class="table"><a id="d0e14321"><!--anchor d0e14321--></a><p class="title"><strong>表 9.19. 压缩格式的field key（以<code class="code">_fm.r._0.p</code>为例）的组成</strong></p><div class="table-contents"><table summary="压缩格式的field key（以_fm.r._0.p为例）的组成" cellpadding="10" style="border-collapse: collapse;border-top: 0.5pt solid #6666cc; border-bottom: 0.5pt solid #6666cc; border-left: 0.5pt solid #6666cc; border-right: 0.5pt solid #6666cc; "><colgroup><col width="23%" class="c1"/><col width="77%" class="c2"/></colgroup><thead><tr><th style="border-right: 0.5pt solid #6666cc; border-bottom: 0.5pt solid #6666cc; ">名称</th><th style="border-bottom: 0.5pt solid #6666cc; ">说明</th></tr></thead><tbody><tr><td style="border-right: 0.5pt solid #6666cc; border-bottom: 0.5pt solid #6666cc; ">
                                <p><code class="code">_fm</code></p>
                            </td><td style="border-bottom: 0.5pt solid #6666cc; ">
                                <p>固定的前缀。它是单词“form”的缩写。表单系统依此来识别该字段为需要验证的表单字段。</p>
                            </td></tr><tr><td style="border-right: 0.5pt solid #6666cc; border-bottom: 0.5pt solid #6666cc; ">
                                <p><code class="code">r</code></p>
                            </td><td style="border-bottom: 0.5pt solid #6666cc; ">被压缩的group名称。</td></tr><tr><td style="border-right: 0.5pt solid #6666cc; border-bottom: 0.5pt solid #6666cc; ">
                                <p><code class="code">_0</code></p>
                            </td><td style="border-bottom: 0.5pt solid #6666cc; ">
                                <p>代表group instance的唯一ID。<code class="code">_0</code>是默认的ID。</p>
                            </td></tr><tr><td style="border-right: 0.5pt solid #6666cc; ">
                                <p><code class="code">p</code></p>
                            </td><td style="">被压缩的field名称。</td></tr></tbody></table></div></div><p>在以上例子中，field keys被压缩了。压缩以后的field keys更短，但同时也比较难以阅读。由于在多数情况下，我们并不需要去理解field
                    keys的含义，所以这样做并没有问题。但有一种情况，我们需要对表单进行单元测试或者集成测试。这种压缩的格式会为测试带来一定困难。为此，表单服务提供了另一种非压缩的格式可供使用。非压缩的格式和压缩格式类似，只不过其group和field的名称是完整的。例如，非压缩版的“<code class="code">_fm.register._0.password</code>”和压缩版的<code class="code">_fm.r._0.p</code>是等效的。</p><div class="table"><a id="d0e14390"><!--anchor d0e14390--></a><p class="title"><strong>表 9.20. 非压缩格式的field key（以<code class="code">_fm.register._0.password</code>为例）的组成</strong></p><div class="table-contents"><table summary="非压缩格式的field key（以_fm.register._0.password为例）的组成" cellpadding="10" style="border-collapse: collapse;border-top: 0.5pt solid #6666cc; border-bottom: 0.5pt solid #6666cc; border-left: 0.5pt solid #6666cc; border-right: 0.5pt solid #6666cc; "><colgroup><col width="23%" class="c1"/><col width="77%" class="c2"/></colgroup><thead><tr><th style="border-right: 0.5pt solid #6666cc; border-bottom: 0.5pt solid #6666cc; ">名称</th><th style="border-bottom: 0.5pt solid #6666cc; ">说明</th></tr></thead><tbody><tr><td style="border-right: 0.5pt solid #6666cc; border-bottom: 0.5pt solid #6666cc; ">
                                <p><code class="code">_fm</code></p>
                            </td><td style="border-bottom: 0.5pt solid #6666cc; ">
                                <p>固定的前缀，是单词“form”的缩写。表单系统依此来识别该字段为需要验证的表单字段。</p>
                            </td></tr><tr><td style="border-right: 0.5pt solid #6666cc; border-bottom: 0.5pt solid #6666cc; ">
                                <p><code class="code">register</code></p>
                            </td><td style="border-bottom: 0.5pt solid #6666cc; ">完整的group名称。大小写不敏感，以下写法完全等效：<code class="code">register</code>、<code class="code">Register</code>、<code class="code">rEgiSter</code>。</td></tr><tr><td style="border-right: 0.5pt solid #6666cc; border-bottom: 0.5pt solid #6666cc; ">
                                <p><code class="code">_0</code></p>
                            </td><td style="border-bottom: 0.5pt solid #6666cc; ">
                                <p>代表group instance的唯一ID。<code class="code">_0</code>是默认的ID。</p>
                            </td></tr><tr><td style="border-right: 0.5pt solid #6666cc; ">
                                <p><code class="code">password</code></p>
                            </td><td style="">完整的field名称。大小写不敏感，以下写法完全等效：<code class="code">password</code>、<code class="code">Password</code>、<code class="code">paSswoRd</code>。</td></tr></tbody></table></div></div><p>浏览器或单元测试的代码在提交表单数据时，可以混合使用压缩和非压缩的格式。但是在默认情况下，表单系统只会生成压缩格式的field
                keys。如果你希望表单系统生成非压缩的格式，你可以在配置文件中这样写：</p><div class="example"><a id="d0e14471"><!--anchor d0e14471--></a><p class="title"><strong>例 9.69. 让表单系统生成非压缩的格式的field keys</strong></p><div class="example-contents"><pre class="programlisting"><strong class="hl-tag" style="color: #000096">&lt;services:form</strong> <span class="hl-attribute" style="color: #F5844C">fieldKeyFormat</span>=<span class="hl-value" style="color: #993300">"uncompressed"</span><strong class="hl-tag" style="color: #000096">&gt;</strong> <a id="co.form.fieldKeyFormat"><!--anchor co.form.fieldKeyFormat--></a><span class="calloutno"><img src="images/callouts/1.png" border="0"/></span>
    ...
<strong class="hl-tag" style="color: #000096">&lt;/services:form&gt;</strong></pre><div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#co.form.fieldKeyFormat"><span class="calloutno"><img src="images/callouts/1.png" border="0"/></span></a> </p></td><td valign="top" align="left"><p>如果不指定，其默认值为<code class="code">compressed</code>。</p></td></tr></table></div></div></div><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[注意]" src="images/note.png"/></td><th align="left">注意</th></tr><tr><td align="left" valign="top"><p>当表单系统被配置成<code class="code">fieldKeyFormat="uncompressed"</code>时，系统就<span class="emphasis"><em>不支持</em></span>压缩格式的field
                    keys了。</p><p>当表单系统被配置成<code class="code">fieldKeyFormat="compressed"</code>时，系统就<span class="emphasis"><em>同时支持</em></span>压缩格式和非压缩格式的field
                    keys。</p></td></tr></table></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="d0e14502"><!--anchor d0e14502--></a>9.4.5. 外部验证</h3></div></div></div><p>表单验证服务是被设计成供一个<span class="emphasis"><em>应用的内部</em></span>使用的服务。它所生成的压缩格式的field
                    key，例如“<code class="code">_fm.r._0.p</code>”，是不稳定的。它和配置文件中的group、field的名称、排列顺序有关，可能随着配置的变化而变化。即便是非压缩的格式，例如“<code class="code">_fm.register._0.password</code>”，也会因配置文件中group、field命名的改变而改变。如果需要让外界系统来提交并验证表单，最好提供一个相对稳定的接口。所以外界系统最好不要依赖于这些内部的field
                keys。</p><p>如果真的需要让外界系统来提交并验证表单，可以做一个screen来转发这个请求。Screen的代码像这个样子：</p><div class="example"><a id="d0e14518"><!--anchor d0e14518--></a><p class="title"><strong>例 9.70. 转发外部表单请求</strong></p><div class="example-contents"><pre class="programlisting"><strong class="hl-keyword" style="color: maroon">public</strong> <strong class="hl-keyword" style="color: maroon">class</strong> RemoteRegister {
    <strong class="hl-keyword" style="color: maroon">public</strong> <strong class="hl-keyword" style="color: maroon">void</strong> execute(ParameterParser params, Form form, Navigator nav) <strong class="hl-keyword" style="color: maroon">throws</strong> Exception {
        Group group = form.getGroup(<strong class="hl-string"><em style="color:navy">"register"</em></strong>); <a id="co.form.external.newgroup"><!--anchor co.form.external.newgroup--></a><span class="calloutno"><img src="images/callouts/1.png" border="0"/></span>

        group.init(); <a id="co.form.external.transfer"><!--anchor co.form.external.transfer--></a><span class="calloutno"><img src="images/callouts/2.png" border="0"/></span>
        group.getField(<strong class="hl-string"><em style="color:navy">"userId"</em></strong>).setValue(params.getString(<strong class="hl-string"><em style="color:navy">"userId"</em></strong>)); <a id="co.form.external.transfer1"><!--anchor co.form.external.transfer1--></a><span class="calloutno"><img src="images/callouts/3.png" border="0"/></span>
        group.getField(<strong class="hl-string"><em style="color:navy">"password"</em></strong>).setValue(params.getString(<strong class="hl-string"><em style="color:navy">"password"</em></strong>)); <a id="co.form.external.transfer2"><!--anchor co.form.external.transfer2--></a><span class="calloutno"><img src="images/callouts/4.png" border="0"/></span>
        group.getField(<strong class="hl-string"><em style="color:navy">"passwordConfirm"</em></strong>).setValue(params.getString(<strong class="hl-string"><em style="color:navy">"password"</em></strong>)); <a id="co.form.external.transfer3"><!--anchor co.form.external.transfer3--></a><span class="calloutno"><img src="images/callouts/5.png" border="0"/></span>
        group.validate(); <a id="co.form.external.validate"><!--anchor co.form.external.validate--></a><span class="calloutno"><img src="images/callouts/6.png" border="0"/></span>

        nav.forwardTo(<strong class="hl-string"><em style="color:navy">"register"</em></strong>, <strong class="hl-string"><em style="color:navy">"registerAction"</em></strong>, <strong class="hl-string"><em style="color:navy">"register"</em></strong>); <a id="co.form.external.forward"><!--anchor co.form.external.forward--></a><span class="calloutno"><img src="images/callouts/7.png" border="0"/></span>
    }
}</pre><div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#co.form.external.newgroup"><span class="calloutno"><img src="images/callouts/1.png" border="0"/></span></a> </p></td><td valign="top" align="left"><p>创建register group的实例。</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#co.form.external.transfer"><span class="calloutno"><img src="images/callouts/2.png" border="0"/></span></a> <a href="#co.form.external.transfer1"><span class="calloutno"><img src="images/callouts/3.png" border="0"/></span></a> <a href="#co.form.external.transfer2"><span class="calloutno"><img src="images/callouts/4.png" border="0"/></span></a> <a href="#co.form.external.transfer3"><span class="calloutno"><img src="images/callouts/5.png" border="0"/></span></a> </p></td><td valign="top" align="left"><p>将request parameters中的参数设置到form
                            group中。需要注意的是，request参数名和field名称不必相同。</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#co.form.external.validate"><span class="calloutno"><img src="images/callouts/6.png" border="0"/></span></a> </p></td><td valign="top" align="left"><p>验证表单。</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#co.form.external.forward"><span class="calloutno"><img src="images/callouts/7.png" border="0"/></span></a> </p></td><td valign="top" align="left"><p>内部重定向到register页面，并指明action参数和actionEvent参数（分别是“<code class="code">registerAction</code>”和“<code class="code">register</code>”）。</p></td></tr></table></div><p>只需要访问下面的URL就可以实现从系统外部注册帐户的功能：</p><pre class="screen">http://localhost:8081/myapp/remote_register.do?userId=xxx&amp;password=yyy</pre></div></div></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="d0e14560"><!--anchor d0e14560--></a>9.5. 本章总结</h2></div></div></div><p>表单服务是一个比较复杂但也相当强大的服务。虽然目前它还不支持客户端验证和服务端异步验证功能，但下一步会加上这些功能。</p><p>表单服务最重要的设计思想是：将验证规则与页面以及业务逻辑完全分离，使验证规则的扩展和维护变得非常容易。</p></div></div><div class="navfooter"><hr/><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="pt03.html">上一页</a> </td><td width="20%" align="center"><a accesskey="u" href="pt03.html">上一级</a></td><td width="40%" align="right"> <a accesskey="n" href="pt04.html">下一页</a></td></tr><tr><td width="40%" align="left" valign="top">部分 III. Webx应用支持服务 </td><td width="20%" align="center"><a accesskey="h" href="index.html">起始页</a></td><td width="40%" align="right" valign="top"> 部分 IV. Webx应用实作</td></tr></table></div></body></html>